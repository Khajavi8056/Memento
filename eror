```mqh

// ÙØ§ÛŒÙ„ 1 ØªÙ†Ø¶ÛŒÙ…Ø§Øª ::


//+------------------------------------------------------------------+
//|                                                      set.mqh     |
//|                 Â© 2025, Mohammad & Gemini                        |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, hipoalgoritm" // Ø­Ù‚ÙˆÙ‚ Ú©Ù¾ÛŒâ€ŒØ±Ø§ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡
#property link      "https://www.mql5.com" // Ù„ÛŒÙ†Ú© Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ù¾Ø±ÙˆÚ˜Ù‡
#property version   "3.1" // Ù†Ø³Ø®Ù‡ Ø¨Ø§ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±ØªÙ‚Ø§Ø¡Ù‡Ø§

// --- Ø§Ù†ÙˆØ§Ø¹ Ø´Ù…Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± Ú©Ø¯ ---

enum E_Entry_Confirmation_Mode
{
    CONFIRM_CURRENT_TIMEFRAME, // Ø±ÙˆØ´ ÙØ¹Ù„ÛŒ: ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ù†Ø¯Ù„ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ
    CONFIRM_LOWER_TIMEFRAME    // Ø±ÙˆØ´ Ø¬Ø¯ÛŒØ¯: ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø± (CHoCH) Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†
};

enum E_Grace_Period_Mode
{
    GRACE_BY_CANDLES,          // Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ (Ø±ÙˆØ´ Ø³Ø§Ø¯Ù‡)
    GRACE_BY_STRUCTURE         // Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø± Ù‚ÛŒÙ…Øª (Ø±ÙˆØ´ Ù‡ÙˆØ´Ù…Ù†Ø¯)
};

enum E_Confirmation_Mode { MODE_CLOSE_ONLY, MODE_OPEN_AND_CLOSE }; // Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ú©Ù†Ø¯Ù„

enum E_SL_Mode
{
    MODE_COMPLEX,         // Ø¨Ù‡ÛŒÙ†Ù‡ (Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ù…Ù†Ø·Ù‚ÛŒ)
    MODE_SIMPLE,          // Ø³Ø§Ø¯Ù‡ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ù†Ú¯ Ù…Ø®Ø§Ù„Ù Ú©Ù†Ø¯Ù„)
    MODE_ATR,             // Ù¾ÙˆÛŒØ§ (Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± ATR)
    MODE_STRUCTURE        // [MODIFIED] Ø³Ø§Ø®ØªØ§Ø±ÛŒ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ø²Ø§Ø±)
};

enum E_Signal_Mode { MODE_REPLACE_SIGNAL, MODE_SIGNAL_CONTEST }; // Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„

enum E_Talaqi_Mode
{
    TALAQI_MODE_MANUAL,     // Ø¯Ø³ØªÛŒ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÙˆÛŒÙ†Øª)
    TALAQI_MODE_KUMO,       // Ù‡ÙˆØ´Ù…Ù†Ø¯ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ)
    TALAQI_MODE_ATR,        // Ù¾ÙˆÛŒØ§ (Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± ATR)
};

enum E_Filter_Timeframe_Context
{
    FILTER_CONTEXT_HTF, // ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ (HTF)
    FILTER_CONTEXT_LTF  // ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ (LTF)
};

enum E_Primary_Strategy_Mode
{
    STRATEGY_TRIPLE_CROSS,  // Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ ÙØ¹Ù„ÛŒ: Ú©Ø±Ø§Ø³ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡
    STRATEGY_KUMO_MTL       // Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¬Ø¯ÛŒØ¯: Ø§Ø¨Ø±ØŒ Ù…ÙˆÙ…Ù†ØªÙˆÙ… Ùˆ Ù†ÙˆØ³Ø§Ù† (MKM)
};

// set.mqh
enum E_Entry_Tactic
{
    TACTIC_CONFIRMATION, // ØªØ§Ú©ØªÛŒÚ© ØªØ§ÛŒÛŒØ¯ (Ù…Ù†ØªØ¸Ø± ØªØ´Ú©ÛŒÙ„ Ø³ÙˆÛŒÙ†Ú¯ Ù„Ùˆ)
    TACTIC_PREDICTIVE    // ØªØ§Ú©ØªÛŒÚ© Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ (Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù† Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø±)
};

//+------------------------------------------------------------------+
//|                      ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø§Ú©Ø³Ù¾Ø±Øª                         |
//+------------------------------------------------------------------+

// ---=== âš™ï¸ 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ (General) âš™ï¸ ===---
input group           "          ---=== âš™ï¸ 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ (General) âš™ï¸ ===---"; // Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ
input bool            Inp_Enable_Dashboard  = true;                   // âœ… ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ
input string          Inp_Symbols_List      = "EURUSD,GBPUSD,XAUUSD"; // Ù„ÛŒØ³Øª Ù†Ù…Ø§Ø¯Ù‡Ø§ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)
input int             Inp_Magic_Number      = 12345;                  // Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø§Ø¯ÙˆÛŒÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
input bool            Inp_Enable_Logging    = true;                   // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§

// ---=== ğŸ“ˆ 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ (Ichimoku Baseline) ğŸ“ˆ ===---
input group           "      ---=== ğŸ“ˆ 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ (Ichimoku) ğŸ“ˆ ===---"; // Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
input ENUM_TIMEFRAMES Inp_Ichimoku_Timeframe = PERIOD_H1;                // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
input int             Inp_Tenkan_Period     = 10;                     // Ø¯ÙˆØ±Ù‡ ØªÙ†Ú©Ø§Ù†-Ø³Ù† (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_Kijun_Period      = 28;                     // Ø¯ÙˆØ±Ù‡ Ú©ÛŒØ¬ÙˆÙ†-Ø³Ù† (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_Senkou_Period     = 55;                     // Ø¯ÙˆØ±Ù‡ Ø³Ù†Ú©Ùˆ Ø§Ø³Ù¾Ù† Ø¨ÛŒ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_Chikou_Period     = 26;                     // Ø¯ÙˆØ±Ù‡ Ú†ÛŒÚ©Ùˆ Ø§Ø³Ù¾Ù† (Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹)

// ---=== ğŸ¯ 3. Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ (Signal & Confirmation) ğŸ¯ ===---
input group           "---=== ğŸ¯ 3. Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ (Signal & Confirmation) ğŸ¯ ===---"; // Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡
input E_Primary_Strategy_Mode Inp_Primary_Strategy = STRATEGY_TRIPLE_CROSS; // Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø§ØµÙ„ÛŒ
input E_Signal_Mode   Inp_Signal_Mode         = MODE_SIGNAL_CONTEST;  // Ø±ÙˆØ´ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„

input group           "         --- ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ ÙˆØ±ÙˆØ¯ (Final Confirmation) ---"; // Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ÙˆØ±ÙˆØ¯
input E_Entry_Confirmation_Mode Inp_Entry_Confirmation_Mode = CONFIRM_CURRENT_TIMEFRAME; // Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ÙˆØ±ÙˆØ¯

input E_Entry_Tactic          Inp_Entry_Tactic = TACTIC_CONFIRMATION; // <<<< âœ… Ø§ÛŒÙ† Ø®Ø· Ø¬Ø¯ÛŒØ¯Ù‡

input group           "         --- Ù…Ù‡Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± (Grace Period) ---"; // Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ Ù…Ù‡Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„
input E_Grace_Period_Mode Inp_Grace_Period_Mode = GRACE_BY_CANDLES;   // Ù†ÙˆØ¹ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„
input int             Inp_Grace_Period_Candles= 4;                      // [Ø­Ø§Ù„Øª Ú©Ù†Ø¯Ù„ÛŒ] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…Ù‡Ù„Øª Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡

input group           "         --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† (LTF) ---"; // Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ LTF
input ENUM_TIMEFRAMES Inp_LTF_Timeframe = PERIOD_M5;                      // [Ø±ÙˆØ´ LTF] ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ÙˆØ±ÙˆØ¯
input E_Confirmation_Mode Inp_Confirmation_Type = MODE_CLOSE_ONLY;    // [Ø±ÙˆØ´ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… ÙØ¹Ù„ÛŒ] Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ Ú©Ù†Ø¯Ù„


// --- Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ø§Ù‚ÛŒ (Confluence) ---
input group           "         --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ø§Ù‚ÛŒ (Confluence) ---"; // Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ ØªÙ„Ø§Ù‚ÛŒ
input E_Talaqi_Mode   Inp_Talaqi_Calculation_Mode = TALAQI_MODE_ATR;    // Ø±ÙˆØ´ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ ØªÙ„Ø§Ù‚ÛŒ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input double          Inp_Talaqi_ATR_Multiplier     = 0.28;             // [ATR Mode] Ø¶Ø±ÛŒØ¨ ATR Ø¨Ø±Ø§ÛŒ ØªÙ„Ø§Ù‚ÛŒ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input double          Inp_Talaqi_Distance_in_Points = 3.0;              // [MANUAL Mode] ÙØ§ØµÙ„Ù‡ ØªÙ„Ø§Ù‚ÛŒ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÙˆÛŒÙ†Øª)
input double          Inp_Talaqi_Kumo_Factor      = 0.2;              // [KUMO Mode] Ø¶Ø±ÛŒØ¨ ØªÙ„Ø§Ù‚ÛŒ (Ø¯Ø±ØµØ¯ Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ)


// ---=== ğŸ›¡ï¸ 4. Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø± (Stop Loss) ğŸ›¡ï¸ ===---
input group           "       ---=== ğŸ›¡ï¸ 4. Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø± (Stop Loss) ğŸ›¡ï¸ ===---"; // Ú¯Ø±ÙˆÙ‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø±
input ENUM_TIMEFRAMES Inp_SL_Timeframe = PERIOD_CURRENT;                // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ SL
input E_SL_Mode       Inp_StopLoss_Type       = MODE_COMPLEX;           // Ø±ÙˆØ´ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³
input double          Inp_SL_ATR_Multiplier   = 2.2;                    // [ATR Mode] Ø¶Ø±ÛŒØ¨ ATR Ø¨Ø±Ø§ÛŒ Ø­Ø¯ Ø¶Ø±Ø± (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_SL_Lookback_Period  = 15;                     // [SIMPLE] Ø¯ÙˆØ±Ù‡ Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ø³Ù‚Ù/Ú©Ù
input double          Inp_SL_Buffer_Multiplier = 3.0;                   // [SIMPLE/COMPLEX] Ø¶Ø±ÛŒØ¨ Ø¨Ø§ÙØ±
input int             Inp_Flat_Kijun_Period   = 50;                     // [COMPLEX] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
input int             Inp_Flat_Kijun_Min_Length = 5;                    // [COMPLEX] Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
input int             Inp_Pivot_Lookback      = 30;                     // [COMPLEX] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙˆØª

input group           "    --- SL Ù¾ÙˆÛŒØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ³Ø§Ù† ---"; // Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ SL Ù¾ÙˆÛŒØ§
input bool            Inp_Enable_SL_Vol_Regime = false;                 // ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ SL Ù¾ÙˆÛŒØ§ Ø¨Ø§ Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù†
input int             Inp_SL_Vol_Regime_ATR_Period = 14;                // [Ù¾ÙˆÛŒØ§] Ø¯ÙˆØ±Ù‡ ATR Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†ÙˆØ³Ø§Ù†
input int             Inp_SL_Vol_Regime_EMA_Period = 20;                // [Ù¾ÙˆÛŒØ§] Ø¯ÙˆØ±Ù‡ EMA Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø®Ø· Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù†
input double          Inp_SL_High_Vol_Multiplier = 2.2;                 // [Ù¾ÙˆÛŒØ§] Ø¶Ø±ÛŒØ¨ ATR Ø¯Ø± Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù† Ø¨Ø§Ù„Ø§
input double          Inp_SL_Low_Vol_Multiplier = 1.5;                  // [Ù¾ÙˆÛŒØ§] Ø¶Ø±ÛŒØ¨ ATR Ø¯Ø± Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù† Ù¾Ø§ÛŒÛŒÙ†

// [NEW] Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú© Ù¾ÙˆÛŒØ§
input group           "    --- Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú© Ù¾ÙˆÛŒØ§ SL ---";
input double          Inp_Min_SL_Distance_Atr_Percent = 0.5;            // Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ SL Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯ ATR
input double          Inp_SL_Buffer_Atr_Percent = 0.1;                 // Ø¨Ø§ÙØ± SL Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±ØµØ¯ ATR

// ---=== ğŸ’° 5. Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡ (Money Management) ğŸ’° ===---
input group           " ---=== ğŸ’° 5. Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡ (Money Management) ğŸ’° ===---"; // Ú¯Ø±ÙˆÙ‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡
input double          Inp_Risk_Percent_Per_Trade = 0.7;                 // Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú© Ø¯Ø± Ù‡Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input double          Inp_Take_Profit_Ratio   = 1.9;                    // Ù†Ø³Ø¨Øª Ø±ÛŒØ³Ú© Ø¨Ù‡ Ø±ÛŒÙˆØ§Ø±Ø¯ Ø¨Ø±Ø§ÛŒ Ø­Ø¯ Ø³ÙˆØ¯ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_Max_Trades_Per_Symbol = 1;                    // Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø² Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§Ø¯
input int             Inp_Max_Total_Trades    = 5;                      // Ø­Ø¯Ø§Ú©Ø«Ø± Ú©Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø²

// ---=== ğŸ¨ 6. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ (Visuals) ğŸ¨ ===---
input group           "        ---=== ğŸ¨ 6. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ (Visuals) ğŸ¨ ===---"; // Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
input double          Inp_Object_Size_Multiplier = 1.0;                 // Ø¶Ø±ÛŒØ¨ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø§Ø´ÛŒØ§Ø¡ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
input color           Inp_Bullish_Color       = clrLimeGreen;           // Ø±Ù†Ú¯ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ø§Ø´ÛŒØ§Ø¡ Ø®Ø±ÛŒØ¯
input color           Inp_Bearish_Color       = clrRed;                 // Ø±Ù†Ú¯ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ø§Ø´ÛŒØ§Ø¡ ÙØ±ÙˆØ´

// ---=== ğŸš¦ 7. ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ (Entry Filters) ğŸš¦ ===---
input group           "   ---=== ğŸš¦ 7. ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ (Entry Filters) ğŸš¦ ===---"; // Ú¯Ø±ÙˆÙ‡ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯
input E_Filter_Timeframe_Context Inp_Filter_Context = FILTER_CONTEXT_HTF; // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§Ø¬Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§
input bool            Inp_Enable_Kumo_Filter = true;                    // âœ… [ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ]: ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„
input bool            Inp_Enable_ATR_Filter  = true;                    // âœ… [ÙÛŒÙ„ØªØ± ATR]: ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„
input int             Inp_ATR_Filter_Period  = 14;                      // [ÙÛŒÙ„ØªØ± ATR]: Ø¯ÙˆØ±Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ ATR
input double          Inp_ATR_Filter_Min_Value_pips = 9.0;              // [ÙÛŒÙ„ØªØ± ATR]: Ø­Ø¯Ø§Ù‚Ù„ Ù…Ù‚Ø¯Ø§Ø± ATR Ø¨Ù‡ Ù¾ÛŒÙ¾ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input bool            Inp_Enable_ADX_Filter = false;                    // ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ± Ù‚Ø¯Ø±Øª Ùˆ Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯ ADX
input int             Inp_ADX_Period = 14;                              // [ADX] Ø¯ÙˆØ±Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡
input double          Inp_ADX_Threshold = 25.0;                         // [ADX] Ø­Ø¯Ø§Ù‚Ù„ Ù‚Ø¯Ø±Øª Ø±ÙˆÙ†Ø¯ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯

input group           "         --- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ (MKM Filters) ---";
input bool            Inp_Enable_KijunSlope_Filter = false;     // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ± Ø´ÛŒØ¨ Ú©ÛŒØ¬ÙˆÙ†-Ø³Ù†
input bool            Inp_Enable_KumoExpansion_Filter = false;  // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ± Ø§Ù†Ø¨Ø³Ø§Ø· Ú©ÙˆÙ…Ùˆ
input bool            Inp_Enable_ChikouSpace_Filter = false;    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ú†ÛŒÚ©Ùˆ

// [NEW] Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ MKM
input group           "         --- Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ MKM ---";
input int             Inp_MKM_Kijun_Slope_Period = 5;                   // Ø¯ÙˆØ±Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÛŒØ¨ Ú©ÛŒØ¬ÙˆÙ† Ø¨Ø±Ø§ÛŒ MKM
input int            Inp_MKM_Kumo_Expansion_Period = 20;   // <<<< (Ø¯ÙˆØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ø¨Ø³Ø§Ø· Ú©ÙˆÙ…Ùˆ)

// ---=== ğŸ¯ 8. Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ (Exit Logic) ğŸ¯ ===---
input group "       ---=== ğŸ¯ 8. Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ (Exit Logic) ğŸ¯ ===---"; // Ú¯Ø±ÙˆÙ‡ Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬
input bool            Inp_Enable_Early_Exit = false;                    // ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ Ø¨Ø§ Ú©Ø±Ø§Ø³ Ú†ÛŒÚ©Ùˆ Ùˆ ØªØ§ÛŒÛŒØ¯ RSI
input int             Inp_Early_Exit_RSI_Period = 14;                   // [Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³] Ø¯ÙˆØ±Ù‡ RSI
input int             Inp_Early_Exit_RSI_Overbought = 70;               // [Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³] Ø³Ø·Ø­ Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² ÙØ±ÙˆØ´
input int             Inp_Early_Exit_RSI_Oversold = 30;                 // [Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³] Ø³Ø·Ø­ Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² Ø®Ø±ÛŒØ¯

// [NEW] Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø³Ø§Ø®ØªØ§Ø±ÛŒ
input group           "         --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø³Ø§Ø®ØªØ§Ø±ÛŒ ---";
input int             Inp_Structural_Grace_Candles = 3;                 // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…Ù‡Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ
input int             Inp_Structure_Lookback_Bars = 50;                 // ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø± Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† Ø³Ø§Ø®ØªØ§Ø±


//+------------------------------------------------------------------+
//|     Ø³Ø§Ø®ØªØ§Ø± Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ØªÙ…Ø§Ù… ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ (SSettings)       |
//+------------------------------------------------------------------+
struct SSettings
{
    // 1. General
    bool                enable_dashboard; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    string              symbols_list; // Ù„ÛŒØ³Øª Ù†Ù…Ø§Ø¯Ù‡Ø§
    int                 magic_number; // Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø§Ø¯ÙˆÛŒÛŒ
    bool                enable_logging; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§
    
    // 2. Ichimoku
    ENUM_TIMEFRAMES     ichimoku_timeframe;      // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ ØªØ­Ù„ÛŒÙ„
    int                 tenkan_period; // Ø¯ÙˆØ±Ù‡ ØªÙ†Ú©Ø§Ù†
    int                 kijun_period; // Ø¯ÙˆØ±Ù‡ Ú©ÛŒØ¬ÙˆÙ†
    int                 senkou_period; // Ø¯ÙˆØ±Ù‡ Ø³Ù†Ú©Ùˆ
    int                 chikou_period; // Ø¯ÙˆØ±Ù‡ Ú†ÛŒÚ©Ùˆ
    
    // 3. Signal & Confirmation
    E_Primary_Strategy_Mode primary_strategy; // Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø§ØµÙ„ÛŒ
    E_Signal_Mode       signal_mode; // Ø­Ø§Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„
    
    E_Entry_Confirmation_Mode entry_confirmation_mode; // Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ÙˆØ±ÙˆØ¯
    E_Entry_Tactic          entry_tactic; // <<<< âœ… Ø§ÛŒÙ† Ø®Ø· Ø¬Ø¯ÛŒØ¯Ù‡

    E_Grace_Period_Mode grace_period_mode;           // Ù†ÙˆØ¹ Ù…Ù‡Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„
    int                 grace_period_candles;        // [Ø­Ø§Ù„Øª Ú©Ù†Ø¯Ù„ÛŒ] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…Ù‡Ù„Øª
    E_Confirmation_Mode confirmation_type;           // [Ø­Ø§Ù„Øª ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… ÙØ¹Ù„ÛŒ] Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ Ú©Ù†Ø¯Ù„
    ENUM_TIMEFRAMES     ltf_timeframe;               // [Ø­Ø§Ù„Øª LTF] ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡
    
    // 3.1. Talaqi
    E_Talaqi_Mode       talaqi_calculation_mode; // Ø­Ø§Ù„Øª ØªÙ„Ø§Ù‚ÛŒ
    double              talaqi_distance_in_points; // ÙØ§ØµÙ„Ù‡ Ø¯Ø³ØªÛŒ
    double              talaqi_kumo_factor; // Ø¶Ø±ÛŒØ¨ Ú©ÙˆÙ…Ùˆ
    double              talaqi_atr_multiplier; // Ø¶Ø±ÛŒØ¨ ATR
    
    // 4. Stop Loss
    ENUM_TIMEFRAMES     sl_timeframe; // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ SL
    E_SL_Mode           stoploss_type; // Ù†ÙˆØ¹ SL
    double              sl_atr_multiplier; // Ø¶Ø±ÛŒØ¨ ATR Ø¨Ø±Ø§ÛŒ SL
    int                 sl_lookback_period; // Ø¯ÙˆØ±Ù‡ Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨
    double              sl_buffer_multiplier; // Ø¶Ø±ÛŒØ¨ Ø¨Ø§ÙØ±
    int                 flat_kijun_period; // Ø¯ÙˆØ±Ù‡ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
    int                 flat_kijun_min_length; // Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ ÙÙ„Øª
    int                 pivot_lookback; // Ø¯ÙˆØ±Ù‡ Ù¾ÛŒÙˆØª
    
    bool                enable_sl_vol_regime; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† SL Ù¾ÙˆÛŒØ§
    int                 sl_vol_regime_atr_period; // Ø¯ÙˆØ±Ù‡ ATR Ù¾ÙˆÛŒØ§
    int                 sl_vol_regime_ema_period; // Ø¯ÙˆØ±Ù‡ EMA Ù¾ÙˆÛŒØ§
    double              sl_high_vol_multiplier; // Ø¶Ø±ÛŒØ¨ Ø¨Ø§Ù„Ø§ Ù†ÙˆØ³Ø§Ù†
    double              sl_low_vol_multiplier; // Ø¶Ø±ÛŒØ¨ Ù¾Ø§ÛŒÛŒÙ† Ù†ÙˆØ³Ø§Ù†

    // [NEW] Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú© Ù¾ÙˆÛŒØ§ SL
    double              min_sl_distance_atr_percent; // Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ SL Ø¨Ø± Ø§Ø³Ø§Ø³ ATR
    double              sl_buffer_atr_percent; // Ø¨Ø§ÙØ± SL Ø¨Ø± Ø§Ø³Ø§Ø³ ATR

    // 5. Money Management
    double              risk_percent_per_trade; // Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú©
    double              take_profit_ratio; // Ù†Ø³Ø¨Øª TP
    int                 max_trades_per_symbol; // Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù†Ù…Ø§Ø¯
    int                 max_total_trades; // Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ú©Ù„
    
    // 6. Visuals
    double              object_size_multiplier; // Ø¶Ø±ÛŒØ¨ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø§Ø´ÛŒØ§Ø¡
    color               bullish_color; // Ø±Ù†Ú¯ Ø®Ø±ÛŒØ¯
    color               bearish_color; // Ø±Ù†Ú¯ ÙØ±ÙˆØ´
    
    // 7. Entry Filters
    E_Filter_Timeframe_Context filter_context; // Ø²Ù…ÛŒÙ†Ù‡ ÙÛŒÙ„ØªØ±Ù‡Ø§
    bool                enable_kumo_filter; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©ÙˆÙ…Ùˆ
    bool                enable_atr_filter; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ATR
    int                 atr_filter_period; // Ø¯ÙˆØ±Ù‡ ATR ÙÛŒÙ„ØªØ±
    double              atr_filter_min_value_pips; // Ø­Ø¯Ø§Ù‚Ù„ ATR

    bool                enable_adx_filter; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ADX
    int                 adx_period; // Ø¯ÙˆØ±Ù‡ ADX
    double              adx_threshold; // Ø¢Ø³ØªØ§Ù†Ù‡ ADX

    bool                enable_kijun_slope_filter;   // ÙÛŒÙ„ØªØ± Ø´ÛŒØ¨ Ú©ÛŒØ¬ÙˆÙ†
    bool                enable_kumo_expansion_filter;// ÙÛŒÙ„ØªØ± Ø§Ù†Ø¨Ø³Ø§Ø· Ú©ÙˆÙ…Ùˆ
    bool                enable_chikou_space_filter;  // ÙÛŒÙ„ØªØ± ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ú†ÛŒÚ©Ùˆ

    // 8. Exit Logic
    bool                enable_early_exit; // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³
    int                 early_exit_rsi_period; // Ø¯ÙˆØ±Ù‡ RSI Ø®Ø±ÙˆØ¬
    int                 early_exit_rsi_overbought; // Ø³Ø·Ø­ Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯
    int                 early_exit_rsi_oversold; // Ø³Ø·Ø­ Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´

    // [NEW] Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ MKM
    int                 mkm_kijun_slope_period; // Ø¯ÙˆØ±Ù‡ Ø´ÛŒØ¨ Ú©ÛŒØ¬ÙˆÙ† Ø¨Ø±Ø§ÛŒ MKM
    int                    mkm_kumo_expansion_period;
    // [NEW] ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø³Ø§Ø®ØªØ§Ø±ÛŒ
    int                 structural_grace_candles; // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…Ù‡Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ
    int                 structure_lookback_bars; // ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø± Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®ØªØ§Ø±
};



///ÙØ§ÛŒÙ„ 2 Ø§Ú©Ø³Ù¾Ø±Øª Ø§Ø¬Ø±Ø§ÛŒÛŒ:::

//+------------------------------------------------------------------+
//|                                                      Memento.mq5 |
//|                                  Copyright 2025,hipoalgoritm |
//|                                                  Final & Bulletproof |
//+------------------------------------------------------------------+
#property copyright "Copyright 2025,hipoalgoritm" // Ø­Ù‚ÙˆÙ‚ Ú©Ù¾ÛŒâ€ŒØ±Ø§ÛŒØª Ø§Ú©Ø³Ù¾Ø±Øª
#property link      "https://www.mql5.com" // Ù„ÛŒÙ†Ú© Ù…Ø±ØªØ¨Ø·
#property version   "3.1" // Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ú©Ø§Ù…Ù„Ø§ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
#property description "Ø§Ú©Ø³Ù¾Ø±Øª Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù…Ù…Ù†ØªÙˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ú©Ø±Ø§Ø³ Ø³Ù‡ Ú¯Ø§Ù†Ù‡ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ" // ØªÙˆØ¶ÛŒØ­ Ø§Ú©Ø³Ù¾Ø±Øª


#include <Trade\Trade.mqh> // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªØ±ÛŒØ¯
#include <Object.mqh> // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø§Ø´ÛŒØ§Ø¡
#include "IchimokuLogic.mqh" // Ù…Ù†Ø·Ù‚ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
#include "VisualManager.mqh" // Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±Ø§ÙÛŒÚ©
#include "TrailingStopManager.mqh" // Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾

#include  "licensed.mqh" // Ù„Ø§ÛŒØ³Ù†Ø³

//--- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
SSettings            g_settings; // Ø³Ø§Ø®ØªØ§Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª
string               g_symbols_array[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ù†Ù…Ø§Ø¯Ù‡Ø§
CStrategyManager* g_symbol_managers[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
bool              g_dashboard_needs_update = true; // Ù¾Ø±Ú†Ù… Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
CTrailingStopManager TrailingStop; // Ù…Ø¯ÛŒØ± ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾



int OnInit() {
    //--- âœ…âœ…âœ… Ø¨Ø®Ø´ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ùˆ Ù‡Ù…Ø§Ù‡Ù†Ú¯) âœ…âœ…âœ… ---

    // 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ
    g_settings.enable_dashboard           = Inp_Enable_Dashboard; // Ú©Ù¾ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    g_settings.symbols_list                 = Inp_Symbols_List; // Ú©Ù¾ÛŒ Ù„ÛŒØ³Øª Ù†Ù…Ø§Ø¯Ù‡Ø§
    g_settings.magic_number                 = Inp_Magic_Number; // Ú©Ù¾ÛŒ Ù…Ø¬ÛŒÚ© Ù†Ø§Ù…Ø¨Ø±
    g_settings.enable_logging               = Inp_Enable_Logging; // Ú©Ù¾ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯

    // 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
    g_settings.ichimoku_timeframe           = Inp_Ichimoku_Timeframe; // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    g_settings.tenkan_period                = Inp_Tenkan_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ ØªÙ†Ú©Ø§Ù†
    g_settings.kijun_period                 = Inp_Kijun_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ Ú©ÛŒØ¬ÙˆÙ†
    g_settings.senkou_period                = Inp_Senkou_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ Ø³Ù†Ú©Ùˆ
    g_settings.chikou_period                = Inp_Chikou_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ Ú†ÛŒÚ©Ùˆ

    // 3. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡
    g_settings.primary_strategy             = Inp_Primary_Strategy; // <<<< Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
    g_settings.signal_mode                  = Inp_Signal_Mode; // Ú©Ù¾ÛŒ Ø­Ø§Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„
    g_settings.entry_confirmation_mode      = Inp_Entry_Confirmation_Mode; // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
   
    g_settings.grace_period_mode            = Inp_Grace_Period_Mode; // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    g_settings.grace_period_candles         = Inp_Grace_Period_Candles; // Ú©Ù¾ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…Ù‡Ù„Øª
    g_settings.confirmation_type            = Inp_Confirmation_Type; // Ú©Ù¾ÛŒ Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯
    g_settings.ltf_timeframe                = Inp_LTF_Timeframe; // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    g_settings.talaqi_calculation_mode      = Inp_Talaqi_Calculation_Mode; // Ú©Ù¾ÛŒ Ø­Ø§Ù„Øª ØªÙ„Ø§Ù‚ÛŒ
    g_settings.talaqi_atr_multiplier        = Inp_Talaqi_ATR_Multiplier; // Ú©Ù¾ÛŒ Ø¶Ø±ÛŒØ¨ ATR ØªÙ„Ø§Ù‚ÛŒ
    g_settings.talaqi_distance_in_points    = Inp_Talaqi_Distance_in_Points; // Ú©Ù¾ÛŒ ÙØ§ØµÙ„Ù‡ Ø¯Ø³ØªÛŒ ØªÙ„Ø§Ù‚ÛŒ
    g_settings.talaqi_kumo_factor           = Inp_Talaqi_Kumo_Factor; // Ú©Ù¾ÛŒ Ø¶Ø±ÛŒØ¨ Ú©ÙˆÙ…Ùˆ ØªÙ„Ø§Ù‚ÛŒ
    g_settings.entry_tactic                 = Inp_Entry_Tactic; //
    // 4. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø¯ Ø¶Ø±Ø±
    g_settings.sl_timeframe                 = Inp_SL_Timeframe; // <<<< Ø§ÛŒÙ† Ø®Ø· Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
    g_settings.stoploss_type                = Inp_StopLoss_Type; // Ú©Ù¾ÛŒ Ù†ÙˆØ¹ SL
    g_settings.sl_atr_multiplier            = Inp_SL_ATR_Multiplier; // Ú©Ù¾ÛŒ Ø¶Ø±ÛŒØ¨ ATR SL
    g_settings.flat_kijun_period            = Inp_Flat_Kijun_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ ÙÙ„Øª Ú©ÛŒØ¬ÙˆÙ†
    g_settings.flat_kijun_min_length        = Inp_Flat_Kijun_Min_Length; // Ú©Ù¾ÛŒ Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ ÙÙ„Øª
    g_settings.pivot_lookback               = Inp_Pivot_Lookback; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ Ù¾ÛŒÙˆØª
    g_settings.sl_lookback_period           = Inp_SL_Lookback_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨
    g_settings.sl_buffer_multiplier         = Inp_SL_Buffer_Multiplier; // Ú©Ù¾ÛŒ Ø¶Ø±ÛŒØ¨ Ø¨Ø§ÙØ±
    
    // 4.1. <<< Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ SL Ù¾ÙˆÛŒØ§ >>>
    g_settings.enable_sl_vol_regime         = Inp_Enable_SL_Vol_Regime; // Ú©Ù¾ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† SL Ù¾ÙˆÛŒØ§
    g_settings.sl_vol_regime_atr_period     = Inp_SL_Vol_Regime_ATR_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ ATR Ù¾ÙˆÛŒØ§
    g_settings.sl_vol_regime_ema_period     = Inp_SL_Vol_Regime_EMA_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ EMA Ù¾ÙˆÛŒØ§
    g_settings.sl_high_vol_multiplier       = Inp_SL_High_Vol_Multiplier; // Ú©Ù¾ÛŒ Ø¶Ø±ÛŒØ¨ Ø¨Ø§Ù„Ø§ Ù†ÙˆØ³Ø§Ù†
    g_settings.sl_low_vol_multiplier        = Inp_SL_Low_Vol_Multiplier; // Ú©Ù¾ÛŒ Ø¶Ø±ÛŒØ¨ Ù¾Ø§ÛŒÛŒÙ† Ù†ÙˆØ³Ø§Ù†

    g_settings.min_sl_distance_atr_percent = Inp_Min_SL_Distance_Atr_Percent; // [NEW]
    g_settings.sl_buffer_atr_percent = Inp_SL_Buffer_Atr_Percent; // [NEW]

    // 5. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡
    g_settings.risk_percent_per_trade       = Inp_Risk_Percent_Per_Trade; // Ú©Ù¾ÛŒ Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú©
    g_settings.take_profit_ratio            = Inp_Take_Profit_Ratio; // Ú©Ù¾ÛŒ Ù†Ø³Ø¨Øª TP
    g_settings.max_trades_per_symbol        = Inp_Max_Trades_Per_Symbol; // Ú©Ù¾ÛŒ Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù†Ù…Ø§Ø¯
    g_settings.max_total_trades             = Inp_Max_Total_Trades; // Ú©Ù¾ÛŒ Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ú©Ù„

    // 6. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
    g_settings.object_size_multiplier       = Inp_Object_Size_Multiplier; // Ú©Ù¾ÛŒ Ø¶Ø±ÛŒØ¨ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø§Ø´ÛŒØ§Ø¡
    g_settings.bullish_color                = Inp_Bullish_Color; // Ú©Ù¾ÛŒ Ø±Ù†Ú¯ Ø®Ø±ÛŒØ¯
    g_settings.bearish_color                = Inp_Bearish_Color; // Ú©Ù¾ÛŒ Ø±Ù†Ú¯ ÙØ±ÙˆØ´
    
    // 7. <<< Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§ >>>
    g_settings.filter_context               = Inp_Filter_Context; // <<<< Ø§ÛŒÙ† Ø®Ø· Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
    g_settings.enable_kumo_filter           = Inp_Enable_Kumo_Filter; // Ú©Ù¾ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©ÙˆÙ…Ùˆ
    g_settings.enable_atr_filter            = Inp_Enable_ATR_Filter; // Ú©Ù¾ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ATR
    g_settings.atr_filter_period            = Inp_ATR_Filter_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ ATR ÙÛŒÙ„ØªØ±
    g_settings.atr_filter_min_value_pips    = Inp_ATR_Filter_Min_Value_pips; // Ú©Ù¾ÛŒ Ø­Ø¯Ø§Ù‚Ù„ ATR
    g_settings.enable_adx_filter            = Inp_Enable_ADX_Filter; // Ú©Ù¾ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ADX
    g_settings.adx_period                   = Inp_ADX_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ ADX
    g_settings.adx_threshold                = Inp_ADX_Threshold; // Ú©Ù¾ÛŒ Ø¢Ø³ØªØ§Ù†Ù‡ ADX

    g_settings.enable_kijun_slope_filter    = Inp_Enable_KijunSlope_Filter;    // <<<< Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
    g_settings.enable_kumo_expansion_filter = Inp_Enable_KumoExpansion_Filter; // <<<< Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
    g_settings.enable_chikou_space_filter   = Inp_Enable_ChikouSpace_Filter;   // <<<< Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯

    g_settings.mkm_kijun_slope_period = Inp_MKM_Kijun_Slope_Period; // [NEW]
    g_settings.mkm_kumo_expansion_period = Inp_MKM_Kumo_Expansion_Period;
    
    // 8. <<< Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ >>>
    g_settings.enable_early_exit            = Inp_Enable_Early_Exit; // Ú©Ù¾ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³
    g_settings.early_exit_rsi_period        = Inp_Early_Exit_RSI_Period; // Ú©Ù¾ÛŒ Ø¯ÙˆØ±Ù‡ RSI Ø®Ø±ÙˆØ¬
    g_settings.early_exit_rsi_overbought    = Inp_Early_Exit_RSI_Overbought; // Ú©Ù¾ÛŒ Ø³Ø·Ø­ Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯
    g_settings.early_exit_rsi_oversold      = Inp_Early_Exit_RSI_Oversold; // Ú©Ù¾ÛŒ Ø³Ø·Ø­ Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´

    g_settings.structural_grace_candles = Inp_Structural_Grace_Candles; // [NEW]
    g_settings.structure_lookback_bars = Inp_Structure_Lookback_Bars; // [NEW]


    //--- Ø¨Ù‚ÛŒÙ‡ ØªØ§Ø¨Ø¹ OnInit Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± ...
    int symbols_count = StringSplit(g_settings.symbols_list, ',', g_symbols_array); // Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ù†Ù…Ø§Ø¯Ù‡Ø§
    if (symbols_count == 0) { // Ú†Ú© Ø®Ø·Ø§ÛŒ Ù†Ù…Ø§Ø¯Ù‡Ø§
        Print("Ø®Ø·Ø§: Ù‡ÛŒÚ† Ù†Ù…Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        return INIT_FAILED;
    }

    ArrayResize(g_symbol_managers, symbols_count); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ø¯ÛŒØ±Ø§Ù†
    for (int i = 0; i < symbols_count; i++) { // Ø­Ù„Ù‚Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§Ø¯
        string sym = g_symbols_array[i];
        StringTrimLeft(sym);
        StringTrimRight(sym);
        g_symbol_managers[i] = new CStrategyManager(sym, g_settings); // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø¯ÛŒØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ
        if (!g_symbol_managers[i].Init()) { // Ú†Ú© Ø§ÙˆÙ„ÛŒÙ‡
            Print("Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù…Ø§Ø¯ ", sym, " Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ø¹Ù…Ù„ÛŒØ§Øª Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
            for (int j = 0; j <= i; j++) { // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
                if (g_symbol_managers[j] != NULL) { // [MODIFIED] Ú†Ú© NULL
                    delete g_symbol_managers[j];
                    g_symbol_managers[j] = NULL;
                }
            }
            ArrayFree(g_symbol_managers); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø¢Ø±Ø§ÛŒÙ‡
            return INIT_FAILED;
        }
    }

    Print("Ø§Ú©Ø³Ù¾Ø±Øª Memento Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø¯: ", g_settings.symbols_list); // Ù„Ø§Ú¯ Ù…ÙˆÙÙ‚ÛŒØª
    TrailingStop.Init(Inp_Magic_Number); // Ø§ÙˆÙ„ÛŒÙ‡ ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾

    EventSetTimer(1); // ØªÙ†Ø¸ÛŒÙ… ØªØ§ÛŒÙ…Ø±
    return(INIT_SUCCEEDED); // Ø¨Ø§Ø²Ú¯Ø´Øª Ù…ÙˆÙÙ‚ÛŒØª
}




//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù¾Ø§ÛŒØ§Ù† Ø§Ú©Ø³Ù¾Ø±Øª (Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ)                                      |
//+------------------------------------------------------------------+
void OnDeinit(const int reason) {
   EventKillTimer(); // Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† ØªØ§ÛŒÙ…Ø±
//--- Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´ÛŒØ¡Ù‡Ø§
   for (int i = 0; i < ArraySize(g_symbol_managers); i++) { // Ø­Ù„Ù‚Ù‡ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù…Ø¯ÛŒØ±Ø§Ù†
      if (g_symbol_managers[i] != NULL) {
         delete g_symbol_managers[i];
         g_symbol_managers[i] = NULL;
      }
   }
   ArrayFree(g_symbol_managers); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø¢Ø±Ø§ÛŒÙ‡


//--- Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø´ÛŒØ§Ø¡ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ø¨Ø§ Ù¾ÛŒØ´ÙˆÙ†Ø¯ ØµØ­ÛŒØ­
   ObjectsDeleteAll(0, "MEMENTO_UI_"); // Ø­Ø°Ù Ø§Ø´ÛŒØ§Ø¡
   ChartRedraw(); // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú†Ø§Ø±Øª

}
void OnTick(void)
      {
       if(CheckLicenseExpiry()==false) // Ú†Ú© Ù„Ø§ÛŒØ³Ù†Ø³
{
ExpertRemove();
//return(INIT_FAILED);
}
      }
//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ ØªØ§ÛŒÙ…Ø± (Ù…Ø±Ú©Ø² ÙØ±Ù…Ø§Ù†Ø¯Ù‡ÛŒ Ø¬Ø¯ÛŒØ¯)                                  |
//+------------------------------------------------------------------+
void OnTimer() 
{
   // 1. Ø§Ø¬Ø±Ø§ÛŒ ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾ (Ù…Ø«Ù„ Ù‚Ø¨Ù„)
   TrailingStop.Process(); // Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾

   // 2. Ø§Ø¬Ø±Ø§ÛŒ Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§Ø¯ Ø§Ø² Ø·Ø±ÛŒÙ‚ ÛŒÚ© ØªØ§Ø¨Ø¹ ÙˆØ§Ø­Ø¯
   for (int i = 0; i < ArraySize(g_symbol_managers); i++)  // Ø­Ù„Ù‚Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù…Ø¯ÛŒØ±
   {
      if (g_symbol_managers[i] != NULL) 
      {
         g_symbol_managers[i].OnTimerTick(); // <<<< Ù†Ø§Ù… ØªØ§Ø¨Ø¹ Ø§Ø² ProcessNewBar Ø¨Ù‡ OnTimerTick ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
      }
   }

   // 3. Ø¢Ù¾Ø¯ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (Ù…Ø«Ù„ Ù‚Ø¨Ù„)
   if (g_dashboard_needs_update)  // Ú†Ú© Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¢Ù¾Ø¯ÛŒØª
   {
      // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ù…ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ø§Ø² Ù…Ù†ÛŒØ¬Ø± Ú©Ù‡ Ù…Ø³Ø¦ÙˆÙ„ Ú†Ø§Ø±Øª Ø§ØµÙ„ÛŒ Ø§Ø³Øª
      for (int i = 0; i < ArraySize(g_symbol_managers); i++)  // Ø­Ù„Ù‚Ù‡ Ø¬Ø³ØªØ¬Ùˆ
      {
         if (g_symbol_managers[i] != NULL && g_symbol_managers[i].GetSymbol() == _Symbol)  // Ú†Ú© Ù†Ù…Ø§Ø¯
         {
            g_symbol_managers[i].UpdateMyDashboard(); // Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
            Print("Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯."); // Ù„Ø§Ú¯ Ø¢Ù¾Ø¯ÛŒØª
            break; // Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù¾Ø¯ÛŒØª Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
         }
      }
      g_dashboard_needs_update = false; // Ù¾Ø±Ú†Ù… Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¹Ø¯ÛŒ Ø±ÛŒØ³Øª Ú©Ù†
   }
}





//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ                                           |
//+------------------------------------------------------------------+
//
void OnTradeTransaction(const MqlTradeTransaction &trans,
                        const MqlTradeRequest &request,
                        const MqlTradeResult &result) {
// Ù…Ø§ ÙÙ‚Ø· Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ ÛŒÚ© Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ Ø¯Ø§Ø±ÛŒÙ…
   if (trans.type == TRADE_TRANSACTION_DEAL_ADD && trans.deal > 0) { // Ú†Ú© Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´
      // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø±Ø§ Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
      ulong deal_ticket = trans.deal; // ØªÛŒÚ©Øª Ù…Ø¹Ø§Ù…Ù„Ù‡
      if(HistoryDealSelect(deal_ticket)) { // Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¹Ø§Ù…Ù„Ù‡
         // Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ø§Ú©Ø³Ù¾Ø±Øª Ø¨Ø§Ø´Ù‡
         if(HistoryDealGetInteger(deal_ticket, DEAL_MAGIC) == (long)g_settings.magic_number) { // Ú†Ú© Ù…Ø¬ÛŒÚ©
            // Ø§Ú¯Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø§Ø² Ù†ÙˆØ¹ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù¾ÙˆØ²ÛŒØ´Ù† Ø¨ÙˆØ¯ (Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù†)
            if(HistoryDealGetInteger(deal_ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT) { // Ú†Ú© ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬
               string deal_symbol = HistoryDealGetString(deal_ticket, DEAL_SYMBOL); // Ù†Ù…Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ù‡

               // Ù…Ø¯ÛŒØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ù†Ù…Ø§Ø¯ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
               for(int i = 0; i < ArraySize(g_symbol_managers); i++) { // Ø­Ù„Ù‚Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†
                  if(g_symbol_managers[i] != NULL && g_symbol_managers[i].GetSymbol() == deal_symbol) { // Ú†Ú© Ù†Ù…Ø§Ø¯
                     // Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ© Ø¢Ù† Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ùˆ Ø¯Ø± Ù…ØªØºÛŒØ± Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… [MODIFIED]
                     CVisualManager *visual_manager = g_symbol_managers[i].GetVisualManager(); // Ú¯Ø±ÙØªÙ† Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ©
                     if(visual_manager != NULL) { // Ú†Ú© ÙˆØ¬ÙˆØ¯
                        // Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†Ù…Ø§Ø¯ Ø±Ø§ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                        int symbol_index = visual_manager.GetSymbolIndex(deal_symbol); // Ú¯Ø±ÙØªÙ† Ø§ÛŒÙ†Ø¯Ú©Ø³
                        if(symbol_index != -1) { // Ú†Ú© Ø§ÛŒÙ†Ø¯Ú©Ø³
                           // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù† Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
                           double p = HistoryDealGetDouble(deal_ticket, DEAL_PROFIT); // Ø³ÙˆØ¯
                           double c = HistoryDealGetDouble(deal_ticket, DEAL_COMMISSION); // Ú©Ù…ÛŒØ³ÛŒÙˆÙ†
                           double s = HistoryDealGetDouble(deal_ticket, DEAL_SWAP); // Ø³ÙˆØ§Ù¾

                           // Ùˆ Ø¯ÙØªØ±Ú†Ù‡ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                           visual_manager.UpdateDashboardCache(symbol_index, p, c, s); // Ø¢Ù¾Ø¯ÛŒØª Ú©Ø´
                        }
                     }
                     break; // Ù…Ø¯ÛŒØ± Ù¾ÛŒØ¯Ø§ Ø´Ø¯ØŒ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
                  }
               }
            }

            // Ø¯Ø± Ù‡Ø± ØµÙˆØ±Øª (Ú†Ù‡ Ø¨Ø§Ø² Ø´Ø¯Ù† Ùˆ Ú†Ù‡ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù†) Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø§Ø±Ø¯
            g_dashboard_needs_update = true; // ØªÙ†Ø¸ÛŒÙ… Ù¾Ø±Ú†Ù… Ø¢Ù¾Ø¯ÛŒØª
         }
      }
   }
}



//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú†Ø§Ø±Øª (Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡)                   |
//+------------------------------------------------------------------+
void OnChartEvent(const int id,
                  const long &lparam,
                  const double &dparam,
                  const string &sparam) {
// Ø§Ú¯Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø² Ù†ÙˆØ¹ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª Ø¨ÙˆØ¯
   if(id == CHARTEVENT_OBJECT_CLICK) { // Ú†Ú© Ù†ÙˆØ¹ Ø±ÙˆÛŒØ¯Ø§Ø¯
      // Ù…Ø¯ÛŒØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú†Ø§Ø±Øª ÙØ¹Ù„ÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†
      for(int i = 0; i < ArraySize(g_symbol_managers); i++) { // Ø­Ù„Ù‚Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù†
         if(g_symbol_managers[i] != NULL && g_symbol_managers[i].GetSymbol() == _Symbol) { // Ú†Ú© Ù†Ù…Ø§Ø¯
            // Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ© Ø±Ø§ Ø¯Ø± Ù…ØªØºÛŒØ± Ù…Ø­Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù† [MODIFIED]
            CVisualManager *visual_manager = g_symbol_managers[i].GetVisualManager(); // Ú¯Ø±ÙØªÙ† Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ©
            if (visual_manager != NULL) // Ú†Ú© ÙˆØ¬ÙˆØ¯
            {
                visual_manager.OnChartEvent(id, lparam, dparam, sparam); // Ø§Ø±Ø³Ø§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯
            }
            break; // Ú©Ø§Ø± ØªÙ…Ø§Ù… Ø§Ø³ØªØŒ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
         }
      }
   }
}
//+------------------------------------------------------------------+



//--- Ú¯Ø±ÙˆÙ‡: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ ---
input group "  ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ"; // Ú¯Ø±ÙˆÙ‡ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ
input int InpMinTradesPerYear = 30; // Ø­Ø¯Ø§Ù‚Ù„ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ø¯Ø± ÛŒÚ© Ø³Ø§Ù„
input int InpMaxAcceptableDrawdown = 15; // Ø­Ø¯Ø§Ú©Ø«Ø± Ø¯Ø±Ø§ÙˆØ¯Ø§ÙˆÙ† Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„


//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØ³ØªØ± Ú©Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.          |
//+------------------------------------------------------------------+
double OnTester()
{
   // --- 1. Ú¯Ø±ÙØªÙ† ØªÙ…Ø§Ù… Ø¢Ù…Ø§Ø±Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² ---
   double total_trades         = TesterStatistics(STAT_TRADES); // ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
   double net_profit           = TesterStatistics(STAT_PROFIT); // Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ
   double profit_factor        = TesterStatistics(STAT_PROFIT_FACTOR); // ÙØ§Ú©ØªÙˆØ± Ø³ÙˆØ¯
   double sharpe_ratio         = TesterStatistics(STAT_SHARPE_RATIO); // Ø´Ø§Ø±Ù¾ Ø±ÛŒØªÙˆ
   double max_balance_drawdown_percent = TesterStatistics(STAT_BALANCE_DDREL_PERCENT); // Ø­Ø¯Ø§Ú©Ø«Ø± Ø¯Ø±Ø§ÙˆØ¯Ø§ÙˆÙ†

   // --- 2. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯Ø§Ù‚Ù„ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
   datetime startDate = 0, endDate = 0; // ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù†
   if(HistoryDealsTotal() > 0) // Ú†Ú© Ù…Ø¹Ø§Ù…Ù„Ø§Øª
     {
      startDate = (datetime)HistoryDealGetInteger(0, DEAL_TIME); // ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹
      endDate   = (datetime)HistoryDealGetInteger(HistoryDealsTotal() - 1, DEAL_TIME); // ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†
     }
   double duration_days = (endDate > startDate) ? double(endDate - startDate) / (24.0 * 3600.0) : 1.0; // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ²Ù‡Ø§
   double required_min_trades = floor((duration_days / 365.0) * InpMinTradesPerYear); // Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
   if(required_min_trades < 10) required_min_trades = 10; // Ø­Ø¯Ø§Ù‚Ù„ 10

   // --- 3. ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
   if(total_trades < required_min_trades || profit_factor < 1.1 || sharpe_ratio <= 0 || net_profit <= 0) // Ú†Ú© ÙÛŒÙ„ØªØ±Ù‡Ø§
     {
      return 0.0; // Ø¨Ø§Ø²Ú¯Ø´Øª ØµÙØ±
     }

   // --- 4. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
   double r_squared = 0, downside_consistency = 0; // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
   CalculateAdvancedMetrics(r_squared, downside_consistency); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡

   // --- 5. *** Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø§Ù…ØªÛŒØ§Ø²: Ù…Ø­Ø§Ø³Ø¨Ù‡ "Ø¶Ø±ÛŒØ¨ Ù…Ø¬Ø§Ø²Ø§Øª" Ø¨Ø§ Ù…Ù†Ø­Ù†ÛŒ Ú©Ø³ÛŒÙ†ÙˆØ³ÛŒ *** ---
   double drawdown_penalty_factor = 0.0; // Ø¶Ø±ÛŒØ¨ Ù…Ø¬Ø§Ø²Ø§Øª
   if (max_balance_drawdown_percent < InpMaxAcceptableDrawdown && InpMaxAcceptableDrawdown > 0)  // Ú†Ú© Ø¯Ø±Ø§ÙˆØ¯Ø§ÙˆÙ†
   {
      // Ø¯Ø±Ø§ÙˆØ¯Ø§Ù† Ø±Ùˆ Ø¨Ù‡ ÛŒÚ© Ø²Ø§ÙˆÛŒÙ‡ Ø¨ÛŒÙ† 0 ØªØ§ 90 Ø¯Ø±Ø¬Ù‡ (Ï€/2 Ø±Ø§Ø¯ÛŒØ§Ù†) ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
      double angle = (max_balance_drawdown_percent / InpMaxAcceptableDrawdown) * (M_PI / 2.0); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ø§ÙˆÛŒÙ‡
      
      // Ø¶Ø±ÛŒØ¨ Ù…Ø¬Ø§Ø²Ø§ØªØŒ Ú©Ø³ÛŒÙ†ÙˆØ³ Ø§ÙˆÙ† Ø²Ø§ÙˆÛŒÙ‡ Ø§Ø³Øª. Ù‡Ø±Ú†ÛŒ Ø²Ø§ÙˆÛŒÙ‡ (Ø¯Ø±Ø§ÙˆØ¯Ø§Ù†) Ø¨ÛŒØ´ØªØ±ØŒ Ú©Ø³ÛŒÙ†ÙˆØ³ (Ø§Ù…ØªÛŒØ§Ø²) Ú©Ù…ØªØ±
      drawdown_penalty_factor = cos(angle); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ø³ÛŒÙ†ÙˆØ³
   }
   // Ø§Ú¯Ø± Ø¯Ø±Ø§ÙˆØ¯Ø§Ù† Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø¨Ø§Ø´Ù‡ØŒ Ø¶Ø±ÛŒØ¨ ØµÙØ± Ù…ÛŒâ€ŒÙ…ÙˆÙ†Ù‡ Ùˆ Ú©Ù„ Ù¾Ø§Ø³ Ø±Ø¯ Ù…ÛŒØ´Ù‡

   // --- 6. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø¬Ø§Ù…Ø¹ Ø¨Ø§ ÙØ±Ù…ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ Ùˆ Ù¾ÛŒÙˆØ³ØªÙ‡ ---
   double final_score = 0.0; // Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ
   if(drawdown_penalty_factor > 0) // Ú†Ú© Ù…Ø¬Ø§Ø²Ø§Øª
   {
      // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² log Ø¨Ø±Ø§ÛŒ Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ§Ø«ÛŒØ± Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø²Ø±Ú¯
      double trades_factor = log(total_trades + 1); // +1 Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² log(0)
      double net_profit_factor = log(net_profit + 1); // ÙØ§Ú©ØªÙˆØ± Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ

      final_score = (profit_factor * sharpe_ratio * r_squared * downside_consistency * trades_factor * net_profit_factor) 
                     * drawdown_penalty_factor; // Ø¶Ø±Ø¨ Ø¯Ø± Ø¶Ø±ÛŒØ¨ Ù…Ø¬Ø§Ø²Ø§Øª Ø¬Ø¯ÛŒØ¯ Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯
   }

   // --- 7. Ú†Ø§Ù¾ Ù†ØªÛŒØ¬Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ ---
   PrintFormat("Ù†ØªÛŒØ¬Ù‡: Trades=%d, PF=%.2f, Sharpe=%.2f, RÂ²=%.3f, BalDD=%.2f%%, Penalty=%.2f -> Ø§Ù…ØªÛŒØ§Ø²: %.4f",
               (int)total_trades, profit_factor, sharpe_ratio, r_squared, max_balance_drawdown_percent, drawdown_penalty_factor, final_score); // Ù„Ø§Ú¯ Ù†ØªÛŒØ¬Ù‡

   return final_score; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ù…ØªÛŒØ§Ø²
}

// ØªØ§Ø¨Ø¹ CalculateAdvancedMetrics Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
void CalculateAdvancedMetrics(double &r_squared, double &downside_consistency)
{
   r_squared = 0; // Ø§ÙˆÙ„ÛŒÙ‡ r_squared
   downside_consistency = 1.0; // Ø§ÙˆÙ„ÛŒÙ‡ Ø«Ø¨Ø§Øª

   if(!HistorySelect(0, TimeCurrent())) return; // Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®Ú†Ù‡
   uint total_deals = HistoryDealsTotal(); // ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
   if(total_deals < 5) return; // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª

   EquityPoint equity_curve[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ù†Ø­Ù†ÛŒ Ø§Ú©ÙˆÛŒØªÛŒ
   ArrayResize(equity_curve, (int)total_deals + 2); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡

   double final_balance = AccountInfoDouble(ACCOUNT_BALANCE); // Ø¨Ø§Ù„Ø§Ù†Ø³ Ù†Ù‡Ø§ÛŒÛŒ
   double net_profit = TesterStatistics(STAT_PROFIT); // Ø³ÙˆØ¯ Ø®Ø§Ù„Øµ
   double initial_balance = final_balance - net_profit; // Ø¨Ø§Ù„Ø§Ù†Ø³ Ø§ÙˆÙ„ÛŒÙ‡
   
   double current_balance = initial_balance; // Ø¨Ø§Ù„Ø§Ù†Ø³ ÙØ¹Ù„ÛŒ
   equity_curve[0].time      = (datetime)HistoryDealGetInteger(0, DEAL_TIME) - 1; // Ø²Ù…Ø§Ù† Ø§ÙˆÙ„ÛŒÙ‡
   equity_curve[0].balance   = current_balance; // Ø¨Ø§Ù„Ø§Ù†Ø³ Ø§ÙˆÙ„ÛŒÙ‡

   int equity_points = 1; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù†Ù‚Ø§Ø·
   for(uint i = 0; i < total_deals; i++) // Ø­Ù„Ù‚Ù‡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
     {
      ulong ticket = HistoryDealGetTicket(i); // ØªÛŒÚ©Øª
      if(ticket > 0) // Ú†Ú© ØªÛŒÚ©Øª
        {
         if(HistoryDealGetInteger(ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT) // Ú†Ú© Ø®Ø±ÙˆØ¬
           {
            current_balance += HistoryDealGetDouble(ticket, DEAL_PROFIT) + HistoryDealGetDouble(ticket, DEAL_COMMISSION) + HistoryDealGetDouble(ticket, DEAL_SWAP); // Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø§Ù„Ø§Ù†Ø³
            equity_curve[equity_points].time = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME); // Ø²Ù…Ø§Ù† Ù†Ù‚Ø·Ù‡
            equity_curve[equity_points].balance = current_balance; // Ø¨Ø§Ù„Ø§Ù†Ø³ Ù†Ù‚Ø·Ù‡
            equity_points++; // Ø§ÙØ²Ø§ÛŒØ´
           }
        }
     }
   ArrayResize(equity_curve, equity_points); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
   if(equity_points < 3) return; // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„ Ù†Ù‚Ø§Ø·
   
   double sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0, sum_y2 = 0; // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§ØªÛŒ
   for(int i = 0; i < equity_points; i++) // Ø­Ù„Ù‚Ù‡ Ù†Ù‚Ø§Ø·
     {
      double x = i + 1.0; double y = equity_curve[i].balance; // x Ùˆ y
      sum_x += x; sum_y += y; sum_xy += x * y; sum_x2 += x*x; sum_y2 += y*y; // Ø¬Ù…Ø¹â€ŒÙ‡Ø§
     }
   double n = equity_points; // ØªØ¹Ø¯Ø§Ø¯ Ù†Ù‚Ø§Ø·
   double den_part1 = (n*sum_x2) - (sum_x*sum_x); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù†ÙˆÙ…ÛŒÙ†Ø§ØªÙˆØ± 1
   double den_part2 = (n*sum_y2) - (sum_y*sum_y); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù†ÙˆÙ…ÛŒÙ†Ø§ØªÙˆØ± 2
   if(den_part1 > 0 && den_part2 > 0) // Ú†Ú© Ù…Ø«Ø¨Øª Ø¨ÙˆØ¯Ù†
     {
      double r = ((n*sum_xy) - (sum_x*sum_y)) / sqrt(den_part1 * den_part2); // Ù…Ø­Ø§Ø³Ø¨Ù‡ r
      r_squared = r*r; // Ù…Ø­Ø§Ø³Ø¨Ù‡ r_squared
     }

   MonthlyTrades monthly_counts[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ø§Ù‡Ø§Ù†Ù‡
   int total_months = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù…Ø§Ù‡â€ŒÙ‡Ø§
   
   for(uint i=0; i<total_deals; i++) // Ø­Ù„Ù‚Ù‡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
     {
      ulong ticket = HistoryDealGetTicket(i); // ØªÛŒÚ©Øª
      if(ticket > 0 && HistoryDealGetInteger(ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT) // Ú†Ú© Ø®Ø±ÙˆØ¬
        {
         datetime deal_time = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME); // Ø²Ù…Ø§Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡
         MqlDateTime dt; // Ø³Ø§Ø®ØªØ§Ø± Ø²Ù…Ø§Ù†
         TimeToStruct(deal_time, dt); // ØªØ¨Ø¯ÛŒÙ„ Ø²Ù…Ø§Ù†
         
         int month_idx = -1; // Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù…Ø§Ù‡
         for(int j=0; j<total_months; j++) { // Ø¬Ø³ØªØ¬Ùˆ Ù…Ø§Ù‡
            if(monthly_counts[j].year == dt.year && monthly_counts[j].month == dt.mon) { // Ú†Ú© Ù…Ø§Ù‡ Ùˆ Ø³Ø§Ù„
               month_idx = j;
               break;
            }
         }
         
         if(month_idx == -1) { // Ø§Ú¯Ø± Ø¬Ø¯ÛŒØ¯
            ArrayResize(monthly_counts, total_months + 1); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡
            monthly_counts[total_months].year = dt.year; // Ø³Ø§Ù„
            monthly_counts[total_months].month = dt.mon; // Ù…Ø§Ù‡
            monthly_counts[total_months].count = 1; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
            total_months++; // Ø§ÙØ²Ø§ÛŒØ´
         } else { // Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
            monthly_counts[month_idx].count++;
         }
        }
     }

   if(total_months <= 1) { // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø§Ù‡â€ŒÙ‡Ø§
      downside_consistency = 1.0; // Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
      return;
   }

   double target_trades_per_month = InpMinTradesPerYear / 12.0; // Ù‡Ø¯Ù Ù…Ø§Ù‡Ø§Ù†Ù‡
   if (target_trades_per_month < 1) target_trades_per_month = 1; // Ø­Ø¯Ø§Ù‚Ù„ 1


   double sum_of_squared_downside_dev = 0; // Ø¬Ù…Ø¹ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù†Ø­Ø±Ø§Ù
   for(int i = 0; i < total_months; i++) { // Ø­Ù„Ù‚Ù‡ Ù…Ø§Ù‡â€ŒÙ‡Ø§
      if(monthly_counts[i].count < target_trades_per_month) { // Ú†Ú© Ú©Ù…ØªØ± Ø§Ø² Ù‡Ø¯Ù
         double deviation = target_trades_per_month - monthly_counts[i].count; // Ø§Ù†Ø­Ø±Ø§Ù
         sum_of_squared_downside_dev += deviation * deviation; // Ø¬Ù…Ø¹ Ù…Ø±Ø¨Ø¹Ø§Øª
      }
   }

   double downside_variance = sum_of_squared_downside_dev / total_months; // ÙˆØ§Ø±ÛŒØ§Ù†Ø³
   double downside_deviation = sqrt(downside_variance); // Ø§Ù†Ø­Ø±Ø§Ù Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯

   downside_consistency = 1.0 / (1.0 + downside_deviation); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø«Ø¨Ø§Øª
}



//+------------------------------------------------------------------+
//|     Ø¨Ø®Ø´ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ (Custom Optimization) Ù†Ø³Ø®Ù‡ 10.0 - Ù†Ù‡Ø§ÛŒÛŒ   |
//|      Ø¨Ø§ "Ù…Ù†Ø­Ù†ÛŒ Ù…Ø¬Ø§Ø²Ø§Øª Ø¯Ø±Ø§ÙˆØ¯Ø§ÙˆÙ† Ù¾ÛŒÙˆØ³ØªÙ‡" (Continuous Penalty Curve)     |
//+------------------------------------------------------------------+

//--- Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
struct EquityPoint
{
   datetime time; // Ø²Ù…Ø§Ù† Ù†Ù‚Ø·Ù‡
   double   balance; // Ø¨Ø§Ù„Ø§Ù†Ø³ Ù†Ù‚Ø·Ù‡
};
struct MonthlyTrades
{
   int      year; // Ø³Ø§Ù„
   int      month; // Ù…Ø§Ù‡
   int      count; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
};



// ÙØ§ÛŒÙ„ 3 Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡  Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ Ù‡Ø³ØªÙ‡ Ø§ØµÙ„ÛŒ:::


//+------------------------------------------------------------------+
//|                                     IchimokuLogic.mqh            |
//|                          Â© 2025, hipoalgoritm                   |
//+------------------------------------------------------------------+
#property copyright "Â© 2025,hipoalgoritm" // Ø­Ù‚ÙˆÙ‚ Ú©Ù¾ÛŒâ€ŒØ±Ø§ÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡
#property link      "https://www.mql5.com" // Ù„ÛŒÙ†Ú© Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ù¾Ø±ÙˆÚ˜Ù‡
#property version   "3.1"  // Ù†Ø³Ø®Ù‡ Ø¨Ø§ Ù…Ø¹Ù…Ø§Ø±ÛŒ "Hunter" Ùˆ Ø§Ø±ØªÙ‚Ø§Ø¡Ù‡Ø§
#include "set.mqh" // ÙØ§ÛŒÙ„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
#include <Trade\Trade.mqh> // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ù…Ù„Ø§Øª
#include <Trade\SymbolInfo.mqh> // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§Ø¯
#include <Object.mqh> // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø´ÛŒØ§Ø¡ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
#include "VisualManager.mqh" // ÙØ§ÛŒÙ„ Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±Ø§ÙÛŒÚ© Ùˆ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
#include <MovingAverages.mqh> // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ù…ØªØ­Ø±Ú©
#include "MarketStructure.mqh" // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ø²Ø§Ø±

//+------------------------------------------------------------------+
//| Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ù‚ÙˆÙ‡ (Potential Signals)     |
//+------------------------------------------------------------------+
struct SPotentialSignal
{
    datetime        time; // Ø²Ù…Ø§Ù† ÙˆÙ‚ÙˆØ¹ Ø³ÛŒÚ¯Ù†Ø§Ù„
    bool            is_buy; // Ù†ÙˆØ¹ Ø³ÛŒÚ¯Ù†Ø§Ù„: true Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ØŒ false Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´
    int             grace_candle_count; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù„Øª Ø¨Ø±Ø§ÛŒ Ø§Ù†Ù‚Ø¶Ø§
    double          invalidation_level; // Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ (Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ)
    
    // Ø³Ø§Ø²Ù†Ø¯Ù‡ Ú©Ù¾ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª Ú©Ù¾ÛŒ Ø³Ø§Ø®ØªØ§Ø±
    SPotentialSignal(const SPotentialSignal &other) // Ú©Ù¾ÛŒ Ø³Ø§Ø²Ù†Ø¯Ù‡
    {
        time = other.time; // Ú©Ù¾ÛŒ Ø²Ù…Ø§Ù†
        is_buy = other.is_buy; // Ú©Ù¾ÛŒ Ù†ÙˆØ¹ Ø³ÛŒÚ¯Ù†Ø§Ù„
        grace_candle_count = other.grace_candle_count; // Ú©Ù¾ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
        invalidation_level = other.invalidation_level; // Ú©Ù¾ÛŒ Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„
    }
    // Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    SPotentialSignal() // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    {
       invalidation_level = 0.0; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„
    }
};

//+------------------------------------------------------------------+
//| Ú©Ù„Ø§Ø³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§Ø¯ Ø®Ø§Øµ                          |
//+------------------------------------------------------------------+
class CStrategyManager
{
private:
    string              m_symbol; // Ù†Ù…Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ ÙØ¹Ù„ÛŒ
    SSettings           m_settings; // Ø³Ø§Ø®ØªØ§Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
    CTrade              m_trade; // Ø´ÛŒØ¡ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ù…Ù„Ø§Øª
   
    datetime            m_last_bar_time_htf; // Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ú©Ù†Ø¯Ù„ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ (HTF)
    datetime            m_last_bar_time_ltf; // Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ú©Ù†Ø¯Ù„ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† (LTF)
    
    // --- Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ (Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª) ---
    int                 m_ichimoku_handle; // Ù‡Ù†Ø¯Ù„ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
    int                 m_atr_handle;      // Ù‡Ù†Ø¯Ù„ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± ATR
    int                 m_adx_handle;       // Ù‡Ù†Ø¯Ù„ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± ADX Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø±ÙˆÙ†Ø¯
    int                 m_rsi_exit_handle;  // Ù‡Ù†Ø¯Ù„ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± RSI Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³

    // --- Ø¨Ø§ÙØ±Ù‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ ---
    double              m_tenkan_buffer[]; // Ø¨Ø§ÙØ± ØªÙ†Ú©Ø§Ù†-Ø³Ù†
    double              m_kijun_buffer[]; // Ø¨Ø§ÙØ± Ú©ÛŒØ¬ÙˆÙ†-Ø³Ù†
    double              m_chikou_buffer[]; // Ø¨Ø§ÙØ± Ú†ÛŒÚ©Ùˆ Ø§Ø³Ù¾Ù†
    double              m_high_buffer[]; // Ø¨Ø§ÙØ± Ø³Ù‚Ù Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
    double              m_low_buffer[];  // Ø¨Ø§ÙØ± Ú©Ù Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
    
    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ ---
    SPotentialSignal    m_signal; // Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ØµÙ„ÛŒ ÙØ¹Ø§Ù„
    bool                m_is_waiting; // Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„
    bool                m_waiting_for_shift; // [NEW] Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø³Ø§Ø®ØªØ§Ø±
    bool                m_waiting_for_pullback; // [NEW] Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù¾ÙˆÙ„Ø¨Ú©
    SPotentialSignal    m_potential_signals[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ù‚ÙˆÙ‡ Ø¯Ø± Ø­Ø§Ù„Øª Ù…Ø³Ø§Ø¨Ù‚Ù‡
    CVisualManager* m_visual_manager; // Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ© Ùˆ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    CMarketStructureShift m_ltf_analyzer; // ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ø²Ø§Ø± Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† (LTF)
    CMarketStructureShift m_grace_structure_analyzer; // ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø±Ø§ÛŒ Ù…Ù‡Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ

    //--- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¯Ø§Ø®Ù„ÛŒ ---
    void Log(string message); // ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    
    // --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ ---
    void AddOrUpdatePotentialSignal(bool is_buy); // Ø§Ø¶Ø§ÙÙ‡ ÛŒØ§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ø§Ù„Ù‚ÙˆÙ‡
    bool CheckTripleCross(bool& is_buy); // Ú†Ú© Ú©Ø±Ø¯Ù† Ú©Ø±Ø§Ø³ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡ (ØªÙ†Ú©Ø§Ù†ØŒ Ú©ÛŒØ¬ÙˆÙ†ØŒ Ú†ÛŒÚ©Ùˆ) - Ø¨Ù‡Ø¨ÙˆØ¯: ØªÙ„Ø±Ø§Ù†Ø³ Ø¨Ø±Ø§ÛŒ Chikou Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    bool CheckFinalConfirmation(bool is_buy); // Ú†Ú© ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ ÙˆØ±ÙˆØ¯
    bool CheckLowerTfConfirmation(bool is_buy); // Ú†Ú© ØªØ§ÛŒÛŒØ¯ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† (LTF)
    // --- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ ---
    bool AreAllFiltersPassed(bool is_buy); // Ú†Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯
    bool CheckKumoFilter(bool is_buy, ENUM_TIMEFRAMES timeframe); // ÙÛŒÙ„ØªØ± Ù…ÙˆÙ‚Ø¹ÛŒØª Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø§Ø¨Ø± Ú©ÙˆÙ…Ùˆ Ø¨Ø§ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    bool CheckAtrFilter(ENUM_TIMEFRAMES timeframe); // ÙÛŒÙ„ØªØ± Ø­Ø¯Ø§Ù‚Ù„ Ù†ÙˆØ³Ø§Ù† ATR Ø¨Ø§ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    bool CheckAdxFilter(bool is_buy, ENUM_TIMEFRAMES timeframe); // ÙÛŒÙ„ØªØ± Ù‚Ø¯Ø±Øª Ùˆ Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯ ADX Ø¨Ø§ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…

    // --- Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ ---
    void CheckForEarlyExit();         // Ú†Ú© Ú©Ø±Ø¯Ù† Ø´Ø±Ø§ÛŒØ· Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ Ø§Ø² Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    bool CheckChikouRsiExit(bool is_buy); // Ú†Ú© Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ Ø¨Ø§ Ú©Ø±Ø§Ø³ Ú†ÛŒÚ©Ùˆ Ùˆ ØªØ§ÛŒÛŒØ¯ RSI

    //--- Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ ---
    double CalculateStopLoss(bool is_buy, double entry_price); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø³Ø·Ø­ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³
    double CalculateAtrStopLoss(bool is_buy, double entry_price, ENUM_TIMEFRAMES timeframe); // Ù…Ø­Ø§Ø³Ø¨Ù‡ SL Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± ATR Ø¨Ø§ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    double GetTalaqiTolerance(int reference_shift); // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„Ø±Ø§Ù†Ø³ ØªÙ„Ø§Ù‚ÛŒ (Confluence)
    double CalculateAtrTolerance(int reference_shift); // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„Ø±Ø§Ù†Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ ATR
    double CalculateDynamicTolerance(int reference_shift); // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„Ø±Ø§Ù†Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ
    double FindFlatKijun(ENUM_TIMEFRAMES timeframe); // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø·Ø­ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª Ø¨Ø§ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    double FindPivotKijun(bool is_buy, ENUM_TIMEFRAMES timeframe); // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾ÛŒÙˆØª Ø±ÙˆÛŒ Ú©ÛŒØ¬ÙˆÙ† Ø¨Ø§ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    double FindPivotTenkan(bool is_buy, ENUM_TIMEFRAMES timeframe); // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾ÛŒÙˆØª Ø±ÙˆÛŒ ØªÙ†Ú©Ø§Ù† Ø¨Ø§ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    double FindBackupStopLoss(bool is_buy, double buffer, ENUM_TIMEFRAMES timeframe); // Ù…Ø­Ø§Ø³Ø¨Ù‡ SL Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø§ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    double CalculateStructuralStopLoss(bool is_buy, double entry_price); // [NEW] Ù…Ø­Ø§Ø³Ø¨Ù‡ SL Ø³Ø§Ø®ØªØ§Ø±ÛŒ
    
    //--- Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ù…Ù„Ø§Øª ---
    int CountSymbolTrades(); // Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø² Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯ ÙØ¹Ù„ÛŒ
    int CountTotalTrades(); // Ø´Ù…Ø§Ø±Ø´ Ú©Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø²
    void OpenTrade(bool is_buy); // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¬Ø¯ÛŒØ¯
    bool PlaceLimitOrder(bool is_buy);
    bool IsDataReady(); // Ú†Ú© Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…â€ŒÙ‡Ø§
    bool IsNewBar(ENUM_TIMEFRAMES timeframe, datetime &last_bar_time); // Ú†Ú© ØªØ´Ú©ÛŒÙ„ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù…Ø´Ø®Øµ

    //--- ØªÙˆØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ MKM ---
    double CalculateKijunSlope(ENUM_TIMEFRAMES timeframe, int period, double& threshold); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÛŒØ¨ Ú©ÛŒØ¬ÙˆÙ†
    bool IsKumoExpanding(ENUM_TIMEFRAMES timeframe, int period); // Ú†Ú© Ø§Ù†Ø¨Ø³Ø§Ø· Ø§Ø¨Ø± Ú©ÙˆÙ…Ùˆ - Ø¨Ù‡Ø¨ÙˆØ¯: SMA Ø¨Ù‡ EMA ØªØºÛŒÛŒØ± ÛŒØ§ÙØª
    bool IsChikouInOpenSpace(bool is_buy, ENUM_TIMEFRAMES timeframe); // Ú†Ú© ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ú†ÛŒÚ©Ùˆ

public:
    CStrategyManager(string symbol, SSettings &settings); // Ú©Ø§Ù†Ø³ØªØ±Ø§Ú©ØªÙˆØ± Ú©Ù„Ø§Ø³
    ~CStrategyManager(); // Ø¯ÛŒØ³ØªØ±Ø§Ú©ØªÙˆØ± Ú©Ù„Ø§Ø³
    bool Init(); // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ù„Ø§Ø³
    void OnTimerTick(); // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØ§ÛŒÙ…Ø± (Ù‡Ø± Ø«Ø§Ù†ÛŒÙ‡)
    void ProcessSignalSearch(); // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡
    void ManageActiveSignal(bool is_new_htf_bar); // Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
    string GetSymbol() const { return m_symbol; } // Ú¯Ø±ÙØªÙ† Ù†Ù…Ø§Ø¯ ÙØ¹Ù„ÛŒ
    void UpdateMyDashboard(); // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    CVisualManager* GetVisualManager() { return m_visual_manager; } // Ú¯Ø±ÙØªÙ† Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ©
};

//+------------------------------------------------------------------+
//| Ú©Ø§Ù†Ø³ØªØ±Ø§Ú©ØªÙˆØ± Ú©Ù„Ø§Ø³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ                                |
//+------------------------------------------------------------------+
CStrategyManager::CStrategyManager(string symbol, SSettings &settings)
{
    m_symbol = symbol; // ØªÙ†Ø¸ÛŒÙ… Ù†Ù…Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ
    m_settings = settings; // Ú©Ù¾ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ
    m_last_bar_time_htf = 0; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ú©Ù†Ø¯Ù„ HTF
    m_last_bar_time_ltf = 0; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ú©Ù†Ø¯Ù„ LTF
    m_is_waiting = false; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± (ØºÛŒØ±ÙØ¹Ø§Ù„)
    m_waiting_for_shift = false; // [NEW] Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø­Ø§Ù„Øª ØªØºÛŒÛŒØ±
    m_waiting_for_pullback = false; // [NEW] Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø­Ø§Ù„Øª Ù¾ÙˆÙ„Ø¨Ú©
    ArrayFree(m_potential_signals); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø¢Ø±Ø§ÛŒÙ‡ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ù‚ÙˆÙ‡
    m_ichimoku_handle = INVALID_HANDLE; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ø¯Ù„ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
    m_atr_handle = INVALID_HANDLE; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ø¯Ù„ ATR
    m_visual_manager = new CVisualManager(symbol, settings); // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ© Ø¬Ø¯ÛŒØ¯
}

//+------------------------------------------------------------------+
//| Ø¯ÛŒØ³ØªØ±Ø§Ú©ØªÙˆØ± Ú©Ù„Ø§Ø³ (Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹)                          |
//+------------------------------------------------------------------+
CStrategyManager::~CStrategyManager()
{
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ© Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
    if (m_visual_manager != NULL) // Ú†Ú© ÙˆØ¬ÙˆØ¯ Ø´ÛŒØ¡
    {
        delete m_visual_manager; // Ø­Ø°Ù Ø´ÛŒØ¡
        m_visual_manager = NULL; // Ø±ÛŒØ³Øª Ø§Ø´Ø§Ø±Ù‡â€ŒÚ¯Ø±
    }

    // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ (Ù‡Ø± Ú©Ø¯Ø§Ù… ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø±)
    if(m_ichimoku_handle != INVALID_HANDLE) // Ú†Ú© Ù‡Ù†Ø¯Ù„ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
        IndicatorRelease(m_ichimoku_handle); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„
    if(m_atr_handle != INVALID_HANDLE) // Ú†Ú© Ù‡Ù†Ø¯Ù„ ATR
        IndicatorRelease(m_atr_handle); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„
    if(m_adx_handle != INVALID_HANDLE) // Ú†Ú© Ù‡Ù†Ø¯Ù„ ADX
        IndicatorRelease(m_adx_handle); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„
    if(m_rsi_exit_handle != INVALID_HANDLE) // Ú†Ú© Ù‡Ù†Ø¯Ù„ RSI
        IndicatorRelease(m_rsi_exit_handle); // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„
}

//+------------------------------------------------------------------+
//| Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ                                    |
//+------------------------------------------------------------------+
void CStrategyManager::UpdateMyDashboard() 
{ 
    if (m_visual_manager != NULL) // Ú†Ú© ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ©
    {
        m_visual_manager.UpdateDashboard(); // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    }
}

//+------------------------------------------------------------------+
//| Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ù„Ø§Ø³ (Ø¨Ø§ ÙˆØ§Ú©Ø³ÛŒÙ†Ø§Ø³ÛŒÙˆÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§)                    |
//+------------------------------------------------------------------+
bool CStrategyManager::Init()
{
    // +++ ÙˆØ§Ú©Ø³ÛŒÙ†Ø§Ø³ÛŒÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ +++
    int attempts = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§
    while(iBars(m_symbol, m_settings.ichimoku_timeframe) < 200 && attempts < 100) // Ø­Ù„Ù‚Ù‡ ØªØ§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§ÙÛŒ
    {
        Sleep(100);  // ØªØ§Ø®ÛŒØ± Û±Û°Û° Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡
        MqlRates rates[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ù†Ø±Ø®â€ŒÙ‡Ø§
        CopyRates(m_symbol, m_settings.ichimoku_timeframe, 0, 1, rates);  // Ú©Ù¾ÛŒ Ù†Ø±Ø®â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ØªØ­Ø±ÛŒÚ© Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
        attempts++; // Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
    }
    if (iBars(m_symbol, m_settings.ichimoku_timeframe) < 200) // Ú†Ú© Ù†Ù‡Ø§ÛŒÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø±Ù‡Ø§
    {
        Log("Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ: Ù¾Ø³ Ø§Ø² ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø±Ø±ØŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯ " + m_symbol + " Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯."); // Ù„Ø§Ú¯ Ø®Ø·Ø§
        return false; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø´Ú©Ø³Øª
    }
    // +++ Ù¾Ø§ÛŒØ§Ù† ÙˆØ§Ú©Ø³ÛŒÙ†Ø§Ø³ÛŒÙˆÙ† +++

    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø´ÛŒØ¡ ØªØ±ÛŒØ¯
    m_trade.SetExpertMagicNumber(m_settings.magic_number); // ØªÙ†Ø¸ÛŒÙ… Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø§Ø¯ÙˆÛŒÛŒ
    m_trade.SetTypeFillingBySymbol(m_symbol); // ØªÙ†Ø¸ÛŒÙ… Ù†ÙˆØ¹ Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³ÙØ§Ø±Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø§Ø¯
    
    // --- Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ù„ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ Ø¯Ø± Ø­Ø§Ù„Øª Ù†Ø§Ù…Ø±Ø¦ÛŒ (Ghost Mode) ---
    // Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ Ø¯Ø± Ø­Ø§Ù„Øª Ù†Ø§Ù…Ø±Ø¦ÛŒ
    MqlParam ichimoku_params[3]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
    ichimoku_params[0].type = TYPE_INT; ichimoku_params[0].integer_value = m_settings.tenkan_period; // Ø¯ÙˆØ±Ù‡ ØªÙ†Ú©Ø§Ù†
    ichimoku_params[1].type = TYPE_INT; ichimoku_params[1].integer_value = m_settings.kijun_period; // Ø¯ÙˆØ±Ù‡ Ú©ÛŒØ¬ÙˆÙ†
    ichimoku_params[2].type = TYPE_INT; ichimoku_params[2].integer_value = m_settings.senkou_period; // Ø¯ÙˆØ±Ù‡ Ø³Ù†Ú©Ùˆ
    m_ichimoku_handle = IndicatorCreate(m_symbol, m_settings.ichimoku_timeframe, IND_ICHIMOKU, 3, ichimoku_params); // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ù„

    // ATR Ø¯Ø± Ø­Ø§Ù„Øª Ù†Ø§Ù…Ø±Ø¦ÛŒ
    MqlParam atr_params[1]; // Ù¾Ø§Ø±Ø§Ù…ØªØ± ATR
    atr_params[0].type = TYPE_INT; atr_params[0].integer_value = m_settings.atr_filter_period; // Ø¯ÙˆØ±Ù‡ ATR
    m_atr_handle = IndicatorCreate(m_symbol, m_settings.ichimoku_timeframe, IND_ATR, 1, atr_params); // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ù„

    // ADX Ø¯Ø± Ø­Ø§Ù„Øª Ù†Ø§Ù…Ø±Ø¦ÛŒ
    MqlParam adx_params[1]; // Ù¾Ø§Ø±Ø§Ù…ØªØ± ADX
    adx_params[0].type = TYPE_INT; adx_params[0].integer_value = m_settings.adx_period; // Ø¯ÙˆØ±Ù‡ ADX
    m_adx_handle = IndicatorCreate(m_symbol, m_settings.ichimoku_timeframe, IND_ADX, 1, adx_params); // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ù„

    // RSI Ø¯Ø± Ø­Ø§Ù„Øª Ù†Ø§Ù…Ø±Ø¦ÛŒ
    MqlParam rsi_params[2]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ RSI
    rsi_params[0].type = TYPE_INT; rsi_params[0].integer_value = m_settings.early_exit_rsi_period; // Ø¯ÙˆØ±Ù‡ RSI
    rsi_params[1].type = TYPE_INT; rsi_params[1].integer_value = PRICE_CLOSE; // Ù†ÙˆØ¹ Ù‚ÛŒÙ…Øª (Ø¨Ø³ØªÙ‡)
    m_rsi_exit_handle = IndicatorCreate(m_symbol, m_settings.ichimoku_timeframe, IND_RSI, 2, rsi_params); // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ù„
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± ØªÙ…Ø§Ù… Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§
    if (m_ichimoku_handle == INVALID_HANDLE || m_atr_handle == INVALID_HANDLE || m_adx_handle == INVALID_HANDLE || m_rsi_exit_handle == INVALID_HANDLE) // Ú†Ú© Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±. Ù„Ø·ÙØ§Ù‹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."); // Ù„Ø§Ú¯ Ø®Ø·Ø§
        return false; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø´Ú©Ø³Øª
    }

    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ÙØ±Ù‡Ø§
    ArraySetAsSeries(m_tenkan_buffer, true); // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§ÙØ± ØªÙ†Ú©Ø§Ù† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒ
    ArraySetAsSeries(m_kijun_buffer, true); // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§ÙØ± Ú©ÛŒØ¬ÙˆÙ† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒ
    ArraySetAsSeries(m_chikou_buffer, true); // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§ÙØ± Ú†ÛŒÚ©Ùˆ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒ
    ArraySetAsSeries(m_high_buffer, true); // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§ÙØ± Ø³Ù‚Ù Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒ
    ArraySetAsSeries(m_low_buffer, true);  // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§ÙØ± Ú©Ù Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒ
    
    if (!m_visual_manager.Init()) // Ú†Ú© Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ©
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ VisualManager."); // Ù„Ø§Ú¯ Ø®Ø·Ø§
        return false; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø´Ú©Ø³Øª
    }

    if(m_symbol == _Symbol) // Ø§Ú¯Ø± Ù†Ù…Ø§Ø¯ ÙØ¹Ù„ÛŒ Ø±ÙˆÛŒ Ú†Ø§Ø±Øª Ø§Ø³Øª
    {
        m_visual_manager.InitDashboard(); // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    }
    
    m_ltf_analyzer.Init(m_symbol, m_settings.ltf_timeframe); // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ ØªØ­Ù„ÛŒÙ„Ú¯Ø± LTF
    
    m_grace_structure_analyzer.Init(m_symbol, m_settings.ichimoku_timeframe); // ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ù…Ù‡Ù„Øª Ø±ÙˆÛŒ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ 
    
    Log("Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø¯."); // Ù„Ø§Ú¯ Ù…ÙˆÙÙ‚ÛŒØª
    return true; // Ø¨Ø§Ø²Ú¯Ø´Øª Ù…ÙˆÙÙ‚ÛŒØª
}

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØ§ÛŒÙ…Ø± (Ù‡Ø± Ø«Ø§Ù†ÛŒÙ‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯)                  |
//+------------------------------------------------------------------+
void CStrategyManager::OnTimerTick()
{
    // ÙˆØ§Ú©Ø³Ù†: Ú†Ú© Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    if (!IsDataReady()) return; // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³ØªØŒ Ø®Ø±ÙˆØ¬

    // Ø¢Ù¾Ø¯ÛŒØª ØªØ­Ù„ÛŒÙ„Ú¯Ø± LTF Ø§Ú¯Ø± Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø´Ø¯
    bool is_new_ltf_bar = IsNewBar(m_settings.ltf_timeframe, m_last_bar_time_ltf); // Ú†Ú© Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ LTF
    if (is_new_ltf_bar) // Ø§Ú¯Ø± Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯
    {
        m_ltf_analyzer.ProcessNewBar();  // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØªØ­Ù„ÛŒÙ„Ú¯Ø± LTF
    }

    // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙÙ‚Ø· Ø±ÙˆÛŒ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ HTF
    bool is_new_htf_bar = IsNewBar(m_settings.ichimoku_timeframe, m_last_bar_time_htf); // Ú†Ú© Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ HTF
    if (is_new_htf_bar) // Ø§Ú¯Ø± Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯
    {
        m_grace_structure_analyzer.ProcessNewBar();  // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ù…Ù‡Ù„Øª

        ProcessSignalSearch();  // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„
    if (m_waiting_for_shift || m_waiting_for_pullback || m_is_waiting || ArraySize(m_potential_signals) > 0) // [MODIFIED] Ú†Ú© Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
    {
        if (is_new_htf_bar || is_new_ltf_bar) // Ø§Ú¯Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯ HTF ÛŒØ§ LTF
        {
            ManageActiveSignal(is_new_htf_bar); // Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„
        }
    }

    // Ú†Ú© Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
    if (is_new_htf_bar && m_settings.enable_early_exit) // Ø§Ú¯Ø± Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ HTF Ùˆ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ ÙØ¹Ø§Ù„
    {
        CheckForEarlyExit(); // Ú†Ú© Ø´Ø±Ø§ÛŒØ· Ø®Ø±ÙˆØ¬
    }
}

//+------------------------------------------------------------------+
//| [MODIFIED] Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ "Ø´Ú©Ø§Ø±Ú†ÛŒ"           |
//+------------------------------------------------------------------+
// IchimokuLogic.mqh

void CStrategyManager::ProcessSignalSearch()
{
    // Ø§Ú¯Ø± Ø¯Ø± Ù‡Ø± ÛŒÚ© Ø§Ø² Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ¸Ø§Ø± Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯ Ù†Ú¯Ø±Ø¯
    if (m_waiting_for_shift || m_waiting_for_pullback || m_is_waiting) return;

    // --- Ù…Ø³ÛŒØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ 1: Ú©Ø±Ø§Ø³ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡ ---
    if (m_settings.primary_strategy == STRATEGY_TRIPLE_CROSS)
    {
        bool is_new_signal_buy = false;
        if (!CheckTripleCross(is_new_signal_buy)) return;

        Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡ HTF (Triple Cross) ÛŒØ§ÙØª Ø´Ø¯: " + (is_new_signal_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´"));

        // Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø­Ø§Ù„Øª
        m_waiting_for_shift = false;
        m_waiting_for_pullback = false;
        m_is_waiting = false;
        
        m_signal.is_buy = is_new_signal_buy;
        m_signal.time = iTime(m_symbol, m_settings.ichimoku_timeframe, m_settings.chikou_period);
        m_signal.grace_candle_count = 0;

        // Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ "Ø®Ù„Ø¨Ø§Ù†": Ú†Ú© ÙÙˆØ±ÛŒ Ø³Ø§Ø®ØªØ§Ø± LTF
        if (m_settings.entry_confirmation_mode == CONFIRM_LOWER_TIMEFRAME)
        {
            int found_at_bar = -1;
            bool has_existing_mss = m_ltf_analyzer.ScanPastForMSS(is_new_signal_buy, m_settings.structure_lookback_bars, found_at_bar);

            if (has_existing_mss)
            {
                m_waiting_for_pullback = true;
                Log("Ø³Ø§Ø®ØªØ§Ø± LTF Ù‡Ù…â€ŒØ¬Ù‡Øª Ø§Ø³Øª. ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ÙØ§Ø² Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù¾ÙˆÙ„Ø¨Ú©.");
            }
            else
            {
                m_waiting_for_shift = true;
                Log("Ø³Ø§Ø®ØªØ§Ø± LTF Ù‡Ù…â€ŒØ¬Ù‡Øª Ù†ÛŒØ³Øª. ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ÙØ§Ø² Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø³Ø§Ø®ØªØ§Ø± (MSS).");
            }
            
            m_signal.invalidation_level = m_signal.is_buy ? m_ltf_analyzer.GetSecondLastSwingLow() : m_ltf_analyzer.GetSecondLastSwingHigh();
            Log("Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ (Grandfather) Ø¯Ø± LTF ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯: " + DoubleToString(m_signal.invalidation_level, _Digits));
        }
        // Ù…Ø¹Ù…Ø§Ø±ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ: ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø¯Ø± ØªØ§ÛŒÙ… Ø¬Ø§Ø±ÛŒ
        else
        {
            if (m_settings.signal_mode == MODE_REPLACE_SIGNAL)
            {
                m_is_waiting = true;
                if (m_settings.grace_period_mode == GRACE_BY_STRUCTURE)
                {
                    m_signal.invalidation_level = is_new_signal_buy ? m_grace_structure_analyzer.GetLastSwingLow() : m_grace_structure_analyzer.GetLastSwingHigh();
                }
            }
            else // MODE_SIGNAL_CONTEST
            {
                AddOrUpdatePotentialSignal(is_new_signal_buy);
            }
        }

        if(m_symbol == _Symbol && m_visual_manager != NULL) 
            m_visual_manager.DrawTripleCrossRectangle(is_new_signal_buy, m_settings.chikou_period);
    }
    // --- Ù…Ø³ÛŒØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ 2: MKM ---
    else if (m_settings.primary_strategy == STRATEGY_KUMO_MTL)
    {
        // ÙÛŒÙ„ØªØ± Ø±ÙˆÙ†Ø¯ Ú©Ù„Ø§Ù† Ø¯Ø± HTF 
        int htf_ichi_handle = iIchimoku(m_symbol, m_settings.ichimoku_timeframe, m_settings.tenkan_period, m_settings.kijun_period, m_settings.senkou_period);
        if (htf_ichi_handle == INVALID_HANDLE) return;

        double senkou_a[1], senkou_b[1];
        if(CopyBuffer(htf_ichi_handle, 2, 0, 1, senkou_a) < 1 || CopyBuffer(htf_ichi_handle, 3, 0, 1, senkou_b) < 1)
        {
            IndicatorRelease(htf_ichi_handle);
            return;
        }
        IndicatorRelease(htf_ichi_handle);

        double high_kumo = MathMax(senkou_a[0], senkou_b[0]);
        double low_kumo = MathMin(senkou_a[0], senkou_b[0]);
        double close_price = iClose(m_symbol, m_settings.ichimoku_timeframe, 1); // Use close of last bar for stability

        bool is_buy_trend = (close_price > high_kumo);
        bool is_sell_trend = (close_price < low_kumo);

        if (is_buy_trend || is_sell_trend)
        {
            m_signal.is_buy = is_buy_trend;
            m_signal.time = TimeCurrent();
            Log("Ø±ÙˆÙ†Ø¯ Ú©Ù„Ø§Ù† MKM " + (m_signal.is_buy ? "ØµØ¹ÙˆØ¯ÛŒ" : "Ù†Ø²ÙˆÙ„ÛŒ") + " Ø§Ø³Øª. ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ LTF...");

            int found_bar = -1;
            bool has_existing_mss = m_ltf_analyzer.ScanPastForMSS(m_signal.is_buy, m_settings.structure_lookback_bars, found_bar);
            if (has_existing_mss)
            {
                m_waiting_for_pullback = true;
            }
            else
            {
                m_waiting_for_shift = true;
            }

            if (m_settings.grace_period_mode == GRACE_BY_STRUCTURE)
            {
                m_signal.invalidation_level = m_signal.is_buy ? m_ltf_analyzer.GetSecondLastSwingLow() : m_ltf_analyzer.GetSecondLastSwingHigh();
            }
        }
    }
}



//+------------------------------------------------------------------+
//| Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø§ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø­Ø§Ù„Øª-Ù…Ø­ÙˆØ± (Ù†Ø³Ø®Ù‡ ØªØ§Ú©ØªÛŒÚ©ÛŒ)        |
//+------------------------------------------------------------------+
void CStrategyManager::ManageActiveSignal(bool is_new_htf_bar)
{
    // Ø§Ú¯Ø± Ø¯Ø± Ù‡ÛŒÚ† Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø±ÛŒ Ù†ÛŒØ³ØªÛŒÙ…ØŒ Ù‡ÛŒÚ† Ú©Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.
    if (!m_waiting_for_shift && !m_waiting_for_pullback && !m_is_waiting && ArraySize(m_potential_signals) == 0) return;

    // Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¢ÛŒØ§ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† (LTF) Ø¯Ø§Ø±ÛŒÙ… ÛŒØ§ Ù†Ù‡
    bool is_new_ltf_bar = IsNewBar(m_settings.ltf_timeframe, m_last_bar_time_ltf);

    // --- Ø¨Ø®Ø´ Û±: Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¹Ù…Ø§Ø±ÛŒ "Ø®Ù„Ø¨Ø§Ù†" Ø¨Ø§ ØªØ§Ú©ØªÛŒÚ©â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù…ØªÙØ§ÙˆØª ---
    if (m_settings.entry_confirmation_mode == CONFIRM_LOWER_TIMEFRAME && (m_waiting_for_shift || m_waiting_for_pullback))
    {
        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ (Ø®Ø· Ù‚Ø±Ù…Ø² ÛŒØ§ Ù‚Ø§Ù†ÙˆÙ† Ù¾Ø¯Ø±Ø¨Ø²Ø±Ú¯) ---
        bool is_signal_expired = false;
        if (m_settings.grace_period_mode == GRACE_BY_CANDLES)
        {
            if (is_new_ltf_bar) m_signal.grace_candle_count++;
            if (m_signal.grace_candle_count >= m_settings.structural_grace_candles) is_signal_expired = true;
        }
        else // GRACE_BY_STRUCTURE (Ø±ÙˆØ´ Ù‡ÙˆØ´Ù…Ù†Ø¯)
        {
            double current_price_ltf = iClose(m_symbol, m_settings.ltf_timeframe, 1);
            if (m_signal.invalidation_level > 0 &&
               ((m_signal.is_buy && current_price_ltf < m_signal.invalidation_level) ||
               (!m_signal.is_buy && current_price_ltf > m_signal.invalidation_level)))
               is_signal_expired = true;
        }
        
        if (is_signal_expired)
        {
            Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø§Ù†Ù‚Ø¶Ø§ (Ø´Ú©Ø³Øª Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ ÛŒØ§ ØªÙ…Ø§Ù… Ø´Ø¯Ù† Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù„Øª) Ø¨Ø§Ø·Ù„ Ø´Ø¯.");
            m_waiting_for_shift = false;
            m_waiting_for_pullback = false;
            return;
        }

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¯Ø± Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ LTF ---
        if (is_new_ltf_bar)
        {
            // Ø§Ø² ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ø²Ø§Ø± Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
            SMssSignal ltf_signal = m_ltf_analyzer.ProcessNewBar();
            
            // Ø§Ú¯Ø± Ø¯Ø± ÙØ§Ø² "Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø³Ø§Ø®ØªØ§Ø±" (MSS) Ù‡Ø³ØªÛŒÙ…
            if (m_waiting_for_shift)
            {
                if ((m_signal.is_buy && ltf_signal.type == MSS_SHIFT_UP) || (!m_signal.is_buy && ltf_signal.type == MSS_SHIFT_DOWN))
                {
                    Log("ØªØºÛŒÛŒØ± Ø³Ø§Ø®ØªØ§Ø± (MSS) Ø¯Ø± LTF ØªØ§ÛŒÛŒØ¯ Ø´Ø¯. ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ÙØ§Ø² Ø§Ù†ØªØ¸Ø§Ø± Ù¾ÙˆÙ„Ø¨Ú©.");
                    m_waiting_for_shift = false;
                    m_waiting_for_pullback = true;
                }
            }
            // Ø§Ú¯Ø± Ø¯Ø± ÙØ§Ø² "Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù¾ÙˆÙ„Ø¨Ú©" Ù‡Ø³ØªÛŒÙ…
            else if (m_waiting_for_pullback)
            {
                // ================== Ø¯ÙˆØ±Ø§Ù‡ÛŒ ØªØ§Ú©ØªÛŒÚ© ÙˆØ±ÙˆØ¯: Ú©Ø§Ø±Ø¨Ø± Ú©Ø¯Ø§Ù… Ø±ÙˆØ´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ØŸ ==================
                if(m_settings.entry_tactic == TACTIC_CONFIRMATION)
                {
                    // ØªØ§Ú©ØªÛŒÚ© Û±: ÙˆØ±ÙˆØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§ÛŒÛŒØ¯ (Ù…Ù†Ø·Ù‚ Ù‚Ø¨Ù„ÛŒ Ùˆ Ù…Ø­Ø§ÙØ¸Ù‡â€ŒÚ©Ø§Ø±Ø§Ù†Ù‡)
                    // Ù…Ù†ØªØ¸Ø± Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ… ØªØ§ ÛŒÚ© Ø³ÙˆÛŒÙ†Ú¯ Ù„Ùˆ (Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯) ÛŒØ§ Ø³ÙˆÛŒÙ†Ú¯ Ù‡Ø§ÛŒ (Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´) Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ ØªØ§ÛŒÛŒØ¯ Ø´ÙˆØ¯
                    if (ltf_signal.new_swing_formed && (m_signal.is_buy != ltf_signal.is_swing_high))
                    {
                        Log("ØªØ§Ú©ØªÛŒÚ© ØªØ§ÛŒÛŒØ¯: Ù¾ÙˆÙ„Ø¨Ú© (ØªØ´Ú©ÛŒÙ„ Ø³ÙˆÛŒÙ†Ú¯ Ù…Ø®Ø§Ù„Ù) Ø¯Ø± LTF ØªØ§ÛŒÛŒØ¯ Ø´Ø¯. Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Market.");
                        if(AreAllFiltersPassed(m_signal.is_buy))
                        {
                            OpenTrade(m_signal.is_buy);
                        }
                        // Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ Ù¾Ø³ Ø§Ø² ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯
                        m_waiting_for_shift = false;
                        m_waiting_for_pullback = false;
                    }
                }
                else // TACTIC_PREDICTIVE
                {
                    // ØªØ§Ú©ØªÛŒÚ© Û²: ÙˆØ±ÙˆØ¯ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¨Ø§ Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø± (Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ùˆ ØªÙ‡Ø§Ø¬Ù…ÛŒ)
                    // Ø¨Ù‡ Ø¬Ø§ÛŒ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ØŒ ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ÛŒÚ© Ø³ÙØ§Ø±Ø´ Ù„ÛŒÙ…ÛŒØª Ø¯Ø± Ù…Ø­Ù„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ù¾Ø§ÛŒØ§Ù† Ù¾ÙˆÙ„Ø¨Ú© Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒÙ…
                    Log("ØªØ§Ú©ØªÛŒÚ© Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ: Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ù„ Ù…Ù†Ø§Ø³Ø¨ Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø±...");
                    if(PlaceLimitOrder(m_signal.is_buy))
                    {
                        // Ø§Ú¯Ø± Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯ØŒ Ø§Ø² Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…
                        m_waiting_for_shift = false;
                        m_waiting_for_pullback = false;
                    }
                }
                // ======================================================================================
            }
        }
    }
    // --- Ø¨Ø®Ø´ Û²: Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ (Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø¨Ù„ÛŒ) ---
    else if (m_settings.entry_confirmation_mode == CONFIRM_CURRENT_TIMEFRAME)
    {
        // (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
        // Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª MODE_REPLACE_SIGNAL
        if (m_settings.signal_mode == MODE_REPLACE_SIGNAL && m_is_waiting)
        {
            bool is_signal_expired = false;
            if (is_new_htf_bar && m_settings.grace_period_mode == GRACE_BY_CANDLES)
            {
                m_signal.grace_candle_count++;
                if (m_signal.grace_candle_count >= m_settings.grace_period_candles) is_signal_expired = true;
            }
            else if (m_settings.grace_period_mode == GRACE_BY_STRUCTURE)
            {
                double current_price = iClose(m_symbol, m_settings.ichimoku_timeframe, 1);
                if (m_signal.invalidation_level > 0 &&
                   ((m_signal.is_buy && current_price < m_signal.invalidation_level) ||
                   (!m_signal.is_buy && current_price > m_signal.invalidation_level)))
                   is_signal_expired = true;
            }

            if (is_signal_expired) { m_is_waiting = false; }
            else if (CheckFinalConfirmation(m_signal.is_buy))
            {
                if (AreAllFiltersPassed(m_signal.is_buy)) { OpenTrade(m_signal.is_buy); }
                m_is_waiting = false;
            }
        }
        // Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª MODE_SIGNAL_CONTEST
        else if (m_settings.signal_mode == MODE_SIGNAL_CONTEST && ArraySize(m_potential_signals) > 0)
        {
             for (int i = ArraySize(m_potential_signals) - 1; i >= 0; i--)
             {
                bool is_signal_expired = false;
                if (m_settings.grace_period_mode == GRACE_BY_CANDLES && is_new_htf_bar)
                {
                    m_potential_signals[i].grace_candle_count++;
                    if (m_potential_signals[i].grace_candle_count >= m_settings.grace_period_candles)
                        is_signal_expired = true;
                }
                else if (m_settings.grace_period_mode == GRACE_BY_STRUCTURE)
                {
                    double current_price = iClose(m_symbol, m_settings.ichimoku_timeframe, 1);
                     if (m_potential_signals[i].invalidation_level > 0 &&
                        ((m_potential_signals[i].is_buy && current_price < m_potential_signals[i].invalidation_level) ||
                         (!m_potential_signals[i].is_buy && current_price > m_potential_signals[i].invalidation_level)))
                         is_signal_expired = true;
                }

                if(is_signal_expired)
                {
                    ArrayRemove(m_potential_signals, i, 1);
                    continue;
                }

                if(CheckFinalConfirmation(m_potential_signals[i].is_buy) && AreAllFiltersPassed(m_potential_signals[i].is_buy))
                {
                    OpenTrade(m_potential_signals[i].is_buy);
                    bool winner_is_buy = m_potential_signals[i].is_buy;
                    for (int j = ArraySize(m_potential_signals) - 1; j >= 0; j--)
                    {
                        if (m_potential_signals[j].is_buy == winner_is_buy)
                            ArrayRemove(m_potential_signals, j, 1);
                    }
                    return;
                }
             }
        }
    }



    // Ù…Ø³ÛŒØ± MKM
    else if (m_settings.primary_strategy == STRATEGY_KUMO_MTL)
    {
        if (!m_waiting_for_shift && !m_waiting_for_pullback) return; // Ø§Ú¯Ø± Ù…Ù†ØªØ¸Ø± Ù†ÛŒØ³ØªØŒ Ø®Ø±ÙˆØ¬

        ENUM_TIMEFRAMES ltf = m_settings.ltf_timeframe; // ØªØ§ÛŒÙ… LTF
        bool is_buy = m_signal.is_buy; // Ù†ÙˆØ¹ Ø³ÛŒÚ¯Ù†Ø§Ù„

        // ÙÛŒÙ„ØªØ± Ù…ÙˆÙ…Ù†ØªÙˆÙ…
        double slope_threshold = 0.0; // Ø¢Ø³ØªØ§Ù†Ù‡ Ø´ÛŒØ¨
        double slope = CalculateKijunSlope(ltf, m_settings.mkm_kijun_slope_period, slope_threshold); // [MODIFIED] Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ… Ø¬Ø¯ÛŒØ¯
        bool momentum_ok = is_buy ? (slope > slope_threshold) : (slope < -slope_threshold); // Ú†Ú© Ù…ÙˆÙ…Ù†ØªÙˆÙ…

        // ÙÛŒÙ„ØªØ± Ù†ÙˆØ³Ø§Ù†
        bool volatility_ok = IsKumoExpanding(ltf, m_settings.mkm_kumo_expansion_period); // [MODIFIED] Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ… Ø¬Ø¯ÛŒØ¯ (ÙØ±Ø¶ Ø¨Ø± ØªØ¹Ø±ÛŒÙ ÙˆØ±ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯)

        // ØªØ§ÛŒÛŒØ¯ Ø³Ø§Ø®ØªØ§Ø±ÛŒ
        bool structure_ok = IsChikouInOpenSpace(is_buy, ltf); // Ú†Ú© ÙØ¶Ø§ÛŒ Ú†ÛŒÚ©Ùˆ

        // Ù…Ø§Ø´Ù‡ ÙˆØ±ÙˆØ¯: Ø¨ÙˆÙ†Ø³ Ú©ÛŒØ¬ÙˆÙ†
        bool trigger_ok = false; // ÙÙ„Ú¯ Ù…Ø§Ø´Ù‡
        int ltf_ichi_handle = iIchimoku(m_symbol, ltf, m_settings.tenkan_period, m_settings.kijun_period, m_settings.senkou_period); // Ù‡Ù†Ø¯Ù„ LTF
        if (ltf_ichi_handle != INVALID_HANDLE) // Ú†Ú© Ù‡Ù†Ø¯Ù„
        {
            double kijun_buffer[1]; // Ø¨Ø§ÙØ± Ú©ÛŒØ¬ÙˆÙ†
            CopyBuffer(ltf_ichi_handle, 1, 1, 1, kijun_buffer); // Ú©Ù¾ÛŒ Ú©ÛŒØ¬ÙˆÙ† Ø´ÛŒÙØª 1
            double kijun = kijun_buffer[0]; // Ù…Ù‚Ø¯Ø§Ø± Ú©ÛŒØ¬ÙˆÙ†
            IndicatorRelease(ltf_ichi_handle); // Ø¢Ø²Ø§Ø¯ Ù‡Ù†Ø¯Ù„

            if (is_buy && iLow(m_symbol, ltf, 1) <= kijun && iClose(m_symbol, ltf, 1) > kijun) // Ú†Ú© Ø¨ÙˆÙ†Ø³ Ø®Ø±ÛŒØ¯
                trigger_ok = true;
            if (!is_buy && iHigh(m_symbol, ltf, 1) >= kijun && iClose(m_symbol, ltf, 1) < kijun) // Ú†Ú© Ø¨ÙˆÙ†Ø³ ÙØ±ÙˆØ´
                trigger_ok = true;
        }

        if (momentum_ok && volatility_ok && structure_ok && trigger_ok) // Ø§Ú¯Ø± ØªÙ…Ø§Ù… Ø´Ø±Ø§ÛŒØ·
        {
            Log("ØªÙ…Ø§Ù… Ø´Ø±Ø§ÛŒØ· MKM Ø¨Ø±Ø§ÛŒ " + (is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " ÙØ±Ø§Ù‡Ù… Ø´Ø¯."); // Ù„Ø§Ú¯
            if(AreAllFiltersPassed(is_buy)) // Ú†Ú© ÙÛŒÙ„ØªØ±Ù‡Ø§
            {
                OpenTrade(is_buy); // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù†
            }
            m_waiting_for_shift = false; // Ø±ÛŒØ³Øª
            m_waiting_for_pullback = false; // Ø±ÛŒØ³Øª
        }
    }
}

//+------------------------------------------------------------------+
//| Ú†Ú© Ú©Ø±Ø§Ø³ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡ (Triple Cross) - Ø¨Ù‡Ø¨ÙˆØ¯: ØªÙ„Ø±Ø§Ù†Ø³ Ø¨Ø±Ø§ÛŒ Chikou Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯|
//+------------------------------------------------------------------+
bool CStrategyManager::CheckTripleCross(bool& is_buy)
{
    int shift = m_settings.chikou_period; // Ø´ÛŒÙØª Ù…Ø±Ø¬Ø¹ Ú†ÛŒÚ©Ùˆ
    if (iBars(m_symbol, _Period) < shift + 2) return false; // Ú†Ú© ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø±Ù‡Ø§

    double tk_shifted[], ks_shifted[]; // Ø¨Ø§ÙØ±Ù‡Ø§ÛŒ Ø´ÛŒÙØª Ø´Ø¯Ù‡
    if(CopyBuffer(m_ichimoku_handle, 0, shift, 2, tk_shifted) < 2 || 
       CopyBuffer(m_ichimoku_handle, 1, shift, 2, ks_shifted) < 2)
    {
       return false; // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¨ÙˆØ¯
    }
       
    double tenkan_at_shift = tk_shifted[0]; // ØªÙ†Ú©Ø§Ù† Ø¯Ø± Ø´ÛŒÙØª
    double kijun_at_shift = ks_shifted[0]; // Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ø´ÛŒÙØª
    double tenkan_prev_shift = tk_shifted[1]; // ØªÙ†Ú©Ø§Ù† Ù‚Ø¨Ù„ÛŒ
    double kijun_prev_shift = ks_shifted[1]; // Ú©ÛŒØ¬ÙˆÙ† Ù‚Ø¨Ù„ÛŒ

    bool is_cross_up = tenkan_prev_shift < kijun_prev_shift && tenkan_at_shift > kijun_at_shift; // Ú©Ø±Ø§Ø³ ØµØ¹ÙˆØ¯ÛŒ
    bool is_cross_down = tenkan_prev_shift > kijun_prev_shift && tenkan_at_shift < kijun_at_shift; // Ú©Ø±Ø§Ø³ Ù†Ø²ÙˆÙ„ÛŒ
    bool is_tk_cross = is_cross_up || is_cross_down; // ÙˆØ¬ÙˆØ¯ Ú©Ø±Ø§Ø³

    double tolerance = GetTalaqiTolerance(shift); // ØªÙ„Ø±Ø§Ù†Ø³ ØªÙ„Ø§Ù‚ÛŒ
    bool is_confluence = (tolerance > 0) ? (MathAbs(tenkan_at_shift - kijun_at_shift) <= tolerance) : false; // Ú†Ú© ØªÙ„Ø§Ù‚ÛŒ

    if (!is_tk_cross && !is_confluence) // Ø§Ú¯Ø± Ù†Ù‡ Ú©Ø±Ø§Ø³ Ùˆ Ù†Ù‡ ØªÙ„Ø§Ù‚ÛŒ
    {
        return false; // Ø¨Ø¯ÙˆÙ† Ø³ÛŒÚ¯Ù†Ø§Ù„
    }

    double chikou_now  = iClose(m_symbol, m_settings.ichimoku_timeframe, 1); // Ú†ÛŒÚ©Ùˆ ÙØ¹Ù„ÛŒ
    double chikou_prev = iClose(m_symbol, m_settings.ichimoku_timeframe, 2);  // Ú†ÛŒÚ©Ùˆ Ù‚Ø¨Ù„ÛŒ

    double upper_line = MathMax(tenkan_at_shift, kijun_at_shift); // Ø®Ø· Ø¨Ø§Ù„Ø§
    double lower_line = MathMin(tenkan_at_shift, kijun_at_shift); // Ø®Ø· Ù¾Ø§ÛŒÛŒÙ†

    // Ø¨Ù‡Ø¨ÙˆØ¯: ØªÙ„Ø±Ø§Ù†Ø³ Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Chikou (Ù†ØµÙ ØªÙ„Ø±Ø§Ù†Ø³ TK) Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù†ÙˆÛŒØ²
    double chikou_tolerance = tolerance * 0.5; // ØªÙ„Ø±Ø§Ù†Ø³ Chikou (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ØªØ³Øª Ø´Ø¯Ù‡)

    bool chikou_crosses_up = (chikou_now > upper_line - chikou_tolerance) && (chikou_prev < upper_line + chikou_tolerance); // Ú©Ø±Ø§Ø³ ØµØ¹ÙˆØ¯ÛŒ Ø¨Ø§ ØªÙ„Ø±Ø§Ù†Ø³
    if (chikou_crosses_up) // Ø§Ú¯Ø± ØµØ¹ÙˆØ¯ÛŒ
    {
        is_buy = true; // ØªÙ†Ø¸ÛŒÙ… Ø®Ø±ÛŒØ¯
        return true;  // Ù…ÙˆÙÙ‚ÛŒØª
    }

    bool chikou_crosses_down = (chikou_now < lower_line + chikou_tolerance) && (chikou_prev > lower_line - chikou_tolerance); // Ú©Ø±Ø§Ø³ Ù†Ø²ÙˆÙ„ÛŒ Ø¨Ø§ ØªÙ„Ø±Ø§Ù†Ø³
    if (chikou_crosses_down) // Ø§Ú¯Ø± Ù†Ø²ÙˆÙ„ÛŒ
    {
        is_buy = false; // ØªÙ†Ø¸ÛŒÙ… ÙØ±ÙˆØ´
        return true;  // Ù…ÙˆÙÙ‚ÛŒØª
    }

    return false;  // Ø¨Ø¯ÙˆÙ† Ø³ÛŒÚ¯Ù†Ø§Ù„
}

//+------------------------------------------------------------------+
//| Ú†Ú© ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ ÙˆØ±ÙˆØ¯                                              |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckFinalConfirmation(bool is_buy)
{
    switch(m_settings.entry_confirmation_mode) // Ø³ÙˆØ¦ÛŒÚ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø§Ù„Øª ØªØ§ÛŒÛŒØ¯
    {
        case CONFIRM_LOWER_TIMEFRAME: // Ø­Ø§Ù„Øª LTF
            return CheckLowerTfConfirmation(is_buy); // Ú†Ú© LTF

        case CONFIRM_CURRENT_TIMEFRAME: // Ø­Ø§Ù„Øª ÙØ¹Ù„ÛŒ
        {
            if (iBars(m_symbol, m_settings.ichimoku_timeframe) < 2) return false; // Ú†Ú© Ø¨Ø§Ø±Ù‡Ø§

            CopyBuffer(m_ichimoku_handle, 0, 1, 1, m_tenkan_buffer); // Ú©Ù¾ÛŒ ØªÙ†Ú©Ø§Ù†
            CopyBuffer(m_ichimoku_handle, 1, 1, 1, m_kijun_buffer); // Ú©Ù¾ÛŒ Ú©ÛŒØ¬ÙˆÙ†

            double tenkan_at_1 = m_tenkan_buffer[0]; // ØªÙ†Ú©Ø§Ù† Ø´ÛŒÙØª 1
            double kijun_at_1 = m_kijun_buffer[0]; // Ú©ÛŒØ¬ÙˆÙ† Ø´ÛŒÙØª 1
            double open_at_1 = iOpen(m_symbol, m_settings.ichimoku_timeframe, 1); // Ø¨Ø§Ø² Ø´ÛŒÙØª 1
            double close_at_1 = iClose(m_symbol, m_settings.ichimoku_timeframe, 1); // Ø¨Ø³ØªÙ‡ Ø´ÛŒÙØª 1

            if (is_buy) // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯
            {
                if (tenkan_at_1 <= kijun_at_1) return false; // Ú†Ú© ØªÙ†Ú©Ø§Ù† Ø¨Ø§Ù„Ø§ÛŒ Ú©ÛŒØ¬ÙˆÙ†
                if (m_settings.confirmation_type == MODE_OPEN_AND_CLOSE) { // Ú†Ú© Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡
                    if (open_at_1 > tenkan_at_1 && open_at_1 > kijun_at_1 && close_at_1 > tenkan_at_1 && close_at_1 > kijun_at_1)
                        return true; // ØªØ§ÛŒÛŒØ¯
                } else { // Ú†Ú© Ø¨Ø³ØªÙ‡
                    if (close_at_1 > tenkan_at_1 && close_at_1 > kijun_at_1)
                        return true; // ØªØ§ÛŒÛŒØ¯
                }
            }
            else // Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´
            {
                if (tenkan_at_1 >= kijun_at_1) return false; // Ú†Ú© ØªÙ†Ú©Ø§Ù† Ù¾Ø§ÛŒÛŒÙ† Ú©ÛŒØ¬ÙˆÙ†
                if (m_settings.confirmation_type == MODE_OPEN_AND_CLOSE) { // Ú†Ú© Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡
                    if (open_at_1 < tenkan_at_1 && open_at_1 < kijun_at_1 && close_at_1 < tenkan_at_1 && close_at_1 < kijun_at_1)
                        return true; // ØªØ§ÛŒÛŒØ¯
                } else { // Ú†Ú© Ø¨Ø³ØªÙ‡
                    if (close_at_1 < tenkan_at_1 && close_at_1 < kijun_at_1)
                        return true; // ØªØ§ÛŒÛŒØ¯
                }
            }
            return false; // Ø¹Ø¯Ù… ØªØ§ÛŒÛŒØ¯
        }
    }
    return false; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¹Ø¯Ù… ØªØ§ÛŒÛŒØ¯
}


//+------------------------------------------------------------------+
//| [Ø¬Ø¯ÛŒØ¯] Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø³ÙØ§Ø±Ø´ Ù„ÛŒÙ…ÛŒØª Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ú©ØªÛŒÚ© Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ            |
//+------------------------------------------------------------------+
bool CStrategyManager::PlaceLimitOrder(bool is_buy)
{
    // Û±. Ú¯Ø±ÙØªÙ† Ù‚ÛŒÙ…Øª Ú©ÛŒØ¬ÙˆÙ†â€ŒØ³Ù† Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù Ù¾ÙˆÙ„Ø¨Ú©
    int ltf_ichi_handle = iIchimoku(m_symbol, m_settings.ltf_timeframe, m_settings.tenkan_period, m_settings.kijun_period, m_settings.senkou_period);
    if(ltf_ichi_handle == INVALID_HANDLE) return false;

    double kijun_buffer[1];
    if(CopyBuffer(ltf_ichi_handle, 1, 1, 1, kijun_buffer) < 1)
    {
        IndicatorRelease(ltf_ichi_handle);
        return false;
    }
    IndicatorRelease(ltf_ichi_handle);
    double limit_price = kijun_buffer[0];

    // Û². Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù†Ø·Ù‚ÛŒ Ø¨ÙˆØ¯Ù† Ù‚ÛŒÙ…Øª Ù„ÛŒÙ…ÛŒØª
    // Ø³ÙØ§Ø±Ø´ Ø®Ø±ÛŒØ¯ Ù„ÛŒÙ…ÛŒØª Ø¨Ø§ÛŒØ¯ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¨Ø§Ø´Ø¯
    if(is_buy && limit_price >= SymbolInfoDouble(m_symbol, SYMBOL_ASK))
    {
        Log("Ù‚ÛŒÙ…Øª Ù„ÛŒÙ…ÛŒØª Ø®Ø±ÛŒØ¯ ("+DoubleToString(limit_price, _Digits)+") Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ask Ø§Ø³Øª. Ø³ÙØ§Ø±Ø´ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
        return false;
    }
    // Ø³ÙØ§Ø±Ø´ ÙØ±ÙˆØ´ Ù„ÛŒÙ…ÛŒØª Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø¨Ø§Ø´Ø¯
    if(!is_buy && limit_price <= SymbolInfoDouble(m_symbol, SYMBOL_BID))
    {
        Log("Ù‚ÛŒÙ…Øª Ù„ÛŒÙ…ÛŒØª ÙØ±ÙˆØ´ ("+DoubleToString(limit_price, _Digits)+") Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Bid Ø§Ø³Øª. Ø³ÙØ§Ø±Ø´ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯.");
        return false;
    }

    // Û³. Ú†Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ú©ÙˆÙ…ÙˆØŒ ATRØŒ ADX Ùˆ...)
    if(!AreAllFiltersPassed(is_buy))
    {
        Log("ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø± Ø±Ø¯ Ø´Ø¯Ù†Ø¯.");
        return false; // Ù‡Ù†ÙˆØ² Ø´Ø±Ø§ÛŒØ· Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ù†ÛŒØ³Øª
    }
    
    // Û´. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø®ØªØ§Ø± (Ù‚Ø§Ù†ÙˆÙ† Ù¾Ø¯Ø±Ø¨Ø²Ø±Ú¯)
    // Ù…Ø§ Ø§Ø² Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹ Ø§Ø³ØªØ§Ù¾ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    double sl = m_signal.invalidation_level;
    if(sl <= 0) 
    {
        Log("Ø®Ø·Ø§: Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
        return false;
    }

    // Ûµ. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ù‡ Ùˆ Ø­Ø¯ Ø³ÙˆØ¯ (Ú©Ù¾ÛŒ Ø´Ø¯Ù‡ Ø§Ø² Ù…Ù†Ø·Ù‚ OpenTrade Ø¨Ø±Ø§ÛŒ Ø«Ø¨Ø§Øª)
    double balance = AccountInfoDouble(ACCOUNT_BALANCE);
    double risk_amount = balance * (m_settings.risk_percent_per_trade / 100.0);
    double loss_for_one_lot = 0;

    // ØªÙˆØ¬Ù‡: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø¶Ø±Ø± Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‚ÛŒÙ…Øª Ù„ÛŒÙ…ÛŒØª Ùˆ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯
    if(!OrderCalcProfit(is_buy ? ORDER_TYPE_BUY : ORDER_TYPE_SELL, m_symbol, 1.0, limit_price, sl, loss_for_one_lot))
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø±. Ú©Ø¯ Ø®Ø·Ø§: " + (string)GetLastError());
        return false;
    }
    loss_for_one_lot = MathAbs(loss_for_one_lot);
    if(loss_for_one_lot <= 0)
    {
        Log("Ù…ÛŒØ²Ø§Ù† Ø¶Ø±Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø± Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
        return false;
    }
    
    double lot_size = NormalizeDouble(risk_amount / loss_for_one_lot, 2);
    double min_lot = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_MIN);
    double max_lot = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_MAX);
    double lot_step = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_STEP);
    lot_size = MathMax(min_lot, MathMin(max_lot, lot_size));
    lot_size = MathRound(lot_size / lot_step) * lot_step;

    if(lot_size < min_lot)
    {
        Log("Ø­Ø¬Ù… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ…ÛŒØª Ø§Ø±Ø¯Ø± Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª.");
        return false;
    }
    
    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double sl_distance_points = MathAbs(limit_price - sl) / point;
    double tp_distance_points = sl_distance_points * m_settings.take_profit_ratio;
    double tp = is_buy ? limit_price + tp_distance_points * point : limit_price - tp_distance_points * point;
    
    int digits = (int)SymbolInfoInteger(m_symbol, SYMBOL_DIGITS);
    sl = NormalizeDouble(sl, digits);
    tp = NormalizeDouble(tp, digits);
    limit_price = NormalizeDouble(limit_price, digits);
    
    // Û¶. ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³ÙØ§Ø±Ø´ (Ù…Ø«Ù„Ø§Ù‹ Ûµ Ú©Ù†Ø¯Ù„ ØªØ§ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†)
    datetime expiration = TimeCurrent() + 5 * (datetime)PeriodSeconds(m_settings.ltf_timeframe);

    // Û·. Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø³ÙØ§Ø±Ø´ Ù„ÛŒÙ…ÛŒØª
    string comment = "Memento Predictive";
    if(is_buy)
    {
        m_trade.BuyLimit(lot_size, limit_price, m_symbol, sl, tp, ORDER_TIME_SPECIFIED, expiration, comment);
    }
    else
    {
        m_trade.SellLimit(lot_size, limit_price, m_symbol, sl, tp, ORDER_TIME_SPECIFIED, expiration, comment);
    }
    
    Log("Ø³ÙØ§Ø±Ø´ Ù„ÛŒÙ…ÛŒØª " + (is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¯Ø± Ù‚ÛŒÙ…Øª " + DoubleToString(limit_price, _Digits) + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯. Ø­Ø¬Ù…: " + DoubleToString(lot_size,2));
    return true; // Ø¨Ù‡ Ù†Ø´Ø§Ù†Ù‡ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø³ÙØ§Ø±Ø´
}





//+------------------------------------------------------------------+
//| Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø·Ø­ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³                                             |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateStopLoss(bool is_buy, double entry_price)
{
    ENUM_TIMEFRAMES sl_tf = (m_settings.sl_timeframe == PERIOD_CURRENT) ? _Period : m_settings.sl_timeframe; // ØªØ¹ÛŒÛŒÙ† ØªØ§ÛŒÙ… SL
    if (m_settings.stoploss_type == MODE_SIMPLE) // Ø­Ø§Ù„Øª Ø³Ø§Ø¯Ù‡
    {
        double buffer = m_settings.sl_buffer_multiplier * SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ø¨Ø§ÙØ±
        return FindBackupStopLoss(is_buy, buffer, sl_tf); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
    }
    if (m_settings.stoploss_type == MODE_ATR) // Ø­Ø§Ù„Øª ATR
    {
        double sl_price = CalculateAtrStopLoss(is_buy, entry_price, sl_tf); // Ù…Ø­Ø§Ø³Ø¨Ù‡ ATR
        if (sl_price == 0) // Ø§Ú¯Ø± Ø´Ú©Ø³Øª
        {
            Log("Ù…Ø­Ø§Ø³Ø¨Ù‡ ATR SL Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ù¾Ø´ØªÛŒØ¨Ø§Ù†..."); // Ù„Ø§Ú¯
            double buffer = m_settings.sl_buffer_multiplier * SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ø¨Ø§ÙØ±
            return FindBackupStopLoss(is_buy, buffer, sl_tf); // Ù¾Ø´ØªÛŒØ¨Ø§Ù†
        }
        return sl_price; // Ø¨Ø§Ø²Ú¯Ø´Øª SL
    }
    if (m_settings.stoploss_type == MODE_STRUCTURE) // [NEW] Ø­Ø§Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ
    {
        double sl_price = CalculateStructuralStopLoss(is_buy, entry_price); // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø®ØªØ§Ø±ÛŒ
        if (sl_price == 0) // Ø§Ú¯Ø± Ø´Ú©Ø³Øª
        {
            Log("Ù…Ø­Ø§Ø³Ø¨Ù‡ Structural SL Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ù¾Ø´ØªÛŒØ¨Ø§Ù†..."); // Ù„Ø§Ú¯
            double buffer = m_settings.sl_buffer_multiplier * SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ø¨Ø§ÙØ±
            return FindBackupStopLoss(is_buy, buffer, sl_tf); // Ù¾Ø´ØªÛŒØ¨Ø§Ù†
        }
        return sl_price; // Ø¨Ø§Ø²Ú¯Ø´Øª SL
    }

    // Ø­Ø§Ù„Øª Ù¾ÛŒÚ†ÛŒØ¯Ù‡ (Ø¨Ù‡ÛŒÙ†Ù‡)
    Log("Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¨Ù‡ÛŒÙ†Ù‡..."); // Ù„Ø§Ú¯ Ø´Ø±ÙˆØ¹
    double candidates[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§Ù‡Ø§
    int count = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
    double sl_candidate = 0; // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ù…ÙˆÙ‚Øª
    double buffer = m_settings.sl_buffer_multiplier * SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ø¨Ø§ÙØ±
    
    sl_candidate = FindFlatKijun(sl_tf); // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡
        candidates[count] = is_buy ? sl_candidate - buffer : sl_candidate + buffer; // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§ Ø¨Ø§ÙØ±
        count++; // Ø§ÙØ²Ø§ÛŒØ´
    }
    
    sl_candidate = FindPivotKijun(is_buy, sl_tf); // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ù¾ÛŒÙˆØª Ú©ÛŒØ¬ÙˆÙ†
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡
        candidates[count] = is_buy ? sl_candidate - buffer : sl_candidate + buffer; // ØªÙ†Ø¸ÛŒÙ…
        count++; // Ø§ÙØ²Ø§ÛŒØ´
    }

    sl_candidate = FindPivotTenkan(is_buy, sl_tf); // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ù¾ÛŒÙˆØª ØªÙ†Ú©Ø§Ù†
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡
        candidates[count] = is_buy ? sl_candidate - buffer : sl_candidate + buffer; // ØªÙ†Ø¸ÛŒÙ…
        count++; // Ø§ÙØ²Ø§ÛŒØ´
    }

    sl_candidate = FindBackupStopLoss(is_buy, buffer, sl_tf); // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ø³Ø§Ø¯Ù‡
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡
        candidates[count] = sl_candidate; // Ø§Ø¶Ø§ÙÙ‡
        count++; // Ø§ÙØ²Ø§ÛŒØ´
    }
    
    sl_candidate = CalculateAtrStopLoss(is_buy, entry_price, sl_tf); // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ ATR
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡
        candidates[count] = sl_candidate; // Ø§Ø¶Ø§ÙÙ‡
        count++; // Ø§ÙØ²Ø§ÛŒØ´
    }

    if (count == 0) // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§
    {
        Log("Ø®Ø·Ø§: Ù‡ÛŒÚ† Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."); // Ù„Ø§Ú¯
        return 0.0; // ØµÙØ±
    }

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§Ù‡Ø§
    double valid_candidates[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ø¹ØªØ¨Ø±Ù‡Ø§
    int valid_count = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø±
    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ù¾ÙˆÛŒÙ†Øª Ù†Ù…Ø§Ø¯
    double spread = (double)SymbolInfoInteger(m_symbol, SYMBOL_SPREAD) * point; // Ø§Ø³Ù¾Ø±Ø¯
    double min_safe_distance = spread + buffer;  // Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ Ø§ÛŒÙ…Ù†

    for (int i = 0; i < count; i++) // Ø­Ù„Ù‚Ù‡ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
    {
        double current_sl = candidates[i]; // SL ÙØ¹Ù„ÛŒ
        
        if ((is_buy && current_sl >= entry_price) || (!is_buy && current_sl <= entry_price)) // Ú†Ú© Ù…ÙˆÙ‚Ø¹ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø±
        {
            continue;  // Ø±Ø¯ Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§
        }

        if (MathAbs(entry_price - current_sl) < min_safe_distance) // Ú†Ú© ÙØ§ØµÙ„Ù‡ Ú©Ù…
        {
            current_sl = is_buy ? entry_price - min_safe_distance : entry_price + min_safe_distance; // Ø§ØµÙ„Ø§Ø­ SL
            Log("Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡ " + (string)(i+1) + " Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ù†Ø²Ø¯ÛŒÚ©ÛŒ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¨Ù‡ Ù‚ÛŒÙ…Øª " + DoubleToString(current_sl, _Digits) + " Ø§ØµÙ„Ø§Ø­ Ø´Ø¯."); // Ù„Ø§Ú¯
        }

        ArrayResize(valid_candidates, valid_count + 1); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡
        valid_candidates[valid_count] = current_sl; // Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ Ù…Ø¹ØªØ¨Ø±Ù‡Ø§
        valid_count++; // Ø§ÙØ²Ø§ÛŒØ´
    }

    if (valid_count == 0) // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ù…Ø¹ØªØ¨Ø±
    {
        Log("Ø®Ø·Ø§: Ù¾Ø³ Ø§Ø² ÙÛŒÙ„ØªØ±ÛŒÙ†Ú¯ØŒ Ù‡ÛŒÚ† Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¨Ø§Ù‚ÛŒ Ù†Ù…Ø§Ù†Ø¯."); // Ù„Ø§Ú¯
        return 0.0; // ØµÙØ±
    }
    
    // Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ù…Ø¹ØªØ¨Ø±
    double best_sl_price = 0.0; // Ø¨Ù‡ØªØ±ÛŒÙ† SL
    double smallest_distance = DBL_MAX; // Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ Ø§ÙˆÙ„ÛŒÙ‡

    for (int i = 0; i < valid_count; i++) // Ø­Ù„Ù‚Ù‡ Ø§Ù†ØªØ®Ø§Ø¨
    {
        double distance = MathAbs(entry_price - valid_candidates[i]); // ÙØ§ØµÙ„Ù‡
        if (distance < smallest_distance) // Ø§Ú¯Ø± Ú©ÙˆÚ†Ú©ØªØ±
        {
            smallest_distance = distance; // Ø¢Ù¾Ø¯ÛŒØª Ø­Ø¯Ø§Ù‚Ù„
            best_sl_price = valid_candidates[i]; // Ø¨Ù‡ØªØ±ÛŒÙ†
        }
    }

    Log("âœ… Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¨Ù‡ÛŒÙ†Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯: " + DoubleToString(best_sl_price, _Digits) + ". ÙØ§ØµÙ„Ù‡: " + DoubleToString(smallest_distance / point, 1) + " Ù¾ÙˆÛŒÙ†Øª."); // Ù„Ø§Ú¯ Ù…ÙˆÙÙ‚ÛŒØª

    return best_sl_price; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ØªØ±ÛŒÙ† SL
}

//+------------------------------------------------------------------+
//| Ù…Ø­Ø§Ø³Ø¨Ù‡ SL Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ù†Ø¯Ù„ Ù…Ø®Ø§Ù„Ù                             |
//+------------------------------------------------------------------+
double CStrategyManager::FindBackupStopLoss(bool is_buy, double buffer, ENUM_TIMEFRAMES timeframe)
{
    int bars_to_check = m_settings.sl_lookback_period; // ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø± Ø¨Ø±Ø§ÛŒ Ú†Ú©
    if (iBars(m_symbol, timeframe) < bars_to_check + 1) return 0; // Ú†Ú© ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø±Ù‡Ø§
    
    for (int i = 1; i <= bars_to_check; i++) // Ø­Ù„Ù‚Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨
    {
        bool is_candle_bullish = (iClose(m_symbol, timeframe, i) > iOpen(m_symbol, timeframe, i)); // Ú†Ú© ØµØ¹ÙˆØ¯ÛŒ
        bool is_candle_bearish = (iClose(m_symbol, timeframe, i) < iOpen(m_symbol, timeframe, i)); // Ú†Ú© Ù†Ø²ÙˆÙ„ÛŒ

        if (is_buy) // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯
        {
            if (is_candle_bearish) // Ø§Ú¯Ø± Ù†Ø²ÙˆÙ„ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯
            {
                double sl_price = iLow(m_symbol, timeframe, i) - buffer; // SL Ø²ÛŒØ± Ú©Ù
                Log("Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø³Ø§Ø¯Ù‡: Ø§ÙˆÙ„ÛŒÙ† Ú©Ù†Ø¯Ù„ Ù†Ø²ÙˆÙ„ÛŒ Ø¯Ø± Ø´ÛŒÙØª " + (string)i + " Ù¾ÛŒØ¯Ø§ Ø´Ø¯."); // Ù„Ø§Ú¯
                return sl_price; // Ø¨Ø§Ø²Ú¯Ø´Øª
            }
        }
        else // Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´
        {
            if (is_candle_bullish) // Ø§Ú¯Ø± ØµØ¹ÙˆØ¯ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯
            {
                double sl_price = iHigh(m_symbol, timeframe, i) + buffer; // SL Ø¨Ø§Ù„Ø§ÛŒ Ø³Ù‚Ù
                Log("Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø³Ø§Ø¯Ù‡: Ø§ÙˆÙ„ÛŒÙ† Ú©Ù†Ø¯Ù„ ØµØ¹ÙˆØ¯ÛŒ Ø¯Ø± Ø´ÛŒÙØª " + (string)i + " Ù¾ÛŒØ¯Ø§ Ø´Ø¯."); // Ù„Ø§Ú¯
                return sl_price; // Ø¨Ø§Ø²Ú¯Ø´Øª
            }
        }
    }
    
    // Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø§Ú¯Ø± Ù…Ø®Ø§Ù„Ù Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
    Log("Ù‡ÛŒÚ† Ú©Ù†Ø¯Ù„ Ø±Ù†Ú¯ Ù…Ø®Ø§Ù„ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø³Ø§Ø¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø§Ø² Ø±ÙˆØ´ Ø³Ù‚Ù/Ú©Ù Ù…Ø·Ù„Ù‚ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯."); // Ù„Ø§Ú¯
    CopyHigh(m_symbol, timeframe, 1, bars_to_check, m_high_buffer); // Ú©Ù¾ÛŒ Ø³Ù‚Ùâ€ŒÙ‡Ø§
    CopyLow(m_symbol, timeframe, 1, bars_to_check, m_low_buffer); // Ú©Ù¾ÛŒ Ú©Ùâ€ŒÙ‡Ø§

    if(is_buy) // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯
    {
       int min_index = ArrayMinimum(m_low_buffer, 0, bars_to_check); // Ø­Ø¯Ø§Ù‚Ù„ Ú©Ù
       return m_low_buffer[min_index] - buffer; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ø§ Ø¨Ø§ÙØ±
    }
    else // Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´
    {
       int max_index = ArrayMaximum(m_high_buffer, 0, bars_to_check); // Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ù‚Ù
       return m_high_buffer[max_index] + buffer; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ø§ Ø¨Ø§ÙØ±
    }
}

//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª                                              |
//+------------------------------------------------------------------+
double CStrategyManager::FindFlatKijun(ENUM_TIMEFRAMES timeframe)
{
    int kijun_handle = m_ichimoku_handle; // Ù‡Ù†Ø¯Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    if (timeframe != m_settings.ichimoku_timeframe) // Ø§Ú¯Ø± Ù…ØªÙØ§ÙˆØª
    {
        MqlParam params[3]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
        params[0].type = TYPE_INT; params[0].integer_value = m_settings.tenkan_period;
        params[1].type = TYPE_INT; params[1].integer_value = m_settings.kijun_period;
        params[2].type = TYPE_INT; params[2].integer_value = m_settings.senkou_period;
        kijun_handle = IndicatorCreate(m_symbol, timeframe, IND_ICHIMOKU, 3, params); // Ù…ÙˆÙ‚Øª
        if (kijun_handle == INVALID_HANDLE) return 0.0; // Ø´Ú©Ø³Øª
    }

    double kijun_values[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ú©ÛŒØ¬ÙˆÙ†
    if (CopyBuffer(kijun_handle, 1, 1, m_settings.flat_kijun_period, kijun_values) < m_settings.flat_kijun_period) // Ú©Ù¾ÛŒ
    {
        if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯
        return 0.0; // ØµÙØ±
    }

    ArraySetAsSeries(kijun_values, true); // ØªÙ†Ø¸ÛŒÙ… Ø³Ø±ÛŒ

    int flat_count = 1; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ ÙÙ„Øª
    for (int i = 1; i < m_settings.flat_kijun_period; i++) // Ø­Ù„Ù‚Ù‡ Ú†Ú© ÙÙ„Øª
    {
        if (kijun_values[i] == kijun_values[i - 1]) // Ø§Ú¯Ø± Ø¨Ø±Ø§Ø¨Ø±
        {
            flat_count++; // Ø§ÙØ²Ø§ÛŒØ´
            if (flat_count >= m_settings.flat_kijun_min_length) // Ø§Ú¯Ø± Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„
            {
                if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯
                return kijun_values[i]; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø³Ø·Ø­ ÙÙ„Øª
            }
        }
        else // Ø±ÛŒØ³Øª ÙÙ„Øª
        {
            flat_count = 1; // Ø±ÛŒØ³Øª
        }
    }

    if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯ Ù†Ù‡Ø§ÛŒÛŒ
    return 0.0; // Ù‡ÛŒÚ† ÙÙ„Øª
}

//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾ÛŒÙˆØª Ø±ÙˆÛŒ Ú©ÛŒØ¬ÙˆÙ†                                         |
//+------------------------------------------------------------------+
double CStrategyManager::FindPivotKijun(bool is_buy, ENUM_TIMEFRAMES timeframe)
{
    int kijun_handle = m_ichimoku_handle; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    if (timeframe != m_settings.ichimoku_timeframe) // Ù…ØªÙØ§ÙˆØª
    {
        MqlParam params[3]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
        params[0].type = TYPE_INT; params[0].integer_value = m_settings.tenkan_period;
        params[1].type = TYPE_INT; params[1].integer_value = m_settings.kijun_period;
        params[2].type = TYPE_INT; params[2].integer_value = m_settings.senkou_period;
        kijun_handle = IndicatorCreate(m_symbol, timeframe, IND_ICHIMOKU, 3, params); // Ù…ÙˆÙ‚Øª
        if (kijun_handle == INVALID_HANDLE) return 0.0; // Ø´Ú©Ø³Øª
    }

    double kijun_values[]; // Ø¢Ø±Ø§ÛŒÙ‡
    if (CopyBuffer(kijun_handle, 1, 1, m_settings.pivot_lookback, kijun_values) < m_settings.pivot_lookback) // Ú©Ù¾ÛŒ
    {
        if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯
        return 0.0; // ØµÙØ±
    }

    ArraySetAsSeries(kijun_values, true); // Ø³Ø±ÛŒ

    for (int i = 1; i < m_settings.pivot_lookback - 1; i++) // Ø­Ù„Ù‚Ù‡ Ù¾ÛŒÙˆØª
    {
        if (is_buy && kijun_values[i] < kijun_values[i - 1] && kijun_values[i] < kijun_values[i + 1]) // Ø¯Ø±Ù‡ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯
        {
            if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯
            return kijun_values[i]; // Ø¨Ø§Ø²Ú¯Ø´Øª
        }
        if (!is_buy && kijun_values[i] > kijun_values[i - 1] && kijun_values[i] > kijun_values[i + 1]) // Ù‚Ù„Ù‡ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´
        {
            if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯
            return kijun_values[i]; // Ø¨Ø§Ø²Ú¯Ø´Øª
        }
    }

    if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯ Ù†Ù‡Ø§ÛŒÛŒ
    return 0.0; // Ù‡ÛŒÚ† Ù¾ÛŒÙˆØª
}

//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾ÛŒÙˆØª Ø±ÙˆÛŒ ØªÙ†Ú©Ø§Ù†                                         |
//+------------------------------------------------------------------+
double CStrategyManager::FindPivotTenkan(bool is_buy, ENUM_TIMEFRAMES timeframe)
{
    int tenkan_handle = m_ichimoku_handle; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    if (timeframe != m_settings.ichimoku_timeframe) // Ù…ØªÙØ§ÙˆØª
    {
        MqlParam params[3]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
        params[0].type = TYPE_INT; params[0].integer_value = m_settings.tenkan_period;
        params[1].type = TYPE_INT; params[1].integer_value = m_settings.kijun_period;
        params[2].type = TYPE_INT; params[2].integer_value = m_settings.senkou_period;
        tenkan_handle = IndicatorCreate(m_symbol, timeframe, IND_ICHIMOKU, 3, params); // Ù…ÙˆÙ‚Øª
        if (tenkan_handle == INVALID_HANDLE) return 0.0; // Ø´Ú©Ø³Øª
    }

    double tenkan_values[]; // Ø¢Ø±Ø§ÛŒÙ‡
    if (CopyBuffer(tenkan_handle, 0, 1, m_settings.pivot_lookback, tenkan_values) < m_settings.pivot_lookback) // Ú©Ù¾ÛŒ
    {
        if (tenkan_handle != m_ichimoku_handle) IndicatorRelease(tenkan_handle); // Ø¢Ø²Ø§Ø¯
        return 0.0; // ØµÙØ±
    }

    ArraySetAsSeries(tenkan_values, true); // Ø³Ø±ÛŒ

    for (int i = 1; i < m_settings.pivot_lookback - 1; i++) // Ø­Ù„Ù‚Ù‡ Ù¾ÛŒÙˆØª
    {
        if (is_buy && tenkan_values[i] < tenkan_values[i - 1] && tenkan_values[i] < tenkan_values[i + 1]) // Ø¯Ø±Ù‡
        {
            if (tenkan_handle != m_ichimoku_handle) IndicatorRelease(tenkan_handle); // Ø¢Ø²Ø§Ø¯
            return tenkan_values[i]; // Ø¨Ø§Ø²Ú¯Ø´Øª
        }
        if (!is_buy && tenkan_values[i] > tenkan_values[i - 1] && tenkan_values[i] > tenkan_values[i + 1]) // Ù‚Ù„Ù‡
        {
            if (tenkan_handle != m_ichimoku_handle) IndicatorRelease(tenkan_handle); // Ø¢Ø²Ø§Ø¯
            return tenkan_values[i]; // Ø¨Ø§Ø²Ú¯Ø´Øª
        }
    }

    if (tenkan_handle != m_ichimoku_handle) IndicatorRelease(tenkan_handle); // Ø¢Ø²Ø§Ø¯ Ù†Ù‡Ø§ÛŒÛŒ
    return 0.0; // Ù‡ÛŒÚ†
}

//+------------------------------------------------------------------+
//| Ù…Ø­Ø§Ø³Ø¨Ù‡ SL Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± ATR                                            |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateAtrStopLoss(bool is_buy, double entry_price, ENUM_TIMEFRAMES timeframe)
{
    if (!m_settings.enable_sl_vol_regime) // Ø§Ú¯Ø± Ù¾ÙˆÛŒØ§ ØºÛŒØ±ÙØ¹Ø§Ù„
    {
        int atr_handle = m_atr_handle; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        if (timeframe != m_settings.ichimoku_timeframe) // Ù…ØªÙØ§ÙˆØª
        {
            MqlParam params[1]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±
            params[0].type = TYPE_INT; params[0].integer_value = m_settings.atr_filter_period;
            atr_handle = IndicatorCreate(m_symbol, timeframe, IND_ATR, 1, params); // Ù…ÙˆÙ‚Øª
            if (atr_handle == INVALID_HANDLE) // Ú†Ú©
            {
                Log("Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± CalculateAtrStopLoss: Ù‡Ù†Ø¯Ù„ ATR Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª! Ù¾Ø±ÛŒÙˆØ¯ ATR Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."); // Ù„Ø§Ú¯
                return 0.0; // ØµÙØ±
            }
        }
        
        double atr_buffer[]; // Ø¨Ø§ÙØ±
        if(CopyBuffer(atr_handle, 0, 1, 1, atr_buffer) < 1) // Ú©Ù¾ÛŒ
        {
            Log("Ø¯Ø§Ø¯Ù‡ ATR Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯ Ø¶Ø±Ø± Ø³Ø§Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª. (ØªØ§Ø¨Ø¹ CopyBuffer Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯)"); // Ù„Ø§Ú¯
            if (atr_handle != m_atr_handle) IndicatorRelease(atr_handle); // Ø¢Ø²Ø§Ø¯
            return 0.0; // ØµÙØ±
        }
        
        if (atr_handle != m_atr_handle) IndicatorRelease(atr_handle); // Ø¢Ø²Ø§Ø¯
        
        double atr_value = atr_buffer[0]; // Ù…Ù‚Ø¯Ø§Ø± ATR
        double sl = is_buy ? entry_price - (atr_value * m_settings.sl_atr_multiplier) : entry_price + (atr_value * m_settings.sl_atr_multiplier); // SL Ø§ÙˆÙ„ÛŒÙ‡
        // [NEW] Ø§Ø¹Ù…Ø§Ù„ Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ Ùˆ Ø¨Ø§ÙØ± ATR-based
        double min_distance = atr_value * m_settings.min_sl_distance_atr_percent / 100.0; // Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡
        double atr_buffer_val = atr_value * m_settings.sl_buffer_atr_percent / 100.0; // Ø¨Ø§ÙØ± ATR
        if (MathAbs(entry_price - sl) < min_distance) // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„
        {
            sl = is_buy ? entry_price - min_distance : entry_price + min_distance; // Ø§ØµÙ„Ø§Ø­
        }
        sl = is_buy ? sl - atr_buffer_val : sl + atr_buffer_val; // Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø§ÙØ±
        return sl; // Ø¨Ø§Ø²Ú¯Ø´Øª SL Ù†Ù‡Ø§ÛŒÛŒ
    }

    // Ù…Ù†Ø·Ù‚ Ù¾ÙˆÛŒØ§
    int history_size = m_settings.sl_vol_regime_ema_period + 5; // Ø§Ù†Ø¯Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
    double atr_values[], ema_values[]; // Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§

    int atr_sl_handle = iATR(m_symbol, timeframe, m_settings.sl_vol_regime_atr_period); // Ù‡Ù†Ø¯Ù„ ATR
    if (atr_sl_handle == INVALID_HANDLE || CopyBuffer(atr_sl_handle, 0, 0, history_size, atr_values) < history_size) // Ú†Ú©
    {
        Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ SL Ù¾ÙˆÛŒØ§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª."); // Ù„Ø§Ú¯
        if(atr_sl_handle != INVALID_HANDLE) 
            IndicatorRelease(atr_sl_handle); // Ø¢Ø²Ø§Ø¯
        return 0.0; // ØµÙØ±
    }
    
    IndicatorRelease(atr_sl_handle); // Ø¢Ø²Ø§Ø¯
    ArraySetAsSeries(atr_values, true);  // Ø³Ø±ÛŒ

    if(SimpleMAOnBuffer(history_size, 0, m_settings.sl_vol_regime_ema_period, MODE_EMA, atr_values, ema_values) < 1) // Ù…Ø­Ø§Ø³Ø¨Ù‡ EMA
    {
         Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ EMA Ø±ÙˆÛŒ ATR."); // Ù„Ø§Ú¯
         return 0.0; // ØµÙØ±
    }

    double current_atr = atr_values[1];  // ATR Ø´ÛŒÙØª 1
    double ema_atr = ema_values[1];      // EMA Ø´ÛŒÙØª 1

    bool is_high_volatility = (current_atr > ema_atr); // Ú†Ú© Ø±Ú˜ÛŒÙ… Ø¨Ø§Ù„Ø§
    double final_multiplier = is_high_volatility ? m_settings.sl_high_vol_multiplier : m_settings.sl_low_vol_multiplier; // Ø¶Ø±ÛŒØ¨ Ù†Ù‡Ø§ÛŒÛŒ

    Log("Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù†: " + (is_high_volatility ? "Ø¨Ø§Ù„Ø§" : "Ù¾Ø§ÛŒÛŒÙ†") + ". Ø¶Ø±ÛŒØ¨ SL Ù†Ù‡Ø§ÛŒÛŒ: " + (string)final_multiplier); // Ù„Ø§Ú¯

    double sl = is_buy ? entry_price - (current_atr * final_multiplier) : entry_price + (current_atr * final_multiplier); // SL Ù¾ÙˆÛŒØ§
    // [NEW] Ø§Ø¹Ù…Ø§Ù„ Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ Ùˆ Ø¨Ø§ÙØ± ATR-based
    double min_distance = current_atr * m_settings.min_sl_distance_atr_percent / 100.0; // Ø­Ø¯Ø§Ù‚Ù„
    double atr_buffer_val = current_atr * m_settings.sl_buffer_atr_percent / 100.0; // Ø¨Ø§ÙØ±
    if (MathAbs(entry_price - sl) < min_distance) // Ú†Ú©
    {
        sl = is_buy ? entry_price - min_distance : entry_price + min_distance; // Ø§ØµÙ„Ø§Ø­
    }
    sl = is_buy ? sl - atr_buffer_val : sl + atr_buffer_val; // Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø§ÙØ±
    return sl; // Ø¨Ø§Ø²Ú¯Ø´Øª
}

//+------------------------------------------------------------------+
//| Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„Ø±Ø§Ù†Ø³ ØªÙ„Ø§Ù‚ÛŒ                                               |
//+------------------------------------------------------------------+
double CStrategyManager::GetTalaqiTolerance(int reference_shift)
{
    switch(m_settings.talaqi_calculation_mode) // Ø³ÙˆØ¦ÛŒÚ† Ø­Ø§Ù„Øª
    {
        case TALAQI_MODE_MANUAL: // Ø¯Ø³ØªÛŒ
            return m_settings.talaqi_distance_in_points * SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÙˆÛŒÙ†Øª
        case TALAQI_MODE_KUMO: // Ú©ÙˆÙ…Ùˆ
            return CalculateDynamicTolerance(reference_shift); // Ù¾ÙˆÛŒØ§ Ú©ÙˆÙ…Ùˆ
        case TALAQI_MODE_ATR: // ATR
            return CalculateAtrTolerance(reference_shift);     // ATR
        default: // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            return 0.0; // Ø¨Ø¯ÙˆÙ† ØªÙ„Ø±Ø§Ù†Ø³
    }
}

//+------------------------------------------------------------------+
//| Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„Ø±Ø§Ù†Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©ÙˆÙ…Ùˆ                                       |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateDynamicTolerance(int reference_shift)
{
    if(m_settings.talaqi_kumo_factor <= 0) return 0.0; // Ø§Ú¯Ø± Ø¶Ø±ÛŒØ¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø±

    double senkou_a_buffer[], senkou_b_buffer[]; // Ø¨Ø§ÙØ±Ù‡Ø§ÛŒ Ø³Ù†Ú©Ùˆ

    if(CopyBuffer(m_ichimoku_handle, 2, reference_shift, 1, senkou_a_buffer) < 1 || 
       CopyBuffer(m_ichimoku_handle, 3, reference_shift, 1, senkou_b_buffer) < 1)
    {
       Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯."); // Ù„Ø§Ú¯
       return 0.0; // ØµÙØ±
    }

    double kumo_thickness = MathAbs(senkou_a_buffer[0] - senkou_b_buffer[0]); // Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ

    if(kumo_thickness == 0) return SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ø­Ø¯Ø§Ù‚Ù„ Ú©ÙˆÚ†Ú©

    double tolerance = kumo_thickness * m_settings.talaqi_kumo_factor; // ØªÙ„Ø±Ø§Ù†Ø³

    return tolerance; // Ø¨Ø§Ø²Ú¯Ø´Øª
}

//+------------------------------------------------------------------+
//| Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¯Ø± Ø­Ø§Ù„Øª Ù…Ø³Ø§Ø¨Ù‚Ù‡                        |
//+------------------------------------------------------------------+
void CStrategyManager::AddOrUpdatePotentialSignal(bool is_buy)
{
    int total = ArraySize(m_potential_signals); // ØªØ¹Ø¯Ø§Ø¯ ÙØ¹Ù„ÛŒ
    ArrayResize(m_potential_signals, total + 1); // Ø§Ø¶Ø§ÙÙ‡ ÛŒÚ© Ø¹Ø¶Ùˆ
    
    m_potential_signals[total].time = iTime(m_symbol, m_settings.ichimoku_timeframe, m_settings.chikou_period); // Ø²Ù…Ø§Ù†
    m_potential_signals[total].is_buy = is_buy; // Ù†ÙˆØ¹
    m_potential_signals[total].grace_candle_count = 0; // Ø±ÛŒØ³Øª Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
    
    Log("[Ø­Ø§Ù„Øª Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ] Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù†Ø§Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ " + (is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§: " + (string)ArraySize(m_potential_signals)); // Ù„Ø§Ú¯
    
    if(m_symbol == _Symbol && m_visual_manager != NULL) // Ú†Ú© Ø±Ø³Ù…
    m_visual_manager.DrawTripleCrossRectangle(is_buy, m_settings.chikou_period); // Ø±Ø³Ù…
}

//+------------------------------------------------------------------+
//| Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„Ø±Ø§Ù†Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ ATR                                        |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateAtrTolerance(int reference_shift)
{
    if(m_settings.talaqi_atr_multiplier <= 0) return 0.0; // Ø§Ú¯Ø± Ø¶Ø±ÛŒØ¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
    
    if (m_atr_handle == INVALID_HANDLE) // Ú†Ú© Ù‡Ù†Ø¯Ù„
    {
        Log("Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„ÙˆØ±Ø§Ù†Ø³ ATR Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª Ú†ÙˆÙ† Ù‡Ù†Ø¯Ù„ Ø¢Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù¾Ø±ÛŒÙˆØ¯ ATR Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."); // Ù„Ø§Ú¯
        return 0.0; // ØµÙØ±
    }

    double atr_buffer[]; // Ø¨Ø§ÙØ±
    if(CopyBuffer(m_atr_handle, 0, reference_shift, 1, atr_buffer) < 1) // Ú©Ù¾ÛŒ
    {
        Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ATR Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯."); // Ù„Ø§Ú¯
        return 0.0; // ØµÙØ±
    }
    
    double tolerance = atr_buffer[0] * m_settings.talaqi_atr_multiplier; // ØªÙ„Ø±Ø§Ù†Ø³
    return tolerance; // Ø¨Ø§Ø²Ú¯Ø´Øª
}

//+------------------------------------------------------------------+
//| Ú†Ú© ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯                                            |
//+------------------------------------------------------------------+
bool CStrategyManager::AreAllFiltersPassed(bool is_buy)
{
    ENUM_TIMEFRAMES filter_tf = (m_settings.filter_context == FILTER_CONTEXT_HTF) 
                                ? m_settings.ichimoku_timeframe 
                                : m_settings.ltf_timeframe; // ØªØ§ÛŒÙ… ÙÛŒÙ„ØªØ±

    if (m_settings.enable_kumo_filter) // ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ
    {
        if (!CheckKumoFilter(is_buy, filter_tf)) // Ú†Ú©
        {
            Log("ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ Ø±Ø¯ Ø´Ø¯."); // Ù„Ø§Ú¯
            return false; // Ø±Ø¯
        }
    }

    if (m_settings.enable_atr_filter) // ÙÛŒÙ„ØªØ± ATR
    {
        if (!CheckAtrFilter(filter_tf)) // Ú†Ú©
        {
            Log("ÙÛŒÙ„ØªØ± ATR Ø±Ø¯ Ø´Ø¯."); // Ù„Ø§Ú¯
            return false; // Ø±Ø¯
        }
    }

    if (m_settings.enable_adx_filter) // ÙÛŒÙ„ØªØ± ADX
    {
        if (!CheckAdxFilter(is_buy, filter_tf)) // Ú†Ú©
        {
            Log("ÙÛŒÙ„ØªØ± ADX Ø±Ø¯ Ø´Ø¯."); // Ù„Ø§Ú¯
            return false; // Ø±Ø¯
        }
    }

    // ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ MKM
    if (m_settings.enable_kijun_slope_filter) // Ø´ÛŒØ¨ Ú©ÛŒØ¬ÙˆÙ†
    {
        double threshold = 0.0; // Ø¢Ø³ØªØ§Ù†Ù‡
        double slope = CalculateKijunSlope(filter_tf, 5, threshold); // Ù…Ø­Ø§Ø³Ø¨Ù‡
        if (is_buy && slope <= threshold) return false; // Ø±Ø¯ Ø®Ø±ÛŒØ¯
        if (!is_buy && slope >= -threshold) return false; // Ø±Ø¯ ÙØ±ÙˆØ´
    }
    if (m_settings.enable_kumo_expansion_filter) // Ø§Ù†Ø¨Ø³Ø§Ø· Ú©ÙˆÙ…Ùˆ
    {
        if (!IsKumoExpanding(filter_tf, 20)) return false; // Ø±Ø¯
    }
    if (m_settings.enable_chikou_space_filter) // ÙØ¶Ø§ÛŒ Ú†ÛŒÚ©Ùˆ
    {
        if (!IsChikouInOpenSpace(is_buy, filter_tf)) return false; // Ø±Ø¯
    }

    Log("âœ… ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ø³ Ø´Ø¯Ù†Ø¯."); // Ù„Ø§Ú¯ Ù…ÙˆÙÙ‚ÛŒØª
    return true; // Ù¾Ø§Ø³
}

//+------------------------------------------------------------------+
//| ÙÛŒÙ„ØªØ± Ù…ÙˆÙ‚Ø¹ÛŒØª Ù†Ø³Ø¨Øª Ø¨Ù‡ Ú©ÙˆÙ…Ùˆ                                         |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckKumoFilter(bool is_buy, ENUM_TIMEFRAMES timeframe)
{
    int ichi_handle = m_ichimoku_handle; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    if (timeframe != m_settings.ichimoku_timeframe) // Ù…ØªÙØ§ÙˆØª
    {
        MqlParam params[3]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
        params[0].type = TYPE_INT; params[0].integer_value = m_settings.tenkan_period;
        params[1].type = TYPE_INT; params[1].integer_value = m_settings.kijun_period;
        params[2].type = TYPE_INT; params[2].integer_value = m_settings.senkou_period;
        ichi_handle = IndicatorCreate(m_symbol, timeframe, IND_ICHIMOKU, 3, params); // Ù…ÙˆÙ‚Øª
        if (ichi_handle == INVALID_HANDLE) // Ú†Ú©
        {
            Log("Ø®Ø·Ø§: Ù‡Ù†Ø¯Ù„ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… " + EnumToString(timeframe) + " Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯."); // Ù„Ø§Ú¯
            return false; // Ø±Ø¯
        }
    }
    
    double senkou_a[], senkou_b[]; // Ø¨Ø§ÙØ±Ù‡Ø§
    if(CopyBuffer(ichi_handle, 2, 0, 1, senkou_a) < 1 || 
       CopyBuffer(ichi_handle, 3, 0, 1, senkou_b) < 1)
    {
       Log("Ø®Ø·Ø§: Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª."); // Ù„Ø§Ú¯
       if (ichi_handle != m_ichimoku_handle) IndicatorRelease(ichi_handle); // Ø¢Ø²Ø§Ø¯
       return false; // Ø±Ø¯
    }
    
    if (ichi_handle != m_ichimoku_handle) IndicatorRelease(ichi_handle); // Ø¢Ø²Ø§Ø¯
    
    double high_kumo = MathMax(senkou_a[0], senkou_b[0]); // Ø¨Ø§Ù„Ø§ÛŒ Ú©ÙˆÙ…Ùˆ
    double low_kumo = MathMin(senkou_a[0], senkou_b[0]); // Ù¾Ø§ÛŒÛŒÙ† Ú©ÙˆÙ…Ùˆ
    double close_price = iClose(m_symbol, timeframe, 1); // Ø¨Ø³ØªÙ‡ Ø´ÛŒÙØª 1

    if (is_buy) // Ø®Ø±ÛŒØ¯
    {
        return (close_price > high_kumo); // Ø¨Ø§Ù„Ø§ÛŒ Ú©ÙˆÙ…Ùˆ
    }
    else // ÙØ±ÙˆØ´
    {
        return (close_price < low_kumo); // Ù¾Ø§ÛŒÛŒÙ† Ú©ÙˆÙ…Ùˆ
    }
}

//+------------------------------------------------------------------+
//| ÙÛŒÙ„ØªØ± Ø­Ø¯Ø§Ù‚Ù„ ATR                                                   |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckAtrFilter(ENUM_TIMEFRAMES timeframe)
{
    int atr_handle = m_atr_handle; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    if (timeframe != m_settings.ichimoku_timeframe) // Ù…ØªÙØ§ÙˆØª
    {
        MqlParam params[1]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±
        params[0].type = TYPE_INT; params[0].integer_value = m_settings.atr_filter_period;
        atr_handle = IndicatorCreate(m_symbol, timeframe, IND_ATR, 1, params); // Ù…ÙˆÙ‚Øª
        if (atr_handle == INVALID_HANDLE) // Ú†Ú©
        {
            Log("ÙÛŒÙ„ØªØ± ATR Ø±Ø¯ Ø´Ø¯ Ú†ÙˆÙ† Ù‡Ù†Ø¯Ù„ Ø¢Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù¾Ø±ÛŒÙˆØ¯ ATR Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."); // Ù„Ø§Ú¯
            return false; // Ø±Ø¯
        }
    }
    
    double atr_value_buffer[]; // Ø¨Ø§ÙØ±
    if(CopyBuffer(atr_handle, 0, 1, 1, atr_value_buffer) < 1) // Ú©Ù¾ÛŒ
    {
       Log("Ø®Ø·Ø§: Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± ATR Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª."); // Ù„Ø§Ú¯
       if (atr_handle != m_atr_handle) IndicatorRelease(atr_handle); // Ø¢Ø²Ø§Ø¯
       return false; // Ø±Ø¯
    }
    
    if (atr_handle != m_atr_handle) IndicatorRelease(atr_handle); // Ø¢Ø²Ø§Ø¯
    
    double current_atr = atr_value_buffer[0]; // ATR ÙØ¹Ù„ÛŒ
    
    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ù¾ÙˆÛŒÙ†Øª
    double min_atr_threshold = m_settings.atr_filter_min_value_pips * point; // Ø¢Ø³ØªØ§Ù†Ù‡
    
    if(_Digits == 3 || _Digits == 5) // ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ 3 ÛŒØ§ 5 Ø±Ù‚Ù…ÛŒ
    {
        min_atr_threshold *= 10; // Ø¶Ø±Ø¨ Ø¯Ø± 10
    }

    return (current_atr >= min_atr_threshold); // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„
}

//+------------------------------------------------------------------+
//| ÙÛŒÙ„ØªØ± ADX                                                         |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckAdxFilter(bool is_buy, ENUM_TIMEFRAMES timeframe) 
{  
    int adx_handle = m_adx_handle; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    if (timeframe != m_settings.ichimoku_timeframe) // Ù…ØªÙØ§ÙˆØª
    {
        MqlParam params[1]; // Ù¾Ø§Ø±Ø§Ù…ØªØ±
        params[0].type = TYPE_INT; params[0].integer_value = m_settings.adx_period;
        adx_handle = IndicatorCreate(m_symbol, timeframe, IND_ADX, 1, params); // Ù…ÙˆÙ‚Øª
        if (adx_handle == INVALID_HANDLE) // Ú†Ú©
        {
            Log("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ù„ ADX Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… " + EnumToString(timeframe)); // Ù„Ø§Ú¯
            return false; // Ø±Ø¯
        }
    }
    
    double adx_buffer[1], di_plus_buffer[1], di_minus_buffer[1];  // Ø¨Ø§ÙØ±Ù‡Ø§
    
    if (CopyBuffer(adx_handle, 0, 1, 1, adx_buffer) < 1 ||  // ADX
        CopyBuffer(adx_handle, 1, 1, 1, di_plus_buffer) < 1 ||  // DI+
        CopyBuffer(adx_handle, 2, 1, 1, di_minus_buffer) < 1) // DI-
    {
        Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± ADX Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª."); // Ù„Ø§Ú¯
        if (adx_handle != m_adx_handle) IndicatorRelease(adx_handle); // Ø¢Ø²Ø§Ø¯
        return false; // Ø±Ø¯
    }
    
    if (adx_handle != m_adx_handle) IndicatorRelease(adx_handle); // Ø¢Ø²Ø§Ø¯
    
    if (adx_buffer[0] <= m_settings.adx_threshold)  // Ú†Ú© Ù‚Ø¯Ø±Øª
    {
        return false; // Ø±Ø¯
    }
    
    if (is_buy) // Ø®Ø±ÛŒØ¯
    {
        return (di_plus_buffer[0] > di_minus_buffer[0]); // DI+ > DI-
    }
    else // ÙØ±ÙˆØ´
    {
        return (di_minus_buffer[0] > di_plus_buffer[0]); // DI- > DI+
    }
}

//+------------------------------------------------------------------+
//| Ú†Ú© Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ Ø§Ø² Ù…Ø¹Ø§Ù…Ù„Ø§Øª                                         |
//+------------------------------------------------------------------+
void CStrategyManager::CheckForEarlyExit()
{
    for (int i = PositionsTotal() - 1; i >= 0; i--)  // Ø­Ù„Ù‚Ù‡ Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§
    {
        ulong ticket = PositionGetTicket(i); // ØªÛŒÚ©Øª Ù¾ÙˆØ²ÛŒØ´Ù†
        if (PositionGetString(POSITION_SYMBOL) == m_symbol && PositionGetInteger(POSITION_MAGIC) == (long)m_settings.magic_number) // Ú†Ú© Ù†Ù…Ø§Ø¯ Ùˆ Ù…Ø¬ÛŒÚ©
        {
            if (PositionSelectByTicket(ticket)) // Ø§Ù†ØªØ®Ø§Ø¨ Ù¾ÙˆØ²ÛŒØ´Ù†
            {
                bool is_buy = (PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_BUY); // Ù†ÙˆØ¹ Ù¾ÙˆØ²ÛŒØ´Ù†
                if (CheckChikouRsiExit(is_buy))  // Ú†Ú© Ø´Ø±Ø§ÛŒØ· Ø®Ø±ÙˆØ¬
                { 
                    Log("ğŸš¨ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + " ØµØ§Ø¯Ø± Ø´Ø¯. Ø¨Ø³ØªÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡..."); // Ù„Ø§Ú¯
                    m_trade.PositionClose(ticket);  // Ø¨Ø³ØªÙ† Ù¾ÙˆØ²ÛŒØ´Ù†
                }
            }
        }
    }
}

//+------------------------------------------------------------------+
//| Ú†Ú© Ø´Ø±Ø§ÛŒØ· Ø®Ø±ÙˆØ¬ Ø¨Ø§ Ú†ÛŒÚ©Ùˆ Ùˆ RSI                                      |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckChikouRsiExit(bool is_buy)
{
    double chikou_price = iClose(m_symbol, m_settings.ichimoku_timeframe, 1); // Ú†ÛŒÚ©Ùˆ Ø´ÛŒÙØª 1
    
    double tenkan_buffer[1], kijun_buffer[1], rsi_buffer[1]; // Ø¨Ø§ÙØ±Ù‡Ø§
    if(CopyBuffer(m_ichimoku_handle, 0, 1, 1, tenkan_buffer) < 1 ||
       CopyBuffer(m_ichimoku_handle, 1, 1, 1, kijun_buffer) < 1 ||
       CopyBuffer(m_rsi_exit_handle, 0, 1, 1, rsi_buffer) < 1)
    {
        return false; // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¨ÙˆØ¯
    }
    
    double tenkan = tenkan_buffer[0]; // ØªÙ†Ú©Ø§Ù†
    double kijun = kijun_buffer[0]; // Ú©ÛŒØ¬ÙˆÙ†
    double rsi = rsi_buffer[0]; // RSI
    
    bool chikou_cross_confirms_exit = false; // ÙÙ„Ú¯ Ú†ÛŒÚ©Ùˆ
    bool rsi_confirms_exit = false; // ÙÙ„Ú¯ RSI

    if (is_buy) // Ø®Ø±ÙˆØ¬ Ø§Ø² Ø®Ø±ÛŒØ¯ (Ù†Ø²ÙˆÙ„ÛŒ)
    {
        chikou_cross_confirms_exit = (chikou_price < MathMin(tenkan, kijun)); // Ú†ÛŒÚ©Ùˆ Ø²ÛŒØ± Ø®Ø·ÙˆØ·
        rsi_confirms_exit = (rsi < m_settings.early_exit_rsi_oversold); // RSI Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´
    }
    else // Ø®Ø±ÙˆØ¬ Ø§Ø² ÙØ±ÙˆØ´ (ØµØ¹ÙˆØ¯ÛŒ)
    {
        chikou_cross_confirms_exit = (chikou_price > MathMax(tenkan, kijun)); // Ú†ÛŒÚ©Ùˆ Ø¨Ø§Ù„Ø§ÛŒ Ø®Ø·ÙˆØ·
        rsi_confirms_exit = (rsi > m_settings.early_exit_rsi_overbought); // RSI Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯
    }
    
    return (chikou_cross_confirms_exit && rsi_confirms_exit); // Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ú¯Ø± Ù‡Ø± Ø¯Ùˆ
}

//+------------------------------------------------------------------+
//| Ú†Ú© ØªØ§ÛŒÛŒØ¯ LTF (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)                                         |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckLowerTfConfirmation(bool is_buy)
{
    if (is_buy)
    {
        if (m_ltf_analyzer.IsUptrend())
        {
            Log("âœ… ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø³Ø§Ø®ØªØ§Ø± ØµØ¹ÙˆØ¯ÛŒ (HH/HL) Ø¯Ø± LTF Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.");
            return true;
        }
    }
    else 
    {
        if (m_ltf_analyzer.IsDowntrend())
        {
            Log("âœ… ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø³Ø§Ø®ØªØ§Ø± Ù†Ø²ÙˆÙ„ÛŒ (LH/LL) Ø¯Ø± LTF Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.");
            return true;
        }
    }
    return false;
}

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯                                                          |
//+------------------------------------------------------------------+
void CStrategyManager::Log(string message)
{
    if (m_settings.enable_logging) // Ø§Ú¯Ø± Ù„Ø§Ú¯ ÙØ¹Ø§Ù„
    {
        Print(m_symbol, ": ", message); // Ú†Ø§Ù¾ Ù¾ÛŒØ§Ù…
    }
}

//+------------------------------------------------------------------+
//| Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù†Ù…Ø§Ø¯                                               |
//+------------------------------------------------------------------+
int CStrategyManager::CountSymbolTrades()
{
    int count = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
    for(int i = PositionsTotal() - 1; i >= 0; i--) // Ø­Ù„Ù‚Ù‡ Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§
    {
        if(PositionGetSymbol(i) == m_symbol && PositionGetInteger(POSITION_MAGIC) == (long)m_settings.magic_number) // Ú†Ú©
        {
            count++; // Ø§ÙØ²Ø§ÛŒØ´
        }
    }
    return count; // Ø¨Ø§Ø²Ú¯Ø´Øª
}

//+------------------------------------------------------------------+
//| Ø´Ù…Ø§Ø±Ø´ Ú©Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª                                                 |
//+------------------------------------------------------------------+
int CStrategyManager::CountTotalTrades()
{
    int count = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
    for(int i = PositionsTotal() - 1; i >= 0; i--) // Ø­Ù„Ù‚Ù‡
    {
        if(PositionGetInteger(POSITION_MAGIC) == (long)m_settings.magic_number) // Ú†Ú© Ù…Ø¬ÛŒÚ©
        {
            count++; // Ø§ÙØ²Ø§ÛŒØ´
        }
    }
    return count; // Ø¨Ø§Ø²Ú¯Ø´Øª
}

//+------------------------------------------------------------------+
//| Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡                                                  |
//+------------------------------------------------------------------+
void CStrategyManager::OpenTrade(bool is_buy)
{
    if(CountTotalTrades() >= m_settings.max_total_trades || CountSymbolTrades() >= m_settings.max_trades_per_symbol) // Ú†Ú© Ø­Ø¯
    {
        Log("Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø­Ø¯ Ù…Ø¬Ø§Ø² Ù…Ø¹Ø§Ù…Ù„Ø§Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ù†Ø´Ø¯."); // Ù„Ø§Ú¯
        return; // Ø®Ø±ÙˆØ¬
    }

    double entry_price = is_buy ? SymbolInfoDouble(m_symbol, SYMBOL_ASK) : SymbolInfoDouble(m_symbol, SYMBOL_BID); // Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯
    double sl = CalculateStopLoss(is_buy, entry_price); // Ù…Ø­Ø§Ø³Ø¨Ù‡ SL

    if(sl == 0) // Ú†Ú© SL
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯."); // Ù„Ø§Ú¯
        return; // Ø®Ø±ÙˆØ¬
    }
    
    double balance = AccountInfoDouble(ACCOUNT_BALANCE); // Ø¨Ø§Ù„Ø§Ù†Ø³ Ø­Ø³Ø§Ø¨
    double risk_amount = balance * (m_settings.risk_percent_per_trade / 100.0); // Ø±ÛŒØ³Ú© Ø¨Ù‡ Ù¾ÙˆÙ„

    double loss_for_one_lot = 0; // Ø¶Ø±Ø± ÛŒÚ© Ù„Ø§Øª
    if(!OrderCalcProfit(is_buy ? ORDER_TYPE_BUY : ORDER_TYPE_SELL, m_symbol, 1.0, entry_price, sl, loss_for_one_lot)) // Ù…Ø­Ø§Ø³Ø¨Ù‡
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø¨Ø§ OrderCalcProfit. Ú©Ø¯ Ø®Ø·Ø§: " + (string)GetLastError()); // Ù„Ø§Ú¯
        return; // Ø®Ø±ÙˆØ¬
    }
    loss_for_one_lot = MathAbs(loss_for_one_lot); // Ù…Ø·Ù„Ù‚ Ø¶Ø±Ø±

    if(loss_for_one_lot <= 0) // Ú†Ú© Ù…Ø¹ØªØ¨Ø±
    {
        Log("Ù…ÛŒØ²Ø§Ù† Ø¶Ø±Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Û± Ù„Ø§Øª Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯."); // Ù„Ø§Ú¯
        return; // Ø®Ø±ÙˆØ¬
    }

    double lot_size = NormalizeDouble(risk_amount / loss_for_one_lot, 2); // Ø­Ø¬Ù… Ù„Ø§Øª

    double min_lot = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_MIN); // Ø­Ø¯Ø§Ù‚Ù„ Ù„Ø§Øª
    double max_lot = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_MAX); // Ø­Ø¯Ø§Ú©Ø«Ø± Ù„Ø§Øª
    double lot_step = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_STEP); // Ú¯Ø§Ù… Ù„Ø§Øª
    
    lot_size = MathMax(min_lot, MathMin(max_lot, lot_size)); // Ù…Ø­Ø¯ÙˆØ¯Ù‡
    lot_size = MathRound(lot_size / lot_step) * lot_step; // Ú¯Ø±Ø¯ Ú©Ø±Ø¯Ù†

    if(lot_size < min_lot) // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„
    {
        Log("Ø­Ø¬Ù… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ (" + DoubleToString(lot_size,2) + ") Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯Ø§Ù‚Ù„ Ù„Ø§Øª Ù…Ø¬Ø§Ø² (" + DoubleToString(min_lot,2) + ") Ø§Ø³Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯."); // Ù„Ø§Ú¯
        return; // Ø®Ø±ÙˆØ¬
    }

    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT); // Ù¾ÙˆÛŒÙ†Øª
    double sl_distance_points = MathAbs(entry_price - sl) / point; // ÙØ§ØµÙ„Ù‡ SL Ø¨Ù‡ Ù¾ÙˆÛŒÙ†Øª
    double tp_distance_points = sl_distance_points * m_settings.take_profit_ratio; // ÙØ§ØµÙ„Ù‡ TP
    double tp = is_buy ? entry_price + tp_distance_points * point : entry_price - tp_distance_points * point; // TP
    
    int digits = (int)SymbolInfoInteger(m_symbol, SYMBOL_DIGITS); // digits Ù†Ù…Ø§Ø¯
    sl = NormalizeDouble(sl, digits); // Ù†Ø±Ù…Ø§Ù„ SL
    tp = NormalizeDouble(tp, digits); // Ù†Ø±Ù…Ø§Ù„ TP
    
    string comment = "Memento " + (is_buy ? "Buy" : "Sell"); // Ú©Ø§Ù…Ù†Øª Ù…Ø¹Ø§Ù…Ù„Ù‡
    MqlTradeResult result; // Ù†ØªÛŒØ¬Ù‡ Ù…Ø¹Ø§Ù…Ù„Ù‡
    
    if(is_buy) // Ø®Ø±ÛŒØ¯
    {
        m_trade.Buy(lot_size, m_symbol, 0, sl, tp, comment); // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø®Ø±ÛŒØ¯
    }
    else // ÙØ±ÙˆØ´
    {
        m_trade.Sell(lot_size, m_symbol, 0, sl, tp, comment); // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙØ±ÙˆØ´
    }
    
    if(m_trade.ResultRetcode() == TRADE_RETCODE_DONE) // Ú†Ú© Ù…ÙˆÙÙ‚ÛŒØª
    {
        Log("Ù…Ø¹Ø§Ù…Ù„Ù‡ " + comment + " Ø¨Ø§ Ù„Ø§Øª " + DoubleToString(lot_size, 2) + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø² Ø´Ø¯."); // Ù„Ø§Ú¯
    }
    else // Ø´Ú©Ø³Øª
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ " + comment + ": " + (string)m_trade.ResultRetcode() + " - " + m_trade.ResultComment()); // Ù„Ø§Ú¯
    }
}

//+------------------------------------------------------------------+
//| Ú†Ú© Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§                                             |
//+------------------------------------------------------------------+
bool CStrategyManager::IsDataReady()
{
    ENUM_TIMEFRAMES timeframes_to_check[3]; // Ø¢Ø±Ø§ÛŒÙ‡ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…â€ŒÙ‡Ø§
    timeframes_to_check[0] = m_settings.ichimoku_timeframe; // HTF
    timeframes_to_check[1] = m_settings.ltf_timeframe;      // LTF
    timeframes_to_check[2] = PERIOD_CURRENT;                 // ÙØ¹Ù„ÛŒ

    int required_bars = 200;  // Ø­Ø¯Ø§Ù‚Ù„ Ø¨Ø§Ø± Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²

    for(int i = 0; i < 3; i++) // Ø­Ù„Ù‚Ù‡ Ú†Ú©
    {
        ENUM_TIMEFRAMES tf = timeframes_to_check[i]; // ØªØ§ÛŒÙ… ÙØ¹Ù„ÛŒ
        if(iBars(m_symbol, tf) < required_bars || iTime(m_symbol, tf, 1) == 0) // Ú†Ú© Ø¨Ø§Ø± Ùˆ Ø²Ù…Ø§Ù†
        {
            // Log("Ø¯Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… " + EnumToString(tf) + " Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª.");
            return false; // Ù†Ù‡ Ø¢Ù…Ø§Ø¯Ù‡
        }
    }
    
    return true;  // Ø¢Ù…Ø§Ø¯Ù‡
}

//+------------------------------------------------------------------+
//| Ú†Ú© Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯                                                      |
//+------------------------------------------------------------------+
bool CStrategyManager::IsNewBar(ENUM_TIMEFRAMES timeframe, datetime &last_bar_time)
{
    datetime current_bar_time = iTime(m_symbol, timeframe, 0); // Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ
    if (current_bar_time > last_bar_time) // Ø§Ú¯Ø± Ø¬Ø¯ÛŒØ¯
    {
        last_bar_time = current_bar_time; // Ø¢Ù¾Ø¯ÛŒØª
        return true; // Ø¬Ø¯ÛŒØ¯
    }
    return false; // Ù‚Ø¯ÛŒÙ…ÛŒ
}

//+------------------------------------------------------------------+
//| Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÛŒØ¨ Ú©ÛŒØ¬ÙˆÙ†                                                 |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateKijunSlope(ENUM_TIMEFRAMES timeframe, int period, double& threshold)
{
    threshold = 0.0; // Ø¢Ø³ØªØ§Ù†Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶

    int kijun_handle = (timeframe == m_settings.ichimoku_timeframe) ? m_ichimoku_handle : iIchimoku(m_symbol, timeframe, m_settings.tenkan_period, m_settings.kijun_period, m_settings.senkou_period); // Ù‡Ù†Ø¯Ù„
    if (kijun_handle == INVALID_HANDLE) return 0.0; // Ø´Ú©Ø³Øª

    double kijun_buffer[]; // Ø¨Ø§ÙØ±
    if (CopyBuffer(kijun_handle, 1, 0, period + 1, kijun_buffer) < period + 1) // Ú©Ù¾ÛŒ
    {
        if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯
        return 0.0; // ØµÙØ±
    }

    if (kijun_handle != m_ichimoku_handle) IndicatorRelease(kijun_handle); // Ø¢Ø²Ø§Ø¯

    ArraySetAsSeries(kijun_buffer, true); // Ø³Ø±ÛŒ
    double current_kijun = kijun_buffer[0]; // ÙØ¹Ù„ÛŒ
    double past_kijun = kijun_buffer[period]; // Ú¯Ø°Ø´ØªÙ‡

    double slope = (current_kijun - past_kijun) / period; // Ø´ÛŒØ¨
    return slope; // Ø¨Ø§Ø²Ú¯Ø´Øª
}

//+------------------------------------------------------------------+
//| Ú†Ú© Ø§Ù†Ø¨Ø³Ø§Ø· Ú©ÙˆÙ…Ùˆ - Ø¨Ù‡Ø¨ÙˆØ¯: SimpleMAOnBuffer Ø¨Ù‡ ExponentialMAOnBuffer ØªØºÛŒÛŒØ± ÛŒØ§ÙØª Ø¨Ø±Ø§ÛŒ ÙˆØ§Ú©Ù†Ø´ Ø³Ø±ÛŒØ¹â€ŒØªØ±|
//+------------------------------------------------------------------+
bool CStrategyManager::IsKumoExpanding(ENUM_TIMEFRAMES timeframe, int period)
{
    int ichi_handle = (timeframe == m_settings.ichimoku_timeframe) ? m_ichimoku_handle : iIchimoku(m_symbol, timeframe, m_settings.tenkan_period, m_settings.kijun_period, m_settings.senkou_period); // Ù‡Ù†Ø¯Ù„
    if (ichi_handle == INVALID_HANDLE) return false; // Ø´Ú©Ø³Øª

    double senkou_a[], senkou_b[]; // Ø¨Ø§ÙØ±Ù‡Ø§
    if (CopyBuffer(ichi_handle, 2, 0, period, senkou_a) < period || CopyBuffer(ichi_handle, 3, 0, period, senkou_b) < period) // Ú©Ù¾ÛŒ
    {
        if (ichi_handle != m_ichimoku_handle) IndicatorRelease(ichi_handle); // Ø¢Ø²Ø§Ø¯
        return false; // Ø±Ø¯
    }

    if (ichi_handle != m_ichimoku_handle) IndicatorRelease(ichi_handle); // Ø¢Ø²Ø§Ø¯

    ArraySetAsSeries(senkou_a, true); // Ø³Ø±ÛŒ A
    ArraySetAsSeries(senkou_b, true); // Ø³Ø±ÛŒ B

    double thickness[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ø¶Ø®Ø§Ù…Øª
    ArrayResize(thickness, period); // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡
    for (int i = 0; i < period; i++) // Ø­Ù„Ù‚Ù‡
    {
        thickness[i] = MathAbs(senkou_a[i] - senkou_b[i]); // Ø¶Ø®Ø§Ù…Øª
    }

    // [MODIFIED] Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ø§Ù…Ù† Ùˆ Ø³Ø§Ø¯Ù‡ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ…
    if(ArraySize(thickness) < 2) return false; // Ú¯Ø§Ø±Ø¯Ø±ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ú©Ø§ÙÛŒ
    ArraySetAsSeries(thickness, true); // Ø³Ø±ÛŒ Ø¶Ø®Ø§Ù…Øª
    return (thickness[0] > thickness[1]); // Ú†Ú© Ø§ÙØ²Ø§ÛŒØ´ (Ø§Ù†Ø¨Ø³Ø§Ø·)
}

//+------------------------------------------------------------------+
//| Ú†Ú© ÙØ¶Ø§ÛŒ Ø¨Ø§Ø² Ú†ÛŒÚ©Ùˆ                                                 |
//+------------------------------------------------------------------+
bool CStrategyManager::IsChikouInOpenSpace(bool is_buy, ENUM_TIMEFRAMES timeframe)
{
    int ichi_handle = (timeframe == m_settings.ichimoku_timeframe) ? m_ichimoku_handle : iIchimoku(m_symbol, timeframe, m_settings.tenkan_period, m_settings.kijun_period, m_settings.senkou_period); // Ù‡Ù†Ø¯Ù„
    if (ichi_handle == INVALID_HANDLE) return false; // Ø´Ú©Ø³Øª

    double chikou_buffer[]; // Ø¨Ø§ÙØ± Ú†ÛŒÚ©Ùˆ
    if (CopyBuffer(ichi_handle, 4, 1, 1, chikou_buffer) < 1) // Ú©Ù¾ÛŒ Ø´ÛŒÙØª 1
    {
        if (ichi_handle != m_ichimoku_handle) IndicatorRelease(ichi_handle); // Ø¢Ø²Ø§Ø¯
        return false; // Ø±Ø¯
    }

    if (ichi_handle != m_ichimoku_handle) IndicatorRelease(ichi_handle); // Ø¢Ø²Ø§Ø¯

    double chikou = chikou_buffer[0]; // Ù…Ù‚Ø¯Ø§Ø± Ú†ÛŒÚ©Ùˆ

    double high_buffer[], low_buffer[]; // Ø¨Ø§ÙØ±Ù‡Ø§ÛŒ Ù‚ÛŒÙ…Øª
    CopyHigh(m_symbol, timeframe, 1, 26, high_buffer); // Ø³Ù‚Ù 26 Ø´ÛŒÙØª
    CopyLow(m_symbol, timeframe, 1, 26, low_buffer); // Ú©Ù 26 Ø´ÛŒÙØª

    if (is_buy) // Ø®Ø±ÛŒØ¯
    {
        return (chikou > ArrayMaximum(high_buffer)); // Ú†ÛŒÚ©Ùˆ Ø¨Ø§Ù„Ø§ÛŒ Ø­Ø¯Ø§Ú©Ø«Ø±
    }
    else // ÙØ±ÙˆØ´
    {
        return (chikou < ArrayMinimum(low_buffer)); // Ú†ÛŒÚ©Ùˆ Ù¾Ø§ÛŒÛŒÙ† Ø­Ø¯Ø§Ù‚Ù„
    }
}

//+------------------------------------------------------------------+
//| [NEW] Ù…Ø­Ø§Ø³Ø¨Ù‡ SL Ø³Ø§Ø®ØªØ§Ø±ÛŒ                                          |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateStructuralStopLoss(bool is_buy, double entry_price)
{
    double sl_level = is_buy ? m_ltf_analyzer.GetLastSwingLow() : m_ltf_analyzer.GetLastSwingHigh(); // Ø³Ø·Ø­ SL Ø³Ø§Ø®ØªØ§Ø±ÛŒ
    if (sl_level <= 0) return 0.0; // Ø§Ú¯Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø±

    double atr_buffer[1]; // Ø¨Ø§ÙØ± ATR
    if (CopyBuffer(m_atr_handle, 0, 1, 1, atr_buffer) < 1) return 0.0; // Ú†Ú© ATR

    double atr_value = atr_buffer[0]; // ATR ÙØ¹Ù„ÛŒ
    double buffer = atr_value * m_settings.sl_buffer_atr_percent / 100.0; // Ø¨Ø§ÙØ± ATR
    sl_level = is_buy ? sl_level - buffer : sl_level + buffer; // Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø§ÙØ±

    double min_distance = atr_value * m_settings.min_sl_distance_atr_percent / 100.0; // Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡
    if (MathAbs(entry_price - sl_level) < min_distance) // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„
    {
        sl_level = is_buy ? entry_price - min_distance : entry_price + min_distance; // Ø§ØµÙ„Ø§Ø­
    }

    return sl_level; // Ø¨Ø§Ø²Ú¯Ø´Øª SL Ø³Ø§Ø®ØªØ§Ø±ÛŒ
}


///Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø³Ø§Ø®ØªØ§Ø±ÛŒ:::

//+------------------------------------------------------------------+
//|                                        MarketStructure.mqh       |
//|                 Â© 2025, Mohammad & Gemini                        |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, HipoAlgorithm" // Ø­Ù‚ÙˆÙ‚ Ú©Ù¾ÛŒâ€ŒØ±Ø§ÛŒØª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡
#property link      "https://www.mql5.com" // Ù„ÛŒÙ†Ú© Ù…Ø±ØªØ¨Ø·
#property version   "3.1" // Ù†Ø³Ø®Ù‡ Ø¨Ø§ Ø§ØµÙ„Ø§Ø­Ø§Øª Ø§Ø±ØªÙ‚Ø§Ø¡

#include <Object.mqh> // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø§Ø´ÛŒØ§Ø¡ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù…

//+------------------------------------------------------------------+
//| ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ (Ù…Ø³ØªÙ‚Ù„)                                  |
//+------------------------------------------------------------------+
input group "---=== ğŸ›ï¸ Market Structure Library Settings ğŸ›ï¸ ===---"; // Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡
input group "Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ØªØ­Ù„ÛŒÙ„"; // Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
input int    Inp_MSS_Swing_Length   = 10;   // Ø·ÙˆÙ„ ØªØ´Ø®ÛŒØµ Ø³Ù‚Ù/Ú©Ù (ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ø§Ø² Ù‡Ø± Ø·Ø±Ù)
input group "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†Ù…Ø§ÛŒØ´ÛŒ Ùˆ Ù„Ø§Ú¯"; // Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ Ù†Ù…Ø§ÛŒØ´ÛŒ
input bool   Inp_MSS_Enable_Drawing = true;  // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø±Ø³Ù… Ø±ÙˆÛŒ Ú†Ø§Ø±Øª
input bool   Inp_MSS_Enable_Logging = false; // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯)
input group ""; // Ù¾Ø§ÛŒØ§Ù† Ú¯Ø±ÙˆÙ‡

// --- ØªØ¹Ø±ÛŒÙ Ø§Ù†ÙˆØ§Ø¹ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ÛŒ ---
enum E_MSS_SignalType
{
    MSS_NONE,         // Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ
    MSS_BREAK_HIGH,   // Ø´Ú©Ø³Øª Ø³Ø§Ø¯Ù‡ ØµØ¹ÙˆØ¯ÛŒ (BoS)
    MSS_BREAK_LOW,    // Ø´Ú©Ø³Øª Ø³Ø§Ø¯Ù‡ Ù†Ø²ÙˆÙ„ÛŒ (BoS)
    MSS_SHIFT_UP,     // ØªØºÛŒÛŒØ± Ø¨Ù‡ ØµØ¹ÙˆØ¯ÛŒ (MSS)
    MSS_SHIFT_DOWN    // ØªØºÛŒÛŒØ± Ø¨Ù‡ Ù†Ø²ÙˆÙ„ÛŒ (MSS)
};

// MarketStructure.mqh

struct SMssSignal
{
    E_MSS_SignalType type;
    double           break_price;
    datetime         break_time;
    int              swing_bar_index;
    bool             new_swing_formed;
    bool             is_swing_high;    // <<<< âœ… Ø§ÛŒÙ† Ø®Ø· Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    
    SMssSignal() { Reset(); } 
    void Reset() { type=MSS_NONE; break_price=0.0; break_time=0; swing_bar_index=0; new_swing_formed=false; is_swing_high=false; } // Ø¨Ù‡ Ø±ÛŒØ³Øª Ù‡Ù… Ø§Ø¶Ø§ÙØ´ Ú©Ù†

    SMssSignal(const SMssSignal &other) 
    {
        type = other.type;
        break_price = other.break_price;
        break_time = other.break_time;
        swing_bar_index = other.swing_bar_index;
        new_swing_formed = other.new_swing_formed;
        is_swing_high = other.is_swing_high; // <<<< âœ… Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†
    }
};


//+------------------------------------------------------------------+
//| Ú©Ù„Ø§Ø³ Ø§ØµÙ„ÛŒ ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ø²Ø§Ø±                                    |
//+------------------------------------------------------------------+
class CMarketStructureShift
{
private:
    int      m_swing_length; // Ø·ÙˆÙ„ ØªØ´Ø®ÛŒØµ Ú†Ø±Ø®Ø´
    string   m_symbol; // Ù†Ù…Ø§Ø¯
    ENUM_TIMEFRAMES m_period; // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    bool     m_enable_logging; // ÙØ¹Ø§Ù„ Ù„Ø§Ú¯
    bool     m_enable_drawing; // ÙØ¹Ø§Ù„ Ø±Ø³Ù…
    long     m_chart_id; // ID Ú†Ø§Ø±Øª
    string   m_obj_prefix; // Ù¾ÛŒØ´ÙˆÙ†Ø¯ Ø§Ø´ÛŒØ§Ø¡
    datetime m_last_bar_time; // Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡
    
    double   m_swing_highs_array[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ø¢Ø®Ø±ÛŒÙ† Ø³Ù‚Ùâ€ŒÙ‡Ø§ ([0] Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†)
    double   m_swing_lows_array[]; // Ø¢Ø±Ø§ÛŒÙ‡ Ø¢Ø®Ø±ÛŒÙ† Ú©Ùâ€ŒÙ‡Ø§ ([0] Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†)
    
    double   m_last_swing_h; // Ø¢Ø®Ø±ÛŒÙ† Ø³Ù‚Ù Ú†Ø±Ø®Ø´
    double   m_last_swing_l; // Ø¢Ø®Ø±ÛŒÙ† Ú©Ù Ú†Ø±Ø®Ø´
    int      m_last_swing_h_index; // Ø§Ù†Ø¯ÛŒØ³ Ø¢Ø®Ø±ÛŒÙ† Ø³Ù‚Ù
    int      m_last_swing_l_index; // Ø§Ù†Ø¯ÛŒØ³ Ø¢Ø®Ø±ÛŒÙ† Ú©Ù

    double   high(int index) { return iHigh(m_symbol, m_period, index); } // Ú¯Ø±ÙØªÙ† Ø³Ù‚Ù Ø§Ù†Ø¯ÛŒØ³
    double   low(int index) { return iLow(m_symbol, m_period, index); } // Ú¯Ø±ÙØªÙ† Ú©Ù Ø§Ù†Ø¯ÛŒØ³
    datetime time(int index) { return iTime(m_symbol, m_period, index); } // Ú¯Ø±ÙØªÙ† Ø²Ù…Ø§Ù† Ø§Ù†Ø¯ÛŒØ³
    void     Log(string message); // ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯
    
    void drawSwingPoint(string objName,datetime time_param,double price,int arrCode, color clr,int direction); // Ø±Ø³Ù… Ù†Ù‚Ø·Ù‡ Ú†Ø±Ø®Ø´
    void drawBreakLevel(string objName,datetime time1,double price1, datetime time2,double price2,color clr,int direction); // Ø±Ø³Ù… Ø®Ø· Ø´Ú©Ø³Øª BoS
    void drawBreakLevel_MSS(string objName,datetime time1,double price1, datetime time2,double price2,color clr,int direction); // Ø±Ø³Ù… Ø®Ø· Ø´Ú©Ø³Øª MSS
    
public:
    void Init(string symbol, ENUM_TIMEFRAMES period); // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    SMssSignal ProcessNewBar(); // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø³ÛŒÚ¯Ù†Ø§Ù„
    double GetLastSwingHigh() const { return m_last_swing_h; } // Ú¯Ø±ÙØªÙ† Ø¢Ø®Ø±ÛŒÙ† Ø³Ù‚Ù
    double GetLastSwingLow() const { return m_last_swing_l; } // Ú¯Ø±ÙØªÙ† Ø¢Ø®Ø±ÛŒÙ† Ú©Ù
    int    GetLastSwingHighIndex() const { return m_last_swing_h_index; } // Ø§Ù†Ø¯ÛŒØ³ Ø¢Ø®Ø±ÛŒÙ† Ø³Ù‚Ù
    int    GetLastSwingLowIndex() const { return m_last_swing_l_index; } // Ø§Ù†Ø¯ÛŒØ³ Ø¢Ø®Ø±ÛŒÙ† Ú©Ù
    void   GetRecentHighs(double &highs[]) const { ArrayCopy(highs, m_swing_highs_array); } // Ú©Ù¾ÛŒ Ø³Ù‚Ùâ€ŒÙ‡Ø§
    void   GetRecentLows(double &lows[]) const { ArrayCopy(lows, m_swing_lows_array); } // Ú©Ù¾ÛŒ Ú©Ùâ€ŒÙ‡Ø§
    bool   IsUptrend() const; // Ú†Ú© Ø±ÙˆÙ†Ø¯ ØµØ¹ÙˆØ¯ÛŒ
    bool   IsDowntrend() const; // Ú†Ú© Ø±ÙˆÙ†Ø¯ Ù†Ø²ÙˆÙ„ÛŒ
    double GetSecondLastSwingHigh() const; // [NEW] Ú¯Ø±ÙØªÙ† Ø¯ÙˆÙ…ÛŒÙ† Ø³Ù‚Ù Ø¢Ø®Ø±
    double GetSecondLastSwingLow() const; // [NEW] Ú¯Ø±ÙØªÙ† Ø¯ÙˆÙ…ÛŒÙ† Ú©Ù Ø¢Ø®Ø±
    bool   ScanPastForMSS(bool is_buy_direction, int lookback_bars, int &found_at_bar); // [NEW] Ø§Ø³Ú©Ù† Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø±Ø§ÛŒ MSS
};

//+------------------------------------------------------------------+
//| Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ù„Ø§Ø³                                              |
//+------------------------------------------------------------------+
void CMarketStructureShift::Init(string symbol, ENUM_TIMEFRAMES period)
{
    m_symbol = symbol; // ØªÙ†Ø¸ÛŒÙ… Ù†Ù…Ø§Ø¯
    m_period = period; // ØªÙ†Ø¸ÛŒÙ… ØªØ§ÛŒÙ… ÙØ±ÛŒÙ…
    
    m_swing_length = Inp_MSS_Swing_Length > 2 ? Inp_MSS_Swing_Length : 10; // Ø·ÙˆÙ„ Ú†Ø±Ø®Ø´ (Ø­Ø¯Ø§Ù‚Ù„ 3)
    m_enable_logging = Inp_MSS_Enable_Logging; // ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯
    m_enable_drawing = Inp_MSS_Enable_Drawing; // ØªÙ†Ø¸ÛŒÙ… Ø±Ø³Ù…
    
    m_chart_id = ChartID(); // ID Ú†Ø§Ø±Øª ÙØ¹Ù„ÛŒ
    m_obj_prefix = "MSS_LIB_" + m_symbol + "_" + EnumToString(m_period) + "_"; // Ù¾ÛŒØ´ÙˆÙ†Ø¯ Ø§Ø´ÛŒØ§Ø¡
    m_last_bar_time = 0; // Ø±ÛŒØ³Øª Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø±
    m_last_swing_h = -1.0; // Ø±ÛŒØ³Øª Ø¢Ø®Ø±ÛŒÙ† Ø³Ù‚Ù
    m_last_swing_l = -1.0; // Ø±ÛŒØ³Øª Ø¢Ø®Ø±ÛŒÙ† Ú©Ù
    m_last_swing_h_index = 0; // Ø±ÛŒØ³Øª Ø§Ù†Ø¯ÛŒØ³ Ø³Ù‚Ù
    m_last_swing_l_index = 0; // Ø±ÛŒØ³Øª Ø§Ù†Ø¯ÛŒØ³ Ú©Ù
    
    // Ø±ÛŒØ³Øª Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§
    ArrayFree(m_swing_highs_array); // Ø¢Ø²Ø§Ø¯ Ø³Ù‚Ùâ€ŒÙ‡Ø§
    ArrayFree(m_swing_lows_array); // Ø¢Ø²Ø§Ø¯ Ú©Ùâ€ŒÙ‡Ø§
    
    int highs_found = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø³Ù‚Ùâ€ŒÙ‡Ø§
    int lows_found = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ú©Ùâ€ŒÙ‡Ø§
    
    // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø­Ø¯Ø§Ù‚Ù„ Ø¯Ùˆ Ø³Ù‚Ù Ùˆ Ú©Ù Ø§ÙˆÙ„ÛŒÙ‡
    for(int i = m_swing_length; i < 500 && (highs_found < 2 || lows_found < 2); i++) // Ø­Ù„Ù‚Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨
    {
        if(iBars(m_symbol, m_period) < i + m_swing_length + 1) break; // Ú†Ú© Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ
        
        bool is_high = true; // ÙÙ„Ú¯ Ø³Ù‚Ù
        bool is_low = true; // ÙÙ„Ú¯ Ú©Ù
        
        for(int j = 1; j <= m_swing_length; j++) // Ú†Ú© Ø§Ø·Ø±Ø§Ù
        {
            if(high(i) <= high(i-j) || high(i) < high(i+j)) is_high = false; // Ú†Ú© Ø³Ù‚Ù
            if(low(i) >= low(i-j) || low(i) > low(i+j)) is_low = false; // Ú†Ú© Ú©Ù
        }
        
        if(is_high && highs_found < 2) // Ø§Ú¯Ø± Ø³Ù‚Ù Ùˆ Ú©Ù…ØªØ± Ø§Ø² 2
        {
            double temp_high[1]; // Ø¢Ø±Ø§ÛŒÙ‡ Ù…ÙˆÙ‚Øª
            temp_high[0] = high(i); // Ù…Ù‚Ø¯Ø§Ø± Ø³Ù‚Ù
            ArrayInsert(m_swing_highs_array, temp_high, 0); // Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§
            highs_found++; // Ø§ÙØ²Ø§ÛŒØ´
        }
        
        if(is_low && lows_found < 2) // Ø§Ú¯Ø± Ú©Ù Ùˆ Ú©Ù…ØªØ± Ø§Ø² 2
        {
            double temp_low[1]; // Ø¢Ø±Ø§ÛŒÙ‡ Ù…ÙˆÙ‚Øª
            temp_low[0] = low(i); // Ù…Ù‚Ø¯Ø§Ø± Ú©Ù
            ArrayInsert(m_swing_lows_array, temp_low, 0); // Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§
            lows_found++; // Ø§ÙØ²Ø§ÛŒØ´
        }
    }
    
    if(m_enable_logging) // Ø§Ú¯Ø± Ù„Ø§Ú¯ ÙØ¹Ø§Ù„
    {
       Print("Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ MarketStructure Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯."); // Ú†Ø§Ù¾
       Print("Ø³Ù‚Ùâ€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡:"); // Ú†Ø§Ù¾
       ArrayPrint(m_swing_highs_array); // Ú†Ø§Ù¾ Ø¢Ø±Ø§ÛŒÙ‡
       Print("Ú©Ùâ€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡:"); // Ú†Ø§Ù¾
       ArrayPrint(m_swing_lows_array); // Ú†Ø§Ù¾ Ø¢Ø±Ø§ÛŒÙ‡
    }
    
    Log("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ MarketStructure Ø¨Ø±Ø§ÛŒ " + m_symbol + " Ø¯Ø± " + EnumToString(m_period) + " Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯."); // Ù„Ø§Ú¯ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
}

//+------------------------------------------------------------------+
//| Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)                                    |
//+------------------------------------------------------------------+
SMssSignal CMarketStructureShift::ProcessNewBar()
{
    SMssSignal result; // Ù†ØªÛŒØ¬Ù‡ Ø³ÛŒÚ¯Ù†Ø§Ù„
    datetime current_bar_time = iTime(m_symbol, m_period, 0); // Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ
    if (current_bar_time == m_last_bar_time) return result; // Ø§Ú¯Ø± Ù‡Ù…Ø§Ù†ØŒ Ø®Ø±ÙˆØ¬
    m_last_bar_time = current_bar_time; // Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù†

    const int curr_bar = m_swing_length; // Ø¨Ø§Ø± ÙØ¹Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ú†Ú©
    if (iBars(m_symbol, m_period) < curr_bar * 2 + 1) return result; // Ú†Ú© Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ

    bool isSwingHigh = true, isSwingLow = true; // ÙÙ„Ú¯â€ŒÙ‡Ø§

    for (int a = 1; a <= m_swing_length; a++) // Ú†Ú© Ø§Ø·Ø±Ø§Ù
    {
        if ((high(curr_bar) <= high(curr_bar - a)) || (high(curr_bar) < high(curr_bar + a))) isSwingHigh = false; // Ú†Ú© Ø³Ù‚Ù
        if ((low(curr_bar) >= low(curr_bar - a)) || (low(curr_bar) > low(curr_bar + a))) isSwingLow = false; // Ú†Ú© Ú©Ù
    }

    if (isSwingHigh) // Ø§Ú¯Ø± Ø³Ù‚Ù Ø¬Ø¯ÛŒØ¯
    {
        m_last_swing_h = high(curr_bar); // ØªÙ†Ø¸ÛŒÙ… Ø³Ù‚Ù
        m_last_swing_h_index = curr_bar; // Ø§Ù†Ø¯ÛŒØ³
        Log("Ø³Ù‚Ù Ú†Ø±Ø®Ø´ Ø¬Ø¯ÛŒØ¯: " + DoubleToString(m_last_swing_h, _Digits)); // Ù„Ø§Ú¯
        if (m_enable_drawing) drawSwingPoint(m_obj_prefix + TimeToString(time(curr_bar)), time(curr_bar), m_last_swing_h, 77, clrBlue, -1); // Ø±Ø³Ù…

        // [MODIFIED] Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø§ Ú†Ú© Ø§Ù†Ø¯Ø§Ø²Ù‡
        if(ArraySize(m_swing_highs_array) > 0)
        {
           if(ArraySize(m_swing_highs_array) == 1) ArrayResize(m_swing_highs_array, 2);
           m_swing_highs_array[1] = m_swing_highs_array[0];
        }
        else ArrayResize(m_swing_highs_array, 2);
        m_swing_highs_array[0] = m_last_swing_h;
        result.new_swing_formed = true; // [NEW] Ø§Ø¹Ù„Ø§Ù… ØªØ´Ú©ÛŒÙ„ Ø³ÙˆÛŒÙ†Ú¯ Ø¬Ø¯ÛŒØ¯
    }
    
    if (isSwingLow) // Ø§Ú¯Ø± Ú©Ù Ø¬Ø¯ÛŒØ¯
    {
        m_last_swing_l = low(curr_bar); // ØªÙ†Ø¸ÛŒÙ… Ú©Ù
        m_last_swing_l_index = curr_bar; // Ø§Ù†Ø¯ÛŒØ³
        Log("Ú©Ù Ú†Ø±Ø®Ø´ Ø¬Ø¯ÛŒØ¯: " + DoubleToString(m_last_swing_l, _Digits)); // Ù„Ø§Ú¯
        if (m_enable_drawing) drawSwingPoint(m_obj_prefix + TimeToString(time(curr_bar)), time(curr_bar), m_last_swing_l, 77, clrRed, +1); // Ø±Ø³Ù…

        // [MODIFIED] Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø§ Ú†Ú© Ø§Ù†Ø¯Ø§Ø²Ù‡
        if(ArraySize(m_swing_lows_array) > 0)
        {
           if(ArraySize(m_swing_lows_array) == 1) ArrayResize(m_swing_lows_array, 2);
           m_swing_lows_array[1] = m_swing_lows_array[0];
        }
        else ArrayResize(m_swing_lows_array, 2);
        m_swing_lows_array[0] = m_last_swing_l;
        result.new_swing_formed = true; // [NEW] Ø§Ø¹Ù„Ø§Ù… ØªØ´Ú©ÛŒÙ„ Ø³ÙˆÛŒÙ†Ú¯ Ø¬Ø¯ÛŒØ¯
    }

    double Ask = SymbolInfoDouble(m_symbol, SYMBOL_ASK); // Ù‚ÛŒÙ…Øª Ask
    double Bid = SymbolInfoDouble(m_symbol, SYMBOL_BID); // Ù‚ÛŒÙ…Øª Bid

    if (m_last_swing_h > 0 && Ask > m_last_swing_h) // Ø´Ú©Ø³Øª Ø³Ù‚Ù
    {
        Log("Ø´Ú©Ø³Øª Ø³Ù‚Ù Ø¯Ø± Ù‚ÛŒÙ…Øª " + DoubleToString(m_last_swing_h, _Digits)); // Ù„Ø§Ú¯
        
        bool isMSS_High = IsUptrend(); // Ú†Ú© MSS ØµØ¹ÙˆØ¯ÛŒ
        if (isMSS_High) {
            result.type = MSS_SHIFT_UP; // ØªØºÛŒÛŒØ± Ø¨Ù‡ ØµØ¹ÙˆØ¯ÛŒ
            if (m_enable_drawing) drawBreakLevel_MSS(m_obj_prefix + "MSS_UP_" + TimeToString(time(0)), time(m_last_swing_h_index), m_last_swing_h, time(0), m_last_swing_h, clrDarkGreen, -1); // Ø±Ø³Ù…
        } else {
            result.type = MSS_BREAK_HIGH; // Ø´Ú©Ø³Øª Ø³Ø§Ø¯Ù‡ ØµØ¹ÙˆØ¯ÛŒ
            if (m_enable_drawing) drawBreakLevel(m_obj_prefix + "BOS_UP_" + TimeToString(time(0)), time(m_last_swing_h_index), m_last_swing_h, time(0), m_last_swing_h, clrBlue, -1); // Ø±Ø³Ù…
        }
        
        result.break_price = m_last_swing_h; // Ù‚ÛŒÙ…Øª Ø´Ú©Ø³Øª
        result.break_time = time(0); // Ø²Ù…Ø§Ù†
        result.swing_bar_index = m_last_swing_h_index; // Ø§Ù†Ø¯ÛŒØ³
        m_last_swing_h = -1.0; // Ø±ÛŒØ³Øª
    }
    else if (m_last_swing_l > 0 && Bid < m_last_swing_l) // Ø´Ú©Ø³Øª Ú©Ù
    {
        Log("Ø´Ú©Ø³Øª Ú©Ù Ø¯Ø± Ù‚ÛŒÙ…Øª " + DoubleToString(m_last_swing_l, _Digits)); // Ù„Ø§Ú¯
        
        bool isMSS_Low = IsDowntrend(); // Ú†Ú© MSS Ù†Ø²ÙˆÙ„ÛŒ
        if (isMSS_Low) {
            result.type = MSS_SHIFT_DOWN; // ØªØºÛŒÛŒØ± Ø¨Ù‡ Ù†Ø²ÙˆÙ„ÛŒ
            if (m_enable_drawing) drawBreakLevel_MSS(m_obj_prefix + "MSS_DOWN_" + TimeToString(time(0)), time(m_last_swing_l_index), m_last_swing_l, time(0), m_last_swing_l, clrBlack, +1); // Ø±Ø³Ù…
        } else {
            result.type = MSS_BREAK_LOW; // Ø´Ú©Ø³Øª Ø³Ø§Ø¯Ù‡ Ù†Ø²ÙˆÙ„ÛŒ
            if (m_enable_drawing) drawBreakLevel(m_obj_prefix + "BOS_DOWN_" + TimeToString(time(0)), time(m_last_swing_l_index), m_last_swing_l, time(0), m_last_swing_l, clrRed, +1); // Ø±Ø³Ù…
        }

        result.break_price = m_last_swing_l; // Ù‚ÛŒÙ…Øª
        result.break_time = time(0); // Ø²Ù…Ø§Ù†
        result.swing_bar_index = m_last_swing_l_index; // Ø§Ù†Ø¯ÛŒØ³
        m_last_swing_l = -1.0; // Ø±ÛŒØ³Øª
    }


      // [MODIFIED] Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ ØªØ§Ø¨Ø¹ ProcessNewBar Ø¯Ø± MarketStructure.mqh Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
      if (isSwingHigh)
      {
          result.new_swing_formed = true;
          result.is_swing_high = true;
      }
      if (isSwingLow)
      {
          result.new_swing_formed = true;
          result.is_swing_high = false;
      }

return result; //  
}
//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡                                                |
//+------------------------------------------------------------------+
void CMarketStructureShift::Log(string message)
{
    if (m_enable_logging) // Ø§Ú¯Ø± ÙØ¹Ø§Ù„
    {
        Print("[MSS Lib][", m_symbol, "][", EnumToString(m_period), "]: ", message); // Ú†Ø§Ù¾
    }
}

//+------------------------------------------------------------------+
//| Ú†Ú© Ø±ÙˆÙ†Ø¯ ØµØ¹ÙˆØ¯ÛŒ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)                                       |
//+------------------------------------------------------------------+
bool CMarketStructureShift::IsUptrend() const
{
    if (ArraySize(m_swing_highs_array) < 2 || ArraySize(m_swing_lows_array) < 2) return false; // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„ 2 Ø¹Ø¶Ùˆ
    // Ú†Ú© Ø³Ù‚Ù Ø¬Ø¯ÛŒØ¯ > Ø³Ù‚Ù Ù‚Ø¯ÛŒÙ…ÛŒ Ùˆ Ú©Ù Ø¬Ø¯ÛŒØ¯ > Ú©Ù Ù‚Ø¯ÛŒÙ…ÛŒ
    return (m_swing_highs_array[0] > m_swing_highs_array[1] && m_swing_lows_array[0] > m_swing_lows_array[1]);
}

//+------------------------------------------------------------------+
//| Ú†Ú© Ø±ÙˆÙ†Ø¯ Ù†Ø²ÙˆÙ„ÛŒ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)                                       |
//+------------------------------------------------------------------+
bool CMarketStructureShift::IsDowntrend() const
{
    if (ArraySize(m_swing_highs_array) < 2 || ArraySize(m_swing_lows_array) < 2) return false; // Ú†Ú© Ø­Ø¯Ø§Ù‚Ù„ 2 Ø¹Ø¶Ùˆ
    // Ú†Ú© Ø³Ù‚Ù Ø¬Ø¯ÛŒØ¯ < Ø³Ù‚Ù Ù‚Ø¯ÛŒÙ…ÛŒ Ùˆ Ú©Ù Ø¬Ø¯ÛŒØ¯ < Ú©Ù Ù‚Ø¯ÛŒÙ…ÛŒ
    return (m_swing_highs_array[0] < m_swing_highs_array[1] && m_swing_lows_array[0] < m_swing_lows_array[1]);
}

//+------------------------------------------------------------------+
//| [NEW] Ú¯Ø±ÙØªÙ† Ø¯ÙˆÙ…ÛŒÙ† Ø³Ù‚Ù Ø¢Ø®Ø±                                        |
//+------------------------------------------------------------------+
double CMarketStructureShift::GetSecondLastSwingHigh() const
{
    if (ArraySize(m_swing_highs_array) < 2) return -1.0; // Ú†Ú© Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¢Ø±Ø§ÛŒÙ‡
    return m_swing_highs_array[1]; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯ÙˆÙ…ÛŒÙ† Ø¹Ø¶Ùˆ
}

//+------------------------------------------------------------------+
//| [NEW] Ú¯Ø±ÙØªÙ† Ø¯ÙˆÙ…ÛŒÙ† Ú©Ù Ø¢Ø®Ø±                                         |
//+------------------------------------------------------------------+
double CMarketStructureShift::GetSecondLastSwingLow() const
{
    if (ArraySize(m_swing_lows_array) < 2) return -1.0; // Ú†Ú© Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¢Ø±Ø§ÛŒÙ‡
    return m_swing_lows_array[1]; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯ÙˆÙ…ÛŒÙ† Ø¹Ø¶Ùˆ
}

//+------------------------------------------------------------------+
//| [NEW] Ø§Ø³Ú©Ù† Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† MSS                               |
//+------------------------------------------------------------------+
bool CMarketStructureShift::ScanPastForMSS(bool is_buy_direction, int lookback_bars, int &found_at_bar)
{
    found_at_bar = -1; // Ø±ÛŒØ³Øª Ø§Ù†Ø¯ÛŒØ³
    if (lookback_bars <= 0) return false; // Ú†Ú© ÙˆØ±ÙˆØ¯ÛŒ

    int total_bars = iBars(m_symbol, m_period); // ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø±Ù‡Ø§
    if (total_bars < lookback_bars) lookback_bars = total_bars - 1; // ØªÙ†Ø¸ÛŒÙ… Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨

    for (int i = 1; i <= lookback_bars; i++) // Ø­Ù„Ù‚Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨
    {
        const int curr_bar = i; // Ø¨Ø§Ø± ÙØ¹Ù„ÛŒ Ø§Ø³Ú©Ù†
        if (total_bars < curr_bar + m_swing_length * 2 + 1) continue; // Ú†Ú© Ø¯Ø§Ø¯Ù‡

        bool isSwingHigh = true, isSwingLow = true; // ÙÙ„Ú¯â€ŒÙ‡Ø§

        for (int a = 1; a <= m_swing_length; a++) // Ú†Ú© Ø§Ø·Ø±Ø§Ù
        {
            if ((high(curr_bar) <= high(curr_bar - a)) || (high(curr_bar) < high(curr_bar + a))) isSwingHigh = false;
            if ((low(curr_bar) >= low(curr_bar - a)) || (low(curr_bar) > low(curr_bar + a))) isSwingLow = false;
        }

        double temp_high = isSwingHigh ? high(curr_bar) : 0;
        double temp_low = isSwingLow ? low(curr_bar) : 0;

        // Ú†Ú© Ø´Ú©Ø³Øª Ø¯Ø± Ø¬Ù‡Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±
        if (is_buy_direction && temp_high > 0 && IsUptrend()) // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ùˆ MSS ØµØ¹ÙˆØ¯ÛŒ
        {
            found_at_bar = curr_bar; // ØªÙ†Ø¸ÛŒÙ… Ø§Ù†Ø¯ÛŒØ³
            return true; // Ù¾ÛŒØ¯Ø§ Ø´Ø¯
        }
        else if (!is_buy_direction && temp_low > 0 && IsDowntrend()) // Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ùˆ MSS Ù†Ø²ÙˆÙ„ÛŒ
        {
            found_at_bar = curr_bar; // ØªÙ†Ø¸ÛŒÙ… Ø§Ù†Ø¯ÛŒØ³
            return true; // Ù¾ÛŒØ¯Ø§ Ø´Ø¯
        }
    }

    return false; // Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
}

//+------------------------------------------------------------------+
//| Ø±Ø³Ù… Ù†Ù‚Ø·Ù‡ Ú†Ø±Ø®Ø´                                                    |
//+------------------------------------------------------------------+
void CMarketStructureShift::drawSwingPoint(string objName,datetime time_param,double price,int arrCode, color clr,int direction)
{
   if(ObjectFind(m_chart_id,objName) < 0) { // Ø§Ú¯Ø± Ø´ÛŒØ¡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
      ObjectCreate(m_chart_id,objName,OBJ_ARROW,0,time_param,price); // Ø§ÛŒØ¬Ø§Ø¯ ÙÙ„Ø´
      ObjectSetInteger(m_chart_id,objName,OBJPROP_ARROWCODE,arrCode); // Ú©Ø¯ ÙÙ„Ø´
      ObjectSetInteger(m_chart_id,objName,OBJPROP_COLOR,clr); // Ø±Ù†Ú¯
      ObjectSetInteger(m_chart_id,objName,OBJPROP_FONTSIZE,10); // Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙÙˆÙ†Øª
      if(direction > 0) ObjectSetInteger(m_chart_id,objName,OBJPROP_ANCHOR,ANCHOR_TOP); // Ù„Ù†Ú¯Ø± Ø¨Ø§Ù„Ø§
      if(direction < 0) ObjectSetInteger(m_chart_id,objName,OBJPROP_ANCHOR,ANCHOR_BOTTOM); // Ù„Ù†Ú¯Ø± Ù¾Ø§ÛŒÛŒÙ†
      
      string text = "Swing"; // Ù…ØªÙ†
      string objName_Descr = objName + text; // Ù†Ø§Ù… ØªÙˆØµÛŒÙÛŒ
      ObjectCreate(m_chart_id,objName_Descr,OBJ_TEXT,0,time_param,price); // Ø§ÛŒØ¬Ø§Ø¯ Ù…ØªÙ†
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_COLOR,clr); // Ø±Ù†Ú¯ Ù…ØªÙ†
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_FONTSIZE,10); // Ø§Ù†Ø¯Ø§Ø²Ù‡
      if(direction > 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,"  "+text); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_LEFT_UPPER); } // Ù…ØªÙ† Ø¨Ø§Ù„Ø§
      if(direction < 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,"  "+text); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_LEFT_LOWER); } // Ù…ØªÙ† Ù¾Ø§ÛŒÛŒÙ†
   }
   ChartRedraw(m_chart_id); // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú†Ø§Ø±Øª
}

//+------------------------------------------------------------------+
//| Ø±Ø³Ù… Ø®Ø· Ø´Ú©Ø³Øª BoS                                                   |
//+------------------------------------------------------------------+
void CMarketStructureShift::drawBreakLevel(string objName,datetime time1,double price1, datetime time2,double price2,color clr,int direction)
{
   if(ObjectFind(m_chart_id,objName) < 0) { // Ø§Ú¯Ø± Ø´ÛŒØ¡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
      ObjectCreate(m_chart_id,objName,OBJ_ARROWED_LINE,0,time1,price1,time2,price2); // Ø§ÛŒØ¬Ø§Ø¯ Ø®Ø· ÙÙ„Ø´â€ŒØ¯Ø§Ø±
      ObjectSetInteger(m_chart_id,objName,OBJPROP_COLOR,clr); // Ø±Ù†Ú¯
      ObjectSetInteger(m_chart_id,objName,OBJPROP_WIDTH,2); // Ø¹Ø±Ø¶
      string text = "BoS"; // Ù…ØªÙ†
      string objName_Descr = objName + text; // Ù†Ø§Ù…
      ObjectCreate(m_chart_id,objName_Descr,OBJ_TEXT,0,time2,price2); // Ø§ÛŒØ¬Ø§Ø¯ Ù…ØªÙ†
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_COLOR,clr); // Ø±Ù†Ú¯
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_FONTSIZE,10); // Ø§Ù†Ø¯Ø§Ø²Ù‡
      if(direction > 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,text+"  "); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_RIGHT_UPPER); } // Ù…ØªÙ† Ø¨Ø§Ù„Ø§
      if(direction < 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,text+"  "); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_RIGHT_LOWER); } // Ù…ØªÙ† Ù¾Ø§ÛŒÛŒÙ†
   }
   ChartRedraw(m_chart_id); // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ
}

//+------------------------------------------------------------------+
//| Ø±Ø³Ù… Ø®Ø· Ø´Ú©Ø³Øª MSS                                                   |
//+------------------------------------------------------------------+
void CMarketStructureShift::drawBreakLevel_MSS(string objName,datetime time1,double price1, datetime time2,double price2,color clr,int direction)
{
   if(ObjectFind(m_chart_id,objName) < 0) { // Ø§Ú¯Ø± Ø´ÛŒØ¡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
      ObjectCreate(m_chart_id,objName,OBJ_ARROWED_LINE,0,time1,price1,time2,price2); // Ø§ÛŒØ¬Ø§Ø¯ Ø®Ø·
      ObjectSetInteger(m_chart_id,objName,OBJPROP_COLOR,clr); // Ø±Ù†Ú¯
      ObjectSetInteger(m_chart_id,objName,OBJPROP_WIDTH,4); // Ø¹Ø±Ø¶ Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ MSS
      string text = "MSS"; // Ù…ØªÙ†
      string objName_Descr = objName + text; // Ù†Ø§Ù…
      ObjectCreate(m_chart_id,objName_Descr,OBJ_TEXT,0,time2,price2); // Ø§ÛŒØ¬Ø§Ø¯ Ù…ØªÙ†
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_COLOR,clr); // Ø±Ù†Ú¯
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_FONTSIZE,13); // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¨Ø²Ø±Ú¯ØªØ±
      if(direction > 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,text+"  "); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_RIGHT_UPPER); } // Ù…ØªÙ†
      if(direction < 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,text+"  "); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_RIGHT_LOWER); } // Ù…ØªÙ†
   }
   ChartRedraw(m_chart_id); // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ
}


 
///ÙØ§ÛŒÙ„ 5 Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªØ±Ù„ÛŒÙ†Ú© Ø§Ø³ØªØ§Ù¾:::

//+------------------------------------------------------------------+
//|                                      Universal Trailing Stop Loss Library |
//|                                      File: TrailingStopManager.mqh |
//|                                      Version: 5.1 (Truly Final) |
//|                                      Â© 2025, Mohammad & Gemini |
//|                                                                  |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "5.1"
#include <Trade\Trade.mqh>

//================================================================================//
//|                                 --- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø³Ø±ÛŒØ¹ ---                   |
//|                                                                                |
//| Û±. Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± Ú©Ù†Ø§Ø± ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù¾Ø±Øª Ø®ÙˆØ¯ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.                                |
//| Û². Ø¯Ø± ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù¾Ø±Øª Ø§ØµÙ„ÛŒ (.mq5)ØŒ Ø§ÛŒÙ† Ø¯Ùˆ Ø®Ø· Ø±Ø§ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ ÙØ§ÛŒÙ„ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:             |
//|    #include "TrailingStopManager.mqh"                                          |
//|    CTrailingStopManager TrailingStop;                                          |
//| Û³. Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ ØªØ§Ø¨Ø¹ OnInit Ø§Ú©Ø³Ù¾Ø±Øª Ø®ÙˆØ¯ØŒ Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:                      |
//|    TrailingStop.Init(magic_number);                                           |
//| Û´. Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ ØªØ§Ø¨Ø¹ OnTimer (ÛŒØ§ OnTick) Ø§Ú©Ø³Ù¾Ø±Øª Ø®ÙˆØ¯ØŒ Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:          |
//|    TrailingStop.Process();                                                     |
//|                                                                                |
//|                                 **Ø¯ÛŒÚ¯Ø± Ø¨Ù‡ Ù‡ÛŒÚ† ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ù†ÛŒØ§Ø² Ù†ÛŒØ³Øª!** |
//|                                                                                |
//================================================================================//

//================================================================//
// Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ (Inputs) - Ú©Ø§Ù…Ù„Ø§ Ù…Ø³ØªÙ‚Ù„ Ùˆ Plug & Play
//================================================================//
input group "---=== ğŸ›¡ï¸ Universal Trailing & Breakeven ğŸ›¡ï¸ ===---";
input bool Inp_TSL_Enable = true;
input double Inp_TSL_Activation_RR = 1.0;
input bool Inp_BE_Enable = true;
input double Inp_BE_Activation_RR = 1.0;
input double Inp_BE_Plus_Pips = 1.0;
enum E_TSL_Mode { TSL_MODE_TENKAN, TSL_MODE_KIJUN, TSL_MODE_MA, TSL_MODE_ATR, TSL_MODE_PSAR, TSL_MODE_PRICE_CHANNEL, TSL_MODE_CHANDELIER_ATR };
input E_TSL_Mode Inp_TSL_Mode = TSL_MODE_TENKAN;
/*input*/ double Inp_TSL_Buffer_Pips = 3.0;
/*input*/ int Inp_TSL_Ichimoku_Tenkan = 9;
/*input*/ int Inp_TSL_Ichimoku_Kijun = 26;
/*input*/ int Inp_TSL_Ichimoku_Senkou = 52;
/*input*/ int Inp_TSL_MA_Period = 50;
/*input*/ ENUM_MA_METHOD Inp_TSL_MA_Method = MODE_SMA;
/*input*/ ENUM_APPLIED_PRICE Inp_TSL_MA_Price = PRICE_CLOSE;
/*input*/ int Inp_TSL_ATR_Period = 14;
/*input*/ double Inp_TSL_ATR_Multiplier = 2.5;
/*input*/ double Inp_TSL_PSAR_Step = 0.02;
/*input*/ double Inp_TSL_PSAR_Max = 0.2;
/*input*/ int Inp_TSL_PriceChannel_Period = 22;

//+------------------------------------------------------------------+
//| Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ù‡ÛŒÙ†Ù‡ Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª ØªØ±ÛŒØ¯Ù‡Ø§          |
//+------------------------------------------------------------------+
struct SIndicatorHandle
{
  string symbol;
  int    handle;
};

struct STradeState
{
  ulong  ticket;
  double open_price;
  double initial_sl;
  bool   be_applied;
};

//+------------------------------------------------------------------+
//| Ú©Ù„Ø§Ø³ Ø§ØµÙ„ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø± Ù…ØªØ­Ø±Ú©                                     |
//+------------------------------------------------------------------+
class CTrailingStopManager
{
private:
  long               m_magic_number;
  bool               m_is_initialized;
  CTrade             m_trade;

  // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
  bool               m_tsl_enabled, m_be_enabled;
  double             m_activation_rr, m_be_activation_rr, m_be_plus_pips;
  E_TSL_Mode         m_tsl_mode;
  double             m_buffer_pips;
  int                m_ichimoku_tenkan, m_ichimoku_kijun, m_ichimoku_senkou;
  int                m_ma_period;
  ENUM_MA_METHOD     m_ma_method;
  ENUM_APPLIED_PRICE m_ma_price;
  int                m_atr_period;
  double             m_atr_multiplier;
  double             m_psar_step, m_psar_max;
  int                m_pricechannel_period;

  // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª ---
  STradeState        m_trade_states[];

  // --- Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§ ---
  SIndicatorHandle   m_ichimoku_handles[];
  SIndicatorHandle   m_ma_handles[];
  SIndicatorHandle   m_atr_handles[];
  SIndicatorHandle   m_psar_handles[];

  // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø®ØµÙˆØµÛŒ ---
  int    GetIchimokuHandle(string symbol);
  int    GetMaHandle(string symbol);
  int    GetAtrHandle(string symbol);
  int    GetPsarHandle(string symbol);
  void   Log(string message);
  void   ManageSingleTrade(ulong ticket);
  int    FindTradeStateIndex(ulong ticket);
  void   AddTradeState(ulong ticket, double open_price, double initial_sl);
  void   CleanupTradeStates();

  double CalculateIchimokuSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculateMaSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculateAtrSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculatePsarSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculatePriceChannelSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculateChandelierAtrSL(string symbol, ENUM_POSITION_TYPE type);
  void   ManageBreakeven(int state_idx);

public:
  CTrailingStopManager() { m_magic_number = 0; m_is_initialized = false; }
  ~CTrailingStopManager();
  void Init(long magic_number);
  void Process();
};

// --- Ù…Ø®Ø±Ø¨ Ú©Ù„Ø§Ø³ ---
CTrailingStopManager::~CTrailingStopManager()
{
  for(int i = 0; i < ArraySize(m_ichimoku_handles); i++) IndicatorRelease(m_ichimoku_handles[i].handle);
  for(int i = 0; i < ArraySize(m_ma_handles); i++) IndicatorRelease(m_ma_handles[i].handle);
  for(int i = 0; i < ArraySize(m_atr_handles); i++) IndicatorRelease(m_atr_handles[i].handle);
  for(int i = 0; i < ArraySize(m_psar_handles); i++) IndicatorRelease(m_psar_handles[i].handle);
}

// --- ØªØ§Ø¨Ø¹ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
void CTrailingStopManager::Init(long magic_number)
{
  if(m_is_initialized) return;
  m_magic_number = magic_number;
  m_trade.SetExpertMagicNumber(m_magic_number);
  m_trade.SetAsyncMode(true);
  m_tsl_enabled = Inp_TSL_Enable;
  m_activation_rr = Inp_TSL_Activation_RR > 0 ? Inp_TSL_Activation_RR : 1.0;
  m_be_enabled = Inp_BE_Enable;
  m_be_activation_rr = Inp_BE_Activation_RR > 0 ? Inp_BE_Activation_RR : 1.0;
  m_be_plus_pips = Inp_BE_Plus_Pips;
  m_tsl_mode = Inp_TSL_Mode;
  m_buffer_pips = Inp_TSL_Buffer_Pips;
  m_ichimoku_tenkan = Inp_TSL_Ichimoku_Tenkan;
  m_ichimoku_kijun = Inp_TSL_Ichimoku_Kijun;
  m_ichimoku_senkou = Inp_TSL_Ichimoku_Senkou;
  m_ma_period = Inp_TSL_MA_Period;
  m_ma_method = Inp_TSL_MA_Method;
  m_ma_price = Inp_TSL_MA_Price;
  m_atr_period = Inp_TSL_ATR_Period;
  m_atr_multiplier = Inp_TSL_ATR_Multiplier;
  m_psar_step = Inp_TSL_PSAR_Step;
  m_psar_max = Inp_TSL_PSAR_Max;
  m_pricechannel_period = Inp_TSL_PriceChannel_Period;
  if(m_tsl_enabled || m_be_enabled) Log("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Universal Trailing/BE Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ Ù…Ø¬ÛŒÚ© Ù†Ø§Ù…Ø¨Ø± " + (string)m_magic_number + " ÙØ¹Ø§Ù„ Ø´Ø¯.");
  m_is_initialized = true;
}

// âœ…âœ…âœ… ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ (Ù…Ù†Ø·Ù‚ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø³ØªÙ‚Ù„) âœ…âœ…âœ…
void CTrailingStopManager::Process()
{
  if(!m_is_initialized || (!m_tsl_enabled && !m_be_enabled)) return;

  // Ú¯Ø§Ù… Û±: Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†.
  int positions_total = PositionsTotal();
  for(int i = 0; i < positions_total; i++)
  {
      ulong ticket = PositionGetTicket(i);
      if(PositionGetInteger(POSITION_MAGIC) != m_magic_number) continue;

      int state_idx = FindTradeStateIndex(ticket);

      if(state_idx == -1)
      {
          if(PositionSelectByTicket(ticket))
          {
              AddTradeState(ticket, PositionGetDouble(POSITION_PRICE_OPEN), PositionGetDouble(POSITION_SL));
          }
      }
  }

  // âœ…âœ…âœ… Ú¯Ø§Ù… Û²: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª Ø§Ø² Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ âœ…âœ…âœ…
  CleanupTradeStates();

  // Ú¯Ø§Ù… Û³: Ù…Ù†Ø·Ù‚ ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ùˆ Ø³Ø±Ø¨Ù‡â€ŒØ³Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù¾ÙˆØ²ÛŒØ´Ù† Ø¯Ø± Ù„ÛŒØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†.
  for(int i = 0; i < ArraySize(m_trade_states); i++)
  {
    ManageSingleTrade(m_trade_states[i].ticket);
  }
}

// âœ…âœ…âœ… ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ ØªØ±ÛŒØ¯ âœ…âœ…âœ…
void CTrailingStopManager::CleanupTradeStates()
{
    for(int i = ArraySize(m_trade_states) - 1; i >= 0; i--)
    {
        ulong ticket = m_trade_states[i].ticket;
        // Ø§Ú¯Ø± Ù¾ÙˆØ²ÛŒØ´Ù† Ø¨Ø§ Ø§ÛŒÙ† ØªÛŒÚ©Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Ù…Ø¬ÛŒÚ© Ù†Ø§Ù…Ø¨Ø±Ø´ ÙØ±Ù‚ Ø¯Ø§Ø´ØªØŒ ÛŒØ¹Ù†ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡.
        if(!PositionSelectByTicket(ticket) || PositionGetInteger(POSITION_MAGIC) != m_magic_number)
        {
            ArrayRemove(m_trade_states, i, 1);
            Log("Ø­Ø§Ù„Øª ØªÛŒÚ©Øª " + (string)ticket + " Ø§Ø² Ù„ÛŒØ³Øª ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø­Ø°Ù Ø´Ø¯.");
        }
    }
}


// ... Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ Ú©Ù„Ø§Ø³ CTrailingStopManager (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ...
void CTrailingStopManager::ManageSingleTrade(ulong ticket)
{
    if(!PositionSelectByTicket(ticket)) return;

    int state_idx = FindTradeStateIndex(ticket);
    if (state_idx == -1) return;

    double initial_sl = m_trade_states[state_idx].initial_sl;
    
    if (initial_sl == 0)
    {
        double current_sl_from_position = PositionGetDouble(POSITION_SL);
        if (current_sl_from_position > 0)
        {
            m_trade_states[state_idx].initial_sl = current_sl_from_position;
            initial_sl = current_sl_from_position;
            Log("SL Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯: " + (string)initial_sl);
        }
        else
        {
            return;
        }
    }
    
    if(m_be_enabled) ManageBreakeven(state_idx);

    if(!m_tsl_enabled) return;

    string symbol = PositionGetString(POSITION_SYMBOL);
    ENUM_POSITION_TYPE type = (ENUM_POSITION_TYPE)PositionGetInteger(POSITION_TYPE);
    double open_price = PositionGetDouble(POSITION_PRICE_OPEN);
    double initial_risk = MathAbs(open_price - initial_sl);
    if(initial_risk == 0) return;

    double required_profit_for_tsl = initial_risk * m_activation_rr;
    double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
    double current_profit = (type == POSITION_TYPE_BUY) ? (current_price - open_price) : (open_price - current_price);
    
    if(current_profit < required_profit_for_tsl) return;
    
    double new_sl_level = 0;
    switch(m_tsl_mode)
    {
    case TSL_MODE_TENKAN:
    case TSL_MODE_KIJUN:
        new_sl_level = CalculateIchimokuSL(symbol, type);
        break;
    case TSL_MODE_MA:
        new_sl_level = CalculateMaSL(symbol, type);
        break;
    case TSL_MODE_ATR:
        new_sl_level = CalculateAtrSL(symbol, type);
        break;
    case TSL_MODE_PSAR:
        new_sl_level = CalculatePsarSL(symbol, type);
        break;
    case TSL_MODE_PRICE_CHANNEL:
        new_sl_level = CalculatePriceChannelSL(symbol, type);
        break;
    case TSL_MODE_CHANDELIER_ATR:
        new_sl_level = CalculateChandelierAtrSL(symbol, type);
        break;
    }
    if(new_sl_level == 0) return;
    
    double final_new_sl = new_sl_level;
    if(m_tsl_mode == TSL_MODE_TENKAN || m_tsl_mode == TSL_MODE_KIJUN || m_tsl_mode == TSL_MODE_MA)
    {
        double point = SymbolInfoDouble(symbol, SYMBOL_POINT);
        double pips_to_points_multiplier = (SymbolInfoInteger(symbol, SYMBOL_DIGITS) == 3 || SymbolInfoInteger(symbol, SYMBOL_DIGITS) == 5) ? 10.0 : 1.0;
        double buffer_points = m_buffer_pips * point * pips_to_points_multiplier;
        if(type == POSITION_TYPE_BUY) final_new_sl -= buffer_points;
        else final_new_sl += buffer_points;
    }
    
    int digits = (int)SymbolInfoInteger(symbol, SYMBOL_DIGITS);
    final_new_sl = NormalizeDouble(final_new_sl, digits);
    double current_sl = PositionGetDouble(POSITION_SL);

    bool should_modify = false;
    if(type == POSITION_TYPE_BUY)
    {
        if(final_new_sl > current_sl && final_new_sl < current_price) should_modify = true;
    }
    else
    {
        if(final_new_sl < current_sl && final_new_sl > current_price) should_modify = true;
    }

    if(should_modify)
    {
        if(m_trade.PositionModify(ticket, final_new_sl, PositionGetDouble(POSITION_TP)))
        {
            Log("ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + " Ø¨Ù‡ Ù‚ÛŒÙ…Øª " + DoubleToString(final_new_sl, digits) + " Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯.");
        }
        else
        {
            Log("Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + ". Ú©Ø¯: " + (string)m_trade.ResultRetcode() + " | " + m_trade.ResultComment());
        }
    }
}
void CTrailingStopManager::ManageBreakeven(int state_idx)
{
    if(m_trade_states[state_idx].be_applied) return;
    ulong ticket = m_trade_states[state_idx].ticket;
    if(!PositionSelectByTicket(ticket)) return;
    string symbol = PositionGetString(POSITION_SYMBOL);
    ENUM_POSITION_TYPE type = (ENUM_POSITION_TYPE)PositionGetInteger(POSITION_TYPE);

    double initial_sl = m_trade_states[state_idx].initial_sl;
    if(initial_sl == 0) return;
    double open_price = PositionGetDouble(POSITION_PRICE_OPEN);
    double initial_risk = MathAbs(open_price - initial_sl);
    if(initial_risk == 0) return;
    double required_profit_for_be = initial_risk * m_be_activation_rr;
    double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
    double current_profit = (type == POSITION_TYPE_BUY) ? (current_price - open_price) : (open_price - current_price);

    if(current_profit >= required_profit_for_be)
    {
        double point = SymbolInfoDouble(symbol, SYMBOL_POINT);
        double pips_to_points_multiplier = (SymbolInfoInteger(symbol, SYMBOL_DIGITS) == 3 || SymbolInfoInteger(symbol, SYMBOL_DIGITS) == 5) ? 10.0 : 1.0;
        double be_offset = m_be_plus_pips * point * pips_to_points_multiplier;
        double new_sl = (type == POSITION_TYPE_BUY) ? open_price + be_offset : open_price - be_offset;
        int digits = (int)SymbolInfoInteger(symbol, SYMBOL_DIGITS);
        new_sl = NormalizeDouble(new_sl, digits);

        if( (type == POSITION_TYPE_BUY && new_sl > PositionGetDouble(POSITION_SL)) ||
            (type == POSITION_TYPE_SELL && new_sl < PositionGetDouble(POSITION_SL)) )
        {
            if(m_trade.PositionModify(ticket, new_sl, PositionGetDouble(POSITION_TP)))
            {
                Log("Ù…Ø¹Ø§Ù…Ù„Ù‡ ØªÛŒÚ©Øª " + (string)ticket + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø±Ø¨Ù‡â€ŒØ³Ø± (Breakeven) Ø´Ø¯.");
                m_trade_states[state_idx].be_applied = true;
            }
        }
    }
}
int CTrailingStopManager::FindTradeStateIndex(ulong ticket)
{
    for(int i = 0; i < ArraySize(m_trade_states); i++)
    {
        if(m_trade_states[i].ticket == ticket) return i;
    }
    return -1;
}
void CTrailingStopManager::AddTradeState(ulong ticket, double open_price, double initial_sl)
{
    int idx = FindTradeStateIndex(ticket);
    if(idx != -1) return;
    
    int new_idx = ArraySize(m_trade_states);
    ArrayResize(m_trade_states, new_idx + 1);
    m_trade_states[new_idx].ticket = ticket;
    m_trade_states[new_idx].open_price = open_price;
    m_trade_states[new_idx].initial_sl = initial_sl;
    m_trade_states[new_idx].be_applied = false;
    Log("Ø­Ø§Ù„Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + " Ø¨Ø§ SL Ø§ÙˆÙ„ÛŒÙ‡ " + (string)initial_sl + " Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
}
int CTrailingStopManager::GetIchimokuHandle(string symbol)
{
  for(int i=0; i<ArraySize(m_ichimoku_handles); i++) if(m_ichimoku_handles[i].symbol==symbol) return m_ichimoku_handles[i].handle;
  int handle = iIchimoku(symbol, _Period, m_ichimoku_tenkan, m_ichimoku_kijun, m_ichimoku_senkou);
  if(handle!=INVALID_HANDLE){int n=ArraySize(m_ichimoku_handles); ArrayResize(m_ichimoku_handles,n+1); m_ichimoku_handles[n].symbol=symbol; m_ichimoku_handles[n].handle=handle;}
  return handle;
}
int CTrailingStopManager::GetMaHandle(string symbol)
{
  for(int i=0; i<ArraySize(m_ma_handles); i++) if(m_ma_handles[i].symbol==symbol) return m_ma_handles[i].handle;
  int handle = iMA(symbol, _Period, m_ma_period, 0, m_ma_method, m_ma_price);
  if(handle!=INVALID_HANDLE){int n=ArraySize(m_ma_handles); ArrayResize(m_ma_handles,n+1); m_ma_handles[n].symbol=symbol; m_ma_handles[n].handle=handle;}
  return handle;
}
int CTrailingStopManager::GetAtrHandle(string symbol)
{
  for(int i=0; i<ArraySize(m_atr_handles); i++) if(m_atr_handles[i].symbol==symbol) return m_atr_handles[i].handle;
  int handle = iATR(symbol, _Period, m_atr_period);
  if(handle!=INVALID_HANDLE){int n=ArraySize(m_atr_handles); ArrayResize(m_atr_handles,n+1); m_atr_handles[n].symbol=symbol; m_atr_handles[n].handle=handle;}
  return handle;
}
int CTrailingStopManager::GetPsarHandle(string symbol)
{
  for(int i=0; i<ArraySize(m_psar_handles); i++) if(m_psar_handles[i].symbol==symbol) return m_psar_handles[i].handle;
  int handle = iSAR(symbol, _Period, m_psar_step, m_psar_max);
  if(handle!=INVALID_HANDLE){int n=ArraySize(m_psar_handles); ArrayResize(m_psar_handles,n+1); m_psar_handles[n].symbol=symbol; m_psar_handles[n].handle=handle;}
  return handle;
}
void CTrailingStopManager::Log(string message)
{
  if (m_magic_number > 0) Print("TSL Manager [", (string)m_magic_number, "]: ", message);
}
double CTrailingStopManager::CalculateIchimokuSL(string symbol, ENUM_POSITION_TYPE type)
{
  int handle = GetIchimokuHandle(symbol);
  if(handle == INVALID_HANDLE) return 0.0;
  int buffer_idx = (m_tsl_mode == TSL_MODE_TENKAN) ? 0 : 1;
  double values[1];
  if(CopyBuffer(handle, buffer_idx, 1, 1, values) < 1) return 0.0;
  double line_value = values[0];
  double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
  if (type == POSITION_TYPE_BUY && line_value > current_price) return 0.0;
  if (type == POSITION_TYPE_SELL && line_value < current_price) return 0.0;
  return line_value;
}
double CTrailingStopManager::CalculateMaSL(string symbol, ENUM_POSITION_TYPE type)
{
  int handle = GetMaHandle(symbol);
  if(handle == INVALID_HANDLE) return 0.0;
  double values[1];
  if(CopyBuffer(handle, 0, 1, 1, values) < 1) return 0.0;
  double ma_value = values[0];
  double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
  if (type == POSITION_TYPE_BUY && ma_value > current_price) return 0.0;
  if (type == POSITION_TYPE_SELL && ma_value < current_price) return 0.0;
  return ma_value;
}
double CTrailingStopManager::CalculateAtrSL(string symbol, ENUM_POSITION_TYPE type)
{
  int handle = GetAtrHandle(symbol);
  if(handle == INVALID_HANDLE) return 0.0;
  double values[1];
  if(CopyBuffer(handle, 0, 1, 1, values) < 1) return 0.0;
  double atr_offset = values[0] * m_atr_multiplier;
  double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
  if(type == POSITION_TYPE_BUY) return current_price - atr_offset;
  else return current_price + atr_offset;
}
double CTrailingStopManager::CalculatePsarSL(string symbol, ENUM_POSITION_TYPE type)
{
  int handle = GetPsarHandle(symbol);
  if(handle == INVALID_HANDLE) return 0.0;
  double values[1];
  if(CopyBuffer(handle, 0, 1, 1, values) < 1) return 0.0;
  double psar_value = values[0];
  double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
  if (type == POSITION_TYPE_BUY && psar_value > current_price) return 0.0;
  if (type == POSITION_TYPE_SELL && psar_value < current_price) return 0.0;
  return psar_value;
}
double CTrailingStopManager::CalculatePriceChannelSL(string symbol, ENUM_POSITION_TYPE type)
{
  double values[];
  if(type == POSITION_TYPE_BUY)
  {
      if(CopyLow(symbol, _Period, 1, m_pricechannel_period, values) < m_pricechannel_period) return 0.0;
      return values[ArrayMinimum(values, 0, m_pricechannel_period)];
  }
  else
  {
      if(CopyHigh(symbol, _Period, 1, m_pricechannel_period, values) < m_pricechannel_period) return 0.0;
      return values[ArrayMaximum(values, 0, m_pricechannel_period)];
  }
}
double CTrailingStopManager::CalculateChandelierAtrSL(string symbol, ENUM_POSITION_TYPE type)
{
  int atr_handle = GetAtrHandle(symbol);
  if(atr_handle == INVALID_HANDLE) return 0.0;
  double atr_values[1];
  if(CopyBuffer(atr_handle, 0, 1, 1, atr_values) < 1) return 0.0;
  double atr_offset = atr_values[0] * m_atr_multiplier;
  double price_channel_values[];
  if(type == POSITION_TYPE_BUY)
  {
      if(CopyHigh(symbol, _Period, 1, m_pricechannel_period, price_channel_values) < m_pricechannel_period) return 0.0;
      double highest_high = price_channel_values[ArrayMaximum(price_channel_values, 0, m_pricechannel_period)];
      return highest_high - atr_offset;
  }
  else
  {
      if(CopyLow(symbol, _Period, 1, m_pricechannel_period, price_channel_values) < m_pricechannel_period) return 0.0;
      double lowest_low = price_channel_values[ArrayMinimum(price_channel_values, 0, m_pricechannel_period)];
      return lowest_low + atr_offset;
  }
}





