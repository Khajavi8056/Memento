ÙØ§ÛŒÙ„ 1:

:


//+------------------------------------------------------------------+
//|                                                                  |
//|                    Project: Memento (By HipoAlgorithm)           |
//|                    File: set.mqh (EA Settings)                   |
//|                    Version: 3.1 (Final Fixed)                    |
//|                    Â© 2025, Mohammad & Gemini                     |
//|                                                                  |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "3.1"

//--- Ø§Ù†ÙˆØ§Ø¹ Ø´Ù…Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± Ú©Ø¯
enum E_Confirmation_Mode { MODE_CLOSE_ONLY, MODE_OPEN_AND_CLOSE };
enum E_SL_Mode           { MODE_COMPLEX, MODE_SIMPLE };

//+------------------------------------------------------------------+
//|                      ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø§Ú©Ø³Ù¾Ø±Øª                         |
//+------------------------------------------------------------------+

// ---=== âš™ï¸ 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ (General) âš™ï¸ ===---
input group           "          ---=== âš™ï¸ 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ (General) âš™ï¸ ===---"
input bool            Inp_Enable_Dashboard  = true;                   // âœ… ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ
input string          Inp_Symbols_List      = "EURUSD,XAUUSD,GBPUSD"; // Ù„ÛŒØ³Øª Ù†Ù…Ø§Ø¯Ù‡Ø§ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)
input int             Inp_Magic_Number      = 12345;                  // Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø§Ø¯ÙˆÛŒÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
input bool            Inp_Enable_Logging    = true;                   // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§

// ---=== ğŸ“ˆ 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ (Ichimoku) ğŸ“ˆ ===---
input group           "      ---=== ğŸ“ˆ 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ (Ichimoku) ğŸ“ˆ ===---"
input int             Inp_Tenkan_Period     = 9;                      // Ø¯ÙˆØ±Ù‡ ØªÙ†Ú©Ø§Ù†-Ø³Ù†
input int             Inp_Kijun_Period      = 26;                     // Ø¯ÙˆØ±Ù‡ Ú©ÛŒØ¬ÙˆÙ†-Ø³Ù†
input int             Inp_Senkou_Period     = 52;                     // Ø¯ÙˆØ±Ù‡ Ø³Ù†Ú©Ùˆ Ø§Ø³Ù¾Ù† Ø¨ÛŒ
input int             Inp_Chikou_Period     = 26;                     // Ø¯ÙˆØ±Ù‡ Ú†ÛŒÚ©Ùˆ Ø§Ø³Ù¾Ù† (Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹)

// ---=== ğŸ¯ 3. Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ (Signal & Confirmation) ğŸ¯ ===---
input group           "---=== ğŸ¯ 3. Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ (Signal & Confirmation) ğŸ¯ ===---"
input E_Confirmation_Mode Inp_Confirmation_Type = MODE_OPEN_AND_CLOSE;  // Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ
input int             Inp_Grace_Period_Candles= 5;                      // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…Ù‡Ù„Øª Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡

// --- Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ø§Ù‚ÛŒ (Confluence)
input group           "         --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ø§Ù‚ÛŒ (Confluence) ---"
input bool            Inp_Talaqi_Auto_Mode    = true;                   // âœ… ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ø¨Ø±Ø§ÛŒ ÙØ§ØµÙ„Ù‡ ØªÙ„Ø§Ù‚ÛŒ
input double          Inp_Talaqi_Distance_in_Points = 3.0;              // [MANUAL] ÙØ§ØµÙ„Ù‡ ØªÙ„Ø§Ù‚ÛŒ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÙˆÛŒÙ†Øª)
input int             Inp_Talaqi_Lookback_Period  = 10;                 // [AUTO] Ø¯ÙˆØ±Ù‡ Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ ØªØ§Ø±ÛŒØ®ÛŒ
input double          Inp_Talaqi_Hist_Multiplier = 0.5;                // [AUTO] Ø¶Ø±ÛŒØ¨ ØªÙ„Ø§Ù‚ÛŒ (Ù…Ø«Ù„Ø§ 0.5 ÛŒØ¹Ù†ÛŒ 50% ÙØ§ØµÙ„Ù‡ ØªØ§Ø±ÛŒØ®ÛŒ)

// ---=== ğŸ›¡ï¸ 4. Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø± (Stop Loss) ğŸ›¡ï¸ ===---
input group           "       ---=== ğŸ›¡ï¸ 4. Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø± (Stop Loss) ğŸ›¡ï¸ ===---"
input E_SL_Mode       Inp_StopLoss_Type       = MODE_COMPLEX;           // Ø±ÙˆØ´ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³
input int             Inp_Flat_Kijun_Period   = 50;                     // [COMPLEX] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
input int             Inp_Flat_Kijun_Min_Length = 5;                    // [COMPLEX] Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
input int             Inp_Pivot_Lookback      = 30;                     // [COMPLEX] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙˆØª
input int             Inp_SL_Lookback_Period  = 15;                     // [SIMPLE] Ø¯ÙˆØ±Ù‡ Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ø³Ù‚Ù/Ú©Ù
input double          Inp_SL_Buffer_Multiplier = 3.0;                   // Ø¶Ø±ÛŒØ¨ Ø¨Ø§ÙØ± Ø¨Ø±Ø§ÛŒ ÙØ§ØµÙ„Ù‡ Ø§Ø² Ø³Ù‚Ù/Ú©Ù

// ---=== ğŸ’° 5. Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡ (Money Management) ğŸ’° ===---
input group           " ---=== ğŸ’° 5. Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡ (Money Management) ğŸ’° ===---"
input double          Inp_Risk_Percent_Per_Trade = 1.0;                 // Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú© Ø¯Ø± Ù‡Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡
input double          Inp_Take_Profit_Ratio   = 1.5;                    // Ù†Ø³Ø¨Øª Ø±ÛŒØ³Ú© Ø¨Ù‡ Ø±ÛŒÙˆØ§Ø±Ø¯ Ø¨Ø±Ø§ÛŒ Ø­Ø¯ Ø³ÙˆØ¯
input int             Inp_Max_Trades_Per_Symbol = 1;                    // Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø² Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§Ø¯
input int             Inp_Max_Total_Trades    = 5;                      // Ø­Ø¯Ø§Ú©Ø«Ø± Ú©Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø²

// ---=== ğŸ¨ 6. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ (Visuals) ğŸ¨ ===---
input group           "        ---=== ğŸ¨ 6. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ (Visuals) ğŸ¨ ===---"
input double          Inp_Object_Size_Multiplier = 1.0;                 // Ø¶Ø±ÛŒØ¨ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø§Ø´ÛŒØ§Ø¡ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
input color           Inp_Bullish_Color       = clrLimeGreen;           // Ø±Ù†Ú¯ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ø§Ø´ÛŒØ§Ø¡ Ø®Ø±ÛŒØ¯
input color           Inp_Bearish_Color       = clrRed;                 // Ø±Ù†Ú¯ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ø§Ø´ÛŒØ§Ø¡ ÙØ±ÙˆØ´


//+------------------------------------------------------------------+
//|     Ø³Ø§Ø®ØªØ§Ø± Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ØªÙ…Ø§Ù… ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ (SSettings)       |
//+------------------------------------------------------------------+
struct SSettings
{
    // 1. General
    bool                enable_dashboard;
    string              symbols_list;
    int                 magic_number;
    bool                enable_logging;
    // 2. Ichimoku
    int                 tenkan_period, kijun_period, senkou_period, chikou_period;
    // 3. Signal & Confirmation
    E_Confirmation_Mode confirmation_type;
    int                 grace_period_candles;
    // 3.1. Talaqi
    bool                talaqi_auto_mode;
    double              talaqi_distance_in_points;
    int                 talaqi_lookback_period;
    double              talaqi_hist_multiplier;
    // 4. Stop Loss
    E_SL_Mode           stoploss_type;
    int                 flat_kijun_period, flat_kijun_min_length, pivot_lookback, sl_lookback_period;
    double              sl_buffer_multiplier;
    // 5. Money Management
    double              risk_percent_per_trade, take_profit_ratio;
    int                 max_trades_per_symbol, max_total_trades;
    // 6. Visuals
    double              object_size_multiplier;
    color               bullish_color, bearish_color;
};





ÙØ§ÛŒÙ„ 2:::

//+------------------------------------------------------------------+
//|                                                      Memento.mq5 |
//|                                  Copyright 2025,hipoalgoritm |
//|                                                  Final & Bulletproof |
//+------------------------------------------------------------------+
#property copyright "Copyright 2025,hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "1.6" // Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ú©Ø§Ù…Ù„Ø§ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
#property description "Ø§Ú©Ø³Ù¾Ø±Øª Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù…Ù…Ù†ØªÙˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ú©Ø±Ø§Ø³ Ø³Ù‡ Ú¯Ø§Ù†Ù‡ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ"

#include <Trade\Trade.mqh>
#include <Object.mqh>
#include "IchimokuLogic.mqh"
#include "VisualManager.mqh"


//--- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
SSettings            g_settings;
string               g_symbols_array[];
CStrategyManager* g_symbol_managers[];

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ Ø§Ú©Ø³Ù¾Ø±Øª (Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡)                                |
//+------------------------------------------------------------------+
//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ Ø§Ú©Ø³Ù¾Ø±Øª (Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡)                                |
//+------------------------------------------------------------------+
int OnInit()
{
    //--- âœ…âœ…âœ… Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ú©Ø§Ù…Ù„ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù† âœ…âœ…âœ… ---
    //--- Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø³Ø§Ø®ØªØ§Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± (Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)
    g_settings.enable_dashboard           = Inp_Enable_Dashboard;
    g_settings.symbols_list                 = Inp_Symbols_List;
    g_settings.magic_number                 = Inp_Magic_Number;
    g_settings.enable_logging               = Inp_Enable_Logging;
    
    g_settings.tenkan_period                = Inp_Tenkan_Period;
    g_settings.kijun_period                 = Inp_Kijun_Period;
    g_settings.senkou_period                = Inp_Senkou_Period;
    g_settings.chikou_period                = Inp_Chikou_Period;
    
    g_settings.confirmation_type            = Inp_Confirmation_Type;
    g_settings.grace_period_candles         = Inp_Grace_Period_Candles;
    
    g_settings.talaqi_auto_mode             = Inp_Talaqi_Auto_Mode;
    g_settings.talaqi_distance_in_points    = Inp_Talaqi_Distance_in_Points;
    g_settings.talaqi_lookback_period       = Inp_Talaqi_Lookback_Period;
    g_settings.talaqi_hist_multiplier       = Inp_Talaqi_Hist_Multiplier;
    
    g_settings.stoploss_type                = Inp_StopLoss_Type;
    g_settings.sl_lookback_period           = Inp_SL_Lookback_Period;
    g_settings.sl_buffer_multiplier         = Inp_SL_Buffer_Multiplier;
    g_settings.flat_kijun_period            = Inp_Flat_Kijun_Period;
    g_settings.flat_kijun_min_length        = Inp_Flat_Kijun_Min_Length;
    g_settings.pivot_lookback               = Inp_Pivot_Lookback;
    
    g_settings.risk_percent_per_trade       = Inp_Risk_Percent_Per_Trade;
    g_settings.take_profit_ratio            = Inp_Take_Profit_Ratio;
    g_settings.max_trades_per_symbol        = Inp_Max_Trades_Per_Symbol;
    g_settings.max_total_trades             = Inp_Max_Total_Trades;
    
    g_settings.object_size_multiplier       = Inp_Object_Size_Multiplier;
    g_settings.bullish_color                = Inp_Bullish_Color;
    g_settings.bearish_color                = Inp_Bearish_Color;

    //--- ØªÙ‚Ø³ÛŒÙ… Ø±Ø´ØªÙ‡ Ù†Ù…Ø§Ø¯Ù‡Ø§ Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ø´ÛŒØ¡ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§Ø¯
    // (Ø¨Ù‚ÛŒÙ‡ ØªØ§Ø¨Ø¹ OnInit Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
    int symbols_count = StringSplit(g_settings.symbols_list, ',', g_symbols_array);
    if (symbols_count == 0)
    {
        Print("Ø®Ø·Ø§: Ù‡ÛŒÚ† Ù†Ù…Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        return INIT_FAILED;
    }
    
    ArrayResize(g_symbol_managers, symbols_count);
    for (int i = 0; i < symbols_count; i++)
    {
        string sym = g_symbols_array[i];
        StringTrimLeft(sym);
        StringTrimRight(sym);
        g_symbol_managers[i] = new CStrategyManager(sym, g_settings);
        if (!g_symbol_managers[i].Init())
        {
            Print("Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù…Ø§Ø¯ ", sym, " Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.");
            return INIT_FAILED;
        }
    }

    Print("Ø§Ú©Ø³Ù¾Ø±Øª Memento Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø¯: ", g_settings.symbols_list);
    
    //--- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¯Ø§ÙˆÙ…
    EventSetTimer(1);
    return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù¾Ø§ÛŒØ§Ù† Ø§Ú©Ø³Ù¾Ø±Øª (Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ)                                      |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
{
    EventKillTimer();
    //--- Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´ÛŒØ¡Ù‡Ø§
    for (int i = 0; i < ArraySize(g_symbol_managers); i++)
    {
        if (g_symbol_managers[i] != NULL)
        {
            delete g_symbol_managers[i];
            g_symbol_managers[i] = NULL;
        }
    }
    ArrayFree(g_symbol_managers);
    //--- Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø´ÛŒØ§Ø¡ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
    //--- Ø§Ø² VisualManager Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ø´ÛŒØ§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ…
    ObjectsDeleteAll(0, g_settings.symbols_list);
    ChartRedraw();
}

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ ØªØ§ÛŒÙ…Ø± (Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¯Ø§ÙˆÙ… Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§)                      |
//+------------------------------------------------------------------+
void OnTimer()
{
    //--- Ø§Ø¬Ø±Ø§ÛŒ Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ ØªØ­Øª Ù…Ø¯ÛŒØ±ÛŒØª
    for (int i = 0; i < ArraySize(g_symbol_managers); i++)
    {
        if (g_symbol_managers[i] != NULL)
        {
            g_symbol_managers[i].ProcessNewBar();
        }
    }
}


ÙØ§ÛŒÙ„3::::
//+------------------------------------------------------------------+
//|                                     IchimokuLogic.mqh            |
//|                          Â© 2025, hipoalgoritm              |
//+------------------------------------------------------------------+
#property copyright "Â© 2025,hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "1.03" // Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ú©Ø§Ù…Ù„Ø§ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
#include "set.mqh"
#include <Trade\Trade.mqh>
#include <Trade\SymbolInfo.mqh>
#include <Object.mqh>
#include "VisualManager.mqh"

//--- ØªØ¹Ø±ÛŒÙ Ø³Ø§Ø®ØªØ§Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„
struct SPotentialSignal
{
    datetime        time;
    bool            is_buy;
    int             grace_candle_count;
};
/*struct SSettings
{
    string              symbols_list;
    int                 magic_number;
    bool                enable_logging;

    int                 tenkan_period;
    int                 kijun_period;
    int                 senkou_period;
    int                 chikou_period;

    E_Confirmation_Mode confirmation_type;
    int                 grace_period_candles;
    double              talaqi_distance_in_points;

    E_SL_Mode           stoploss_type;
    int                 sl_lookback_period;
    double              sl_buffer_multiplier;

    double              risk_percent_per_trade;
    double              take_profit_ratio;
    int                 max_trades_per_symbol;
    int                 max_total_trades;

    double              object_size_multiplier;
    color               bullish_color;
    color               bearish_color;
};
*/
//+------------------------------------------------------------------+
//| Ú©Ù„Ø§Ø³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ù†Ù…Ø§Ø¯ Ø®Ø§Øµ                             |
//+------------------------------------------------------------------+
class CStrategyManager
{
private:
    string              m_symbol;
    SSettings           m_settings;
    CTrade              m_trade;
   
    datetime            m_last_bar_time;
    
    int                 m_ichimoku_handle;
    double              m_tenkan_buffer[];
    double              m_kijun_buffer[];
    double              m_chikou_buffer[];
    
    SPotentialSignal    m_signal;
    bool                m_is_waiting;
    
    CVisualManager* m_visual_manager;

    //--- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
    void Log(string message);
    bool CheckTripleCross(bool& is_buy);
    bool CheckFinalConfirmation(bool is_buy);
    
    //--- Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³
    double CalculateStopLoss(bool is_buy, double entry_price);
    
    double GetTalaqiTolerance(int reference_shift);      // <<-- Ø§ÛŒÙ† Ø®Ø· Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    double CalculateDynamicTolerance(int reference_shift); // <<-- Ø§ÛŒÙ† Ø®Ø· Ø±Ùˆ Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
  
    double FindFlatKijun();
    double FindPivotKijun(bool is_buy);
    double FindPivotTenkan(bool is_buy);
    double FindBackupStopLoss(bool is_buy, double buffer);
    
    //--- Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    int CountSymbolTrades();
    int CountTotalTrades();
    void OpenTrade(bool is_buy);

public:
    CStrategyManager(string symbol,   SSettings &settings);
    bool Init();
    void ProcessNewBar();
    
    ~CStrategyManager();
};

//+------------------------------------------------------------------+
//| Ú©Ø§Ù†Ø³ØªØ±Ø§Ú©ØªÙˆØ± Ú©Ù„Ø§Ø³                                                |
//+------------------------------------------------------------------+
CStrategyManager::CStrategyManager(string symbol, SSettings &settings)

{
    m_symbol = symbol;
    m_settings = settings;
    m_last_bar_time = 0;
    m_is_waiting = false;
    m_ichimoku_handle = INVALID_HANDLE;
    m_visual_manager = new CVisualManager(m_symbol, m_settings);

}

//+------------------------------------------------------------------+
//| Ø¯ÛŒØ³ØªØ±Ø§Ú©ØªÙˆØ± Ú©Ù„Ø§Ø³                                                  |
//+------------------------------------------------------------------+
CStrategyManager::~CStrategyManager()
{
    if (m_visual_manager != NULL)
    {
        delete m_visual_manager;
        m_visual_manager = NULL;
    }
}

//+------------------------------------------------------------------+
//| Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡                                                   |
//+------------------------------------------------------------------+
//+------------------------------------------------------------------+
//| Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡                                                   |
//+------------------------------------------------------------------+
bool CStrategyManager::Init()
{
    m_trade.SetExpertMagicNumber(m_settings.magic_number);
    m_trade.SetTypeFillingBySymbol(m_symbol);
    
    m_ichimoku_handle = iIchimoku(m_symbol, _Period, m_settings.tenkan_period, m_settings.kijun_period, m_settings.senkou_period);
    if (m_ichimoku_handle == INVALID_HANDLE)
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± Ichimoku.");
        return false;
    }
    
    ArraySetAsSeries(m_tenkan_buffer, true);
    ArraySetAsSeries(m_kijun_buffer, true);
    ArraySetAsSeries(m_chikou_buffer, true);
    
    if (!m_visual_manager.Init())
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ VisualManager.");
        return false;
    }

    // âœ…âœ…âœ… Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ âœ…âœ…âœ…
    // ÙÙ‚Ø· Ù†Ù…ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù†Ù…Ø§Ø¯Ø´ Ø¨Ø§ Ù†Ù…Ø§Ø¯ Ú†Ø§Ø±Øª ÛŒÚ©ÛŒ Ø§Ø³ØªØŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯
    if(m_symbol == _Symbol)
    {
         Print("--- DEBUG 1: Master instance found for '", m_symbol, "'. Calling InitDashboard...");
        m_visual_manager.InitDashboard();
    }
    
    Log("Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø¯.");
    return true;
}

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯                                       |
//+------------------------------------------------------------------+
void CStrategyManager::ProcessNewBar()
{
    datetime current_bar_time = iTime(m_symbol, _Period, 0);
    if (current_bar_time == m_last_bar_time)
        return;
    m_last_bar_time = current_bar_time;

    // âœ…âœ…âœ… Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ âœ…âœ…âœ…
    // ÙÙ‚Ø· Ù†Ù…ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù†Ù…Ø§Ø¯Ø´ Ø¨Ø§ Ù†Ù…Ø§Ø¯ Ú†Ø§Ø±Øª ÛŒÚ©ÛŒ Ø§Ø³ØªØŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    if(m_symbol == _Symbol)
    {
    m_visual_manager.UpdateDashboard();
    }

    bool is_buy_signal = false;
    if (!m_is_waiting && CheckTripleCross(is_buy_signal))
    {
        m_is_waiting = true;
        m_signal.time = iTime(m_symbol, _Period, m_settings.chikou_period);
        m_signal.is_buy = is_buy_signal;
        m_signal.grace_candle_count = 0;
        
        Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡ " + (is_buy_signal ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¯Ø± Ú©Ù†Ø¯Ù„ " + TimeToString(m_signal.time) + " Ù¾ÛŒØ¯Ø§ Ø´Ø¯.");
        m_visual_manager.DrawTripleCrossRectangle(m_signal.is_buy, m_settings.chikou_period);
    }
    
    if (m_is_waiting)
    {
        m_visual_manager.DrawScanningArea(m_signal.is_buy, m_settings.chikou_period, m_signal.grace_candle_count);
        
        if (m_signal.grace_candle_count >= m_settings.grace_period_candles)
        {
            m_is_waiting = false;
          //  m_visual_manager.ClearGraphics();
            Log("Ø²Ù…Ø§Ù† ØªØ£ÛŒÛŒØ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„ " + (m_signal.is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø±Ø¯ Ø´Ø¯.");
        }
        else if (CheckFinalConfirmation(m_signal.is_buy))
        {
            m_is_waiting = false;
          //  m_visual_manager.ClearGraphics();
            m_visual_manager.DrawConfirmationArrow(m_signal.is_buy, 1);
            Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ " + (m_signal.is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡.");
            OpenTrade(m_signal.is_buy);
        }
        else
        {
            m_signal.grace_candle_count++;
        }
    }
}
//+------------------------------------------------------------------+
//| Ù…Ù†Ø·Ù‚ ÙØ§Ø² Û±: Ú†Ú© Ú©Ø±Ø¯Ù† Ú©Ø±Ø§Ø³ Ø³Ù‡ Ú¯Ø§Ù†Ù‡ (Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù†Ø·Ù‚ ØµØ­ÛŒØ­) |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckTripleCross(bool& is_buy)
{
    int shift = m_settings.chikou_period;
    if (iBars(m_symbol, _Period) < shift + 2) return false;

    //--- Ø®ÙˆØ§Ù†Ø¯Ù† Tenkan Ùˆ Kijun Ø§Ø² Ø¨Ø§ÙØ± Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± Ø¯Ø± Ú©Ù†Ø¯Ù„ Ù…Ø±Ø¬Ø¹ (Û²Û¶ Ú©Ù†Ø¯Ù„ Ù‚Ø¨Ù„)
    CopyBuffer(m_ichimoku_handle, 0, shift, 2, m_tenkan_buffer);
    CopyBuffer(m_ichimoku_handle, 1, shift, 2, m_kijun_buffer);
    
    //--- Ù…Ù‚Ø§Ø¯ÛŒØ± ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹
    double tenkan_at_shift = m_tenkan_buffer[0]; // Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø± Ú©Ù†Ø¯Ù„ Û²Û¶
    double kijun_at_shift = m_kijun_buffer[0];  // Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø± Ú©Ù†Ø¯Ù„ Û²Û¶

    //--- Ø®ÙˆØ§Ù†Ø¯Ù† Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ùˆ Ù‚Ø¨Ù„ÛŒ Ú©Ù‡ Ù†Ù‚Ø´ Ú†ÛŒÚ©Ùˆ Ø§Ø³Ù¾Ù† Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹ Ø¨Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯
    double chikou_now  = iClose(m_symbol, _Period, 1); // Ù‚ÛŒÙ…Øª Close Ú©Ù†Ø¯Ù„ ÙØ¹Ù„ÛŒ
    double chikou_prev = iClose(m_symbol, _Period, 2); // Ù‚ÛŒÙ…Øª Close Ú©Ù†Ø¯Ù„ Ù‚Ø¨Ù„ÛŒ

        //--- Ø¨Ø±Ø±Ø³ÛŒ ØªÙ„Ø§Ù‚ÛŒ ÛŒØ§ Ú©Ø±Ø§Ø³ ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡
    double tolerance = GetTalaqiTolerance(shift); // Ú¯Ø±ÙØªÙ† Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø² Ù…Ø¯ÛŒØ± Ú©Ù„!
    
    double current_distance = MathAbs(tenkan_at_shift - kijun_at_shift);
    bool is_confluence = (tolerance > 0) ? (current_distance <= tolerance) : false;


    bool tenkan_crossover = m_tenkan_buffer[1] < m_kijun_buffer[1] && tenkan_at_shift > kijun_at_shift;
    bool tenkan_crossunder = m_tenkan_buffer[1] > m_kijun_buffer[1] && tenkan_at_shift < kijun_at_shift;

    // --- Ø´Ø±Ø· Ø®Ø±ÛŒØ¯: Ú©Ø±Ø§Ø³ ØµØ¹ÙˆØ¯ÛŒ ØªÙ†Ú©Ø§Ù†/Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ùˆ Ú©Ø±Ø§Ø³ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ (Ú†ÛŒÚ©Ùˆ) Ø§Ø² Ø¢Ù†Ù‡Ø§
    if (tenkan_crossover || (is_confluence && tenkan_at_shift > kijun_at_shift))
    {
        //--- Ø¢ÛŒØ§ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ (Ú†ÛŒÚ©Ùˆ) Ø§Ø² Ø®Ø·ÙˆØ· ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹ Ø¹Ø¨ÙˆØ± Ú©Ø±Ø¯Ù‡ØŸ
        bool chikou_crosses_up = (chikou_prev < tenkan_at_shift && chikou_now > tenkan_at_shift) && 
                                 (chikou_prev < kijun_at_shift && chikou_now > kijun_at_shift);
      
        if (chikou_crosses_up)
        {
            is_buy = true;
            return true;
        }
    }
    
    // --- Ø´Ø±Ø· ÙØ±ÙˆØ´: Ú©Ø±Ø§Ø³ Ù†Ø²ÙˆÙ„ÛŒ ØªÙ†Ú©Ø§Ù†/Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ùˆ Ú©Ø±Ø§Ø³ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ (Ú†ÛŒÚ©Ùˆ) Ø§Ø² Ø¢Ù†Ù‡Ø§
    if (tenkan_crossunder || (is_confluence && tenkan_at_shift < kijun_at_shift))
    {
        //--- Ø¢ÛŒØ§ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ (Ú†ÛŒÚ©Ùˆ) Ø§Ø² Ø®Ø·ÙˆØ· ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹ Ø¹Ø¨ÙˆØ± Ú©Ø±Ø¯Ù‡ØŸ
        bool chikou_crosses_down = (chikou_prev > tenkan_at_shift && chikou_now < tenkan_at_shift) && 
                                   (chikou_prev > kijun_at_shift && chikou_now < kijun_at_shift);
        if (chikou_crosses_down)
        {
            is_buy = false;
            return true;
        }
    }
    
    return false;
}



//+------------------------------------------------------------------+
//| Ù…Ù†Ø·Ù‚ ÙØ§Ø² Û²: Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú©Ù†Ø¯Ù„ Ø´Ù…Ø§Ø±Ù‡ ÛŒÚ© (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)      |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckFinalConfirmation(bool is_buy)
{
    if (iBars(m_symbol, _Period) < 2) return false;

    CopyBuffer(m_ichimoku_handle, 0, 1, 1, m_tenkan_buffer);
    CopyBuffer(m_ichimoku_handle, 1, 1, 1, m_kijun_buffer);
    
    double tenkan_at_1 = m_tenkan_buffer[0];
    double kijun_at_1 = m_kijun_buffer[0];
    double open_at_1 = iOpen(m_symbol, _Period, 1);
    double close_at_1 = iClose(m_symbol, _Period, 1);
    
    if (is_buy)
    {
        if (tenkan_at_1 <= kijun_at_1) return false;
        if (m_settings.confirmation_type == MODE_OPEN_AND_CLOSE)
        {
           // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯
          // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯
        if (open_at_1 < tenkan_at_1 || open_at_1 < kijun_at_1 || close_at_1 < tenkan_at_1 || close_at_1 < kijun_at_1) return false;


        }
        else // MODE_CLOSE_ONLY
        {
            if (close_at_1 < tenkan_at_1 ||
            close_at_1 < kijun_at_1) return false;
        }
        return true;
    }
    else // is_sell
    {
        if (tenkan_at_1 >= kijun_at_1) return false;
        if (m_settings.confirmation_type == MODE_OPEN_AND_CLOSE)
        {
            if (open_at_1 > tenkan_at_1 || open_at_1 > kijun_at_1 || close_at_1 > tenkan_at_1 || close_at_1 > kijun_at_1) return false;
        }
        else // MODE_CLOSE_ONLY
        {
            if (close_at_1 > tenkan_at_1 || close_at_1 > kijun_at_1) return false;
        }
        return true;
    
    }
}


//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ (Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ø±ÙˆØ´ Ù†Ù‡Ø§ÛŒÛŒ)                       |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateStopLoss(bool is_buy, double entry_price)
{
    double buffer = m_settings.sl_buffer_multiplier * SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double sl_price = 0;

    if (m_settings.stoploss_type == MODE_COMPLEX)
    {
        sl_price = FindFlatKijun();
        if (sl_price != 0) return is_buy ? sl_price - buffer : sl_price + buffer;
        
        sl_price = FindPivotKijun(is_buy);
        if (sl_price != 0) return is_buy ? sl_price - buffer : sl_price + buffer;
        
        sl_price = FindPivotTenkan(is_buy);
        if (sl_price != 0) return is_buy ? sl_price - buffer : sl_price + buffer;
    }
    
    return FindBackupStopLoss(is_buy, buffer);
}

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)                           |
//+------------------------------------------------------------------+
double CStrategyManager::FindBackupStopLoss(bool is_buy, double buffer)
{
    double sl_price = 0;
    int bars_to_check = m_settings.sl_lookback_period + 1;
    if (iBars(m_symbol, _Period) < bars_to_check) return 0;
    
    if (is_buy)
    {
        double min_low = iLow(m_symbol, _Period, 1);
        for (int i = 1; i < bars_to_check; i++)
        {
            if (iLow(m_symbol, _Period, i) < min_low)
            {
                min_low = iLow(m_symbol, _Period, i);
            }
        }
        sl_price = min_low - buffer;
    }
    else // is_sell
    {
        double max_high = iHigh(m_symbol, _Period, 1);
        for (int i = 1; i < bars_to_check; i++)
        {
            if (iHigh(m_symbol, _Period, i) > max_high)
            {
                max_high = iHigh(m_symbol, _Period, i);
            }
        }
        sl_price = max_high + buffer;
    }
    
    return sl_price;
}


//+------------------------------------------------------------------+
//| ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¯ÛŒÚ¯Ø±                                                  |
//+------------------------------------------------------------------+
void CStrategyManager::Log(string message)
{
    if (m_settings.enable_logging)
    {
        Print(m_symbol, ": ", message);
    }
}

int CStrategyManager::CountSymbolTrades()
{
    int count = 0;
    for(int i = PositionsTotal() - 1; i >= 0; i--)
    {
        if(PositionGetSymbol(i) == m_symbol && PositionGetInteger(POSITION_MAGIC) == (long)m_settings.magic_number)
        {
            count++;
        }
    }
    return count;
}

int CStrategyManager::CountTotalTrades()
{
    int count = 0;
    for(int i = PositionsTotal() - 1; i >= 0; i--)
    {
        if(PositionGetInteger(POSITION_MAGIC) == (long)m_settings.magic_number)
        {
            count++;
        }
    }
    return count;
}

void CStrategyManager::OpenTrade(bool is_buy)
{
    if (CountTotalTrades() >= m_settings.max_total_trades || CountSymbolTrades() >= m_settings.max_trades_per_symbol)
    {
        Log("Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø­Ø¯ Ù…Ø¬Ø§Ø² Ù…Ø¹Ø§Ù…Ù„Ø§Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ù†Ø´Ø¯.");
        return;
    }

    double entry_price = is_buy ? SymbolInfoDouble(m_symbol, SYMBOL_ASK) : SymbolInfoDouble(m_symbol, SYMBOL_BID);
    double sl = CalculateStopLoss(is_buy, entry_price);

    if (sl == 0)
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯.");
        return;
    }

    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double sl_distance_points = MathAbs(entry_price - sl) / point;
    if (sl_distance_points < 1)
    {
        Log("ÙØ§ØµÙ„Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¨Ø³ÛŒØ§Ø± Ú©Ù… Ø§Ø³Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯.");
        return;
    }

    double risk_amount = AccountInfoDouble(ACCOUNT_BALANCE) * (m_settings.risk_percent_per_trade / 100.0);
    double tick_value = SymbolInfoDouble(m_symbol, SYMBOL_TRADE_TICK_VALUE_PROFIT);
    if (tick_value <= 0)
    {
        Log("Ù…Ù‚Ø¯Ø§Ø± Tick Value Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯.");
        return;
    }
    
    double lot_size = risk_amount / (sl_distance_points * tick_value);

    double min_lot = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_MIN);
    double max_lot = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_MAX);
    double lot_step = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_STEP);
    
    lot_size = MathMax(min_lot, MathMin(max_lot, NormalizeDouble(lot_size, 2)));
    lot_size = MathRound(lot_size / lot_step) * lot_step;

    double tp_distance_points = sl_distance_points * m_settings.take_profit_ratio;
    double tp = is_buy ? entry_price + tp_distance_points * point : entry_price - tp_distance_points * point;
    
    int digits = (int)SymbolInfoInteger(m_symbol, SYMBOL_DIGITS);
    sl = NormalizeDouble(sl, digits);
    tp = NormalizeDouble(tp, digits);
    
    if (is_buy)
    {
        if (!m_trade.Buy(lot_size, m_symbol, 0, sl, tp, "Memento Buy"))
        {
            Log("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø®Ø±ÛŒØ¯: " + (string)m_trade.ResultRetcode());
        }
        else
        {
            Log("Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù„Ø§Øª " + DoubleToString(lot_size, 2) + " Ø¨Ø§Ø² Ø´Ø¯.");
        }
    }
    else
    {
        if (!m_trade.Sell(lot_size, m_symbol, 0, sl, tp, "Memento Sell"))
        {
            Log("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ ÙØ±ÙˆØ´: " + (string)m_trade.ResultRetcode());
        }
        else
        {
            Log("Ù…Ø¹Ø§Ù…Ù„Ù‡ ÙØ±ÙˆØ´ Ø¨Ø§ Ù„Ø§Øª " + DoubleToString(lot_size, 2) + " Ø¨Ø§Ø² Ø´Ø¯.");
        }
    }
}

//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø·Ø­ Ú©ÛŒØ¬ÙˆÙ† Ø³Ù† ÙÙ„Øª (ØµØ§Ù)                                  |
//+------------------------------------------------------------------+
double CStrategyManager::FindFlatKijun()
{
    double kijun_values[];
    if (CopyBuffer(m_ichimoku_handle, 1, 1, m_settings.flat_kijun_period, kijun_values) < m_settings.flat_kijun_period)
        return 0.0;

    ArraySetAsSeries(kijun_values, true);

    int flat_count = 1;
    for (int i = 1; i < m_settings.flat_kijun_period; i++)
    {
        if (kijun_values[i] == kijun_values[i - 1])
        {
            flat_count++;
            if (flat_count >= m_settings.flat_kijun_min_length)
            {
                return kijun_values[i]; // Ø³Ø·Ø­ ÙÙ„Øª Ù¾ÛŒØ¯Ø§ Ø´Ø¯
            }
        }
        else
        {
            flat_count = 1; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
        }
    }

    return 0.0; // Ù‡ÛŒÚ† Ø³Ø·Ø­ ÙÙ„ØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
}

//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾ÛŒÙˆØª (Ù†Ù‚Ø·Ù‡ Ú†Ø±Ø®Ø´) Ø±ÙˆÛŒ Ú©ÛŒØ¬ÙˆÙ† Ø³Ù†                          |
//+------------------------------------------------------------------+
double CStrategyManager::FindPivotKijun(bool is_buy)
{
    double kijun_values[];
    if (CopyBuffer(m_ichimoku_handle, 1, 1, m_settings.pivot_lookback, kijun_values) < m_settings.pivot_lookback)
        return 0.0;

    ArraySetAsSeries(kijun_values, true);

    for (int i = 1; i < m_settings.pivot_lookback - 1; i++)
    {
        // Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø®Ø±ÛŒØ¯ØŒ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ø¯Ø±Ù‡ (Ù¾ÛŒÙˆØª Ú©Ù) Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (is_buy && kijun_values[i] < kijun_values[i - 1] && kijun_values[i] < kijun_values[i + 1])
        {
            return kijun_values[i];
        }
        // Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ ÙØ±ÙˆØ´ØŒ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ù‚Ù„Ù‡ (Ù¾ÛŒÙˆØª Ø³Ù‚Ù) Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (!is_buy && kijun_values[i] > kijun_values[i - 1] && kijun_values[i] > kijun_values[i + 1])
        {
            return kijun_values[i];
        }
    }

    return 0.0; // Ù‡ÛŒÚ† Ù¾ÛŒÙˆØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
}

//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾ÛŒÙˆØª (Ù†Ù‚Ø·Ù‡ Ú†Ø±Ø®Ø´) Ø±ÙˆÛŒ ØªÙ†Ú©Ø§Ù† Ø³Ù†                          |
//+------------------------------------------------------------------+
double CStrategyManager::FindPivotTenkan(bool is_buy)
{
    double tenkan_values[];
    if (CopyBuffer(m_ichimoku_handle, 0, 1, m_settings.pivot_lookback, tenkan_values) < m_settings.pivot_lookback)
        return 0.0;

    ArraySetAsSeries(tenkan_values, true);

    for (int i = 1; i < m_settings.pivot_lookback - 1; i++)
    {
        // Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø®Ø±ÛŒØ¯ØŒ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ø¯Ø±Ù‡ (Ù¾ÛŒÙˆØª Ú©Ù) Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (is_buy && tenkan_values[i] < tenkan_values[i - 1] && tenkan_values[i] < tenkan_values[i + 1])
        {
            return tenkan_values[i];
        }
        // Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ ÙØ±ÙˆØ´ØŒ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ù‚Ù„Ù‡ (Ù¾ÛŒÙˆØª Ø³Ù‚Ù) Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (!is_buy && tenkan_values[i] > tenkan_values[i - 1] && tenkan_values[i] > tenkan_values[i + 1])
        {
            return tenkan_values[i];
        }
    }

    return 0.0; // Ù‡ÛŒÚ† Ù¾ÛŒÙˆØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
}
//+------------------------------------------------------------------+
//| (Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯ Ù…Ø¬Ø§Ø² ØªÙ„Ø§Ù‚ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§Ø²Ø§Ø±               |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateDynamicTolerance(int reference_shift)
{
    double total_distance = 0;
    int lookback = m_settings.talaqi_lookback_period;
    if(lookback <= 0) return 0.0;

    double past_tenkan[], past_kijun[];
    if(CopyBuffer(m_ichimoku_handle, 0, reference_shift, lookback, past_tenkan) < lookback || 
       CopyBuffer(m_ichimoku_handle, 1, reference_shift, lookback, past_kijun) < lookback)
    {
       Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ ØªØ§Ø±ÛŒØ®ÛŒ ØªÙ„Ø§Ù‚ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
       return 0.0;
    }
    
    for(int i = 0; i < lookback; i++)
    {
        total_distance += MathAbs(past_tenkan[i] - past_kijun[i]);
    }
    
    double average_historical_distance = total_distance / lookback;
    double tolerance = average_historical_distance * m_settings.talaqi_hist_multiplier;
    
    return tolerance;
}

//+------------------------------------------------------------------+
//| (Ù…Ø¯ÛŒØ± Ú©Ù„) Ú¯Ø±ÙØªÙ† Ø­Ø¯ Ù…Ø¬Ø§Ø² ØªÙ„Ø§Ù‚ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ (Ø§ØªÙˆ/Ø¯Ø³ØªÛŒ)     |
//+------------------------------------------------------------------+
double CStrategyManager::GetTalaqiTolerance(int reference_shift)
{
    // Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ø±ÙˆØ´Ù† Ø¨ÙˆØ¯
    if(m_settings.talaqi_auto_mode)
    {
        // Ø¨Ø±Ùˆ Ø§Ø² Ø±ÙˆØ´ Ù‡ÙˆØ´Ù…Ù†Ø¯ (ØªØ§Ø±ÛŒØ®ÛŒ) Ø­Ø³Ø§Ø¨ Ú©Ù†
        return CalculateDynamicTolerance(reference_shift);
    }
    // Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ø®Ø§Ù…ÙˆØ´ Ø¨ÙˆØ¯
    else
    {
        // Ø¨Ø±Ùˆ Ø§Ø² Ø±ÙˆØ´ Ø³Ø§Ø¯Ù‡ (Ø¯Ø³ØªÛŒ) Ø­Ø³Ø§Ø¨ Ú©Ù†
        return m_settings.talaqi_distance_in_points * SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    }
}








ÙØ§ÛŒÙ„ 4:::

//+------------------------------------------------------------------+
//|                                                                  |
//|                    Project: Memento (By HipoAlgorithm)           |
//|                    File: VisualManager.mqh (Graphics Engine)     |
//|                    Version: 4.0 (Final Visibility Fix)           |
//|                    Â© 2025, Mohammad & Gemini                     |
//|                                                                  |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "4.0" // Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø§ØµÙ„Ø§Ø­Ø§Øª Z-Order Ùˆ Ø±Ù†Ú¯ Ø¨Ø±Ø§ÛŒ ØªØ³Øª

#include "set.mqh" 
#include <ChartObjects\ChartObjectsTxtControls.mqh>
#include <ChartObjects\ChartObjectsShapes.mqh>
#include <ChartObjects\ChartObjectsArrows.mqh>
#include <ChartObjects\ChartObjectsLines.mqh>

// ---===== Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ =====---
#define DASHBOARD_Y_POS 5       
#define DASHBOARD_X_GAP 5       
#define BOX_WIDTH 90            
#define BOX_HEIGHT 25           
#define SUB_PANEL_HEIGHT 35     
#define MEMENTO_OBJ_PREFIX "MEMENTO_UI_"

// --- Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù†Ø§Ù… Ø§Ø´ÛŒØ§Ø¡ Ù‡Ø± Ø¬Ø¹Ø¨Ù‡ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ---
struct SPanelBox
{
    string MainBoxName, SymbolLabelName, SubPanelName, TradesLabelName, PlLabelName;
};

//+------------------------------------------------------------------+
//| Ú©Ù„Ø§Ø³ Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±Ø§ÙÛŒÚ© (Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡)                                 |
//+------------------------------------------------------------------+
class CVisualManager
{
private:
    string              m_symbol;
    SSettings           m_settings;
    long                m_chart_id;
    SPanelBox           m_panel_boxes[];
    string              m_symbols_list[];

public:
    CVisualManager(string symbol, SSettings &settings);
    ~CVisualManager();
    bool Init();
    void Deinit();
    void InitDashboard();
    void UpdateDashboard();
    void DrawTripleCrossRectangle(bool is_buy, int shift);
    void DrawConfirmationArrow(bool is_buy, int shift);
    void ClearSignalGraphics(int signal_shift);
    void DrawScanningArea(bool is_buy, int start_shift, int current_shift);
};

//+------------------------------------------------------------------+
//|                      Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªÙˆØ§Ø¨Ø¹ Ú©Ù„Ø§Ø³                        |
//+------------------------------------------------------------------+
CVisualManager::CVisualManager(string symbol, SSettings &settings)
{
    m_symbol = symbol;
    m_settings = settings;
    m_chart_id = ChartID();
}
CVisualManager::~CVisualManager() {}

bool CVisualManager::Init()
{
    ChartSetInteger(m_chart_id, CHART_AUTOSCROLL, 0); // Ø§ÛŒÙ† Ø®Ø· Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ ØµØ­ÛŒØ­ Ø¨ØµØ±ÛŒ Ø­ÛŒØ§ØªÛŒ Ø§Ø³Øª
    ChartSetInteger(m_chart_id, CHART_SHIFT, 1);
    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¸Ø§Ù‡Ø±ÛŒ Ú†Ø§Ø±Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    ChartSetInteger(m_chart_id, CHART_SHOW_GRID, false);
    ChartSetInteger(m_chart_id, CHART_COLOR_CANDLE_BULL, clrGreen);
    ChartSetInteger(m_chart_id, CHART_COLOR_CANDLE_BEAR, clrRed);
    ChartSetInteger(m_chart_id, CHART_COLOR_CHART_UP, clrGreen);
    ChartSetInteger(m_chart_id, CHART_COLOR_CHART_DOWN, clrRed);
    
    return true;
}

void CVisualManager::Deinit()
{
    ObjectsDeleteAll(m_chart_id, MEMENTO_OBJ_PREFIX);
    ChartRedraw(m_chart_id);
}

void CVisualManager::InitDashboard()
{
    if(!m_settings.enable_dashboard) return;
    StringSplit(m_settings.symbols_list, ',', m_symbols_list);
    int total_symbols = ArraySize(m_symbols_list);
    if(total_symbols == 0) return;
    ArrayResize(m_panel_boxes, total_symbols);
    int current_x = DASHBOARD_X_GAP;

    for(int i = 0; i < total_symbols; i++)
    {
        string sym = m_symbols_list[i];
        string base_name = MEMENTO_OBJ_PREFIX + sym;
        m_panel_boxes[i].MainBoxName      = base_name + "_MainBox";
        m_panel_boxes[i].SymbolLabelName  = base_name + "_SymbolLabel";
        m_panel_boxes[i].SubPanelName     = base_name + "_SubPanel";
        m_panel_boxes[i].TradesLabelName  = base_name + "_TradesLabel";
        m_panel_boxes[i].PlLabelName      = base_name + "_PlLabel";

        CChartObjectRectLabel main_box;
        main_box.Create(m_chart_id, m_panel_boxes[i].MainBoxName, 0, current_x, DASHBOARD_Y_POS, BOX_WIDTH, BOX_HEIGHT);
        main_box.Color(clrYellow); main_box.BackColor(clrDarkBlue); // Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø¶Ø­ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
        main_box.Corner(CORNER_LEFT_UPPER); 
        main_box.Z_Order(100); // âœ… Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ú†ÛŒØ²

        CChartObjectLabel symbol_label;
        symbol_label.Create(m_chart_id, m_panel_boxes[i].SymbolLabelName, 0, current_x + BOX_WIDTH / 2, DASHBOARD_Y_POS + BOX_HEIGHT / 2);
        symbol_label.Description(sym); symbol_label.Color(clrWhite);
        symbol_label.Font("Arial"); symbol_label.FontSize(10);
        symbol_label.Anchor(ANCHOR_CENTER); 
        symbol_label.Z_Order(101); // âœ… Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø¬Ø¹Ø¨Ù‡ Ø§ØµÙ„ÛŒ

        CChartObjectRectLabel sub_panel;
        sub_panel.Create(m_chart_id, m_panel_boxes[i].SubPanelName, 0, current_x + 5, DASHBOARD_Y_POS + BOX_HEIGHT, BOX_WIDTH - 10, SUB_PANEL_HEIGHT);
        sub_panel.Color(clrMagenta); sub_panel.BackColor(clrDarkSlateGray); // Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø¶Ø­ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
        sub_panel.Corner(CORNER_LEFT_UPPER); 
        sub_panel.Z_Order(99); // âœ… Ù¾Ø´Øª Ø¬Ø¹Ø¨Ù‡ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ø³ Ù„Ø§ÛŒÙ‡â€ŒØ§ÛŒ
        ObjectSetInteger(m_chart_id, m_panel_boxes[i].SubPanelName, OBJPROP_HIDDEN, true);

        CChartObjectLabel trades_label, pl_label;
        trades_label.Create(m_chart_id, m_panel_boxes[i].TradesLabelName, 0, current_x + 10, DASHBOARD_Y_POS + BOX_HEIGHT + 10);
        pl_label.Create(m_chart_id, m_panel_boxes[i].PlLabelName, 0, current_x + 10, DASHBOARD_Y_POS + BOX_HEIGHT + 25);
        trades_label.Description("Trades: 0"); pl_label.Description("P/L: 0.0");
        trades_label.Color(clrWhite); pl_label.Color(clrWhite);
        trades_label.Font("Arial"); pl_label.Font("Arial");
        trades_label.FontSize(8); pl_label.FontSize(8);
        trades_label.Anchor(ANCHOR_LEFT); pl_label.Anchor(ANCHOR_LEFT);
        trades_label.Z_Order(100); // âœ… Ø±ÙˆÛŒ Ù¾Ù†Ù„ Ø²ÛŒØ±ÛŒÙ†
        ObjectSetInteger(m_chart_id, m_panel_boxes[i].TradesLabelName, OBJPROP_HIDDEN, true);
        ObjectSetInteger(m_chart_id, m_panel_boxes[i].PlLabelName, OBJPROP_HIDDEN, true);
        
        current_x += BOX_WIDTH + DASHBOARD_X_GAP;
    }
    ChartRedraw(m_chart_id);
}

void CVisualManager::UpdateDashboard()
{
    if(!m_settings.enable_dashboard) { Deinit(); return; }
    if(ArraySize(m_symbols_list) == 0) return;

    for(int i = 0; i < ArraySize(m_symbols_list); i++)
    {
        string sym = m_symbols_list[i];
        long magic = m_settings.magic_number;
        
        color box_color = clrGray; // Ø±Ù†Ú¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ÙˆØ§Ø¶Ø­
        if(PositionSelect(sym) && PositionGetInteger(POSITION_MAGIC) == magic)
        {
            if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_BUY) box_color = clrGreen; // Ø±Ù†Ú¯ ÙˆØ§Ø¶Ø­
            else if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_SELL) box_color = clrRed; // Ø±Ù†Ú¯ ÙˆØ§Ø¶Ø­
        }
        ObjectSetInteger(m_chart_id, m_panel_boxes[i].MainBoxName, OBJPROP_BGCOLOR, box_color);

        if(!HistorySelect(0, TimeCurrent())) continue;
        int trades_count = 0;
        double cumulative_pl = 0;
        uint total_deals = HistoryDealsTotal();
        for(uint j = 0; j < total_deals; j++)
        {
            ulong ticket = HistoryDealGetTicket(j);
            if(HistoryDealGetString(ticket, DEAL_SYMBOL) == sym && HistoryDealGetInteger(ticket, DEAL_MAGIC) == magic && HistoryDealGetInteger(ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT)
            {
                trades_count++;
                cumulative_pl += HistoryDealGetDouble(ticket, DEAL_PROFIT) + HistoryDealGetDouble(ticket, DEAL_SWAP) + HistoryDealGetDouble(ticket, DEAL_COMMISSION);
            }
        }
        
        bool show_sub_panel = trades_count > 0;
        ObjectSetInteger(m_chart_id, m_panel_boxes[i].SubPanelName, OBJPROP_HIDDEN, !show_sub_panel);
        ObjectSetInteger(m_chart_id, m_panel_boxes[i].TradesLabelName, OBJPROP_HIDDEN, !show_sub_panel);
        ObjectSetInteger(m_chart_id, m_panel_boxes[i].PlLabelName, OBJPROP_HIDDEN, !show_sub_panel);
        if(show_sub_panel)
        {
            ObjectSetString(m_chart_id, m_panel_boxes[i].TradesLabelName, OBJPROP_TEXT, "Trades: " + (string)trades_count);
            ObjectSetString(m_chart_id, m_panel_boxes[i].PlLabelName, OBJPROP_TEXT, "P/L: " + DoubleToString(cumulative_pl, 2));
            ObjectSetInteger(m_chart_id, m_panel_boxes[i].PlLabelName, OBJPROP_COLOR, cumulative_pl >= 0 ? clrLime : clrRed);
        }
    }
}

void CVisualManager::DrawTripleCrossRectangle(bool is_buy, int shift)
{
    string obj_name = MEMENTO_OBJ_PREFIX + m_symbol + "_SignalRect_" + (string)iTime(m_symbol, _Period, shift);
    double high = iHigh(m_symbol, _Period, shift); double low = iLow(m_symbol, _Period, shift);
    double window_height = ChartGetDouble(m_chart_id, CHART_PRICE_MAX) - ChartGetDouble(m_chart_id, CHART_PRICE_MIN);
    if(window_height <= 0) window_height = SymbolInfoDouble(m_symbol, SYMBOL_ASK) * 0.01;
    double buffer = window_height * 0.02;
    CChartObjectRectangle rect;
    if(rect.Create(m_chart_id, obj_name, 0, iTime(m_symbol, _Period, shift), high + buffer, iTime(m_symbol, _Period, shift-1), low - buffer))
    {
        rect.Color(is_buy ? m_settings.bullish_color : m_settings.bearish_color);
        rect.Style(STYLE_SOLID); rect.Width(1); rect.Background(true);
    }
}

void CVisualManager::DrawScanningArea(bool is_buy, int start_shift, int current_shift)
{
    string base_name = MEMENTO_OBJ_PREFIX + m_symbol + "_Scan_" + (string)iTime(m_symbol, _Period, start_shift);
    string rect_name = base_name + "_Rect"; string vline_name = base_name + "_VLine";
    ObjectDelete(m_chart_id, rect_name); ObjectDelete(m_chart_id, vline_name);
    datetime start_time = iTime(m_symbol, _Period, start_shift);
    datetime end_time = start_time + (datetime)(m_settings.grace_period_candles + 1) * PeriodSeconds(_Period);
    double max_high = iHigh(m_symbol, _Period, start_shift); double min_low = iLow(m_symbol, _Period, start_shift);
    for(int i = 1; i <= m_settings.grace_period_candles; i++)
    {
        int check_shift = start_shift - i;
        if(iBars(m_symbol, _Period) <= check_shift || check_shift < 0) continue;
        max_high = MathMax(max_high, iHigh(m_symbol, _Period, check_shift));
        min_low = MathMin(min_low, iLow(m_symbol, _Period, check_shift));
    }
    CChartObjectRectangle rect;
    if(rect.Create(m_chart_id, rect_name, 0, start_time, max_high, end_time, min_low))
    {
        rect.Color(is_buy ? m_settings.bullish_color : m_settings.bearish_color);
        rect.Style(STYLE_DOT); rect.Background(true);
        ObjectSetInteger(m_chart_id, rect_name, OBJPROP_BGCOLOR, is_buy ? ColorToARGB(m_settings.bullish_color, 220) : ColorToARGB(m_settings.bearish_color, 220));
    }
    datetime scan_time = iTime(m_symbol, _Period, start_shift - current_shift);
    CChartObjectVLine vline;
    if(vline.Create(m_chart_id, vline_name, 0, scan_time))
    {
        vline.Color(clrWhite); vline.Style(STYLE_DASH);
    }
}

void CVisualManager::ClearSignalGraphics(int signal_shift)
{
    string base_name_rect = MEMENTO_OBJ_PREFIX + m_symbol + "_SignalRect_" + (string)iTime(m_symbol, _Period, signal_shift);
    string base_name_scan = MEMENTO_OBJ_PREFIX + m_symbol + "_Scan_" + (string)iTime(m_symbol, _Period, signal_shift);
    ObjectDelete(m_chart_id, base_name_rect);
    ObjectsDeleteAll(m_chart_id, base_name_scan);
}

void CVisualManager::DrawConfirmationArrow(bool is_buy, int shift)
{
    ClearSignalGraphics(m_settings.chikou_period);
    string obj_name = MEMENTO_OBJ_PREFIX + m_symbol + "_ConfirmArrow_" + (string)iTime(m_symbol, _Period, shift);
    double offset = 10 * SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double price = is_buy ? iLow(m_symbol, _Period, shift) - offset : iHigh(m_symbol, _Period, shift) + offset;
    uchar code = is_buy ? 233 : 234;
    CChartObjectArrow arrow;
    if(arrow.Create(m_chart_id, obj_name, 0, iTime(m_symbol, _Period, shift), price, code))
    {
        arrow.Color(is_buy ? m_settings.bullish_color : m_settings.bearish_color);
        arrow.Width(2);
    }
}
