
ğŸ–¥ ğŸ‡¹ğŸ‡· BigCore-26673
ğŸ†” 26673

âœ¦Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ

â˜ï¸ Ø§ÛŒÙ¾ÛŒ Û´: 185.226.93.11
ğŸ‘¤ ÛŒÙˆØ²Ø±Ù†ÛŒÙ…: Administrator
ğŸ” Ù¾Ø³ÙˆØ±Ø¯: zirULM440vjbeUz7kGJl

âœ¦ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±

â€¢ ÙˆØ¶Ø¹ÛŒØª: ğŸ”´Ø¢ÙÙ„Ø§ÛŒÙ†

â€¢ ØªØ±Ø§ÙÛŒÚ© Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡:
    - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡: 0GB 0%
    - Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡: 499GB
    - Ø­Ø¯ Ù…Ø¬Ø§Ø²: 48GB

â€¢ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: 0 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´
â€¢ ØªØ§Ø±ÛŒØ® Ø³Ø§Ø®Øª: 1404-05-26 01:46
â€¢ ØªØ§Ø±ÛŒØ® Ø§ØªÙ…Ø§Ù…: 05-27 13:46 (27 Ø¯Ù‚ÛŒÙ‚Ù‡)
â€¢ Ù‡Ø²ÛŒÙ†Ù‡ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: 0.813$  
â€¢ Ø¯ÙˆØ±Ù‡ ØªÙ…Ø¯ÛŒØ¯: Ø³Ø§Ø¹ØªÛŒ
â€¢ Ø¬Ø²Ø¦ÛŒØ§Øª Ù‡Ø²ÛŒÙ†Ù‡:
   - Server: 0.02$
   - IPv4: 0.00139$

â€¢ Ù‡Ø²ÛŒÙ†Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: 0.022$ (2,100 ØªÙˆÙ…Ø§Ù†)


âœ¦ Ù…Ø´Ø®ØµØ§Øª Ø³Ø±ÙˆØ±

â˜ï¸ Ø³Ø±ÙˆØ± Vca-8 Ø¯ÛŒØªØ§Ø³Ù†ØªØ± BigCore

â€¢ Ù¾Ø±Ø¯Ø§Ø²Ù†Ø¯Ù‡: 4 Ù‡Ø³ØªÙ‡ (V2 Shared)
â€¢ Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ù†Ø¯Ù‡: Intel
â€¢ Ø±Ù…: 8GB
â€¢ Ø¯ÛŒØ³Ú©: 100GB (HDD)
â€¢ ØªØ±Ø§ÙÛŒÚ© Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡: 0.5TB
â€¢ Ù‡Ø²ÛŒÙ†Ù‡ ØªØ±Ø§ÙÛŒÚ© Ù…Ø§Ø²Ø§Ø¯: 1.36$/TB
â€¢ Ù„ÙˆÚ©ÛŒØ´Ù†: TR - Turkey ğŸ‡¹ğŸ‡·
â€¢ Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„: Windows 2019 64
.


//+------------------------------------------------------------------+
//|                                                                  |
//|                    Project: Memento (By HipoAlgorithm)           |
//|                    File: set.mqh (EA Settings)                   |
//|                    Version: 8.0 (HTF & Advanced Grace Period)    |
//|                    Â© 2025, Mohammad & Gemini                     |
//|                                                                  |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "8.0" // Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯Ù† ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ… Ùˆ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù…Ù‡Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„

// --- Ø§Ù†ÙˆØ§Ø¹ Ø´Ù…Ø§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± Ú©Ø¯ ---

enum E_Entry_Confirmation_Mode
{
    CONFIRM_CURRENT_TIMEFRAME, // Ø±ÙˆØ´ ÙØ¹Ù„ÛŒ: ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ù†Ø¯Ù„ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ
    CONFIRM_LOWER_TIMEFRAME    // Ø±ÙˆØ´ Ø¬Ø¯ÛŒØ¯: ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø± (CHoCH) Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†
};

// âœ…âœ…âœ… [Ø¬Ø¯ÛŒØ¯] Ù†ÙˆØ¹ Ù…Ù‡Ù„Øª Ø¨Ø±Ø§ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± âœ…âœ…âœ…
enum E_Grace_Period_Mode
{
    GRACE_BY_CANDLES,          // Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ (Ø±ÙˆØ´ Ø³Ø§Ø¯Ù‡)
    GRACE_BY_STRUCTURE         // Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø± Ù‚ÛŒÙ…Øª (Ø±ÙˆØ´ Ù‡ÙˆØ´Ù…Ù†Ø¯)
};

enum E_Confirmation_Mode { MODE_CLOSE_ONLY, MODE_OPEN_AND_CLOSE };

enum E_SL_Mode
{
    MODE_COMPLEX,         // Ø¨Ù‡ÛŒÙ†Ù‡ (Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ù…Ù†Ø·Ù‚ÛŒ)
    MODE_SIMPLE,          // Ø³Ø§Ø¯Ù‡ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ù†Ú¯ Ù…Ø®Ø§Ù„Ù Ú©Ù†Ø¯Ù„)
    MODE_ATR              // Ù¾ÙˆÛŒØ§ (Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± ATR)
};

enum E_Signal_Mode { MODE_REPLACE_SIGNAL, MODE_SIGNAL_CONTEST };

enum E_Talaqi_Mode
{
    TALAQI_MODE_MANUAL,     // Ø¯Ø³ØªÛŒ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÙˆÛŒÙ†Øª)
    TALAQI_MODE_KUMO,       // Ù‡ÙˆØ´Ù…Ù†Ø¯ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ)
    TALAQI_MODE_ATR,        // Ù¾ÙˆÛŒØ§ (Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± ATR)
};


//+------------------------------------------------------------------+
//|                      ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø§Ú©Ø³Ù¾Ø±Øª                         |
//+------------------------------------------------------------------+

// ---=== âš™ï¸ 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ (General) âš™ï¸ ===---
input group           "          ---=== âš™ï¸ 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ (General) âš™ï¸ ===---";
input bool            Inp_Enable_Dashboard  = true;                   // âœ… ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ
input string          Inp_Symbols_List      = "EURUSD,GBPUSD,XAUUSD"; // Ù„ÛŒØ³Øª Ù†Ù…Ø§Ø¯Ù‡Ø§ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)
input int             Inp_Magic_Number      = 12345;                  // Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø§Ø¯ÙˆÛŒÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§Øª
input bool            Inp_Enable_Logging    = true;                   // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§

// ---=== ğŸ“ˆ 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ (Ichimoku Baseline) ğŸ“ˆ ===---
input group           "      ---=== ğŸ“ˆ 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ (Ichimoku) ğŸ“ˆ ===---";
// âœ…âœ…âœ… [Ø¬Ø¯ÛŒØ¯] ÙˆØ±ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ âœ…âœ…âœ…
input ENUM_TIMEFRAMES Inp_Ichimoku_Timeframe = PERIOD_H1;                // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
input int             Inp_Tenkan_Period     = 10;                     // Ø¯ÙˆØ±Ù‡ ØªÙ†Ú©Ø§Ù†-Ø³Ù† (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_Kijun_Period      = 28;                     // Ø¯ÙˆØ±Ù‡ Ú©ÛŒØ¬ÙˆÙ†-Ø³Ù† (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_Senkou_Period     = 55;                     // Ø¯ÙˆØ±Ù‡ Ø³Ù†Ú©Ùˆ Ø§Ø³Ù¾Ù† Ø¨ÛŒ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_Chikou_Period     = 26;                     // Ø¯ÙˆØ±Ù‡ Ú†ÛŒÚ©Ùˆ Ø§Ø³Ù¾Ù† (Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹)

// ---=== ğŸ¯ 3. Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ (Signal & Confirmation) ğŸ¯ ===---
input group           "---=== ğŸ¯ 3. Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ (Signal & Confirmation) ğŸ¯ ===---";
input E_Signal_Mode   Inp_Signal_Mode         = MODE_SIGNAL_CONTEST;  // Ø±ÙˆØ´ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„

input group           "         --- ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ ÙˆØ±ÙˆØ¯ (Final Confirmation) ---";
input E_Entry_Confirmation_Mode Inp_Entry_Confirmation_Mode = CONFIRM_CURRENT_TIMEFRAME; // Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ÙˆØ±ÙˆØ¯

// âœ…âœ…âœ… [Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯] ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ù‡Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ âœ…âœ…âœ…
input group           "         --- Ù…Ù‡Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± (Grace Period) ---";
input E_Grace_Period_Mode Inp_Grace_Period_Mode = GRACE_BY_CANDLES;   // Ù†ÙˆØ¹ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„
input int             Inp_Grace_Period_Candles= 4;                      // [Ø­Ø§Ù„Øª Ú©Ù†Ø¯Ù„ÛŒ] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…Ù‡Ù„Øª Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡
// Ù†Ú©ØªÙ‡: Ø¯Ø± Ø­Ø§Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒØŒ Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

input group           "         --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† (LTF) ---";
input ENUM_TIMEFRAMES Inp_LTF_Timeframe = PERIOD_M5;                      // [Ø±ÙˆØ´ LTF] ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ÙˆØ±ÙˆØ¯
input E_Confirmation_Mode Inp_Confirmation_Type = MODE_CLOSE_ONLY;    // [Ø±ÙˆØ´ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… ÙØ¹Ù„ÛŒ] Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ Ú©Ù†Ø¯Ù„


// --- Ø²ÛŒØ±Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ø§Ù‚ÛŒ (Confluence) ---
input group           "         --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ„Ø§Ù‚ÛŒ (Confluence) ---";
input E_Talaqi_Mode   Inp_Talaqi_Calculation_Mode = TALAQI_MODE_ATR;    // Ø±ÙˆØ´ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ ØªÙ„Ø§Ù‚ÛŒ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input double          Inp_Talaqi_ATR_Multiplier     = 0.28;             // [ATR Mode] Ø¶Ø±ÛŒØ¨ ATR Ø¨Ø±Ø§ÛŒ ØªÙ„Ø§Ù‚ÛŒ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input double          Inp_Talaqi_Distance_in_Points = 3.0;              // [MANUAL Mode] ÙØ§ØµÙ„Ù‡ ØªÙ„Ø§Ù‚ÛŒ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÙˆÛŒÙ†Øª)
input double          Inp_Talaqi_Kumo_Factor      = 0.2;              // [KUMO Mode] Ø¶Ø±ÛŒØ¨ ØªÙ„Ø§Ù‚ÛŒ (Ø¯Ø±ØµØ¯ Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ)


// ---=== ğŸ›¡ï¸ 4. Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø± (Stop Loss) ğŸ›¡ï¸ ===---
input group           "       ---=== ğŸ›¡ï¸ 4. Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø± (Stop Loss) ğŸ›¡ï¸ ===---";
input E_SL_Mode       Inp_StopLoss_Type       = MODE_COMPLEX;           // Ø±ÙˆØ´ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³
input double          Inp_SL_ATR_Multiplier   = 2.2;                    // [ATR Mode] Ø¶Ø±ÛŒØ¨ ATR Ø¨Ø±Ø§ÛŒ Ø­Ø¯ Ø¶Ø±Ø± (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_SL_Lookback_Period  = 15;                     // [SIMPLE] Ø¯ÙˆØ±Ù‡ Ù†Ú¯Ø§Ù‡ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† Ø³Ù‚Ù/Ú©Ù
input double          Inp_SL_Buffer_Multiplier = 3.0;                   // [SIMPLE/COMPLEX] Ø¶Ø±ÛŒØ¨ Ø¨Ø§ÙØ±
input int             Inp_Flat_Kijun_Period   = 50;                     // [COMPLEX] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
input int             Inp_Flat_Kijun_Min_Length = 5;                    // [COMPLEX] Ø­Ø¯Ø§Ù‚Ù„ Ø·ÙˆÙ„ Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
input int             Inp_Pivot_Lookback      = 30;                     // [COMPLEX] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒÙˆØª

input group           "    --- SL Ù¾ÙˆÛŒØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ³Ø§Ù† ---";
input bool            Inp_Enable_SL_Vol_Regime = false;                 // ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ SL Ù¾ÙˆÛŒØ§ Ø¨Ø§ Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù†
input int             Inp_SL_Vol_Regime_ATR_Period = 14;                // [Ù¾ÙˆÛŒØ§] Ø¯ÙˆØ±Ù‡ ATR Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†ÙˆØ³Ø§Ù†
input int             Inp_SL_Vol_Regime_EMA_Period = 20;                // [Ù¾ÙˆÛŒØ§] Ø¯ÙˆØ±Ù‡ EMA Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø®Ø· Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù†
input double          Inp_SL_High_Vol_Multiplier = 2.2;                 // [Ù¾ÙˆÛŒØ§] Ø¶Ø±ÛŒØ¨ ATR Ø¯Ø± Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù† Ø¨Ø§Ù„Ø§
input double          Inp_SL_Low_Vol_Multiplier = 1.5;                  // [Ù¾ÙˆÛŒØ§] Ø¶Ø±ÛŒØ¨ ATR Ø¯Ø± Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù† Ù¾Ø§ÛŒÛŒÙ†


// ---=== ğŸ’° 5. Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡ (Money Management) ğŸ’° ===---
input group           " ---=== ğŸ’° 5. Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡ (Money Management) ğŸ’° ===---";
input double          Inp_Risk_Percent_Per_Trade = 0.7;                 // Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú© Ø¯Ø± Ù‡Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input double          Inp_Take_Profit_Ratio   = 1.9;                    // Ù†Ø³Ø¨Øª Ø±ÛŒØ³Ú© Ø¨Ù‡ Ø±ÛŒÙˆØ§Ø±Ø¯ Ø¨Ø±Ø§ÛŒ Ø­Ø¯ Ø³ÙˆØ¯ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input int             Inp_Max_Trades_Per_Symbol = 1;                    // Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø² Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†Ù…Ø§Ø¯
input int             Inp_Max_Total_Trades    = 5;                      // Ø­Ø¯Ø§Ú©Ø«Ø± Ú©Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø²

// ---=== ğŸ¨ 6. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ (Visuals) ğŸ¨ ===---
input group           "        ---=== ğŸ¨ 6. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ (Visuals) ğŸ¨ ===---";
input double          Inp_Object_Size_Multiplier = 1.0;                 // Ø¶Ø±ÛŒØ¨ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø§Ø´ÛŒØ§Ø¡ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
input color           Inp_Bullish_Color       = clrLimeGreen;           // Ø±Ù†Ú¯ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ø§Ø´ÛŒØ§Ø¡ Ø®Ø±ÛŒØ¯
input color           Inp_Bearish_Color       = clrRed;                 // Ø±Ù†Ú¯ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ Ø§Ø´ÛŒØ§Ø¡ ÙØ±ÙˆØ´

// ---=== ğŸš¦ 7. ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ (Entry Filters) ğŸš¦ ===---
input group           "   ---=== ğŸš¦ 7. ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ (Entry Filters) ğŸš¦ ===---";
input bool            Inp_Enable_Kumo_Filter = true;                    // âœ… [ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ]: ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„
input bool            Inp_Enable_ATR_Filter  = true;                    // âœ… [ÙÛŒÙ„ØªØ± ATR]: ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„
input int             Inp_ATR_Filter_Period  = 14;                      // [ÙÛŒÙ„ØªØ± ATR]: Ø¯ÙˆØ±Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ ATR
input double          Inp_ATR_Filter_Min_Value_pips = 9.0;              // [ÙÛŒÙ„ØªØ± ATR]: Ø­Ø¯Ø§Ù‚Ù„ Ù…Ù‚Ø¯Ø§Ø± ATR Ø¨Ù‡ Ù¾ÛŒÙ¾ (Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡)
input bool            Inp_Enable_ADX_Filter = false;                    // ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ± Ù‚Ø¯Ø±Øª Ùˆ Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯ ADX
input int             Inp_ADX_Period = 14;                              // [ADX] Ø¯ÙˆØ±Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡
input double          Inp_ADX_Threshold = 25.0;                         // [ADX] Ø­Ø¯Ø§Ù‚Ù„ Ù‚Ø¯Ø±Øª Ø±ÙˆÙ†Ø¯ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯

// ---=== ğŸ¯ 8. Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ (Exit Logic) ğŸ¯ ===---
input group "       ---=== ğŸ¯ 8. Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ (Exit Logic) ğŸ¯ ===---";
input bool            Inp_Enable_Early_Exit = false;                    // ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ Ø¨Ø§ Ú©Ø±Ø§Ø³ Ú†ÛŒÚ©Ùˆ Ùˆ ØªØ§ÛŒÛŒØ¯ RSI
input int             Inp_Early_Exit_RSI_Period = 14;                   // [Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³] Ø¯ÙˆØ±Ù‡ RSI
input int             Inp_Early_Exit_RSI_Overbought = 70;               // [Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³] Ø³Ø·Ø­ Ø§Ø´Ø¨Ø§Ø¹ Ø®Ø±ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² ÙØ±ÙˆØ´
input int             Inp_Early_Exit_RSI_Oversold = 30;                 // [Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³] Ø³Ø·Ø­ Ø§Ø´Ø¨Ø§Ø¹ ÙØ±ÙˆØ´ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² Ø®Ø±ÛŒØ¯


//+------------------------------------------------------------------+
//|     Ø³Ø§Ø®ØªØ§Ø± Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ ØªÙ…Ø§Ù… ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ (SSettings)       |
//+------------------------------------------------------------------+
struct SSettings
{
    // 1. General
    bool                enable_dashboard;
    string              symbols_list;
    int                 magic_number;
    bool                enable_logging;
    
    // 2. Ichimoku
    // âœ…âœ…âœ… [Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡] Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ âœ…âœ…âœ…
    ENUM_TIMEFRAMES     ichimoku_timeframe;      // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ ØªØ­Ù„ÛŒÙ„
    int                 tenkan_period;
    int                 kijun_period;
    int                 senkou_period;
    int                 chikou_period;
    
    // 3. Signal & Confirmation
    E_Signal_Mode       signal_mode;
    
    // âœ…âœ…âœ… [Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡] Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ùˆ Ù…Ù‡Ù„Øª âœ…âœ…âœ…
    E_Entry_Confirmation_Mode entry_confirmation_mode; // Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ÙˆØ±ÙˆØ¯
    E_Grace_Period_Mode grace_period_mode;           // Ù†ÙˆØ¹ Ù…Ù‡Ù„Øª Ø³ÛŒÚ¯Ù†Ø§Ù„
    int                 grace_period_candles;        // [Ø­Ø§Ù„Øª Ú©Ù†Ø¯Ù„ÛŒ] ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…Ù‡Ù„Øª
    E_Confirmation_Mode confirmation_type;           // [Ø­Ø§Ù„Øª ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… ÙØ¹Ù„ÛŒ] Ù†ÙˆØ¹ ØªØ§ÛŒÛŒØ¯ Ú©Ù†Ø¯Ù„
    ENUM_TIMEFRAMES     ltf_timeframe;               // [Ø­Ø§Ù„Øª LTF] ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡
    
    // 3.1. Talaqi
    E_Talaqi_Mode       talaqi_calculation_mode;
    double              talaqi_distance_in_points;
    double              talaqi_kumo_factor;
    double              talaqi_atr_multiplier;
    
    // 4. Stop Loss
    E_SL_Mode           stoploss_type;
    double              sl_atr_multiplier;
    int                 sl_lookback_period;
    double              sl_buffer_multiplier;
    int                 flat_kijun_period;
    int                 flat_kijun_min_length;
    int                 pivot_lookback;
    
    bool                enable_sl_vol_regime;
    int                 sl_vol_regime_atr_period;
    int                 sl_vol_regime_ema_period;
    double              sl_high_vol_multiplier;
    double              sl_low_vol_multiplier;

    // 5. Money Management
    double              risk_percent_per_trade;
    double              take_profit_ratio;
    int                 max_trades_per_symbol;
    int                 max_total_trades;
    
    // 6. Visuals
    double              object_size_multiplier;
    color               bullish_color;
    color               bearish_color;
    
    // 7. Entry Filters
    bool                enable_kumo_filter;
    bool                enable_atr_filter;
    int                 atr_filter_period;
    double              atr_filter_min_value_pips;

    bool                enable_adx_filter;
    int                 adx_period;
    double              adx_threshold;

    // 8. Exit Logic
    bool                enable_early_exit;
    int                 early_exit_rsi_period;
    int                 early_exit_rsi_overbought;
    int                 early_exit_rsi_oversold;
};




------------------------------------------------------------------------------------------------------------------------------
|                                                   ÙØ§ÛŒÙ„ Ø¯ÛŒÚ¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡                                                               |
|-------------------------------------------------------------------------------------------------------------------------------

//+------------------------------------------------------------------+
//|                                                      Memento.mq5 |
//|                                  Copyright 2025,hipoalgoritm |
//|                                                  Final & Bulletproof |
//+------------------------------------------------------------------+
#property copyright "Copyright 2025,hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "1.7" // Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ú©Ø§Ù…Ù„Ø§ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
#property description "Ø§Ú©Ø³Ù¾Ø±Øª Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù…Ù…Ù†ØªÙˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ú©Ø±Ø§Ø³ Ø³Ù‡ Ú¯Ø§Ù†Ù‡ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ"


#include <Trade\Trade.mqh>
#include <Object.mqh>
#include "IchimokuLogic.mqh"
#include "VisualManager.mqh"
#include "TrailingStopManager.mqh"

#include  "licensed.mqh"

//--- Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ
SSettings            g_settings;
string               g_symbols_array[];
CStrategyManager* g_symbol_managers[];
bool              g_dashboard_needs_update = true; // Ù¾Ø±Ú†Ù… Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
CTrailingStopManager TrailingStop;



int OnInit() {
    //--- âœ…âœ…âœ… Ø¨Ø®Ø´ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ùˆ Ù‡Ù…Ø§Ù‡Ù†Ú¯) âœ…âœ…âœ… ---

    // 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ
    g_settings.enable_dashboard           = Inp_Enable_Dashboard;
    g_settings.symbols_list                 = Inp_Symbols_List;
    g_settings.magic_number                 = Inp_Magic_Number;
    g_settings.enable_logging               = Inp_Enable_Logging;

    // 2. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
    g_settings.ichimoku_timeframe           = Inp_Ichimoku_Timeframe; // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    g_settings.tenkan_period                = Inp_Tenkan_Period;
    g_settings.kijun_period                 = Inp_Kijun_Period;
    g_settings.senkou_period                = Inp_Senkou_Period;
    g_settings.chikou_period                = Inp_Chikou_Period;

    // 3. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ùˆ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡
    g_settings.signal_mode                  = Inp_Signal_Mode;
    g_settings.entry_confirmation_mode      = Inp_Entry_Confirmation_Mode; // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    g_settings.grace_period_mode            = Inp_Grace_Period_Mode; // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    g_settings.grace_period_candles         = Inp_Grace_Period_Candles;
    g_settings.confirmation_type            = Inp_Confirmation_Type;
    g_settings.ltf_timeframe                = Inp_LTF_Timeframe; // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
    g_settings.talaqi_calculation_mode      = Inp_Talaqi_Calculation_Mode;
    g_settings.talaqi_atr_multiplier        = Inp_Talaqi_ATR_Multiplier;
    g_settings.talaqi_distance_in_points    = Inp_Talaqi_Distance_in_Points;
    g_settings.talaqi_kumo_factor           = Inp_Talaqi_Kumo_Factor;

    // 4. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø¯ Ø¶Ø±Ø±
    g_settings.stoploss_type                = Inp_StopLoss_Type;
    g_settings.sl_atr_multiplier            = Inp_SL_ATR_Multiplier;
    g_settings.flat_kijun_period            = Inp_Flat_Kijun_Period;
    g_settings.flat_kijun_min_length        = Inp_Flat_Kijun_Min_Length;
    g_settings.pivot_lookback               = Inp_Pivot_Lookback;
    g_settings.sl_lookback_period           = Inp_SL_Lookback_Period;
    g_settings.sl_buffer_multiplier         = Inp_SL_Buffer_Multiplier;
    
    // 4.1. <<< Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ SL Ù¾ÙˆÛŒØ§ >>>
    g_settings.enable_sl_vol_regime         = Inp_Enable_SL_Vol_Regime;
    g_settings.sl_vol_regime_atr_period     = Inp_SL_Vol_Regime_ATR_Period;
    g_settings.sl_vol_regime_ema_period     = Inp_SL_Vol_Regime_EMA_Period;
    g_settings.sl_high_vol_multiplier       = Inp_SL_High_Vol_Multiplier;
    g_settings.sl_low_vol_multiplier        = Inp_SL_Low_Vol_Multiplier;

    // 5. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡
    g_settings.risk_percent_per_trade       = Inp_Risk_Percent_Per_Trade;
    g_settings.take_profit_ratio            = Inp_Take_Profit_Ratio;
    g_settings.max_trades_per_symbol        = Inp_Max_Trades_Per_Symbol;
    g_settings.max_total_trades             = Inp_Max_Total_Trades;

    // 6. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ
    g_settings.object_size_multiplier       = Inp_Object_Size_Multiplier;
    g_settings.bullish_color                = Inp_Bullish_Color;
    g_settings.bearish_color                = Inp_Bearish_Color;
    
    // 7. <<< Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§ >>>
    g_settings.enable_kumo_filter           = Inp_Enable_Kumo_Filter;
    g_settings.enable_atr_filter            = Inp_Enable_ATR_Filter;
    g_settings.atr_filter_period            = Inp_ATR_Filter_Period;
    g_settings.atr_filter_min_value_pips    = Inp_ATR_Filter_Min_Value_pips;
    g_settings.enable_adx_filter            = Inp_Enable_ADX_Filter;
    g_settings.adx_period                   = Inp_ADX_Period;
    g_settings.adx_threshold                = Inp_ADX_Threshold;

    // 8. <<< Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ >>>
    g_settings.enable_early_exit            = Inp_Enable_Early_Exit;
    g_settings.early_exit_rsi_period        = Inp_Early_Exit_RSI_Period;
    g_settings.early_exit_rsi_overbought    = Inp_Early_Exit_RSI_Overbought;
    g_settings.early_exit_rsi_oversold      = Inp_Early_Exit_RSI_Oversold;


    //--- Ø¨Ù‚ÛŒÙ‡ ØªØ§Ø¨Ø¹ OnInit Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± ...
    int symbols_count = StringSplit(g_settings.symbols_list, ',', g_symbols_array);
    if (symbols_count == 0) {
        Print("Ø®Ø·Ø§: Ù‡ÛŒÚ† Ù†Ù…Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        return INIT_FAILED;
    }

    ArrayResize(g_symbol_managers, symbols_count);
    for (int i = 0; i < symbols_count; i++) {
        string sym = g_symbols_array[i];
        StringTrimLeft(sym);
        StringTrimRight(sym);
        g_symbol_managers[i] = new CStrategyManager(sym, g_settings);
        if (!g_symbol_managers[i].Init()) {
            Print("Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù…Ø§Ø¯ ", sym, " Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ø¹Ù…Ù„ÛŒØ§Øª Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
            for (int j = 0; j <= i; j++) {
                if (g_symbol_managers[j] != NULL) {
                    delete g_symbol_managers[j];
                    g_symbol_managers[j] = NULL;
                }
            }
            ArrayFree(g_symbol_managers);
            return INIT_FAILED;
        }
    }

    Print("Ø§Ú©Ø³Ù¾Ø±Øª Memento Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø¯: ", g_settings.symbols_list);
    TrailingStop.Init(Inp_Magic_Number);

    EventSetTimer(1);
    return(INIT_SUCCEEDED);
}




//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù¾Ø§ÛŒØ§Ù† Ø§Ú©Ø³Ù¾Ø±Øª (Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ)                                      |
//+------------------------------------------------------------------+
void OnDeinit(const int reason) {
   EventKillTimer();
//--- Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´ÛŒØ¡Ù‡Ø§
   for (int i = 0; i < ArraySize(g_symbol_managers); i++) {
      if (g_symbol_managers[i] != NULL) {
         delete g_symbol_managers[i];
         g_symbol_managers[i] = NULL;
      }
   }
   ArrayFree(g_symbol_managers);


//--- Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø´ÛŒØ§Ø¡ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ø¨Ø§ Ù¾ÛŒØ´ÙˆÙ†Ø¯ ØµØ­ÛŒØ­
   ObjectsDeleteAll(0, "MEMENTO_UI_");
   ChartRedraw();

}
void OnTick(void)
      {
       if(CheckLicenseExpiry()==false)
{
ExpertRemove();
//return(INIT_FAILED);
}
      }
//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ ØªØ§ÛŒÙ…Ø± (Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¯Ø§ÙˆÙ… Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§)                      |
//+------------------------------------------------------------------+
void OnTimer() {



   TrailingStop.Process();
//--- Ø§Ø¬Ø±Ø§ÛŒ Ù…Ù†Ø·Ù‚ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ ØªØ­Øª Ù…Ø¯ÛŒØ±ÛŒØª
   for (int i = 0; i < ArraySize(g_symbol_managers); i++) {
      if (g_symbol_managers[i] != NULL) {
         g_symbol_managers[i].ProcessNewBar();
      }
   }

//--- Ø¢Ù¾Ø¯ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
   if (g_dashboard_needs_update) {
      // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ù…ÙˆÙ†Ù‡â€ŒØ§ÛŒ Ø§Ø² Ù…Ù†ÛŒØ¬Ø± Ú©Ù‡ Ù…Ø³Ø¦ÙˆÙ„ Ú†Ø§Ø±Øª Ø§ØµÙ„ÛŒ Ø§Ø³Øª
      for (int i = 0; i < ArraySize(g_symbol_managers); i++) {
         if (g_symbol_managers[i] != NULL && g_symbol_managers[i].GetSymbol() == _Symbol) {
            g_symbol_managers[i].UpdateMyDashboard();
            Print("Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯.");
            break; // Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù¾Ø¯ÛŒØª Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
         }
      }
      g_dashboard_needs_update = false; // Ù¾Ø±Ú†Ù… Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¹Ø¯ÛŒ Ø±ÛŒØ³Øª Ú©Ù†
   }
}





//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ                                           |
//+------------------------------------------------------------------+
//
void OnTradeTransaction(const MqlTradeTransaction &trans,
                        const MqlTradeRequest &request,
                        const MqlTradeResult &result) {
// Ù…Ø§ ÙÙ‚Ø· Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ ÛŒÚ© Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ Ø¯Ø§Ø±ÛŒÙ…
   if (trans.type == TRADE_TRANSACTION_DEAL_ADD && trans.deal > 0) {
      // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø±Ø§ Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
      ulong deal_ticket = trans.deal;
      if(HistoryDealSelect(deal_ticket)) {
         // Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ø§Ú©Ø³Ù¾Ø±Øª Ø¨Ø§Ø´Ù‡
         if(HistoryDealGetInteger(deal_ticket, DEAL_MAGIC) == (long)g_settings.magic_number) {
            // Ø§Ú¯Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø§Ø² Ù†ÙˆØ¹ Ø®Ø±ÙˆØ¬ Ø§Ø² Ù¾ÙˆØ²ÛŒØ´Ù† Ø¨ÙˆØ¯ (Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù†)
            if(HistoryDealGetInteger(deal_ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT) {
               string deal_symbol = HistoryDealGetString(deal_ticket, DEAL_SYMBOL);

               // Ù…Ø¯ÛŒØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ù†Ù…Ø§Ø¯ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
               for(int i = 0; i < ArraySize(g_symbol_managers); i++) {
                  if(g_symbol_managers[i] != NULL && g_symbol_managers[i].GetSymbol() == deal_symbol) {
                     // Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ© Ø¢Ù† Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
                     CVisualManager *visual_manager = g_symbol_managers[i].GetVisualManager();
                     if(visual_manager != NULL) {
                        // Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†Ù…Ø§Ø¯ Ø±Ø§ Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                        int symbol_index = visual_manager.GetSymbolIndex(deal_symbol);
                        if(symbol_index != -1) {
                           // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙˆØ¯ Ùˆ Ø²ÛŒØ§Ù† Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
                           double p = HistoryDealGetDouble(deal_ticket, DEAL_PROFIT);
                           double c = HistoryDealGetDouble(deal_ticket, DEAL_COMMISSION);
                           double s = HistoryDealGetDouble(deal_ticket, DEAL_SWAP);

                           // Ùˆ Ø¯ÙØªØ±Ú†Ù‡ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                           visual_manager.UpdateDashboardCache(symbol_index, p, c, s);
                        }
                     }
                     break; // Ù…Ø¯ÛŒØ± Ù¾ÛŒØ¯Ø§ Ø´Ø¯ØŒ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
                  }
               }
            }

            // Ø¯Ø± Ù‡Ø± ØµÙˆØ±Øª (Ú†Ù‡ Ø¨Ø§Ø² Ø´Ø¯Ù† Ùˆ Ú†Ù‡ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù†) Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø§Ø±Ø¯
            g_dashboard_needs_update = true;
         }
      }
   }
}



//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú†Ø§Ø±Øª (Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡)                   |
//+------------------------------------------------------------------+
void OnChartEvent(const int id,
                  const long &lparam,
                  const double &dparam,
                  const string &sparam) {
// Ø§Ú¯Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø² Ù†ÙˆØ¹ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª Ø¨ÙˆØ¯
   if(id == CHARTEVENT_OBJECT_CLICK) {
      // Ù…Ø¯ÛŒØ± Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ú†Ø§Ø±Øª ÙØ¹Ù„ÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†
      for(int i = 0; i < ArraySize(g_symbol_managers); i++) {
         if(g_symbol_managers[i] != NULL && g_symbol_managers[i].GetSymbol() == _Symbol) {
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ© Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
            g_symbol_managers[i].GetVisualManager().OnChartEvent(id, lparam, dparam, sparam);
            break; // Ú©Ø§Ø± ØªÙ…Ø§Ù… Ø§Ø³ØªØŒ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
         }
      }
   }
}
//+------------------------------------------------------------------+



//--- Ú¯Ø±ÙˆÙ‡: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ ---
input group "  ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ";
input int InpMinTradesPerYear = 30; // Ø­Ø¯Ø§Ù‚Ù„ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ø¯Ø± ÛŒÚ© Ø³Ø§Ù„
input int InpMaxAcceptableDrawdown = 15;


//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØ³ØªØ± Ú©Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.          |
//+------------------------------------------------------------------+
double OnTester()
{
   // --- 1. Ú¯Ø±ÙØªÙ† ØªÙ…Ø§Ù… Ø¢Ù…Ø§Ø±Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² ---
   double total_trades         = TesterStatistics(STAT_TRADES);
   double net_profit           = TesterStatistics(STAT_PROFIT);
   double profit_factor        = TesterStatistics(STAT_PROFIT_FACTOR);
   double sharpe_ratio         = TesterStatistics(STAT_SHARPE_RATIO);
   double max_balance_drawdown_percent = TesterStatistics(STAT_BALANCE_DDREL_PERCENT);

   // --- 2. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯Ø§Ù‚Ù„ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
   datetime startDate = 0, endDate = 0;
   if(HistoryDealsTotal() > 0)
     {
      startDate = (datetime)HistoryDealGetInteger(0, DEAL_TIME);
      endDate   = (datetime)HistoryDealGetInteger(HistoryDealsTotal() - 1, DEAL_TIME);
     }
   double duration_days = (endDate > startDate) ? double(endDate - startDate) / (24.0 * 3600.0) : 1.0;
   double required_min_trades = floor((duration_days / 365.0) * InpMinTradesPerYear);
   if(required_min_trades < 10) required_min_trades = 10;

   // --- 3. ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
   if(total_trades < required_min_trades || profit_factor < 1.1 || sharpe_ratio <= 0 || net_profit <= 0)
     {
      return 0.0;
     }

   // --- 4. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
   double r_squared = 0, downside_consistency = 0;
   CalculateAdvancedMetrics(r_squared, downside_consistency);

   // --- 5. *** Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø§Ù…ØªÛŒØ§Ø²: Ù…Ø­Ø§Ø³Ø¨Ù‡ "Ø¶Ø±ÛŒØ¨ Ù…Ø¬Ø§Ø²Ø§Øª" Ø¨Ø§ Ù…Ù†Ø­Ù†ÛŒ Ú©Ø³ÛŒÙ†ÙˆØ³ÛŒ *** ---
   double drawdown_penalty_factor = 0.0;
   if (max_balance_drawdown_percent < InpMaxAcceptableDrawdown && InpMaxAcceptableDrawdown > 0) 
   {
      // Ø¯Ø±Ø§ÙˆØ¯Ø§Ù† Ø±Ùˆ Ø¨Ù‡ ÛŒÚ© Ø²Ø§ÙˆÛŒÙ‡ Ø¨ÛŒÙ† 0 ØªØ§ 90 Ø¯Ø±Ø¬Ù‡ (Ï€/2 Ø±Ø§Ø¯ÛŒØ§Ù†) ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
      double angle = (max_balance_drawdown_percent / InpMaxAcceptableDrawdown) * (M_PI / 2.0);
      
      // Ø¶Ø±ÛŒØ¨ Ù…Ø¬Ø§Ø²Ø§ØªØŒ Ú©Ø³ÛŒÙ†ÙˆØ³ Ø§ÙˆÙ† Ø²Ø§ÙˆÛŒÙ‡ Ø§Ø³Øª. Ù‡Ø±Ú†ÛŒ Ø²Ø§ÙˆÛŒÙ‡ (Ø¯Ø±Ø§ÙˆØ¯Ø§Ù†) Ø¨ÛŒØ´ØªØ±ØŒ Ú©Ø³ÛŒÙ†ÙˆØ³ (Ø§Ù…ØªÛŒØ§Ø²) Ú©Ù…ØªØ±
      drawdown_penalty_factor = cos(angle);
   }
   // Ø§Ú¯Ø± Ø¯Ø±Ø§ÙˆØ¯Ø§Ù† Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø¨Ø§Ø´Ù‡ØŒ Ø¶Ø±ÛŒØ¨ ØµÙØ± Ù…ÛŒâ€ŒÙ…ÙˆÙ†Ù‡ Ùˆ Ú©Ù„ Ù¾Ø§Ø³ Ø±Ø¯ Ù…ÛŒØ´Ù‡

   // --- 6. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ Ø¬Ø§Ù…Ø¹ Ø¨Ø§ ÙØ±Ù…ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ Ùˆ Ù¾ÛŒÙˆØ³ØªÙ‡ ---
   double final_score = 0.0;
   if(drawdown_penalty_factor > 0)
   {
      // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² log Ø¨Ø±Ø§ÛŒ Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ§Ø«ÛŒØ± Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø²Ø±Ú¯
      double trades_factor = log(total_trades + 1); // +1 Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² log(0)
      double net_profit_factor = log(net_profit + 1);

      final_score = (profit_factor * sharpe_ratio * r_squared * downside_consistency * trades_factor * net_profit_factor) 
                     * drawdown_penalty_factor; // Ø¶Ø±Ø¨ Ø¯Ø± Ø¶Ø±ÛŒØ¨ Ù…Ø¬Ø§Ø²Ø§Øª Ø¬Ø¯ÛŒØ¯ Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯
   }

   // --- 7. Ú†Ø§Ù¾ Ù†ØªÛŒØ¬Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ ---
   PrintFormat("Ù†ØªÛŒØ¬Ù‡: Trades=%d, PF=%.2f, Sharpe=%.2f, RÂ²=%.3f, BalDD=%.2f%%, Penalty=%.2f -> Ø§Ù…ØªÛŒØ§Ø²: %.4f",
               (int)total_trades, profit_factor, sharpe_ratio, r_squared, max_balance_drawdown_percent, drawdown_penalty_factor, final_score);

   return final_score;
}

// ØªØ§Ø¨Ø¹ CalculateAdvancedMetrics Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯
void CalculateAdvancedMetrics(double &r_squared, double &downside_consistency)
{
   r_squared = 0;
   downside_consistency = 1.0;

   if(!HistorySelect(0, TimeCurrent())) return;
   uint total_deals = HistoryDealsTotal();
   if(total_deals < 5) return;

   EquityPoint equity_curve[];
   ArrayResize(equity_curve, (int)total_deals + 2);

   double final_balance = AccountInfoDouble(ACCOUNT_BALANCE);
   double net_profit = TesterStatistics(STAT_PROFIT);
   double initial_balance = final_balance - net_profit;
   
   double current_balance = initial_balance;
   equity_curve[0].time      = (datetime)HistoryDealGetInteger(0, DEAL_TIME) - 1;
   equity_curve[0].balance   = current_balance;

   int equity_points = 1;
   for(uint i = 0; i < total_deals; i++)
     {
      ulong ticket = HistoryDealGetTicket(i);
      if(ticket > 0)
        {
         if(HistoryDealGetInteger(ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT)
           {
            current_balance += HistoryDealGetDouble(ticket, DEAL_PROFIT) + HistoryDealGetDouble(ticket, DEAL_COMMISSION) + HistoryDealGetDouble(ticket, DEAL_SWAP);
            equity_curve[equity_points].time = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);
            equity_curve[equity_points].balance = current_balance;
            equity_points++;
           }
        }
     }
   ArrayResize(equity_curve, equity_points);
   if(equity_points < 3) return;
   
   double sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0, sum_y2 = 0;
   for(int i = 0; i < equity_points; i++)
     {
      double x = i + 1.0; double y = equity_curve[i].balance;
      sum_x += x; sum_y += y; sum_xy += x * y; sum_x2 += x*x; sum_y2 += y*y;
     }
   double n = equity_points;
   double den_part1 = (n*sum_x2) - (sum_x*sum_x);
   double den_part2 = (n*sum_y2) - (sum_y*sum_y);
   if(den_part1 > 0 && den_part2 > 0)
     {
      double r = ((n*sum_xy) - (sum_x*sum_y)) / sqrt(den_part1 * den_part2);
      r_squared = r*r;
     }

   MonthlyTrades monthly_counts[];
   int total_months = 0;
   
   for(uint i=0; i<total_deals; i++)
     {
      ulong ticket = HistoryDealGetTicket(i);
      if(ticket > 0 && HistoryDealGetInteger(ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT)
        {
         datetime deal_time = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);
         MqlDateTime dt;
         TimeToStruct(deal_time, dt);
         
         int month_idx = -1;
         for(int j=0; j<total_months; j++) {
            if(monthly_counts[j].year == dt.year && monthly_counts[j].month == dt.mon) {
               month_idx = j;
               break;
            }
         }
         
         if(month_idx == -1) {
            ArrayResize(monthly_counts, total_months + 1);
            monthly_counts[total_months].year = dt.year;
            monthly_counts[total_months].month = dt.mon;
            monthly_counts[total_months].count = 1;
            total_months++;
         } else {
            monthly_counts[month_idx].count++;
         }
        }
     }

   if(total_months <= 1) {
      downside_consistency = 1.0;
      return;
   }

   double target_trades_per_month = InpMinTradesPerYear / 12.0;
   if (target_trades_per_month < 1) target_trades_per_month = 1;


   double sum_of_squared_downside_dev = 0;
   for(int i = 0; i < total_months; i++) {
      if(monthly_counts[i].count < target_trades_per_month) {
         double deviation = target_trades_per_month - monthly_counts[i].count;
         sum_of_squared_downside_dev += deviation * deviation;
      }
   }

   double downside_variance = sum_of_squared_downside_dev / total_months;
   double downside_deviation = sqrt(downside_variance);

   downside_consistency = 1.0 / (1.0 + downside_deviation);
}



//+------------------------------------------------------------------+
//|    Ø¨Ø®Ø´ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ (Custom Optimization) Ù†Ø³Ø®Ù‡ 10.0 - Ù†Ù‡Ø§ÛŒÛŒ   |
//|      Ø¨Ø§ "Ù…Ù†Ø­Ù†ÛŒ Ù…Ø¬Ø§Ø²Ø§Øª Ø¯Ø±Ø§ÙˆØ¯Ø§ÙˆÙ† Ù¾ÛŒÙˆØ³ØªÙ‡" (Continuous Penalty Curve)     |
//+------------------------------------------------------------------+

//--- Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
struct EquityPoint
{
   datetime time;
   double   balance;
};
struct MonthlyTrades
{
   int      year;
   int      month;
   int      count;
};



------------------------------------------------------------------------------------------------------------------------------
|                                                   ÙØ§ÛŒÙ„ Ø¯ÛŒÚ¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡                                                               |
|-------------------------------------------------------------------------------------------------------------------------------



//+------------------------------------------------------------------+
//|                                     IchimokuLogic.mqh            |
//|                          Â© 2025, hipoalgoritm              |
//+------------------------------------------------------------------+
#property copyright "Â© 2025,hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "2.1" 
#include "set.mqh"
#include <Trade\Trade.mqh>
#include <Trade\SymbolInfo.mqh>
#include <Object.mqh>
#include "VisualManager.mqh"
#include <MovingAverages.mqh>
#include "MarketStructure.mqh"




// IchimokuLogic.mqh

struct SPotentialSignal
{
    datetime        time;
    bool            is_buy;
    int             grace_candle_count;
    double          invalidation_level; // âœ…âœ…âœ… Ø§ÛŒÙ† Ø®Ø· Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† âœ…âœ…âœ…
    
    // Ø³Ø§Ø²Ù†Ø¯Ù‡ Ú©Ù¾ÛŒ (Copy Constructor)
    SPotentialSignal(const SPotentialSignal &other)
    {
        time = other.time;
        is_buy = other.is_buy;
        grace_candle_count = other.grace_candle_count;
        invalidation_level = other.invalidation_level; // âœ…âœ…âœ… Ø§ÛŒÙ† Ø®Ø· Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† âœ…âœ…âœ…
    }
    // Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø¯ Ø¨Ù‡ Ù…Ø´Ú©Ù„ Ù†Ø®ÙˆØ±Ù‡)
    SPotentialSignal()
    {
       invalidation_level = 0.0; // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    }
};


 
/*struct SSettings
{
    string              symbols_list;
    int                 magic_number;
    bool                enable_logging;

    int                 tenkan_period;
    int                 kijun_period;
    int                 senkou_period;
    int                 chikou_period;

    E_Confirmation_Mode confirmation_type;
    int                 grace_period_candles;
    double              talaqi_distance_in_points;

    E_SL_Mode           stoploss_type;
    int                 sl_lookback_period;
    double              sl_buffer_multiplier;

    double              risk_percent_per_trade;
    double              take_profit_ratio;
    int                 max_trades_per_symbol;
    int                 max_total_trades;

    double              object_size_multiplier;
    color               bullish_color;
    color               bearish_color;
};
*/

//================================================================
//+------------------------------------------------------------------+
//| Ú©Ù„Ø§Ø³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ù†Ù…Ø§Ø¯ Ø®Ø§Øµ                             |
//+------------------------------------------------------------------+
class CStrategyManager
{
private:
    string              m_symbol;
    SSettings           m_settings;
    CTrade              m_trade;
   
    datetime            m_last_bar_time;
    
    // --- Ù‡Ù†Ø¯Ù„ Ù‡Ø§ÛŒ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± ---
    int                 m_ichimoku_handle;
    int                 m_atr_handle;      
    int                 m_adx_handle;       // +++ NEW: Ù‡Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± ADX
    int                 m_rsi_exit_handle;  // +++ NEW: Ù‡Ù†Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø¨Ø§ RSI

    // --- Ø¨Ø§ÙØ±Ù‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ ---
    double              m_tenkan_buffer[];
    double              m_kijun_buffer[];
    double              m_chikou_buffer[];
    double              m_high_buffer[];
    double              m_low_buffer[];
    
    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„ ---
    SPotentialSignal    m_signal;
    bool                m_is_waiting;
    SPotentialSignal    m_potential_signals[];
    CVisualManager* m_visual_manager;
    CMarketStructureShift m_ltf_analyzer;
    CMarketStructureShift m_grace_structure_analyzer; // ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ù…Ù‡Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ

    //--- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
    void Log(string message);
    
    // --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ ---
    void AddOrUpdatePotentialSignal(bool is_buy);
    bool CheckTripleCross(bool& is_buy);
    bool CheckFinalConfirmation(bool is_buy);
    //[ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯] ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† 
    bool CheckLowerTfConfirmation(bool is_buy);
    // --- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ ---
    bool AreAllFiltersPassed(bool is_buy);
    bool CheckKumoFilter(bool is_buy);
    bool CheckAtrFilter();
    bool CheckAdxFilter(bool is_buy); // +++ NEW: ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± ADX

    // --- Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ ---
    void CheckForEarlyExit();         // +++ NEW: ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³
    bool CheckChikouRsiExit(bool is_buy); // +++ NEW: ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ Ú†ÛŒÚ©Ùˆ+RSI

    //--- Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ ---
    double CalculateStopLoss(bool is_buy, double entry_price);
    double CalculateAtrStopLoss(bool is_buy, double entry_price); // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯
    double GetTalaqiTolerance(int reference_shift);
    double CalculateAtrTolerance(int reference_shift);
    double CalculateDynamicTolerance(int reference_shift);
    double FindFlatKijun();
    double FindPivotKijun(bool is_buy);
    double FindPivotTenkan(bool is_buy);
    double FindBackupStopLoss(bool is_buy, double buffer);
    
    //--- Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ù…Ù„Ø§Øª ---
    int CountSymbolTrades();
    int CountTotalTrades();
    void OpenTrade(bool is_buy);
    bool IsDataReady();

public:
    CStrategyManager(string symbol, SSettings &settings);
    ~CStrategyManager(); // ØªØ®Ø±ÛŒØ¨â€ŒÚ¯Ø±
    bool Init();
    void ProcessNewBar();
    string GetSymbol() const { return m_symbol; }
    void UpdateMyDashboard(); // Ø§Ø¹Ù„Ø§Ù† ØªØ§Ø¨Ø¹ Ø¢Ù¾Ø¯ÛŒØª
    CVisualManager* GetVisualManager() { return m_visual_manager; }
};
//+------------------------------------------------------------------+
//| Ú©Ø§Ù†Ø³ØªØ±Ø§Ú©ØªÙˆØ± Ú©Ù„Ø§Ø³                                                |
//+------------------------------------------------------------------+
CStrategyManager::CStrategyManager(string symbol, SSettings &settings)
{
    m_symbol = symbol;
    m_settings = settings;
    m_last_bar_time = 0;
    m_is_waiting = false;
    ArrayFree(m_potential_signals);
    m_ichimoku_handle = INVALID_HANDLE;
    m_atr_handle = INVALID_HANDLE;
    m_visual_manager = new CVisualManager(m_symbol, m_settings);
}

//+------------------------------------------------------------------+
//| Ø¯ÛŒØ³ØªØ±Ø§Ú©ØªÙˆØ± Ú©Ù„Ø§Ø³ (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)                           |
//+------------------------------------------------------------------+
CStrategyManager::~CStrategyManager()
{
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø¯ÛŒØ± Ú¯Ø±Ø§ÙÛŒÚ©
    if (m_visual_manager != NULL)
    {
        delete m_visual_manager;
        m_visual_manager = NULL;
    }

    // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ± (Ù‡Ø± Ú©Ø¯Ø§Ù… ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø±)
    if(m_ichimoku_handle != INVALID_HANDLE)
        IndicatorRelease(m_ichimoku_handle);
        
    if(m_atr_handle != INVALID_HANDLE)
        IndicatorRelease(m_atr_handle);
        
    if(m_adx_handle != INVALID_HANDLE)
        IndicatorRelease(m_adx_handle);

    if(m_rsi_exit_handle != INVALID_HANDLE)
        IndicatorRelease(m_rsi_exit_handle);
}

//+------------------------------------------------------------------+
//| Ø¢Ù¾Ø¯ÛŒØª Ú©Ø±Ø¯Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯                                                |
//+------------------------------------------------------------------+
void CStrategyManager::UpdateMyDashboard() 
{ 
    if (m_visual_manager != NULL)
    {
        m_visual_manager.UpdateDashboard();
    }
}
//================================================================


//+------------------------------------------------------------------+
//| Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ÛŒ Ù†Ø§Ù…Ø±Ø¦ÛŒ)                  |
//+------------------------------------------------------------------+
bool CStrategyManager::Init()
{
    // +++ Ø¨Ø®Ø´ ÙˆØ§Ú©Ø³ÛŒÙ†Ø§Ø³ÛŒÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¢Ù…Ø§Ø¯Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) +++
    int attempts = 0;
    while(iBars(m_symbol, m_settings.ichimoku_timeframe) < 200 && attempts < 100)
    {
        Sleep(100); 
        MqlRates rates[];
        CopyRates(m_symbol, m_settings.ichimoku_timeframe, 0, 1, rates); 
        attempts++;
    }
    if (iBars(m_symbol, m_settings.ichimoku_timeframe) < 200)
    {
        Log("Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ: Ù¾Ø³ Ø§Ø² ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø±Ø±ØŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯ " + m_symbol + " Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯.");
        return false;
    }
    // +++ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø®Ø´ ÙˆØ§Ú©Ø³ÛŒÙ†Ø§Ø³ÛŒÙˆÙ† +++

    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø´ÛŒØ¡ ØªØ±ÛŒØ¯ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
    m_trade.SetExpertMagicNumber(m_settings.magic_number);
    m_trade.SetTypeFillingBySymbol(m_symbol);
    
    // --- =================================================================== ---
    // --- âœ… Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ ØªØºÛŒÛŒØ±Ø§Øª: Ø³Ø§Ø®Øª Ù‡Ù†Ø¯Ù„ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±Ù‡Ø§ (Ø­Ø§Ù„Øª Ø±ÙˆØ­ Ùˆ Ø¹Ø§Ø¯ÛŒ) âœ… ---
    // --- =================================================================== ---

    // ğŸ’¡ **Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ: Ø§Ù†ØªØ®Ø§Ø¨ Ø¨ÛŒÙ† Ø­Ø§Ù„Øª Ù†Ù…Ø§ÛŒØ´ÛŒ ÛŒØ§ Ø­Ø§Ù„Øª Ø±ÙˆØ­**

    // --- Ø­Ø§Ù„Øª Û± (ÙØ¹Ø§Ù„): Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ Ø±ÙˆÛŒ Ú†Ø§Ø±Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ---
   // m_ichimoku_handle = iIchimoku(m_symbol, m_settings.ichimoku_timeframe, m_settings.tenkan_period, m_settings.kijun_period, m_settings.senkou_period);

    
    // --- Ø­Ø§Ù„Øª Û² (ØºÛŒØ±ÙØ¹Ø§Ù„): Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ùˆ Ø±ÙˆÛŒ Ú†Ø§Ø±Øª Ù†Ù…ÛŒâ€ŒØ¢ÛŒØ¯ (Ø­Ø§Ù„Øª Ø±ÙˆØ­) ---
    // Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ø­Ø§Ù„ØªØŒ Ú©Ø¯ Ø¨Ø§Ù„Ø§ Ø±Ø§ Ú©Ø§Ù…Ù†Øª Ú©Ø±Ø¯Ù‡ Ùˆ Ø§ÛŒÙ† Ø¨Ù„Ø§Ú© Ø±Ø§ Ø§Ø² Ú©Ø§Ù…Ù†Øª Ø®Ø§Ø±Ø¬ Ú©Ù†ÛŒØ¯.
    MqlParam ichimoku_params[3];
    ichimoku_params[0].type = TYPE_INT;
    ichimoku_params[0].integer_value = m_settings.tenkan_period;
    ichimoku_params[1].type = TYPE_INT;
    ichimoku_params[1].integer_value = m_settings.kijun_period;
    ichimoku_params[2].type = TYPE_INT;
    ichimoku_params[2].integer_value = m_settings.senkou_period;
    m_ichimoku_handle = IndicatorCreate(m_symbol, m_settings.ichimoku_timeframe, IND_ICHIMOKU, 3, ichimoku_params);
    


    // ğŸ‘» **Ø³Ø§Ø®Øª Ù‡Ù†Ø¯Ù„ ATR Ø¯Ø± Ø­Ø§Ù„Øª Ø±ÙˆØ­ (Ù†Ø§Ù…Ø±Ø¦ÛŒ)**
    MqlParam atr_params[1];
    atr_params[0].type = TYPE_INT;
    atr_params[0].integer_value = m_settings.atr_filter_period;
    m_atr_handle = IndicatorCreate(m_symbol, m_settings.ichimoku_timeframe, IND_ATR, 1, atr_params);

    // ğŸ‘» **Ø³Ø§Ø®Øª Ù‡Ù†Ø¯Ù„ ADX Ø¯Ø± Ø­Ø§Ù„Øª Ø±ÙˆØ­ (Ù†Ø§Ù…Ø±Ø¦ÛŒ)**
    MqlParam adx_params[1];
    adx_params[0].type = TYPE_INT;
    adx_params[0].integer_value = m_settings.adx_period;
    m_adx_handle = IndicatorCreate(m_symbol, m_settings.ichimoku_timeframe, IND_ADX, 1, adx_params);

    // ğŸ‘» **Ø³Ø§Ø®Øª Ù‡Ù†Ø¯Ù„ RSI Ø¯Ø± Ø­Ø§Ù„Øª Ø±ÙˆØ­ (Ù†Ø§Ù…Ø±Ø¦ÛŒ)**
    MqlParam rsi_params[2];
    rsi_params[0].type = TYPE_INT;
    rsi_params[0].integer_value = m_settings.early_exit_rsi_period;
    rsi_params[1].type = TYPE_INT;
    rsi_params[1].integer_value = PRICE_CLOSE; // applied_price
    m_rsi_exit_handle = IndicatorCreate(m_symbol, m_settings.ichimoku_timeframe, IND_RSI, 2, rsi_params);
    
    // --- =================================================================== ---
    // --- âœ… Ù¾Ø§ÛŒØ§Ù† Ø¨Ø®Ø´ ØªØºÛŒÛŒØ±Ø§Øª âœ… ---
    // --- =================================================================== ---

    // Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø¹ØªØ¨Ø§Ø± ØªÙ…Ø§Ù… Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§
    if (m_ichimoku_handle == INVALID_HANDLE || m_atr_handle == INVALID_HANDLE || m_adx_handle == INVALID_HANDLE || m_rsi_exit_handle == INVALID_HANDLE)
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© ÛŒØ§ Ú†Ù†Ø¯ Ø§Ù†Ø¯ÛŒÚ©Ø§ØªÙˆØ±. Ù„Ø·ÙØ§Ù‹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
        return false;
    }

    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ÙØ±Ù‡Ø§ Ùˆ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
    ArraySetAsSeries(m_tenkan_buffer, true);
    ArraySetAsSeries(m_kijun_buffer, true);
    ArraySetAsSeries(m_chikou_buffer, true);
    ArraySetAsSeries(m_high_buffer, true);
    ArraySetAsSeries(m_low_buffer, true); 
    
    if (!m_visual_manager.Init())
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ VisualManager.");
        return false;
    }

    if(m_symbol == _Symbol)
    {
        m_visual_manager.InitDashboard();
    }
    
    m_ltf_analyzer.Init(m_symbol, m_settings.ltf_timeframe);
    
    Log("Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ø¯.");
    return true;
}


//+------------------------------------------------------------------+
//| (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡) ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯             |
//+------------------------------------------------------------------+
void CStrategyManager::ProcessNewBar()
{
  if (!IsDataReady()) return;//ÙˆØ§Ú©Ø³Ù†
    // --- Ú¯Ø§Ù… Û°: Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---

    // Ø²Ù…Ø§Ù† Ø¨Ø§Ø² Ø´Ø¯Ù† Ú©Ù†Ø¯Ù„ ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ (Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± ØªØ¹ÛŒÛŒÙ† Ú©Ø±Ø¯Ù‡) Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
    datetime current_bar_time = iTime(m_symbol, m_settings.ichimoku_timeframe, 0);
    
    // Ø§Ú¯Ø± Ø§ÛŒÙ† Ú©Ù†Ø¯Ù„ Ù‚Ø¨Ù„Ø§Ù‹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡ØŒ Ø§Ø² ØªØ§Ø¨Ø¹ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ… ØªØ§ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ù†ÛŒÙ….
    if (current_bar_time == m_last_bar_time) 
        return; 
    
    // Ø²Ù…Ø§Ù† Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¯Ø± ØªÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø´ÙˆØ¯.
    m_last_bar_time = current_bar_time;
  
    // Ø§Ú¯Ø± Ù‚Ø§Ø¨Ù„ÛŒØª Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯ØŒ Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø² Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
    if(m_settings.enable_early_exit)
    {
        CheckForEarlyExit();
    }

    // Ø§Ú¯Ø± Ø§ÛŒÙ† Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø² Ú©Ù„Ø§Ø³ØŒ Ù…Ø³Ø¦ÙˆÙ„ Ú†Ø§Ø±Øª Ø§ØµÙ„ÛŒ Ø§Ø³ØªØŒ Ø§Ø´ÛŒØ§Ø¡ Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ø§ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    if(m_symbol == _Symbol && m_visual_manager != NULL)
    {
        m_visual_manager.CleanupOldObjects(200);
    }

    //================================================================//
    //                 Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù†Ø·Ù‚ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø§Ù„Øª Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒÚ¯Ù†Ø§Ù„           //
    //================================================================//

    // --- Ø­Ø§Ù„Øª Ø§ÙˆÙ„: Ù…Ù†Ø·Ù‚ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ (ÙÙ‚Ø· ÛŒÚ© Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯) ---
    if (m_settings.signal_mode == MODE_REPLACE_SIGNAL)
    {
        bool is_new_signal_buy = false;
        
        // Ø¢ÛŒØ§ ÛŒÚ© Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡ Ø¬Ø¯ÛŒØ¯ (Ú©Ø±Ø§Ø³ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡) Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡ Ø§Ø³ØªØŸ
        if (CheckTripleCross(is_new_signal_buy))
        {
            // Ø§Ú¯Ø± Ø§Ø² Ù‚Ø¨Ù„ Ù…Ù†ØªØ¸Ø± ÛŒÚ© Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨ÙˆØ¯ÛŒÙ… Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯ Ù…Ø®Ø§Ù„Ù Ù‚Ø¨Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ú©Ù†Ø³Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
            if (m_is_waiting && is_new_signal_buy != m_signal.is_buy)
            {
                Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯ Ùˆ Ù…Ø®Ø§Ù„Ù Ù¾ÛŒØ¯Ø§ Ø´Ø¯! Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù‚Ø¨Ù„ÛŒ Ú©Ù†Ø³Ù„ Ø´Ø¯.");
                m_is_waiting = false;
            }
            
            // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ù†Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ¹Ø§Ù„ Ø¯Ø± Ù†Ø¸Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ….
            if (!m_is_waiting)
            {
                m_is_waiting = true;
                m_signal.is_buy = is_new_signal_buy;
                m_signal.time = iTime(m_symbol, m_settings.ichimoku_timeframe, m_settings.chikou_period);
                m_signal.grace_candle_count = 0;
                m_signal.invalidation_level = 0.0; // Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø±Ø§ Ø±ÛŒØ³Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….

                // Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ù…Ù‡Ù„Øª "Ø³Ø§Ø®ØªØ§Ø±ÛŒ" Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø±Ø§ Ù‡Ù…ÛŒÙ†Ø¬Ø§ ØªØ¹ÛŒÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
                if (m_settings.grace_period_mode == GRACE_BY_STRUCTURE)
                {
                    m_grace_structure_analyzer.ProcessNewBar(); // ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ø±Ø§ Ø±ÙˆÛŒ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
                    if (is_new_signal_buy)
                    {
                        m_signal.invalidation_level = m_grace_structure_analyzer.GetLastSwingLow();
                        Log("Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯: " + DoubleToString(m_signal.invalidation_level, _Digits));
                    }
                    else
                    {
                        m_signal.invalidation_level = m_grace_structure_analyzer.GetLastSwingHigh();
                        Log("Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´: " + DoubleToString(m_signal.invalidation_level, _Digits));
                    }
                }
                
                Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡ " + (m_signal.is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ù¾ÛŒØ¯Ø§ Ø´Ø¯. ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø±...");
                if(m_symbol == _Symbol && m_visual_manager != NULL) 
                    m_visual_manager.DrawTripleCrossRectangle(m_signal.is_buy, m_settings.chikou_period);
            }
        }
    
        // Ø§ÛŒÙ† Ø¨Ø®Ø´ ÙÙ‚Ø· Ø²Ù…Ø§Ù†ÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡ ÛŒÚ© Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø¹ØªØ¨Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ….
        if (m_is_waiting)
        {
            bool is_signal_expired = false;

            // --- Ú¯Ø§Ù… Û±: Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ú©Ø§Ø±Ø¨Ø± ---
            if (m_settings.grace_period_mode == GRACE_BY_CANDLES)
            {
                if (m_signal.grace_candle_count >= m_settings.grace_period_candles)
                {
                    is_signal_expired = true;
                    Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø§ØªÙ…Ø§Ù… Ù…Ù‡Ù„Øª Ø²Ù…Ø§Ù†ÛŒ (ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„) Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯.");
                }
            }
            else // Ø­Ø§Ù„Øª GRACE_BY_STRUCTURE
            {
                double current_price = iClose(m_symbol, m_settings.ichimoku_timeframe, 1);
                if (m_signal.invalidation_level > 0)
                {
                    if ((m_signal.is_buy && current_price < m_signal.invalidation_level) ||
                        (!m_signal.is_buy && current_price > m_signal.invalidation_level))
                    {
                        is_signal_expired = true;
                        Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø´Ú©Ø³Øª Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø³Ø§Ø®ØªØ§Ø±ÛŒ (" + DoubleToString(m_signal.invalidation_level, _Digits) + ") Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯.");
                    }
                }
            }

            // --- Ú¯Ø§Ù… Û²: ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ù†Ù‡Ø§ÛŒÛŒ ---
            if (is_signal_expired)
            {
                m_is_waiting = false; // Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯ØŒ Ø§Ø² Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø®Ø§Ø±Ø¬ Ø´Ùˆ.
            }
            // Ø§Ú¯Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù‡Ù†ÙˆØ² Ù…Ø¹ØªØ¨Ø± Ø§Ø³ØªØŒ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ….
            else if (CheckFinalConfirmation(m_signal.is_buy))
            {
                Log("ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ " + (m_signal.is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.");
                
                // [Ø¯Ø±ÙˆØ§Ø²Ù‡ Ù†Ù‡Ø§ÛŒÛŒ] Ø­Ø§Ù„Ø§ Ú©Ù‡ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø±Ø§ Ø§Ø² ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¹Ø¨ÙˆØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
                if (AreAllFiltersPassed(m_signal.is_buy))
                {
                    Log("ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§ Ù¾Ø§Ø³ Ø´Ø¯Ù†Ø¯. Ø§Ø±Ø³Ø§Ù„ Ø¯Ø³ØªÙˆØ± Ù…Ø¹Ø§Ù…Ù„Ù‡...");
                    if(m_symbol == _Symbol && m_visual_manager != NULL) 
                        m_visual_manager.DrawConfirmationArrow(m_signal.is_buy, 1);
                    
                    OpenTrade(m_signal.is_buy);
                }
                else
                {
                    Log("âŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ ØªÙˆØ³Ø· ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø¯ Ø´Ø¯.");
                }
                
                m_is_waiting = false; // Ú©Ø§Ø± Ø§ÛŒÙ† Ø³ÛŒÚ¯Ù†Ø§Ù„ (Ú†Ù‡ Ù…ÙˆÙÙ‚ Ú†Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚) ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.
            }
            // Ø§Ú¯Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù†Ù‡ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ùˆ Ù†Ù‡ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª...
            else
            {
                // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ Ø±Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ù…Ù‡Ù„Øª Ø²Ù…Ø§Ù†ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
                if(m_settings.grace_period_mode == GRACE_BY_CANDLES)
                {
                     m_signal.grace_candle_count++;
                }
                // Ù†Ø§Ø­ÛŒÙ‡ Ø§Ø³Ú©Ù† Ø±ÙˆÛŒ Ú†Ø§Ø±Øª Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
                if(m_symbol == _Symbol && m_visual_manager != NULL) 
                    m_visual_manager.DrawScanningArea(m_signal.is_buy, m_settings.chikou_period, m_signal.grace_candle_count);
            }
        }
    }
    // --- Ø­Ø§Ù„Øª Ø¯ÙˆÙ…: Ù…Ù†Ø·Ù‚ Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ (Ù‡Ù†ÙˆØ² Ø§Ø² Ù…Ù†Ø·Ù‚ Ù‚Ø¯ÛŒÙ…ÛŒ Ù…Ù‡Ù„Øª Ø²Ù…Ø§Ù†ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯) ---
    // Ù†Ú©ØªÙ‡: Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ù‡Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡ Ø¯Ø§Ø±Ø¯ Ú©Ù‡ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¹Ø¯ÛŒ Ù‚Ø§Ø¨Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª.
// IchimokuLogic.mqh -> Ø¯Ø§Ø®Ù„ ØªØ§Ø¨Ø¹ ProcessNewBar

    // --- Ø­Ø§Ù„Øª Ø¯ÙˆÙ…: Ù…Ù†Ø·Ù‚ Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ (Ù†Ø³Ø®Ù‡ Ø¢Ù¾Ú¯Ø±ÛŒØ¯ Ø´Ø¯Ù‡ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù…Ù‡Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ) ---
    else if (m_settings.signal_mode == MODE_SIGNAL_CONTEST)
    {
        bool is_new_signal_buy = false;
        // Ø§Ú¯Ø± Ú©Ø±Ø§Ø³ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡ Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ¯Ø§ Ø´Ø¯
        if (CheckTripleCross(is_new_signal_buy))
        {
            // ÛŒÚ© Ù†Ø§Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            int total = ArraySize(m_potential_signals);
            ArrayResize(m_potential_signals, total + 1);
            m_potential_signals[total].time = iTime(m_symbol, m_settings.ichimoku_timeframe, m_settings.chikou_period);
            m_potential_signals[total].is_buy = is_new_signal_buy;
            m_potential_signals[total].grace_candle_count = 0;
            m_potential_signals[total].invalidation_level = 0.0; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡

            // Ø§Ú¯Ø± Ù…Ù‡Ù„Øª Ø§Ø² Ù†ÙˆØ¹ Ø³Ø§Ø®ØªØ§Ø±ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø±Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (m_settings.grace_period_mode == GRACE_BY_STRUCTURE)
            {
                m_grace_structure_analyzer.ProcessNewBar(); // ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                if (is_new_signal_buy)
                {
                    m_potential_signals[total].invalidation_level = m_grace_structure_analyzer.GetLastSwingLow();
                }
                else
                {
                    m_potential_signals[total].invalidation_level = m_grace_structure_analyzer.GetLastSwingHigh();
                }
                Log("[Ø­Ø§Ù„Øª Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ] Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù†Ø§Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ " + (is_new_signal_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¨Ø§ Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ " + DoubleToString(m_potential_signals[total].invalidation_level, _Digits) + " Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
            }
            else // Ø§Ú¯Ø± Ù…Ù‡Ù„Øª Ø§Ø² Ù†ÙˆØ¹ Ú©Ù†Ø¯Ù„ÛŒ Ø¨Ø§Ø´Ø¯
            {
                Log("[Ø­Ø§Ù„Øª Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ] Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù†Ø§Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ " + (is_new_signal_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§: " + (string)ArraySize(m_potential_signals));
            }

            // Ø±Ø³Ù… Ù…Ø³ØªØ·ÛŒÙ„ Ú©Ø±Ø§Ø³ Ø±ÙˆÛŒ Ú†Ø§Ø±Øª
            if(m_symbol == _Symbol && m_visual_manager != NULL)
                m_visual_manager.DrawTripleCrossRectangle(is_new_signal_buy, m_settings.chikou_period);
        }

        // Ø§Ú¯Ø± Ù„ÛŒØ³Øª Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§ Ø®Ø§Ù„ÛŒ Ù†Ø¨Ø§Ø´Ø¯
        if (ArraySize(m_potential_signals) > 0)
        {
            // Ø­Ù„Ù‚Ù‡ Ø§Ø² Ø¢Ø®Ø± Ø¨Ù‡ Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§
            for (int i = ArraySize(m_potential_signals) - 1; i >= 0; i--)
            {
                bool is_signal_expired = false;
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‡Ù„Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒ ÛŒØ§ Ú©Ù†Ø¯Ù„ÛŒ
                if (m_settings.grace_period_mode == GRACE_BY_CANDLES)
                {
                    if (m_potential_signals[i].grace_candle_count >= m_settings.grace_period_candles)
                    {
                        is_signal_expired = true;
                        Log("Ø²Ù…Ø§Ù† Ù†Ø§Ù…Ø²Ø¯ " + (m_potential_signals[i].is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ Ùˆ Ø­Ø°Ù Ø´Ø¯.");
                    }
                }
                else // GRACE_BY_STRUCTURE
                {
                    double current_price = iClose(m_symbol, m_settings.ichimoku_timeframe, 1);
                    if (m_potential_signals[i].invalidation_level > 0 &&
                        ((m_potential_signals[i].is_buy && current_price < m_potential_signals[i].invalidation_level) ||
                         (!m_potential_signals[i].is_buy && current_price > m_potential_signals[i].invalidation_level)))
                    {
                        is_signal_expired = true;
                        Log("Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù†Ø§Ù…Ø²Ø¯ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø´Ú©Ø³Øª Ø³Ø·Ø­ Ø§Ø¨Ø·Ø§Ù„ Ø³Ø§Ø®ØªØ§Ø±ÛŒ (" + DoubleToString(m_potential_signals[i].invalidation_level, _Digits) + ") Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯ Ùˆ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
                    }
                }

                if (is_signal_expired)
                {
                    ArrayRemove(m_potential_signals, i, 1);
                    continue; // Ø¨Ù‡ Ù†Ø§Ù…Ø²Ø¯ Ø¨Ø¹Ø¯ÛŒ Ù…ÛŒâ€ŒØ±ÙˆÛŒÙ…
                }
            
                // Ø§Ú¯Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø±Ø§ Ø¨Ø§ Ù‡Ù… Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ø¯
                if (CheckFinalConfirmation(m_potential_signals[i].is_buy) && AreAllFiltersPassed(m_potential_signals[i].is_buy))
                {
                    Log("ğŸ† Ø¨Ø±Ù†Ø¯Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯: Ø³ÛŒÚ¯Ù†Ø§Ù„ " + (m_potential_signals[i].is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´"));
                
                    if (m_symbol == _Symbol && m_visual_manager != NULL)
                        m_visual_manager.DrawConfirmationArrow(m_potential_signals[i].is_buy, 1);
                    
                    OpenTrade(m_potential_signals[i].is_buy);
                    
                    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§ÛŒ Ù‡Ù…â€ŒØ¬Ù‡Øª Ø¨Ø§ Ø¨Ø±Ù†Ø¯Ù‡
                    bool winner_is_buy = m_potential_signals[i].is_buy;
                    for (int j = ArraySize(m_potential_signals) - 1; j >= 0; j--)
                    {
                        if (m_potential_signals[j].is_buy == winner_is_buy)
                        {
                            ArrayRemove(m_potential_signals, j, 1);
                        }
                    }
                    Log("Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§ÛŒ Ù‡Ù…â€ŒØ¬Ù‡Øª Ø¨Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
                    
                    return; // Ú†ÙˆÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ø´Ø¯Ù‡ Ùˆ Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´Ø¯Ù†Ø¯ØŒ Ø§Ø² ØªØ§Ø¨Ø¹ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…
                }
                else
                {
                    // Ø§Ú¯Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù†Ù‡ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ùˆ Ù†Ù‡ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª
                    // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ Ø±Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Ù…Ù‡Ù„Øª Ú©Ù†Ø¯Ù„ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
                    if (m_settings.grace_period_mode == GRACE_BY_CANDLES)
                    {
                        m_potential_signals[i].grace_candle_count++;
                    }
                    // Ù†Ø§Ø­ÛŒÙ‡ Ø§Ø³Ú©Ù† Ø±ÙˆÛŒ Ú†Ø§Ø±Øª Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    if (m_symbol == _Symbol && m_visual_manager != NULL)
                        m_visual_manager.DrawScanningArea(m_potential_signals[i].is_buy, m_settings.chikou_period, m_potential_signals[i].grace_candle_count);
                }
            }
        }
    }

}

//+------------------------------------------------------------------+
//| Ù…Ù†Ø·Ù‚ ÙØ§Ø² Û±: Ú†Ú© Ú©Ø±Ø¯Ù† Ú©Ø±Ø§Ø³ Ø³Ù‡ Ú¯Ø§Ù†Ù‡ (Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ø§Ù…Ù„ Ùˆ Ù†Ù‡Ø§ÛŒÛŒ)         |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckTripleCross(bool& is_buy)
{
    // --- Ú¯Ø§Ù… Ø§ÙˆÙ„: Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ---

    // Ø´ÛŒÙØª Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒÙ… Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒÙ… (Ù…Ø«Ù„Ø§Ù‹ Û²Û¶ Ú©Ù†Ø¯Ù„ Ù‚Ø¨Ù„)
    int shift = m_settings.chikou_period;
    
    // Ø§Ú¯Ù‡ Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§ÙÛŒ Ú©Ù†Ø¯Ù„ ØªÙˆÛŒ Ú†Ø§Ø±Øª Ù†Ø¨Ø§Ø´Ù‡ØŒ Ø§Ø² ØªØ§Ø¨Ø¹ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÛŒÙ…
    if (iBars(m_symbol, _Period) < shift + 2) return false;

    // --- Ú¯Ø§Ù… Ø¯ÙˆÙ…: Ø¯Ø±ÛŒØ§ÙØª Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ ---

    // Ø¯Ùˆ Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹ Ùˆ Ú©Ù†Ø¯Ù„ Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù†
    double tk_shifted[], ks_shifted[];
    
    // Ø§Ø² Ù…ØªØ§ØªØ±ÛŒØ¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒÙ… Ú©Ù‡ Û² Ù…Ù‚Ø¯Ø§Ø± Ø¢Ø®Ø± ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø±Ùˆ Ø§Ø² Ù†Ù‚Ø·Ù‡ "Ø´ÛŒÙØª" Ø¨Ù‡ Ù…Ø§ Ø¨Ø¯Ù‡
    if(CopyBuffer(m_ichimoku_handle, 0, shift, 2, tk_shifted) < 2 || 
       CopyBuffer(m_ichimoku_handle, 1, shift, 2, ks_shifted) < 2)
    {
       // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ø§Ø¯Ø§Ù…Ù‡ Ù†Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
       return false;
    }
       
    // Ù…Ù‚Ø¯Ø§Ø± ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹ (Ù…Ø«Ù„Ø§Ù‹ Ú©Ù†Ø¯Ù„ Û²Û¶ Ù‚Ø¨Ù„)
    double tenkan_at_shift = tk_shifted[0];
    double kijun_at_shift = ks_shifted[0];
    
    // Ù…Ù‚Ø¯Ø§Ø± ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ú©Ù†Ø¯Ù„Ù Ù‚Ø¨Ù„ Ø§Ø² Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹ (Ù…Ø«Ù„Ø§Ù‹ Ú©Ù†Ø¯Ù„ Û²Û· Ù‚Ø¨Ù„)
    double tenkan_prev_shift = tk_shifted[1];
    double kijun_prev_shift = ks_shifted[1];

    // --- Ú¯Ø§Ù… Ø³ÙˆÙ…: Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø· Ø§ÙˆÙ„ÛŒÙ‡ (Ø¢ÛŒØ§ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ú©Ø±Ø§Ø³ ÛŒØ§ ØªÙ„Ø§Ù‚ÛŒ Ø¯Ø§Ø´ØªÛŒÙ…ØŸ) ---

    // Ø¢ÛŒØ§ Ú©Ø±Ø§Ø³ ØµØ¹ÙˆØ¯ÛŒ Ø§ØªÙØ§Ù‚ Ø§ÙØªØ§Ø¯Ù‡ØŸ (ØªÙ†Ú©Ø§Ù† Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ø§ÙˆÙ…Ø¯Ù‡ Ø¨Ø§Ù„Ø§ÛŒ Ú©ÛŒØ¬ÙˆÙ†)
    bool is_cross_up = tenkan_prev_shift < kijun_prev_shift && tenkan_at_shift > kijun_at_shift;
    
    // Ø¢ÛŒØ§ Ú©Ø±Ø§Ø³ Ù†Ø²ÙˆÙ„ÛŒ Ø§ØªÙØ§Ù‚ Ø§ÙØªØ§Ø¯Ù‡ØŸ (ØªÙ†Ú©Ø§Ù† Ø§Ø² Ø¨Ø§Ù„Ø§ Ø§ÙˆÙ…Ø¯Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ú©ÛŒØ¬ÙˆÙ†)
    bool is_cross_down = tenkan_prev_shift > kijun_prev_shift && tenkan_at_shift < kijun_at_shift;
    
    // Ø¢ÛŒØ§ Ú©Ù„Ø§Ù‹ Ú©Ø±Ø§Ø³ÛŒ Ø¯Ø§Ø´ØªÛŒÙ…ØŸ (ÛŒØ§ ØµØ¹ÙˆØ¯ÛŒ ÛŒØ§ Ù†Ø²ÙˆÙ„ÛŒØŒ Ø¬Ù‡ØªØ´ Ù…Ù‡Ù… Ù†ÛŒØ³Øª)
    bool is_tk_cross = is_cross_up || is_cross_down;

    // Ø¢ÛŒØ§ Ø¯Ùˆ Ø®Ø· Ø®ÛŒÙ„ÛŒ Ø¨Ù‡ Ù‡Ù… Ù†Ø²Ø¯ÛŒÚ© Ø¨ÙˆØ¯Ù† (ØªÙ„Ø§Ù‚ÛŒ)ØŸ
    double tolerance = GetTalaqiTolerance(shift);
    bool is_confluence = (tolerance > 0) ? (MathAbs(tenkan_at_shift - kijun_at_shift) <= tolerance) : false;

    // Ø´Ø±Ø· Ø§ØµÙ„ÛŒ Ø§ÙˆÙ„ÛŒÙ‡: Ø§Ú¯Ø± Ù†Ù‡ Ú©Ø±Ø§Ø³ÛŒ Ø¯Ø§Ø´ØªÛŒÙ… Ùˆ Ù†Ù‡ ØªÙ„Ø§Ù‚ÛŒØŒ Ù¾Ø³ Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ Ø¯Ø± Ú©Ø§Ø± Ù†ÛŒØ³Øª Ùˆ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…
    if (!is_tk_cross && !is_confluence)
    {
        return false;
    }

    // --- Ú¯Ø§Ù… Ú†Ù‡Ø§Ø±Ù…: Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø· Ù†Ù‡Ø§ÛŒÛŒ (Ú©Ø±Ø§Ø³ Ú†ÛŒÚ©Ùˆ Ø§Ø³Ù¾Ù† Ø§Ø² Ø®Ø·ÙˆØ· Ú¯Ø°Ø´ØªÙ‡) ---

    // Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ú©Ù‡ Ù†Ù‚Ø´ Ú†ÛŒÚ©Ùˆ Ø§Ø³Ù¾Ù† Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Ú©Ù„ÙˆØ² Ú©Ù†Ø¯Ù„ Ø´Ù…Ø§Ø±Ù‡ Û±)
    double chikou_now  = iClose(m_symbol, m_settings.ichimoku_timeframe, 1);
    // Ù‚ÛŒÙ…Øª Ú©Ù†Ø¯Ù„ Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù† (Ú©Ù„ÙˆØ² Ú©Ù†Ø¯Ù„ Ø´Ù…Ø§Ø±Ù‡ Û²)
    double chikou_prev = iClose(m_symbol, m_settings.ichimoku_timeframe, 2); 

    // Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ø³Ø·Ø­ Ø¨ÛŒÙ† ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹
    double upper_line = MathMax(tenkan_at_shift, kijun_at_shift);
    // Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Ø³Ø·Ø­ Ø¨ÛŒÙ† ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ø¯Ø± Ù†Ù‚Ø·Ù‡ Ù…Ø±Ø¬Ø¹
    double lower_line = MathMin(tenkan_at_shift, kijun_at_shift);

    // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯:
    // Ø¢ÛŒØ§ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ (Ú†ÛŒÚ©Ùˆ) Ø§Ø² Ø¨Ø§Ù„Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ Ø®Ø· Ø¹Ø¨ÙˆØ± Ú©Ø±Ø¯Ù‡ØŸ
    bool chikou_crosses_up = chikou_now > upper_line && // Ø´Ø±Ø· Û±: Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù„Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ Ø®Ø· Ø¨Ø§Ø´Ø¯
                             chikou_prev < upper_line;    // Ø´Ø±Ø· Û²: Ù‚ÛŒÙ…Øª Ù‚Ø¨Ù„ÛŒ Ø¨Ø§ÛŒØ¯ Ø²ÛŒØ± Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ø®Ø· Ø¨ÙˆØ¯Ù‡ Ø¨Ø§Ø´Ø¯ ØªØ§ "Ú©Ø±Ø§Ø³" Ù…Ø¹Ù†ÛŒ Ø¯Ù‡Ø¯
    
    if (chikou_crosses_up)
    {
        // Ø§Ú¯Ø± Ø¨Ù„Ù‡ØŒ Ù†ÙˆØ¹ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø§ Ø®Ø±ÛŒØ¯ Ø§Ø³Øª
        is_buy = true;
        // Ùˆ ÛŒÚ© Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø¹ØªØ¨Ø± Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒÙ…
        return true; 
    }

    // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´:
    // Ø¢ÛŒØ§ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ (Ú†ÛŒÚ©Ùˆ) Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø± Ø¯Ùˆ Ø®Ø· Ø¹Ø¨ÙˆØ± Ú©Ø±Ø¯Ù‡ØŸ
    bool chikou_crosses_down = chikou_now < lower_line && // Ø´Ø±Ø· Û±: Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ Ø¨Ø§ÛŒØ¯ Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø± Ø¯Ùˆ Ø®Ø· Ø¨Ø§Ø´Ø¯
                               chikou_prev > lower_line;    // Ø´Ø±Ø· Û²: Ù‚ÛŒÙ…Øª Ù‚Ø¨Ù„ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù„Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Ø®Ø· Ø¨ÙˆØ¯Ù‡ Ø¨Ø§Ø´Ø¯ ØªØ§ "Ú©Ø±Ø§Ø³" Ù…Ø¹Ù†ÛŒ Ø¯Ù‡Ø¯
    
    if (chikou_crosses_down)
    {
        // Ø§Ú¯Ø± Ø¨Ù„Ù‡ØŒ Ù†ÙˆØ¹ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø§ ÙØ±ÙˆØ´ Ø§Ø³Øª
        is_buy = false;
        // Ùˆ ÛŒÚ© Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø¹ØªØ¨Ø± Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒÙ…
        return true; 
    }

    // Ø§Ú¯Ø± Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù… Ø§Ø² Ø´Ø±Ø·â€ŒÙ‡Ø§ÛŒ Ú©Ø±Ø§Ø³ Ú†ÛŒÚ©Ùˆ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø¨ÙˆØ¯ØŒ Ù¾Ø³ Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ Ø¯Ø± Ú©Ø§Ø± Ù†ÛŒØ³Øª
    return false;
}


//+------------------------------------------------------------------+
//| (Ù†Ø³Ø®Ù‡ Ø¢Ù¾Ú¯Ø±ÛŒØ¯ Ø´Ø¯Ù‡) Ù…Ø¯ÛŒØ± Ú©Ù„ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ                           |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckFinalConfirmation(bool is_buy)
{
    // Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ Ø±ÙˆØ´ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
    switch(m_settings.entry_confirmation_mode)
    {
        // Ø­Ø§Ù„Øª Û±: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø³Ø±ÛŒØ¹ (ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†)
        case CONFIRM_LOWER_TIMEFRAME:
            return CheckLowerTfConfirmation(is_buy);

        // Ø­Ø§Ù„Øª Û²: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ù‚Ø¯ÛŒÙ…ÛŒ Ùˆ Ú©Ù†Ø¯ (ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… ÙØ¹Ù„ÛŒ)
        case CONFIRM_CURRENT_TIMEFRAME:
        {
            // Ø§ÛŒÙ† Ø¨Ù„Ø§Ú© Ú©Ø¯ØŒ Ù‡Ù…Ø§Ù† Ù…Ù†Ø·Ù‚ Ù‚Ø¯ÛŒÙ…ÛŒ ØªØ§Ø¨Ø¹ Ø§Ø³Øª
            if (iBars(m_symbol, m_settings.ichimoku_timeframe) < 2) return false;

            CopyBuffer(m_ichimoku_handle, 0, 1, 1, m_tenkan_buffer);
            CopyBuffer(m_ichimoku_handle, 1, 1, 1, m_kijun_buffer);

            double tenkan_at_1 = m_tenkan_buffer[0];
            double kijun_at_1 = m_kijun_buffer[0];
            double open_at_1 = iOpen(m_symbol, m_settings.ichimoku_timeframe, 1);
            double close_at_1 = iClose(m_symbol, m_settings.ichimoku_timeframe, 1);

            if (is_buy)
            {
                if (tenkan_at_1 <= kijun_at_1) return false;
                if (m_settings.confirmation_type == MODE_OPEN_AND_CLOSE) {
                    if (open_at_1 > tenkan_at_1 && open_at_1 > kijun_at_1 && close_at_1 > tenkan_at_1 && close_at_1 > kijun_at_1)
                        return true;
                } else {
                    if (close_at_1 > tenkan_at_1 && close_at_1 > kijun_at_1)
                        return true;
                }
            }
            else
            {
                if (tenkan_at_1 >= kijun_at_1) return false;
                if (m_settings.confirmation_type == MODE_OPEN_AND_CLOSE) {
                    if (open_at_1 < tenkan_at_1 && open_at_1 < kijun_at_1 && close_at_1 < tenkan_at_1 && close_at_1 < kijun_at_1)
                        return true;
                } else {
                    if (close_at_1 < tenkan_at_1 && close_at_1 < kijun_at_1)
                        return true;
                }
            }
            return false;
        }
    }
    return false; // Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
}

//+------------------------------------------------------------------+
//| (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ù…Ù†Ø·Ù‚ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ÛŒÙ†Ù‡ - Ú©Ø§Ù…Ù„Ø§Ù‹ Ø³Ø§Ø²Ú¯Ø§Ø±) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateStopLoss(bool is_buy, double entry_price)
{
    // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø±ÙˆØ´ Ø³Ø§Ø¯Ù‡ ÛŒØ§ ATR Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ù‡Ù…Ø§Ù† Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù† (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
    if (m_settings.stoploss_type == MODE_SIMPLE)
    {
        double buffer = m_settings.sl_buffer_multiplier * SymbolInfoDouble(m_symbol, SYMBOL_POINT);
        return FindBackupStopLoss(is_buy, buffer);
    }
    if (m_settings.stoploss_type == MODE_ATR)
    {
        double sl_price = CalculateAtrStopLoss(is_buy, entry_price);
        if (sl_price == 0) // Ø§Ú¯Ø± ATR Ø¨Ù‡ Ù‡Ø± Ø¯Ù„ÛŒÙ„ÛŒ Ø¬ÙˆØ§Ø¨ Ù†Ø¯Ø§Ø¯
        {
            Log("Ù…Ø­Ø§Ø³Ø¨Ù‡ ATR SL Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±ÙˆØ´ Ù¾Ø´ØªÛŒØ¨Ø§Ù†...");
            double buffer = m_settings.sl_buffer_multiplier * SymbolInfoDouble(m_symbol, SYMBOL_POINT);
            return FindBackupStopLoss(is_buy, buffer);
        }
        return sl_price;
    }

    // --- Ù‚Ù„Ø¨ ØªÙ¾Ù†Ø¯Ù‡ Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯: Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ÛŒÙ†Ù‡ (Ø¨Ø±Ø§ÛŒ MODE_COMPLEX) ---

    Log("Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¨Ù‡ÛŒÙ†Ù‡...");

    // --- Ù…Ø±Ø­Ù„Ù‡ Û±: ØªØ´Ú©ÛŒÙ„ Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§Ù‡Ø§ ---
    double candidates[];
    int count = 0;
    double sl_candidate = 0; // Ù…ØªØºÛŒØ± Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù†ØªÛŒØ¬Ù‡ Ù‡Ø± ØªØ§Ø¨Ø¹
    double buffer = m_settings.sl_buffer_multiplier * SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    
    // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Û±: Ú©ÛŒØ¬ÙˆÙ† ÙÙ„Øª
    sl_candidate = FindFlatKijun();
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1);
        candidates[count] = is_buy ? sl_candidate - buffer : sl_candidate + buffer;
        count++;
    }
    
    // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Û²: Ù¾ÛŒÙˆØª Ú©ÛŒØ¬ÙˆÙ†
    sl_candidate = FindPivotKijun(is_buy);
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1);
        candidates[count] = is_buy ? sl_candidate - buffer : sl_candidate + buffer;
        count++;
    }

    // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Û³: Ù¾ÛŒÙˆØª ØªÙ†Ú©Ø§Ù†
    sl_candidate = FindPivotTenkan(is_buy);
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1);
        candidates[count] = is_buy ? sl_candidate - buffer : sl_candidate + buffer;
        count++;
    }

    // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Û´: Ø±ÙˆØ´ Ø³Ø§Ø¯Ù‡ (Ú©Ù†Ø¯Ù„ Ù…Ø®Ø§Ù„Ù)
    sl_candidate = FindBackupStopLoss(is_buy, buffer);
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1);
        candidates[count] = sl_candidate;
        count++;
    }
    
    // Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ûµ: Ø±ÙˆØ´ ATR
    sl_candidate = CalculateAtrStopLoss(is_buy, entry_price);
    if (sl_candidate > 0) {
        ArrayResize(candidates, count + 1);
        candidates[count] = sl_candidate;
        count++;
    }

    if (count == 0)
    {
        Log("Ø®Ø·Ø§: Ù‡ÛŒÚ† Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.");
        return 0.0;
    }

    // --- Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§Ù‡Ø§ ---
    double valid_candidates[];
    int valid_count = 0;
    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double spread = (double)SymbolInfoInteger(m_symbol, SYMBOL_SPREAD) * point;
    double min_safe_distance = spread + buffer; 

    for (int i = 0; i < count; i++)
    {
        double current_sl = candidates[i];
        
        if ((is_buy && current_sl >= entry_price) || (!is_buy && current_sl <= entry_price))
        {
            continue; 
        }

        if (MathAbs(entry_price - current_sl) < min_safe_distance)
        {
            current_sl = is_buy ? entry_price - min_safe_distance : entry_price + min_safe_distance;
            Log("Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡ " + (string)(i+1) + " Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ù†Ø²Ø¯ÛŒÚ©ÛŒ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¨Ù‡ Ù‚ÛŒÙ…Øª " + DoubleToString(current_sl, _Digits) + " Ø§ØµÙ„Ø§Ø­ Ø´Ø¯.");
        }

        ArrayResize(valid_candidates, valid_count + 1);
        valid_candidates[valid_count] = current_sl;
        valid_count++;
    }

    if (valid_count == 0)
    {
        Log("Ø®Ø·Ø§: Ù¾Ø³ Ø§Ø² ÙÛŒÙ„ØªØ±ÛŒÙ†Ú¯ØŒ Ù‡ÛŒÚ† Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¨Ø§Ù‚ÛŒ Ù†Ù…Ø§Ù†Ø¯.");
        return 0.0;
    }
    
    // --- Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ù…Ø¹ØªØ¨Ø± ---
    double best_sl_price = 0.0;
    double smallest_distance = DBL_MAX;

    for (int i = 0; i < valid_count; i++)
    {
        double distance = MathAbs(entry_price - valid_candidates[i]);
        if (distance < smallest_distance)
        {
            smallest_distance = distance;
            best_sl_price = valid_candidates[i];
        }
    }

    Log("âœ… Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¨Ù‡ÛŒÙ†Ù‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯: " + DoubleToString(best_sl_price, _Digits) + ". ÙØ§ØµÙ„Ù‡: " + DoubleToString(smallest_distance / point, 1) + " Ù¾ÙˆÛŒÙ†Øª.");

    return best_sl_price;
}

//---+//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù†Ø·Ù‚ Ø±Ù†Ú¯ Ù…Ø®Ø§Ù„Ù)   |
//+------------------------------------------------------------------+
double CStrategyManager::FindBackupStopLoss(bool is_buy, double buffer)
{
    // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ… Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒÙ….
    int bars_to_check = m_settings.sl_lookback_period;
    
    // Ø§Ú¯Ø± ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ú†Ø§Ø±Øª Ú©Ø§ÙÛŒ Ù†ÛŒØ³ØªØŒ Ø§Ø² ØªØ§Ø¨Ø¹ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ….
    if (iBars(m_symbol, m_settings.ichimoku_timeframe) < bars_to_check + 1) return 0;
    
    // ÛŒÚ© Ø­Ù„Ù‚Ù‡ 'for' Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… Ú©Ù‡ Ø§Ø² Ú©Ù†Ø¯Ù„ Ø´Ù…Ø§Ø±Ù‡ Û± (Ú©Ù†Ø¯Ù„ Ù‚Ø¨Ù„ÛŒ) Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø­Ø±Ú©Øª Ø¨Ù‡ Ø¹Ù‚Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    for (int i = 1; i <= bars_to_check; i++)
    {
        // Ø±Ù†Ú¯ Ú©Ù†Ø¯Ù„ÛŒ Ú©Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ù† Ù‡Ø³ØªÛŒÙ… Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
        bool is_candle_bullish = (iClose(m_symbol, m_settings.ichimoku_timeframe, i) > iOpen(m_symbol, m_settings.ichimoku_timeframe, i));
        bool is_candle_bearish = (iClose(m_symbol, m_settings.ichimoku_timeframe, i) < iOpen(m_symbol, m_settings.ichimoku_timeframe, i));

        // Ø§Ú¯Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø§ Ø§Ø² Ù†ÙˆØ¹ "Ø®Ø±ÛŒØ¯" (Buy) Ø¨Ø§Ø´Ø¯...
        if (is_buy)
        {
            // ...Ù¾Ø³ Ù…Ø§ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ† Ú©Ù†Ø¯Ù„ Ø¨Ø§ Ø±Ù†Ú¯ Ù…Ø®Ø§Ù„ÙØŒ ÛŒØ¹Ù†ÛŒ Ú©Ù†Ø¯Ù„ "Ù†Ø²ÙˆÙ„ÛŒ" (Bearish) Ù‡Ø³ØªÛŒÙ….
            if (is_candle_bearish)
            {
                // Ø¨Ù‡ Ù…Ø­Ø¶ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ú©Ù†Ø¯Ù„ Ù†Ø²ÙˆÙ„ÛŒØŒ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø±Ø§ Ú†Ù†Ø¯ Ù¾ÙˆÛŒÙ†Øª Ø²ÛŒØ± Ú©ÙÙ (Low) Ù‡Ù…Ø§Ù† Ú©Ù†Ø¯Ù„ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
                double sl_price = iLow(m_symbol, m_settings.ichimoku_timeframe, i) - buffer;
                Log("Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø³Ø§Ø¯Ù‡: Ø§ÙˆÙ„ÛŒÙ† Ú©Ù†Ø¯Ù„ Ù†Ø²ÙˆÙ„ÛŒ Ø¯Ø± Ø´ÛŒÙØª " + (string)i + " Ù¾ÛŒØ¯Ø§ Ø´Ø¯.");
                
                // Ù‚ÛŒÙ…Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ… Ùˆ Ú©Ø§Ø± ØªØ§Ø¨Ø¹ ØªÙ…Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                return sl_price;
            }
        }
        // Ø§Ú¯Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø§ Ø§Ø² Ù†ÙˆØ¹ "ÙØ±ÙˆØ´" (Sell) Ø¨Ø§Ø´Ø¯...
        else // is_sell
        {
            // ...Ù¾Ø³ Ù…Ø§ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ† Ú©Ù†Ø¯Ù„ Ø¨Ø§ Ø±Ù†Ú¯ Ù…Ø®Ø§Ù„ÙØŒ ÛŒØ¹Ù†ÛŒ Ú©Ù†Ø¯Ù„ "ØµØ¹ÙˆØ¯ÛŒ" (Bullish) Ù‡Ø³ØªÛŒÙ….
            if (is_candle_bullish)
            {
                // Ø¨Ù‡ Ù…Ø­Ø¶ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ú©Ù†Ø¯Ù„ ØµØ¹ÙˆØ¯ÛŒØŒ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø±Ø§ Ú†Ù†Ø¯ Ù¾ÙˆÛŒÙ†Øª Ø¨Ø§Ù„Ø§ÛŒ Ø³Ù‚ÙÙ (High) Ù‡Ù…Ø§Ù† Ú©Ù†Ø¯Ù„ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
                double sl_price = iHigh(m_symbol, m_settings.ichimoku_timeframe, i) + buffer;
                Log("Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø³Ø§Ø¯Ù‡: Ø§ÙˆÙ„ÛŒÙ† Ú©Ù†Ø¯Ù„ ØµØ¹ÙˆØ¯ÛŒ Ø¯Ø± Ø´ÛŒÙØª " + (string)i + " Ù¾ÛŒØ¯Ø§ Ø´Ø¯.");
                
                // Ù‚ÛŒÙ…Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ… Ùˆ Ú©Ø§Ø± ØªØ§Ø¨Ø¹ ØªÙ…Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                return sl_price;
            }
        }
    }
    
    // --- Ø¨Ø®Ø´ Ù¾Ø´ØªÛŒØ¨Ø§Ù†Ù Ù¾Ø´ØªÛŒØ¨Ø§Ù† ---
    // Ø§Ú¯Ø± Ø­Ù„Ù‚Ù‡ 'for' ØªÙ…Ø§Ù… Ø´ÙˆØ¯ Ùˆ Ú©Ø¯ Ø¨Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø±Ø³Ø¯ØŒ ÛŒØ¹Ù†ÛŒ Ø¯Ø± Ú©Ù„ Ø¨Ø§Ø²Ù‡ Ù…ÙˆØ±Ø¯ Ø¨Ø±Ø±Ø³ÛŒØŒ Ù‡ÛŒÚ† Ú©Ù†Ø¯Ù„ Ø±Ù†Ú¯ Ù…Ø®Ø§Ù„ÙÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
    // (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø± ÛŒÚ© Ø±ÙˆÙ†Ø¯ Ø®ÛŒÙ„ÛŒ Ù‚ÙˆÛŒ Ú©Ù‡ Ù‡Ù…Ù‡ Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ ÛŒÚ© Ø±Ù†Ú¯ Ù‡Ø³ØªÙ†Ø¯)
    // Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„Øª Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒØŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ù†Ù…Ø§Ù†ÛŒÙ…ØŒ Ø§Ø² Ø±ÙˆØ´ Ù‚Ø¯ÛŒÙ…ÛŒ (Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ†/Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
    Log("Ù‡ÛŒÚ† Ú©Ù†Ø¯Ù„ Ø±Ù†Ú¯ Ù…Ø®Ø§Ù„ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ø³Ø§Ø¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø§Ø² Ø±ÙˆØ´ Ø³Ù‚Ù/Ú©Ù Ù…Ø·Ù„Ù‚ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
    
    // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù‚Ù Ùˆ Ú©Ù Ú©Ù†Ø¯Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
    CopyHigh(m_symbol, m_settings.ichimoku_timeframe, 1, bars_to_check, m_high_buffer);
    CopyLow(m_symbol, m_settings.ichimoku_timeframe, 1, bars_to_check, m_low_buffer);

    if(is_buy)
    {
       // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Ú©Ù†Ø¯Ù„ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù‡ Ùˆ Ù‚ÛŒÙ…Øª Low Ø¢Ù† Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ….
       int min_index = ArrayMinimum(m_low_buffer, 0, bars_to_check);
       return m_low_buffer[min_index] - buffer;
    }
    else
    {
       // Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ØŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ú©Ù†Ø¯Ù„ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù‡ Ùˆ Ù‚ÛŒÙ…Øª High Ø¢Ù† Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ….
       int max_index = ArrayMaximum(m_high_buffer, 0, bars_to_check);
       return m_high_buffer[max_index] + buffer;
    }
}

//+------------------------------------------------------------------+
//| ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¯ÛŒÚ¯Ø±                                                  |
//+------------------------------------------------------------------+
void CStrategyManager::Log(string message)
{
    if (m_settings.enable_logging)
    {
        Print(m_symbol, ": ", message);
    }
}

int CStrategyManager::CountSymbolTrades()
{
    int count = 0;
    for(int i = PositionsTotal() - 1; i >= 0; i--)
    {
        if(PositionGetSymbol(i) == m_symbol && PositionGetInteger(POSITION_MAGIC) == (long)m_settings.magic_number)
        {
            count++;
        }
    }
    return count;
}

int CStrategyManager::CountTotalTrades()
{
    int count = 0;
    for(int i = PositionsTotal() - 1; i >= 0; i--)
    {
        if(PositionGetInteger(POSITION_MAGIC) == (long)m_settings.magic_number)
        {
            count++;
        }
    }
    return count;
}

//+------------------------------------------------------------------+
//| Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ (Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ùˆ Ø¯Ù‚ÛŒÙ‚)                |
//+------------------------------------------------------------------+
void CStrategyManager::OpenTrade(bool is_buy)
{
    if(CountTotalTrades() >= m_settings.max_total_trades || CountSymbolTrades() >= m_settings.max_trades_per_symbol)
    {
        Log("Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø­Ø¯ Ù…Ø¬Ø§Ø² Ù…Ø¹Ø§Ù…Ù„Ø§Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ù†Ø´Ø¯.");
        return;
    }

    double entry_price = is_buy ? SymbolInfoDouble(m_symbol, SYMBOL_ASK) : SymbolInfoDouble(m_symbol, SYMBOL_BID);
    double sl = CalculateStopLoss(is_buy, entry_price);

    if(sl == 0)
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯.");
        return;
    }
    
    // âœ…âœ…âœ… Ø¨Ø®Ø´ Ú©Ù„ÛŒØ¯ÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ âœ…âœ…âœ…

    // --- Ú¯Ø§Ù… Û±: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ³Ú© Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ù‡ Ù¾ÙˆÙ„ Ø­Ø³Ø§Ø¨ ---
    double balance = AccountInfoDouble(ACCOUNT_BALANCE);
    double risk_amount = balance * (m_settings.risk_percent_per_trade / 100.0);

    // --- Ú¯Ø§Ù… Û²: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ²Ø§Ù† Ø¶Ø±Ø± Ø¨Ø±Ø§ÛŒ Û± Ù„Ø§Øª Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§ Ø§ÛŒÙ† Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ ---
    double loss_for_one_lot = 0;
    string base_currency = AccountInfoString(ACCOUNT_CURRENCY);
    // Ø§Ø² ØªØ§Ø¨Ø¹ ØªØ®ØµØµÛŒ Ù…ØªØ§ØªØ±ÛŒØ¯Ø± Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    if(!OrderCalcProfit(is_buy ? ORDER_TYPE_BUY : ORDER_TYPE_SELL, m_symbol, 1.0, entry_price, sl, loss_for_one_lot))
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø¨Ø§ OrderCalcProfit. Ú©Ø¯ Ø®Ø·Ø§: " + (string)GetLastError());
        return;
    }
    loss_for_one_lot = MathAbs(loss_for_one_lot);

    if(loss_for_one_lot <= 0)
    {
        Log("Ù…ÛŒØ²Ø§Ù† Ø¶Ø±Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Û± Ù„Ø§Øª Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯.");
        return;
    }

    // --- Ú¯Ø§Ù… Û³: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¬Ù… Ø¯Ù‚ÛŒÙ‚ Ù„Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒØ³Ú© Ùˆ Ù…ÛŒØ²Ø§Ù† Ø¶Ø±Ø± Û± Ù„Ø§Øª ---
    double lot_size = NormalizeDouble(risk_amount / loss_for_one_lot, 2);

    // --- Ú¯Ø§Ù… Û´: Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ú¯Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù„Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø±ÙˆÚ©Ø± ---
    double min_lot = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_MIN);
    double max_lot = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_MAX);
    double lot_step = SymbolInfoDouble(m_symbol, SYMBOL_VOLUME_STEP);
    
    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ù„Ø§Øª Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¬Ø§Ø² Ø§Ø³Øª
    lot_size = MathMax(min_lot, MathMin(max_lot, lot_size));
    
    // Ú¯Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù„Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ú¯Ø§Ù… Ù…Ø¬Ø§Ø² Ø¨Ø±ÙˆÚ©Ø±
    lot_size = MathRound(lot_size / lot_step) * lot_step;

    if(lot_size < min_lot)
    {
        Log("Ø­Ø¬Ù… Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ (" + DoubleToString(lot_size,2) + ") Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯Ø§Ù‚Ù„ Ù„Ø§Øª Ù…Ø¬Ø§Ø² (" + DoubleToString(min_lot,2) + ") Ø§Ø³Øª. Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø¨Ø§Ø² Ù†Ø´Ø¯.");
        return;
    }

    // --- Ú¯Ø§Ù… Ûµ: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯ Ø³ÙˆØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ù‡ ---
    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double sl_distance_points = MathAbs(entry_price - sl) / point;
    double tp_distance_points = sl_distance_points * m_settings.take_profit_ratio;
    double tp = is_buy ? entry_price + tp_distance_points * point : entry_price - tp_distance_points * point;
    
    int digits = (int)SymbolInfoInteger(m_symbol, SYMBOL_DIGITS);
    sl = NormalizeDouble(sl, digits);
    tp = NormalizeDouble(tp, digits);
    
    string comment = "Memento " + (is_buy ? "Buy" : "Sell");
    MqlTradeResult result;
    
    if(is_buy)
    {
        m_trade.Buy(lot_size, m_symbol, 0, sl, tp, comment);
    }
    else
    {
        m_trade.Sell(lot_size, m_symbol, 0, sl, tp, comment);
    }
    
    // Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ù†ØªÛŒØ¬Ù‡
    if(m_trade.ResultRetcode() == TRADE_RETCODE_DONE)
    {
        Log("Ù…Ø¹Ø§Ù…Ù„Ù‡ " + comment + " Ø¨Ø§ Ù„Ø§Øª " + DoubleToString(lot_size, 2) + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø² Ø´Ø¯.");
    }
    else
    {
        Log("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ " + comment + ": " + (string)m_trade.ResultRetcode() + " - " + m_trade.ResultComment());
    }
}


//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø·Ø­ Ú©ÛŒØ¬ÙˆÙ† Ø³Ù† ÙÙ„Øª (ØµØ§Ù)                                  |
//+------------------------------------------------------------------+
double CStrategyManager::FindFlatKijun()
{
    double kijun_values[];
    if (CopyBuffer(m_ichimoku_handle, 1, 1, m_settings.flat_kijun_period, kijun_values) < m_settings.flat_kijun_period)
        return 0.0;

    ArraySetAsSeries(kijun_values, true);

    int flat_count = 1;
    for (int i = 1; i < m_settings.flat_kijun_period; i++)
    {
        if (kijun_values[i] == kijun_values[i - 1])
        {
            flat_count++;
            if (flat_count >= m_settings.flat_kijun_min_length)
            {
                return kijun_values[i]; // Ø³Ø·Ø­ ÙÙ„Øª Ù¾ÛŒØ¯Ø§ Ø´Ø¯
            }
        }
        else
        {
            flat_count = 1; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
        }
    }

    return 0.0; // Ù‡ÛŒÚ† Ø³Ø·Ø­ ÙÙ„ØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
}

//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾ÛŒÙˆØª (Ù†Ù‚Ø·Ù‡ Ú†Ø±Ø®Ø´) Ø±ÙˆÛŒ Ú©ÛŒØ¬ÙˆÙ† Ø³Ù†                          |
//+------------------------------------------------------------------+
double CStrategyManager::FindPivotKijun(bool is_buy)
{
    double kijun_values[];
    if (CopyBuffer(m_ichimoku_handle, 1, 1, m_settings.pivot_lookback, kijun_values) < m_settings.pivot_lookback)
        return 0.0;

    ArraySetAsSeries(kijun_values, true);

    for (int i = 1; i < m_settings.pivot_lookback - 1; i++)
    {
        // Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø®Ø±ÛŒØ¯ØŒ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ø¯Ø±Ù‡ (Ù¾ÛŒÙˆØª Ú©Ù) Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (is_buy && kijun_values[i] < kijun_values[i - 1] && kijun_values[i] < kijun_values[i + 1])
        {
            return kijun_values[i];
        }
        // Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ ÙØ±ÙˆØ´ØŒ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ù‚Ù„Ù‡ (Ù¾ÛŒÙˆØª Ø³Ù‚Ù) Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (!is_buy && kijun_values[i] > kijun_values[i - 1] && kijun_values[i] > kijun_values[i + 1])
        {
            return kijun_values[i];
        }
    }

    return 0.0; // Ù‡ÛŒÚ† Ù¾ÛŒÙˆØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
}

//+------------------------------------------------------------------+
//| Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾ÛŒÙˆØª (Ù†Ù‚Ø·Ù‡ Ú†Ø±Ø®Ø´) Ø±ÙˆÛŒ ØªÙ†Ú©Ø§Ù† Ø³Ù†                          |
//+------------------------------------------------------------------+
double CStrategyManager::FindPivotTenkan(bool is_buy)
{
    double tenkan_values[];
    if (CopyBuffer(m_ichimoku_handle, 0, 1, m_settings.pivot_lookback, tenkan_values) < m_settings.pivot_lookback)
        return 0.0;

    ArraySetAsSeries(tenkan_values, true);

    for (int i = 1; i < m_settings.pivot_lookback - 1; i++)
    {
        // Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø®Ø±ÛŒØ¯ØŒ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ø¯Ø±Ù‡ (Ù¾ÛŒÙˆØª Ú©Ù) Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (is_buy && tenkan_values[i] < tenkan_values[i - 1] && tenkan_values[i] < tenkan_values[i + 1])
        {
            return tenkan_values[i];
        }
        // Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡ ÙØ±ÙˆØ´ØŒ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ù‚Ù„Ù‡ (Ù¾ÛŒÙˆØª Ø³Ù‚Ù) Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (!is_buy && tenkan_values[i] > tenkan_values[i - 1] && tenkan_values[i] > tenkan_values[i + 1])
        {
            return tenkan_values[i];
        }
    }

    return 0.0; // Ù‡ÛŒÚ† Ù¾ÛŒÙˆØªÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
}

////+------------------------------------------------------------------+
//| (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´Ø¯) Ù…Ø¯ÛŒØ± Ú©Ù„ Ú¯Ø±ÙØªÙ† Ø­Ø¯ Ù…Ø¬Ø§Ø² ØªÙ„Ø§Ù‚ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ      |
//+------------------------------------------------------------------+
double CStrategyManager::GetTalaqiTolerance(int reference_shift)
{
    switch(m_settings.talaqi_calculation_mode)
    {
        case TALAQI_MODE_MANUAL:
            return m_settings.talaqi_distance_in_points * SymbolInfoDouble(m_symbol, SYMBOL_POINT);
        
        case TALAQI_MODE_KUMO:
            return CalculateDynamicTolerance(reference_shift); // Ø±ÙˆØ´ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ú©ÙˆÙ…Ùˆ
        
        case TALAQI_MODE_ATR:
            return CalculateAtrTolerance(reference_shift);     // Ø±ÙˆØ´ Ø¬Ø¯ÛŒØ¯ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± ATR
            
        default:
            return 0.0;
    }
}


//+------------------------------------------------------------------+
//| (Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯ Ù…Ø¬Ø§Ø² ØªÙ„Ø§Ù‚ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¶Ø®Ø§Ù…Øª Ø§Ø¨Ø± Ú©ÙˆÙ…Ùˆ            |
//|                  (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ù‡ÙˆØ´Ù…Ù†Ø¯)                           |
//+------------------------------------------------------------------+
double CStrategyManager::CalculateDynamicTolerance(int reference_shift)
{
    // Ø§Ú¯Ø± Ø¶Ø±ÛŒØ¨ Ú©ÙˆÙ…Ùˆ ØµÙØ± ÛŒØ§ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ù‡ØŒ ÛŒØ¹Ù†ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ´ ØºÛŒØ±ÙØ¹Ø§Ù„Ù‡
    if(m_settings.talaqi_kumo_factor <= 0) return 0.0;

    // Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø³Ù†Ú©Ùˆ Ø§Ø³Ù¾Ù† A Ùˆ B Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡
    double senkou_a_buffer[], senkou_b_buffer[];

    // Ø§Ø² Ù…ØªØ§ØªØ±ÛŒØ¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒÙ… Ú©Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø³Ù†Ú©Ùˆ A Ùˆ B Ø±Ùˆ Ø¯Ø± "Ù†Ù‚Ø·Ù‡ X" ØªØ§Ø±ÛŒØ®ÛŒ Ø¨Ù‡ Ù…Ø§ Ø¨Ø¯Ù‡
    // Ø¨Ø§ÙØ± 2 = Senkou Span A
    // Ø¨Ø§ÙØ± 3 = Senkou Span B
    if(CopyBuffer(m_ichimoku_handle, 2, reference_shift, 1, senkou_a_buffer) < 1 || 
       CopyBuffer(m_ichimoku_handle, 3, reference_shift, 1, senkou_b_buffer) < 1)
    {
       Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
       return 0.0; // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ù‚Ø¯Ø§Ø± ØµÙØ± Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÙˆÙ†ÛŒÙ… ØªØ§ ØªÙ„Ø§Ù‚ÛŒ Ú†Ú© Ù†Ø´Ù‡
    }

    // Ú¯Ø§Ù… Û±: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ Ø¯Ø± "Ù†Ù‚Ø·Ù‡ X"
    double kumo_thickness = MathAbs(senkou_a_buffer[0] - senkou_b_buffer[0]);

    // Ø§Ú¯Ø± Ø¶Ø®Ø§Ù…Øª Ú©ÙˆÙ…Ùˆ ØµÙØ± Ø¨ÙˆØ¯ (Ù…Ø«Ù„Ø§ Ø¯Ø± Ú©Ø±Ø§Ø³ Ø³Ù†Ú©ÙˆÙ‡Ø§)ØŒ ÛŒÙ‡ Ù…Ù‚Ø¯Ø§Ø± Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†ÛŒÚ© Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†
    if(kumo_thickness == 0) return SymbolInfoDouble(m_symbol, SYMBOL_POINT);

    // Ú¯Ø§Ù… Û²: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯ Ù…Ø¬Ø§Ø² ØªÙ„Ø§Ù‚ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¶Ø±ÛŒØ¨ ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
    double tolerance = kumo_thickness * m_settings.talaqi_kumo_factor;

    return tolerance;
}


//+------------------------------------------------------------------+
//| (Ø­Ø§Ù„Øª Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ) Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù„ÛŒØ³Øª Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§            |
//+------------------------------------------------------------------+
void CStrategyManager::AddOrUpdatePotentialSignal(bool is_buy)
{
    // ÙˆØ¸ÛŒÙÙ‡: Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù‡Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯ÛŒ Ú©Ù‡ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ù„ÛŒØ³Øª Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    
    // Ú¯Ø§Ù… Ø§ÙˆÙ„: ÛŒÚ© Ù†Ø§Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    int total = ArraySize(m_potential_signals);
    ArrayResize(m_potential_signals, total + 1);
    
    // Ú¯Ø§Ù… Ø¯ÙˆÙ…: Ù…Ø´Ø®ØµØ§Øª Ù†Ø§Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ú©Ù†
    m_potential_signals[total].time = iTime(m_symbol, m_settings.ichimoku_timeframe, m_settings.chikou_period);
    m_potential_signals[total].is_buy = is_buy;
    m_potential_signals[total].grace_candle_count = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù…Ù‡Ù„Øª Ø§Ø² ØµÙØ± Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    
    // Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ø§ÙØ²ÙˆØ¯Ù† Ù†Ø§Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ù‡
    Log("[Ø­Ø§Ù„Øª Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ] Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù†Ø§Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ " + (is_buy ? "Ø®Ø±ÛŒØ¯" : "ÙØ±ÙˆØ´") + " Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù†Ø§Ù…Ø²Ø¯Ù‡Ø§: " + (string)ArraySize(m_potential_signals));
    
    // ÛŒÚ© Ù…Ø³ØªØ·ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ÙˆÙ„ÛŒÙ‡ Ø±ÙˆÛŒ Ú†Ø§Ø±Øª Ø±Ø³Ù… Ú©Ù†
    if(m_symbol == _Symbol && m_visual_manager != NULL)
    m_visual_manager.DrawTripleCrossRectangle(is_buy, m_settings.chikou_period);

}

//+------------------------------------------------------------------+
//| (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø¶Ø¯ Ø¶Ø±Ø¨Ù‡) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯ Ù…Ø¬Ø§Ø² ØªÙ„Ø§Ù‚ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ATR
//+------------------------------------------------------------------+
double CStrategyManager::CalculateAtrTolerance(int reference_shift)
{
    if(m_settings.talaqi_atr_multiplier <= 0) return 0.0;
    
    // âœ…âœ…âœ… Ø¨Ø§Ø¯ÛŒÚ¯ARD Ø´Ù…Ø§Ø±Ù‡ Û³: Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ù‡Ù†Ø¯Ù„ âœ…âœ…âœ…
    if (m_atr_handle == INVALID_HANDLE)
    {
        Log("Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„ÙˆØ±Ø§Ù†Ø³ ATR Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª Ú†ÙˆÙ† Ù‡Ù†Ø¯Ù„ Ø¢Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù¾Ø±ÛŒÙˆØ¯ ATR Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
        return 0.0; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ù…Ù†
    }

    double atr_buffer[];
    if(CopyBuffer(m_atr_handle, 0, reference_shift, 1, atr_buffer) < 1)
    {
        Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ATR Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
        return 0.0;
    }
    
    double tolerance = atr_buffer[0] * m_settings.talaqi_atr_multiplier;
    return tolerance;
}


//+------------------------------------------------------------------+
//| (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø¶Ø¯ Ø¶Ø±Ø¨Ù‡) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯ Ø¶Ø±Ø± ATR 
//+------------------------------------------------------------------+
double CStrategyManager::CalculateAtrStopLoss(bool is_buy, double entry_price)
{
    // Ø§Ú¯Ø± Ø­Ø§Ù„Øª Ù¾ÙˆÛŒØ§ÛŒ SL (Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù†) ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² Ù…Ù†Ø·Ù‚ Ø³Ø§Ø¯Ù‡ Ù‚Ø¨Ù„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    if (!m_settings.enable_sl_vol_regime)
    {
        // âœ…âœ…âœ… Ø¨Ø§Ø¯ÛŒÚ¯ARD Ø´Ù…Ø§Ø±Ù‡ Û±: Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ù‡Ù†Ø¯Ù„ âœ…âœ…âœ…
        if (m_atr_handle == INVALID_HANDLE)
        {
            Log("Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± CalculateAtrStopLoss: Ù‡Ù†Ø¯Ù„ ATR Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª! Ù¾Ø±ÛŒÙˆØ¯ ATR Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
            return 0.0; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø§Ø² Ø´Ø¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡
        }
        
        double atr_buffer[];
        if(CopyBuffer(m_atr_handle, 0, 1, 1, atr_buffer) < 1)
        {
            Log("Ø¯Ø§Ø¯Ù‡ ATR Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¯ Ø¶Ø±Ø± Ø³Ø§Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª. (ØªØ§Ø¨Ø¹ CopyBuffer Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯)");
            return 0.0;
        }
        
        double atr_value = atr_buffer[0];
        return is_buy ? entry_price - (atr_value * m_settings.sl_atr_multiplier) : entry_price + (atr_value * m_settings.sl_atr_multiplier);
    }

    // --- Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯: SL Ù¾ÙˆÛŒØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù† (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù‡Ù†Ø¯Ù„ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø§Ø±Ø¯ Ùˆ Ø§ÛŒÙ…Ù† Ø§Ø³Øª) ---
    int history_size = m_settings.sl_vol_regime_ema_period + 5;
    double atr_values[], ema_values[];

    int atr_sl_handle = iATR(m_symbol, m_settings.ichimoku_timeframe, m_settings.sl_vol_regime_atr_period);
    if (atr_sl_handle == INVALID_HANDLE || CopyBuffer(atr_sl_handle, 0, 0, history_size, atr_values) < history_size)
    {
        Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ SL Ù¾ÙˆÛŒØ§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.");
        if(atr_sl_handle != INVALID_HANDLE) 
            IndicatorRelease(atr_sl_handle);
        return 0.0;
    }
    
    IndicatorRelease(atr_sl_handle);
    ArraySetAsSeries(atr_values, true); 

    if(SimpleMAOnBuffer(history_size, 0, m_settings.sl_vol_regime_ema_period, MODE_EMA, atr_values, ema_values) < 1)
    {
         Log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ EMA Ø±ÙˆÛŒ ATR.");
         return 0.0;
    }

    double current_atr = atr_values[1]; 
    double ema_atr = ema_values[1];     

    bool is_high_volatility = (current_atr > ema_atr);
    double final_multiplier = is_high_volatility ? m_settings.sl_high_vol_multiplier : m_settings.sl_low_vol_multiplier;

    Log("Ø±Ú˜ÛŒÙ… Ù†ÙˆØ³Ø§Ù†: " + (is_high_volatility ? "Ø¨Ø§Ù„Ø§" : "Ù¾Ø§ÛŒÛŒÙ†") + ". Ø¶Ø±ÛŒØ¨ SL Ù†Ù‡Ø§ÛŒÛŒ: " + (string)final_multiplier);

    return is_buy ? entry_price - (current_atr * final_multiplier) : entry_price + (current_atr * final_multiplier);
}

//==================================================================
//  ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ "Ú¯ÛŒØª Ú©Ù†ØªØ±Ù„ Ù†Ù‡Ø§ÛŒÛŒ" Ú©Ù‡ ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø±Ø§ Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Ù†Ø³Ø®Ù‡ Ø¢Ù¾Ú¯Ø±ÛŒØ¯ Ø´Ø¯Ù‡)
//==================================================================
bool CStrategyManager::AreAllFiltersPassed(bool is_buy)
{
    // Ø§Ú¯Ø± ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯ØŒ Ú†Ú©Ø´ Ú©Ù†
    if (m_settings.enable_kumo_filter)
    {
        if (!CheckKumoFilter(is_buy))
        {
            Log("ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ Ø±Ø¯ Ø´Ø¯.");
            return false; // Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† ÙÛŒÙ„ØªØ±ÛŒ Ú©Ù‡ Ø±Ø¯ Ø¨Ø´Ù‡ØŒ Ø³Ø±ÛŒØ¹ Ø®Ø§Ø±Ø¬ Ù…ÛŒØ´ÛŒÙ…
        }
    }

    // Ø§Ú¯Ø± ÙÛŒÙ„ØªØ± ATR ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯ØŒ Ú†Ú©Ø´ Ú©Ù†
    if (m_settings.enable_atr_filter)
    {
        if (!CheckAtrFilter())
        {
            Log("ÙÛŒÙ„ØªØ± ATR Ø±Ø¯ Ø´Ø¯.");
            return false;
        }
    }
    
    // +++ NEW: Ø§Ú¯Ø± ÙÛŒÙ„ØªØ± ADX ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯ØŒ Ú†Ú©Ø´ Ú©Ù† +++
    if (m_settings.enable_adx_filter)
    {
        if (!CheckAdxFilter(is_buy))
        {
            Log("ÙÛŒÙ„ØªØ± ADX Ø±Ø¯ Ø´Ø¯.");
            return false;
        }
    }
    
    // Ø§Ú¯Ù‡ Ú©Ø¯ Ø¨Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø±Ø³Ù‡ØŒ ÛŒØ¹Ù†ÛŒ Ù‡Ù…Ù‡ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ø³ Ø´Ø¯Ù†
    Log("âœ… ØªÙ…Ø§Ù… ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ø³ Ø´Ø¯Ù†Ø¯.");
    return true;
}


//==================================================================
//  ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„ØªØ± Ø§Ø¨Ø± Ú©ÙˆÙ…Ùˆ
//==================================================================
bool CStrategyManager::CheckKumoFilter(bool is_buy)
{
    double senkou_a[], senkou_b[];
    // Ú¯Ø±ÙØªÙ† Ù…Ù‚Ø¯Ø§Ø± Ø³Ù†Ú©Ùˆ A Ùˆ B Ø¨Ø±Ø§ÛŒ Ú©Ù†Ø¯Ù„ ÙØ¹Ù„ÛŒ (Ø´ÛŒÙØª Û°)
    // Ø¨Ø§ÙØ± 2 = Senkou Span A , Ø¨Ø§ÙØ± 3 = Senkou Span B
    if(CopyBuffer(m_ichimoku_handle, 2, 0, 1, senkou_a) < 1 || 
       CopyBuffer(m_ichimoku_handle, 3, 0, 1, senkou_b) < 1)
    {
       Log("Ø®Ø·Ø§: Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ú©ÙˆÙ…Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.");
       return false; // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¨Ø§Ø´Ù‡ØŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø±Ø¯ Ú©Ù†
    }
    
    double high_kumo = MathMax(senkou_a[0], senkou_b[0]);
    double low_kumo = MathMin(senkou_a[0], senkou_b[0]);
    double close_price = iClose(m_symbol, m_settings.ichimoku_timeframe, 1); // Ù‚ÛŒÙ…Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ú©Ù†Ø¯Ù„ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡

    if (is_buy)
    {
        // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ØŒ Ù‚ÛŒÙ…Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù„Ø§ÛŒ Ø§Ø¨Ø± Ø¨Ø§Ø´Ù‡
        return (close_price > high_kumo);
    }
    else // is_sell
    {
        // Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ØŒ Ù‚ÛŒÙ…Øª Ø¨Ø§ÛŒØ¯ Ù¾Ø§ÛŒÛŒÙ† Ø§Ø¨Ø± Ø¨Ø§Ø´Ù‡
        return (close_price < low_kumo);
    }
}

//==================================================================
//  (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø¶Ø¯ Ø¶Ø±Ø¨Ù‡) ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„ØªØ± ATR
//==================================================================
bool CStrategyManager::CheckAtrFilter()
{
    // âœ…âœ…âœ… Ø¨Ø§Ø¯ÛŒÚ¯ARD Ø´Ù…Ø§Ø±Ù‡ Û²: Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ù‡Ù†Ø¯Ù„ âœ…âœ…âœ…
    if (m_atr_handle == INVALID_HANDLE)
    {
        Log("ÙÛŒÙ„ØªØ± ATR Ø±Ø¯ Ø´Ø¯ Ú†ÙˆÙ† Ù‡Ù†Ø¯Ù„ Ø¢Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù¾Ø±ÛŒÙˆØ¯ ATR Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
        return false; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ù…Ù†ØŒ ÙÛŒÙ„ØªØ± Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    }
    
    double atr_value_buffer[];
    if(CopyBuffer(m_atr_handle, 0, 1, 1, atr_value_buffer) < 1)
    {
       Log("Ø®Ø·Ø§: Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± ATR Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.");
       return false;
    }
    
    double current_atr = atr_value_buffer[0];
    
    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double min_atr_threshold = m_settings.atr_filter_min_value_pips * point;
    
    if(_Digits == 3 || _Digits == 5)
    {
        min_atr_threshold *= 10;
    }

    return (current_atr >= min_atr_threshold);
}

//==================================================================
//  (Ø¬Ø¯ÛŒØ¯) ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ ÙÛŒÙ„ØªØ± Ù‚Ø¯Ø±Øª Ùˆ Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯ ADX
//==================================================================
bool CStrategyManager::CheckAdxFilter(bool is_buy) 
{  
    double adx_buffer[1], di_plus_buffer[1], di_minus_buffer[1];  
    
    // Ø§Ø² Ù‡Ù†Ø¯Ù„ Ø§Ø² Ù¾ÛŒØ´ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ú©Ù„Ø§Ø³ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø¨Ù‡ÛŒÙ†Ù‡)
    if (CopyBuffer(m_adx_handle, 0, 1, 1, adx_buffer) < 1 || 
        CopyBuffer(m_adx_handle, 1, 1, 1, di_plus_buffer) < 1 || 
        CopyBuffer(m_adx_handle, 2, 1, 1, di_minus_buffer) < 1)
    {
        Log("Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± ADX Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.");
        return false; // Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØªØŒ Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¨Ø§Ø´Ø¯ ÙÛŒÙ„ØªØ± Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    }
    
    // Ø´Ø±Ø· Û±: Ø¢ÛŒØ§ Ù‚Ø¯Ø±Øª Ø±ÙˆÙ†Ø¯ Ø§Ø² Ø­Ø¯ Ø¢Ø³ØªØ§Ù†Ù‡ Ù…Ø§ Ø¨ÛŒØ´ØªØ± Ø§Ø³ØªØŸ
    if (adx_buffer[0] <= m_settings.adx_threshold) 
    {
        return false;
    }
    
    // Ø´Ø±Ø· Û²: Ø¢ÛŒØ§ Ø¬Ù‡Øª Ø±ÙˆÙ†Ø¯ Ø¨Ø§ Ø¬Ù‡Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ù…Ø§ ÛŒÚ©ÛŒ Ø§Ø³ØªØŸ
    if (is_buy)
    {
        return (di_plus_buffer[0] > di_minus_buffer[0]); // Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ØŒ DI+ Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù„Ø§ÛŒ DI- Ø¨Ø§Ø´Ø¯
    }
    else // is_sell
    {
        return (di_minus_buffer[0] > di_plus_buffer[0]); // Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ØŒ DI- Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ù„Ø§ÛŒ DI+ Ø¨Ø§Ø´Ø¯
    }
}
//+------------------------------------------------------------------+
//| (Ø¬Ø¯ÛŒØ¯) ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³
//+------------------------------------------------------------------+
void CStrategyManager::CheckForEarlyExit()
{
    // Ø§Ø² Ø¢Ø®Ø± Ø¨Ù‡ Ø§ÙˆÙ„ Ø±ÙˆÛŒ Ù¾ÙˆØ²ÛŒØ´Ù† Ù‡Ø§ Ø­Ù„Ù‚Ù‡ Ù…ÛŒØ²Ù†ÛŒÙ… Ú†ÙˆÙ† Ù…Ù…Ú©Ù† Ø§Ø³Øª ÛŒÚ©ÛŒ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯
    for (int i = PositionsTotal() - 1; i >= 0; i--) 
    {
        ulong ticket = PositionGetTicket(i);
        // ÙÙ‚Ø· Ù¾ÙˆØ²ÛŒØ´Ù† Ù‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ø§Ú©Ø³Ù¾Ø±Øª Ùˆ Ù‡Ù…ÛŒÙ† Ù†Ù…Ø§Ø¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒÚ©Ù†ÛŒÙ…
        if (PositionGetString(POSITION_SYMBOL) == m_symbol && PositionGetInteger(POSITION_MAGIC) == (long)m_settings.magic_number)
        {
            if (PositionSelectByTicket(ticket))
            {
                bool is_buy = (PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_BUY);
                // Ø¢ÛŒØ§ Ø´Ø±Ø§ÛŒØ· Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ ÙØ±Ø§Ù‡Ù… Ø§Ø³ØªØŸ
                if (CheckChikouRsiExit(is_buy)) 
                { 
                    Log("ğŸš¨ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ø±Ø³ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + " ØµØ§Ø¯Ø± Ø´Ø¯. Ø¨Ø³ØªÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡...");
                    m_trade.PositionClose(ticket); 
                }
            }
        }
    }
}

//+------------------------------------------------------------------+
//| (Ø¬Ø¯ÛŒØ¯) ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ Ú†ÛŒÚ©Ùˆ + RSI
//+------------------------------------------------------------------+
bool CStrategyManager::CheckChikouRsiExit(bool is_buy)
{
    // Ú¯Ø±ÙØªÙ† Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø§Ø² Ú©Ù†Ø¯Ù„ ØªØ§ÛŒÛŒØ¯ (Ú©Ù†Ø¯Ù„ Ø´Ù…Ø§Ø±Ù‡ Û±)
    double chikou_price = iClose(m_symbol, m_settings.ichimoku_timeframe, 1);
    
    double tenkan_buffer[1], kijun_buffer[1], rsi_buffer[1];
    if(CopyBuffer(m_ichimoku_handle, 0, 1, 1, tenkan_buffer) < 1 ||
       CopyBuffer(m_ichimoku_handle, 1, 1, 1, kijun_buffer) < 1 ||
       CopyBuffer(m_rsi_exit_handle, 0, 1, 1, rsi_buffer) < 1)
    {
        return false; // Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù†Ø¨Ø§Ø´Ø¯ØŒ Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ø± Ú©Ø§Ø± Ù†ÛŒØ³Øª
    }
    
    double tenkan = tenkan_buffer[0];
    double kijun = kijun_buffer[0];
    double rsi = rsi_buffer[0];
    
    bool chikou_cross_confirms_exit = false;
    bool rsi_confirms_exit = false;

    if (is_buy) // Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø®Ø±ÛŒØ¯ØŒ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ Ù†Ø²ÙˆÙ„ÛŒ Ù‡Ø³ØªÛŒÙ…
    {
        // Ø´Ø±Ø· Û±: Ø¢ÛŒØ§ Ù‚ÛŒÙ…Øª (Ú†ÛŒÚ©Ùˆ) Ø¨Ù‡ Ø²ÛŒØ± Ø®Ø·ÙˆØ· ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ú©Ø±Ø§Ø³ Ú©Ø±Ø¯Ù‡ØŸ
        chikou_cross_confirms_exit = (chikou_price < MathMin(tenkan, kijun));
        // Ø´Ø±Ø· Û²: Ø¢ÛŒØ§ RSI Ù‡Ù… Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ù…ÙˆÙ…Ù†ØªÙˆÙ… ØµØ¹ÙˆØ¯ÛŒ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ù…ÛŒÚ©Ù†Ø¯ØŸ
        rsi_confirms_exit = (rsi < m_settings.early_exit_rsi_oversold);
    }
    else // Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ù…Ø¹Ø§Ù…Ù„Ù‡ ÙØ±ÙˆØ´ØŒ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ ØµØ¹ÙˆØ¯ÛŒ Ù‡Ø³ØªÛŒÙ…
    {
        // Ø´Ø±Ø· Û±: Ø¢ÛŒØ§ Ù‚ÛŒÙ…Øª (Ú†ÛŒÚ©Ùˆ) Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ Ø®Ø·ÙˆØ· ØªÙ†Ú©Ø§Ù† Ùˆ Ú©ÛŒØ¬ÙˆÙ† Ú©Ø±Ø§Ø³ Ú©Ø±Ø¯Ù‡ØŸ
        chikou_cross_confirms_exit = (chikou_price > MathMax(tenkan, kijun));
        // Ø´Ø±Ø· Û²: Ø¢ÛŒØ§ RSI Ù‡Ù… Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ† Ù…ÙˆÙ…Ù†ØªÙˆÙ… Ù†Ø²ÙˆÙ„ÛŒ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ù…ÛŒÚ©Ù†Ø¯ØŸ
        rsi_confirms_exit = (rsi > m_settings.early_exit_rsi_overbought);
    }
    
    // Ø§Ú¯Ø± Ù‡Ø± Ø¯Ùˆ Ø´Ø±Ø· Ø¨Ø±Ù‚Ø±Ø§Ø± Ø¨Ø§Ø´Ù†Ø¯ØŒ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÙˆØ¬ ØµØ§Ø¯Ø± Ù…ÛŒØ´ÙˆØ¯
    return (chikou_cross_confirms_exit && rsi_confirms_exit);
}


//+------------------------------------------------------------------+
//| (Ø¬Ø¯ÛŒØ¯) Ø¨Ø±Ø±Ø³ÛŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ†      |
//+------------------------------------------------------------------+
bool CStrategyManager::CheckLowerTfConfirmation(bool is_buy)
{
    // Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± Ø±Ø§ Ø±ÙˆÛŒ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ Ø§Ø¬Ø±Ø§ Ú©Ù†
    SMssSignal mss_signal = m_ltf_analyzer.ProcessNewBar();

    // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    if(mss_signal.type == MSS_NONE)
    {
        return false;
    }

    // Ø§Ú¯Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ØµÙ„ÛŒ Ù…Ø§ "Ø®Ø±ÛŒØ¯" Ø§Ø³Øª...
    if (is_buy)
    {
        // ...Ù…Ø§ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ø´Ú©Ø³Øª ØµØ¹ÙˆØ¯ÛŒ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø³ØªÛŒÙ…
        if (mss_signal.type == MSS_BREAK_HIGH || mss_signal.type == MSS_SHIFT_UP)
        {
            Log("âœ… ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ (CHoCH).");
            return true; // ØªØ§ÛŒÛŒØ¯ Ø´Ø¯!
        }
    }
    else // Ø§Ú¯Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ØµÙ„ÛŒ Ù…Ø§ "ÙØ±ÙˆØ´" Ø§Ø³Øª...
    {
        // ...Ù…Ø§ Ø¯Ù†Ø¨Ø§Ù„ ÛŒÚ© Ø´Ú©Ø³Øª Ù†Ø²ÙˆÙ„ÛŒ Ø¯Ø± ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† Ù‡Ø³ØªÛŒÙ…
        if (mss_signal.type == MSS_BREAK_LOW || mss_signal.type == MSS_SHIFT_DOWN)
        {
            Log("âœ… ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ (CHoCH).");
            return true; // ØªØ§ÛŒÛŒØ¯ Ø´Ø¯!
        }
    }

    // Ø§Ú¯Ø± Ø³ÛŒÚ¯Ù†Ø§Ù„ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù¾Ø§ÛŒÛŒÙ† Ø¯Ø± Ø¬Ù‡Øª Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø§ØµÙ„ÛŒ Ù…Ø§ Ù†Ø¨ÙˆØ¯ØŒ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    return false;
}

// Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ IchimokuLogic.mqh Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†

//+------------------------------------------------------------------+
//| (Ø¬Ø¯ÛŒØ¯) ØªØ§Ø¨Ø¹ ÙˆØ§Ú©Ø³Ù†: Ø¢ÛŒØ§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ§ÛŒÙ…â€ŒÙØ±ÛŒÙ…â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªØŸ       |
//+------------------------------------------------------------------+
bool CStrategyManager::IsDataReady()
{
    // Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ú©Ø³Ù¾Ø±Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†Ù‡
    ENUM_TIMEFRAMES timeframes_to_check[3];
    timeframes_to_check[0] = m_settings.ichimoku_timeframe; // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ø§ØµÙ„ÛŒ Ø§ÛŒÚ†ÛŒÙ…ÙˆÚ©Ùˆ
    timeframes_to_check[1] = m_settings.ltf_timeframe;      // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ø³Ø§Ø®ØªØ§Ø±
    timeframes_to_check[2] = PERIOD_CURRENT;                 // ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… Ú†Ø§Ø±Øª ÙØ¹Ù„ÛŒ

    // Ø­Ø¯Ø§Ù‚Ù„ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ù…Ø·Ù…Ø¦Ù†
    int required_bars = 200; 

    for(int i = 0; i < 3; i++)
    {
        ENUM_TIMEFRAMES tf = timeframes_to_check[i];
        
        // Ø§Ú¯Ø± ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯ Ù†ÛŒØ§Ø² Ø¨ÙˆØ¯ ÛŒØ§ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ Ù†Ø¨ÙˆØ¯
        if(iBars(m_symbol, tf) < required_bars || iTime(m_symbol, tf, 1) == 0)
        {
            // Log("Ø¯Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÙ… ÙØ±ÛŒÙ… " + EnumToString(tf) + " Ù‡Ù†ÙˆØ² Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª.");
            return false; // ÛŒØ¹Ù†ÛŒ Ø¯Ø§Ø¯Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³ØªØŒ Ù¾Ø³ Ø§Ø² ØªØ§Ø¨Ø¹ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
        }
    }
    
    // Ø§Ú¯Ø± Ø­Ù„Ù‚Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯ Ùˆ Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¨ÙˆØ¯ØŒ ÛŒØ¹Ù†ÛŒ Ù‡Ù…Ù‡ Ú†ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª
    return true; 
}


------------------------------------------------------------------------------------------------------------------------------
|                                                   ÙØ§ÛŒÙ„ Ø¯ÛŒÚ¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡                                                               |
|-------------------------------------------------------------------------------------------------------------------------------




//+------------------------------------------------------------------+
//|                                        MarketStructure.mqh       |
//|                 Â© 2025, Mohammad & Gemini                        |
//|          Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…Ø³ØªÙ‚Ù„ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø³Ù‚Ù/Ú©Ù Ùˆ Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø± Ø¨Ø§Ø²Ø§Ø±      |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, HipoAlgorithm"
#property link      "https://www.mql5.com"
#property version   "2.1" // Ø§ØµÙ„Ø§Ø­ Ø¨Ø§Ú¯ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯ Ù…Ù†Ø·Ù‚ Ø¢Ù¾Ø¯ÛŒØª Ø¢Ø±Ø§ÛŒÙ‡

#include <Object.mqh>

//+------------------------------------------------------------------+
//|   Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ (Inputs) - Ú©Ø§Ù…Ù„Ø§ Ù…Ø³ØªÙ‚Ù„ Ùˆ Plug & Play         |
//+------------------------------------------------------------------+
input group "---=== ğŸ›ï¸ Market Structure Library Settings ğŸ›ï¸ ===---";
input group "Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ØªØ­Ù„ÛŒÙ„";
input int    Inp_MSS_Swing_Length   = 10;   // Ø·ÙˆÙ„ ØªØ´Ø®ÛŒØµ Ø³Ù‚Ù/Ú©Ù (ØªØ¹Ø¯Ø§Ø¯ Ú©Ù†Ø¯Ù„ Ø§Ø² Ù‡Ø± Ø·Ø±Ù)
input group "ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†Ù…Ø§ÛŒØ´ÛŒ Ùˆ Ù„Ø§Ú¯";
input bool   Inp_MSS_Enable_Drawing = true;  // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø±Ø³Ù… Ø±ÙˆÛŒ Ú†Ø§Ø±Øª
input bool   Inp_MSS_Enable_Logging = false; // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯)
input group "";

// --- ØªØ¹Ø±ÛŒÙ Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ ---
enum E_MSS_SignalType
{
    MSS_NONE,         // Ù‡ÛŒÚ† Ø³ÛŒÚ¯Ù†Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
    MSS_BREAK_HIGH,   // Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø± Ø³Ø§Ø¯Ù‡ ØµØ¹ÙˆØ¯ÛŒ (BoS)
    MSS_BREAK_LOW,    // Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø± Ø³Ø§Ø¯Ù‡ Ù†Ø²ÙˆÙ„ÛŒ (BoS)
    MSS_SHIFT_UP,     // ØªØºÛŒÛŒØ± Ø³Ø§Ø®ØªØ§Ø± Ø¨Ù‡ ØµØ¹ÙˆØ¯ÛŒ (MSS)
    MSS_SHIFT_DOWN    // ØªØºÛŒÛŒØ± Ø³Ø§Ø®ØªØ§Ø± Ø¨Ù‡ Ù†Ø²ÙˆÙ„ÛŒ (MSS)
};

struct SMssSignal
{
    E_MSS_SignalType type;
    double           break_price;
    datetime         break_time;
    int              swing_bar_index;
    
    SMssSignal() { Reset(); }
    void Reset() { type=MSS_NONE; break_price=0.0; break_time=0; swing_bar_index=0; }
};

//+------------------------------------------------------------------+
//|   Ú©Ù„Ø§Ø³ Ø§ØµÙ„ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡: Ø¬Ø¹Ø¨Ù‡ Ø³ÛŒØ§Ù‡ ØªØ´Ø®ÛŒØµ Ø´Ú©Ø³Øª Ø³Ø§Ø®ØªØ§Ø±                 |
//+------------------------------------------------------------------+
class CMarketStructureShift
{
private:
    int      m_swing_length;
    string   m_symbol;
    ENUM_TIMEFRAMES m_period;
    bool     m_enable_logging;
    bool     m_enable_drawing;
    long     m_chart_id;
    string   m_obj_prefix;
    datetime m_last_bar_time;
    
    double   m_swing_highs_array[];
    double   m_swing_lows_array[];
    
    double   m_last_swing_h;
    double   m_last_swing_l;
    int      m_last_swing_h_index;
    int      m_last_swing_l_index;

    double   high(int index) { return iHigh(m_symbol, m_period, index); }
    double   low(int index) { return iLow(m_symbol, m_period, index); }
    datetime time(int index) { return iTime(m_symbol, m_period, index); }
    void     Log(string message);
    
    void drawSwingPoint(string objName,datetime time_param,double price,int arrCode, color clr,int direction);
    void drawBreakLevel(string objName,datetime time1,double price1, datetime time2,double price2,color clr,int direction);
    void drawBreakLevel_MSS(string objName,datetime time1,double price1, datetime time2,double price2,color clr,int direction);
    
public:
    void Init(string symbol, ENUM_TIMEFRAMES period);
    SMssSignal ProcessNewBar();
    double GetLastSwingHigh() const { return m_last_swing_h; }
    double GetLastSwingLow() const { return m_last_swing_l; }
    int    GetLastSwingHighIndex() const { return m_last_swing_h_index; }
    int    GetLastSwingLowIndex() const { return m_last_swing_l_index; }
    void   GetRecentHighs(double &highs[]) const { ArrayCopy(highs, m_swing_highs_array); }
    void   GetRecentLows(double &lows[]) const { ArrayCopy(lows, m_swing_lows_array); }
    bool   IsUptrend() const;
    bool   IsDowntrend() const;
};

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (Ú©Ø§Ù…Ù„ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)                           |
//+------------------------------------------------------------------+
void CMarketStructureShift::Init(string symbol, ENUM_TIMEFRAMES period)
{
    m_symbol = symbol;
    m_period = period;
    
    m_swing_length = Inp_MSS_Swing_Length > 2 ? Inp_MSS_Swing_Length : 10;
    m_enable_logging = Inp_MSS_Enable_Logging;
    m_enable_drawing = Inp_MSS_Enable_Drawing;
    
    m_chart_id = ChartID();
    m_obj_prefix = "MSS_LIB_" + m_symbol + "_" + EnumToString(m_period) + "_";
    m_last_bar_time = 0;
    m_last_swing_h = -1.0;
    m_last_swing_l = -1.0;
    m_last_swing_h_index = 0;
    m_last_swing_l_index = 0;
    
    // --- âœ… Ø¨Ø®Ø´ Ø­ÛŒØ§ØªÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ âœ… ---
    ArrayFree(m_swing_highs_array);
    ArrayFree(m_swing_lows_array);
    
    int highs_found = 0;
    int lows_found = 0;
    
    // Ø§Ø² Ú©Ù†Ø¯Ù„ ÙØ¹Ù„ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ù‡ Ø¹Ù‚Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    for(int i = m_swing_length; i < 500 && (highs_found < 2 || lows_found < 2); i++)
    {
        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ "array out of range"
        if(iBars(m_symbol, m_period) < i + m_swing_length + 1) break;
        
        bool is_high = true;
        bool is_low = true;
        
        for(int j = 1; j <= m_swing_length; j++)
        {
            if(high(i) <= high(i-j) || high(i) < high(i+j)) is_high = false;
            if(low(i) >= low(i-j) || low(i) > low(i+j)) is_low = false;
        }
        
        if(is_high && highs_found < 2)
        {
            // --- âœ… Ø±ÙˆØ´ ØµØ­ÛŒØ­ Ø¨Ø±Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÛŒÚ© Ø¹Ø¶Ùˆ Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ø¢Ø±Ø§ÛŒÙ‡ ---
            double temp_high[1];      // 1. ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ú©Ù…Ú©ÛŒ ÛŒÚ© Ø¹Ø¶ÙˆÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
            temp_high[0] = high(i);   // 2. Ù…Ù‚Ø¯Ø§Ø± Ø³Ù‚Ù Ø±Ø§ Ø¯Ø± Ø¢Ù† Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            ArrayInsert(m_swing_highs_array, temp_high, 0); // 3. Ø¢Ø±Ø§ÛŒÙ‡ Ú©Ù…Ú©ÛŒ Ø±Ø§ Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ø¢Ø±Ø§ÛŒÙ‡ Ø§ØµÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            highs_found++;
        }
        
        if(is_low && lows_found < 2)
        {
            // --- âœ… Ø±ÙˆØ´ ØµØ­ÛŒØ­ Ø¨Ø±Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÛŒÚ© Ø¹Ø¶Ùˆ Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ø¢Ø±Ø§ÛŒÙ‡ ---
            double temp_low[1];       // 1. ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ú©Ù…Ú©ÛŒ ÛŒÚ© Ø¹Ø¶ÙˆÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
            temp_low[0] = low(i);     // 2. Ù…Ù‚Ø¯Ø§Ø± Ú©Ù Ø±Ø§ Ø¯Ø± Ø¢Ù† Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            ArrayInsert(m_swing_lows_array, temp_low, 0);   // 3. Ø¢Ø±Ø§ÛŒÙ‡ Ú©Ù…Ú©ÛŒ Ø±Ø§ Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ø¢Ø±Ø§ÛŒÙ‡ Ø§ØµÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            lows_found++;
        }
    }
    
    if(m_enable_logging)
    {
       Print("Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ MarketStructure Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
       Print("Ø³Ù‚Ùâ€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡:");
       ArrayPrint(m_swing_highs_array);
       Print("Ú©Ùâ€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡:");
       ArrayPrint(m_swing_lows_array);
    }
    
    Log("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ MarketStructure Ø¨Ø±Ø§ÛŒ " + m_symbol + " Ø¯Ø± " + EnumToString(m_period) + " Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯.");
}

//+------------------------------------------------------------------+
//| ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†Ø¯Ù„ Ø¬Ø¯ÛŒØ¯ (Ú©Ø§Ù…Ù„ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡)                      |
//+------------------------------------------------------------------+
SMssSignal CMarketStructureShift::ProcessNewBar()
{
    SMssSignal result;
    datetime current_bar_time = iTime(m_symbol, m_period, 0);
    if (current_bar_time == m_last_bar_time) return result;
    m_last_bar_time = current_bar_time;

    const int curr_bar = m_swing_length;
    if (iBars(m_symbol, m_period) < curr_bar * 2 + 1) return result;

    bool isSwingHigh = true, isSwingLow = true;

    for (int a = 1; a <= m_swing_length; a++)
    {
        if ((high(curr_bar) <= high(curr_bar - a)) || (high(curr_bar) < high(curr_bar + a))) isSwingHigh = false;
        if ((low(curr_bar) >= low(curr_bar - a)) || (low(curr_bar) > low(curr_bar + a))) isSwingLow = false;
    }

    if (isSwingHigh)
    {
        m_last_swing_h = high(curr_bar);
        m_last_swing_h_index = curr_bar;
        Log("Ø³Ù‚Ù Ú†Ø±Ø®Ø´ Ø¬Ø¯ÛŒØ¯: " + DoubleToString(m_last_swing_h, _Digits));
        if (m_enable_drawing) drawSwingPoint(m_obj_prefix + TimeToString(time(curr_bar)), time(curr_bar), m_last_swing_h, 77, clrBlue, -1);
        
        // --- âœ… Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¢Ø±Ø§ÛŒÙ‡ Ø³Ù‚Ùâ€ŒÙ‡Ø§ ---
        ArrayResize(m_swing_highs_array, ArraySize(m_swing_highs_array) + 1);
        m_swing_highs_array[ArraySize(m_swing_highs_array) - 1] = m_last_swing_h;
        if(ArraySize(m_swing_highs_array) > 2)
        {
            ArrayRemove(m_swing_highs_array, 0, 1);
        }
    }
    
    if (isSwingLow)
    {
        m_last_swing_l = low(curr_bar);
        m_last_swing_l_index = curr_bar;
        Log("Ú©Ù Ú†Ø±Ø®Ø´ Ø¬Ø¯ÛŒØ¯: " + DoubleToString(m_last_swing_l, _Digits));
        if (m_enable_drawing) drawSwingPoint(m_obj_prefix + TimeToString(time(curr_bar)), time(curr_bar), m_last_swing_l, 77, clrRed, +1);

        // --- âœ… Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø¢Ø±Ø§ÛŒÙ‡ Ú©Ùâ€ŒÙ‡Ø§ ---
        ArrayResize(m_swing_lows_array, ArraySize(m_swing_lows_array) + 1);
        m_swing_lows_array[ArraySize(m_swing_lows_array) - 1] = m_last_swing_l;
        if(ArraySize(m_swing_lows_array) > 2)
        {
            ArrayRemove(m_swing_lows_array, 0, 1);
        }
    }

    double Ask = SymbolInfoDouble(m_symbol, SYMBOL_ASK);
    double Bid = SymbolInfoDouble(m_symbol, SYMBOL_BID);

    if (m_last_swing_h > 0 && Ask > m_last_swing_h)
    {
        Log("Ø´Ú©Ø³Øª Ø³Ù‚Ù Ø¯Ø± Ù‚ÛŒÙ…Øª " + DoubleToString(m_last_swing_h, _Digits));
        
        bool isMSS_High = IsUptrend();
        if (isMSS_High) {
            result.type = MSS_SHIFT_UP;
            if (m_enable_drawing) drawBreakLevel_MSS(m_obj_prefix + "MSS_UP_" + TimeToString(time(0)), time(m_last_swing_h_index), m_last_swing_h, time(0), m_last_swing_h, clrDarkGreen, -1);
        } else {
            result.type = MSS_BREAK_HIGH;
            if (m_enable_drawing) drawBreakLevel(m_obj_prefix + "BOS_UP_" + TimeToString(time(0)), time(m_last_swing_h_index), m_last_swing_h, time(0), m_last_swing_h, clrBlue, -1);
        }
        
        result.break_price = m_last_swing_h;
        result.break_time = time(0);
        result.swing_bar_index = m_last_swing_h_index;
        m_last_swing_h = -1.0;
    }
    else if (m_last_swing_l > 0 && Bid < m_last_swing_l)
    {
        Log("Ø´Ú©Ø³Øª Ú©Ù Ø¯Ø± Ù‚ÛŒÙ…Øª " + DoubleToString(m_last_swing_l, _Digits));
        
        bool isMSS_Low = IsDowntrend();
        if (isMSS_Low) {
            result.type = MSS_SHIFT_DOWN;
            if (m_enable_drawing) drawBreakLevel_MSS(m_obj_prefix + "MSS_DOWN_" + TimeToString(time(0)), time(m_last_swing_l_index), m_last_swing_l, time(0), m_last_swing_l, clrBlack, +1);
        } else {
            result.type = MSS_BREAK_LOW;
            if (m_enable_drawing) drawBreakLevel(m_obj_prefix + "BOS_DOWN_" + TimeToString(time(0)), time(m_last_swing_l_index), m_last_swing_l, time(0), m_last_swing_l, clrRed, +1);
        }

        result.break_price = m_last_swing_l;
        result.break_time = time(0);
        result.swing_bar_index = m_last_swing_l_index;
        m_last_swing_l = -1.0;
    }

    return result;
}

void CMarketStructureShift::Log(string message)
{
    if (m_enable_logging)
    {
        Print("[MSS Lib][", m_symbol, "][", EnumToString(m_period), "]: ", message);
    }
}

bool CMarketStructureShift::IsUptrend() const
{
    if (ArraySize(m_swing_highs_array) < 2 || ArraySize(m_swing_lows_array) < 2) return false;
    return (m_swing_highs_array[1] > m_swing_highs_array[0] && m_swing_lows_array[1] > m_swing_lows_array[0]);
}

bool CMarketStructureShift::IsDowntrend() const
{
    if (ArraySize(m_swing_highs_array) < 2 || ArraySize(m_swing_lows_array) < 2) return false;
    return (m_swing_highs_array[1] < m_swing_highs_array[0] && m_swing_lows_array[1] < m_swing_lows_array[0]);
}

void CMarketStructureShift::drawSwingPoint(string objName,datetime time_param,double price,int arrCode, color clr,int direction)
{
   if(ObjectFind(m_chart_id,objName) < 0) {
      ObjectCreate(m_chart_id,objName,OBJ_ARROW,0,time_param,price);
      ObjectSetInteger(m_chart_id,objName,OBJPROP_ARROWCODE,arrCode);
      ObjectSetInteger(m_chart_id,objName,OBJPROP_COLOR,clr);
      ObjectSetInteger(m_chart_id,objName,OBJPROP_FONTSIZE,10);
      if(direction > 0) ObjectSetInteger(m_chart_id,objName,OBJPROP_ANCHOR,ANCHOR_TOP);
      if(direction < 0) ObjectSetInteger(m_chart_id,objName,OBJPROP_ANCHOR,ANCHOR_BOTTOM);
      
      string text = "Swing"; // Ø§ØµÙ„Ø§Ø­ Ø´Ø¯
      string objName_Descr = objName + text;
      ObjectCreate(m_chart_id,objName_Descr,OBJ_TEXT,0,time_param,price);
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_COLOR,clr);
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_FONTSIZE,10);
      if(direction > 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,"  "+text); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_LEFT_UPPER); }
      if(direction < 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,"  "+text); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_LEFT_LOWER); }
   }
   ChartRedraw(m_chart_id);
}

void CMarketStructureShift::drawBreakLevel(string objName,datetime time1,double price1, datetime time2,double price2,color clr,int direction)
{
   if(ObjectFind(m_chart_id,objName) < 0) {
      ObjectCreate(m_chart_id,objName,OBJ_ARROWED_LINE,0,time1,price1,time2,price2);
      ObjectSetInteger(m_chart_id,objName,OBJPROP_COLOR,clr);
      ObjectSetInteger(m_chart_id,objName,OBJPROP_WIDTH,2);
      string text = "BoS"; // Ø§ØµÙ„Ø§Ø­ Ø´Ø¯
      string objName_Descr = objName + text;
      ObjectCreate(m_chart_id,objName_Descr,OBJ_TEXT,0,time2,price2);
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_COLOR,clr);
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_FONTSIZE,10);
      if(direction > 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,text+"  "); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_RIGHT_UPPER); }
      if(direction < 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,text+"  "); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_RIGHT_LOWER); }
   }
   ChartRedraw(m_chart_id);
}

void CMarketStructureShift::drawBreakLevel_MSS(string objName,datetime time1,double price1, datetime time2,double price2,color clr,int direction)
{
   if(ObjectFind(m_chart_id,objName) < 0) {
      ObjectCreate(m_chart_id,objName,OBJ_ARROWED_LINE,0,time1,price1,time2,price2);
      ObjectSetInteger(m_chart_id,objName,OBJPROP_COLOR,clr);
      ObjectSetInteger(m_chart_id,objName,OBJPROP_WIDTH,4);
      string text = "MSS"; // Ø§ØµÙ„Ø§Ø­ Ø´Ø¯
      string objName_Descr = objName + text;
      ObjectCreate(m_chart_id,objName_Descr,OBJ_TEXT,0,time2,price2);
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_COLOR,clr);
      ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_FONTSIZE,13);
      if(direction > 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,text+"  "); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_RIGHT_UPPER); }
      if(direction < 0) { ObjectSetString(m_chart_id,objName_Descr,OBJPROP_TEXT,text+"  "); ObjectSetInteger(m_chart_id,objName_Descr,OBJPROP_ANCHOR,ANCHOR_RIGHT_LOWER); }
   }
   ChartRedraw(m_chart_id);
}






------------------------------------------------------------------------------------------------------------------------------
|                                                   ÙØ§ÛŒÙ„ Ø¯ÛŒÚ¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡                                                               |
|-------------------------------------------------------------------------------------------------------------------------------



//+------------------------------------------------------------------+
//|                                                                  |
//|                    Project: Memento (By HipoAlgorithm)           |
//|                    File: VisualManager.mqh (Graphics Engine)     |
//|                    Version: 3.5 (Polished & Final)               |
//|                    Â© 2025, Mohammad & Gemini                     |
//|                                                                  |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "3.5" 

#include "set.mqh" 

// ---===== Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ø·Ø±Ø§Ø­ÛŒ =====---
#define DASHBOARD_Y_POS 30      
#define DASHBOARD_X_GAP 10      
#define BOX_WIDTH 95           
#define BOX_HEIGHT 28           
#define SUB_PANEL_HEIGHT 40     
#define MEMENTO_OBJ_PREFIX "MEMENTO_UI_"

// --- Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ ---
struct SPanelBox { string MainBoxName, SymbolLabelName, SubPanelName, TradesLabelName, PlLabelName; };
struct SManagedObject { string ObjectName; long CreationBar; };
struct SDashboardData { int trades_count; double cumulative_pl; };

//+------------------------------------------------------------------+
//| Ú©Ù„Ø§Ø³ Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±Ø§ÙÛŒÚ©                                               |
//+------------------------------------------------------------------+
class CVisualManager
{
private:
    string              m_symbol;
    SSettings           m_settings;
    SPanelBox           m_panel_boxes[];
    string              m_symbols_list[];
    SManagedObject      m_managed_objects[];
    SDashboardData      m_dashboard_data[];
    
    bool                m_is_barchart_visible;
    string              m_chart_button_name;
    string              m_chart_panel_bg_name;
    string              m_chart_panel_title_name;

    void ShowBarChart(bool show);
    void CreateManagedObject(string obj_name, long creation_bar);
    
public:
    CVisualManager(string symbol, SSettings &settings);
    ~CVisualManager();

    bool Init();
    void Deinit();
    void InitDashboard();
    void UpdateDashboard();
    
    // âœ… ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ù…Ø³ØªØ·ÛŒÙ„ Ùˆ ÙÙ„Ø´ Ú©Ø±Ø§Ø³ Ø§ÙˆÙ„ÛŒÙ‡ (Ø«Ø§Ø¨Øª)
    void DrawTripleCrossRectangle(bool is_buy, int shift);
    
    // âœ… ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… ÙÙ„Ø´ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ (Ø±ÙˆÛŒ Ú©Ù†Ø¯Ù„ 1)
    void DrawConfirmationArrow(bool is_buy, int shift);
    
    // âœ… ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ù†Ø§Ø­ÛŒÙ‡ Ø§Ø³Ú©Ù† Ù…ØªØ­Ø±Ú© (Ø±Ù†Ú¯ÛŒ Ùˆ Ø´ÙØ§Ù)
    void DrawScanningArea(bool is_buy, int start_shift, int current_shift);
    
    void CleanupOldObjects(const int max_age_in_bars);
    int GetSymbolIndex(string symbol);
    void UpdateDashboardCache(int symbol_index, double deal_profit, double deal_commission, double deal_swap);
    
    void OnChartEvent(const int id, const long &lparam, const double &dparam, const string &sparam);
};

//+------------------------------------------------------------------+
//|                      Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªÙˆØ§Ø¨Ø¹ Ú©Ù„Ø§Ø³                        |
//+------------------------------------------------------------------+
CVisualManager::CVisualManager(string symbol, SSettings &settings)
{
    m_symbol = symbol;
    m_settings = settings;
    m_is_barchart_visible = false;
    m_chart_button_name = MEMENTO_OBJ_PREFIX + "ChartToggleButton";
    m_chart_panel_bg_name = MEMENTO_OBJ_PREFIX + "ChartPanelBg";
    m_chart_panel_title_name = MEMENTO_OBJ_PREFIX + "ChartPanelTitle";
}

CVisualManager::~CVisualManager() { Deinit(); }
bool CVisualManager::Init() { ChartSetInteger(0, CHART_SHIFT, 1); ChartSetInteger(0, CHART_SHOW_GRID, false); return true; }
void CVisualManager::Deinit() { ObjectsDeleteAll(0, MEMENTO_OBJ_PREFIX); ChartRedraw(0); }

void CVisualManager::OnChartEvent(const int id, const long &lparam, const double &dparam, const string &sparam)
{
    if(id == CHARTEVENT_OBJECT_CLICK && sparam == m_chart_button_name)
    {
        m_is_barchart_visible = !m_is_barchart_visible;
        ObjectSetInteger(0, m_chart_button_name, OBJPROP_STATE, m_is_barchart_visible);
        ShowBarChart(m_is_barchart_visible);
        UpdateDashboard(); 
        ChartRedraw(0);
    }
}

void CVisualManager::ShowBarChart(bool show)
{
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_HIDDEN, !show);
    ObjectSetInteger(0, m_chart_panel_title_name, OBJPROP_HIDDEN, !show);

    for(int i=0; i < ArraySize(m_symbols_list); i++)
    {
        string sym = m_symbols_list[i];
        ObjectSetInteger(0, MEMENTO_OBJ_PREFIX + sym + "_BarRect", OBJPROP_HIDDEN, !show);
        ObjectSetInteger(0, MEMENTO_OBJ_PREFIX + sym + "_BarLabel", OBJPROP_HIDDEN, !show);
    }
}

void CVisualManager::InitDashboard()
{
    if(!m_settings.enable_dashboard) return;
    
    StringSplit(m_settings.symbols_list, ',', m_symbols_list);
    int total_symbols = ArraySize(m_symbols_list);
    if(total_symbols == 0) return;
    
    ArrayResize(m_panel_boxes, total_symbols);
    ArrayResize(m_dashboard_data, total_symbols);
    
    int current_x = DASHBOARD_X_GAP;
    
    color main_bg_color = C'26,30,38';      
    color main_border_color = C'55,65,81';  
    color sub_bg_color = C'17,20,25';       
    color text_color_bright = clrWhite;     
    color text_color_dim = clrSilver;       

    ObjectCreate(0, m_chart_button_name, OBJ_BUTTON, 0, 0, 0);
    ObjectSetInteger(0, m_chart_button_name, OBJPROP_XDISTANCE, current_x);
    ObjectSetInteger(0, m_chart_button_name, OBJPROP_YDISTANCE, DASHBOARD_Y_POS);
    ObjectSetInteger(0, m_chart_button_name, OBJPROP_XSIZE, 25);
    ObjectSetInteger(0, m_chart_button_name, OBJPROP_YSIZE, BOX_HEIGHT);
    ObjectSetString(0, m_chart_button_name, OBJPROP_TEXT, "ğŸ“ˆ");
    ObjectSetInteger(0, m_chart_button_name, OBJPROP_BGCOLOR, main_bg_color);
    ObjectSetInteger(0, m_chart_button_name, OBJPROP_BORDER_COLOR, main_border_color);
    ObjectSetInteger(0, m_chart_button_name, OBJPROP_FONTSIZE, 12);
    ObjectSetInteger(0, m_chart_button_name, OBJPROP_CORNER, CORNER_LEFT_UPPER);
    
    current_x += 25 + DASHBOARD_X_GAP;

    for(int i = 0; i < total_symbols; i++)
    {
        string sym = m_symbols_list[i];
        StringTrimLeft(sym); StringTrimRight(sym);
        
        string base_name = MEMENTO_OBJ_PREFIX + sym;
        m_panel_boxes[i].MainBoxName      = base_name + "_MainBox";
        m_panel_boxes[i].SymbolLabelName  = base_name + "_SymbolLabel";
        m_panel_boxes[i].SubPanelName     = base_name + "_SubPanel";
        m_panel_boxes[i].TradesLabelName  = base_name + "_TradesLabel";
        m_panel_boxes[i].PlLabelName      = base_name + "_PlLabel";

        ObjectCreate(0, m_panel_boxes[i].MainBoxName, OBJ_RECTANGLE_LABEL, 0, 0, 0);
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_XDISTANCE, current_x);
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_YDISTANCE, DASHBOARD_Y_POS);
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_XSIZE, BOX_WIDTH);
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_YSIZE, BOX_HEIGHT);
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_COLOR, main_border_color);
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_BGCOLOR, main_bg_color);
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_CORNER, CORNER_LEFT_UPPER);
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_ZORDER, 100);

        ObjectCreate(0, m_panel_boxes[i].SymbolLabelName, OBJ_LABEL, 0, 0, 0);
        ObjectSetString(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_TEXT, sym);
        ObjectSetInteger(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_XDISTANCE, current_x + BOX_WIDTH / 2);
        ObjectSetInteger(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_YDISTANCE, DASHBOARD_Y_POS + BOX_HEIGHT / 2);
        ObjectSetInteger(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_COLOR, text_color_bright);
        ObjectSetString(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_FONT, "Calibri");
        ObjectSetInteger(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_FONTSIZE, 12);
        ObjectSetInteger(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_ANCHOR, ANCHOR_CENTER);
        ObjectSetInteger(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_ZORDER, 101);

        ObjectCreate(0, m_panel_boxes[i].SubPanelName, OBJ_RECTANGLE_LABEL, 0, 0, 0);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_XDISTANCE, current_x);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_YDISTANCE, DASHBOARD_Y_POS + BOX_HEIGHT);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_XSIZE, BOX_WIDTH);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_YSIZE, SUB_PANEL_HEIGHT);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_COLOR, main_border_color);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_BGCOLOR, sub_bg_color);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_CORNER, CORNER_LEFT_UPPER);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_ZORDER, 99);
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_HIDDEN, true);

        ObjectCreate(0, m_panel_boxes[i].TradesLabelName, OBJ_LABEL, 0, 0, 0);
        ObjectSetString(0, m_panel_boxes[i].TradesLabelName, OBJPROP_TEXT, "Trades: 0");
        ObjectSetInteger(0, m_panel_boxes[i].TradesLabelName, OBJPROP_XDISTANCE, current_x + 5);
        ObjectSetInteger(0, m_panel_boxes[i].TradesLabelName, OBJPROP_YDISTANCE, DASHBOARD_Y_POS + BOX_HEIGHT + 10);
        ObjectSetInteger(0, m_panel_boxes[i].TradesLabelName, OBJPROP_COLOR, text_color_dim);
        ObjectSetString(0, m_panel_boxes[i].TradesLabelName, OBJPROP_FONT, "Calibri");
        ObjectSetInteger(0, m_panel_boxes[i].TradesLabelName, OBJPROP_FONTSIZE, 8);
        ObjectSetInteger(0, m_panel_boxes[i].TradesLabelName, OBJPROP_ANCHOR, ANCHOR_LEFT);
        ObjectSetInteger(0, m_panel_boxes[i].TradesLabelName, OBJPROP_HIDDEN, true);

        ObjectCreate(0, m_panel_boxes[i].PlLabelName, OBJ_LABEL, 0, 0, 0);
        ObjectSetString(0, m_panel_boxes[i].PlLabelName, OBJPROP_TEXT, "P/L: 0.0");
        ObjectSetInteger(0, m_panel_boxes[i].PlLabelName, OBJPROP_XDISTANCE, current_x + 5);
        ObjectSetInteger(0, m_panel_boxes[i].PlLabelName, OBJPROP_YDISTANCE, DASHBOARD_Y_POS + BOX_HEIGHT + 22);
        ObjectSetInteger(0, m_panel_boxes[i].PlLabelName, OBJPROP_COLOR, text_color_dim);
        ObjectSetString(0, m_panel_boxes[i].PlLabelName, OBJPROP_FONT, "Calibri");
        ObjectSetInteger(0, m_panel_boxes[i].PlLabelName, OBJPROP_FONTSIZE, 8);
        ObjectSetInteger(0, m_panel_boxes[i].PlLabelName, OBJPROP_ANCHOR, ANCHOR_LEFT);
        ObjectSetInteger(0, m_panel_boxes[i].PlLabelName, OBJPROP_HIDDEN, true);
        
        current_x += BOX_WIDTH + DASHBOARD_X_GAP;
        
        if(!HistorySelect(0, TimeCurrent())) continue;
        int trades_count = 0;
        double cumulative_pl = 0;
        uint total_deals = HistoryDealsTotal();
        for(uint j = 0; j < total_deals; j++) {
            ulong ticket = HistoryDealGetTicket(j);
            if(HistoryDealGetString(ticket, DEAL_SYMBOL) == sym && HistoryDealGetInteger(ticket, DEAL_MAGIC) == (long)m_settings.magic_number && HistoryDealGetInteger(ticket, DEAL_ENTRY) == DEAL_ENTRY_OUT) {
                trades_count++;
                cumulative_pl += HistoryDealGetDouble(ticket, DEAL_PROFIT) + HistoryDealGetDouble(ticket, DEAL_SWAP) + HistoryDealGetDouble(ticket, DEAL_COMMISSION);
            }
        }
        m_dashboard_data[i].trades_count = trades_count;
        m_dashboard_data[i].cumulative_pl = cumulative_pl;
    }
    
    int chart_panel_y = DASHBOARD_Y_POS + BOX_HEIGHT + SUB_PANEL_HEIGHT + 10;
    int chart_panel_width = (BOX_WIDTH + DASHBOARD_X_GAP) * total_symbols + 25;
    int chart_panel_height = 25 + (20 * total_symbols);
    
    ObjectCreate(0, m_chart_panel_bg_name, OBJ_RECTANGLE_LABEL, 0, 0, 0);
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_XDISTANCE, DASHBOARD_X_GAP);
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_YDISTANCE, chart_panel_y);
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_XSIZE, chart_panel_width);
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_YSIZE, chart_panel_height);
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_BGCOLOR, sub_bg_color);
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_COLOR, main_border_color);
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_CORNER, CORNER_LEFT_UPPER);
    ObjectSetInteger(0, m_chart_panel_bg_name, OBJPROP_ZORDER, 90);

    ObjectCreate(0, m_chart_panel_title_name, OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, m_chart_panel_title_name, OBJPROP_TEXT, "P/L Distribution");
    ObjectSetInteger(0, m_chart_panel_title_name, OBJPROP_XDISTANCE, DASHBOARD_X_GAP + chart_panel_width/2);
    ObjectSetInteger(0, m_chart_panel_title_name, OBJPROP_YDISTANCE, chart_panel_y + 12);
    ObjectSetInteger(0, m_chart_panel_title_name, OBJPROP_COLOR, text_color_bright);
    ObjectSetString(0, m_chart_panel_title_name, OBJPROP_FONT, "Calibri");
    ObjectSetInteger(0, m_chart_panel_title_name, OBJPROP_FONTSIZE, 12);
    ObjectSetInteger(0, m_chart_panel_title_name, OBJPROP_ANCHOR, ANCHOR_CENTER);
    ObjectSetInteger(0, m_chart_panel_title_name, OBJPROP_ZORDER, 91);
    
    for(int i=0; i < total_symbols; i++) {
        string sym = m_symbols_list[i];
        ObjectCreate(0, MEMENTO_OBJ_PREFIX + sym + "_BarRect", OBJ_RECTANGLE_LABEL, 0, 0, 0);
        ObjectCreate(0, MEMENTO_OBJ_PREFIX + sym + "_BarLabel", OBJ_LABEL, 0, 0, 0);
    }
    ShowBarChart(false);
    ChartRedraw(0);
}

void CVisualManager::UpdateDashboard()
{
    if(!m_settings.enable_dashboard || ArraySize(m_symbols_list) == 0) return;
    
    int total_symbols = ArraySize(m_symbols_list);
    int current_x = DASHBOARD_X_GAP + 25 + DASHBOARD_X_GAP;

    for(int i = 0; i < total_symbols; i++)
    {
        string sym = m_symbols_list[i];
        long magic = (long)m_settings.magic_number;
        color box_color = C'26,30,38';
        color text_color = clrWhite;

        if(PositionSelect(sym) && PositionGetInteger(POSITION_MAGIC) == magic) {
            if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_BUY) {
                box_color = m_settings.bullish_color;
                text_color = clrBlack;
            } else if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_SELL) {
                box_color = m_settings.bearish_color;
                text_color = clrWhite;
            }
        }
        ObjectSetInteger(0, m_panel_boxes[i].MainBoxName, OBJPROP_BGCOLOR, box_color);
        ObjectSetInteger(0, m_panel_boxes[i].SymbolLabelName, OBJPROP_COLOR, text_color);
        
        int trades_count = m_dashboard_data[i].trades_count;
        double cumulative_pl = m_dashboard_data[i].cumulative_pl;
        bool show_sub_panel = trades_count > 0;
        ObjectSetInteger(0, m_panel_boxes[i].SubPanelName, OBJPROP_HIDDEN, !show_sub_panel);
        ObjectSetInteger(0, m_panel_boxes[i].TradesLabelName, OBJPROP_HIDDEN, !show_sub_panel);
        ObjectSetInteger(0, m_panel_boxes[i].PlLabelName, OBJPROP_HIDDEN, !show_sub_panel);
        
        if(show_sub_panel) {
            ObjectSetString(0, m_panel_boxes[i].TradesLabelName, OBJPROP_TEXT, "Trades: " + (string)trades_count);
            ObjectSetString(0, m_panel_boxes[i].PlLabelName, OBJPROP_TEXT, "P/L: " + DoubleToString(cumulative_pl, 2));
            ObjectSetInteger(0, m_panel_boxes[i].PlLabelName, OBJPROP_COLOR, cumulative_pl >= 0 ? C'4,180,95' : C'240,82,90');
        }
        current_x += BOX_WIDTH + DASHBOARD_X_GAP;
    }
    
    if(m_is_barchart_visible)
    {
        double max_abs_pl = 0;
        for(int i=0; i < ArraySize(m_dashboard_data); i++)
        {
            if(MathAbs(m_dashboard_data[i].cumulative_pl) > max_abs_pl)
                max_abs_pl = MathAbs(m_dashboard_data[i].cumulative_pl);
        }
        if(max_abs_pl == 0) max_abs_pl = 1;

        int max_bar_width = BOX_WIDTH * 2;
        int current_y = DASHBOARD_Y_POS + BOX_HEIGHT + SUB_PANEL_HEIGHT + 10 + 30;

        for(int i=0; i < total_symbols; i++)
        {
            string sym = m_symbols_list[i];
            double pl = m_dashboard_data[i].cumulative_pl;
            string bar_rect_name = MEMENTO_OBJ_PREFIX + sym + "_BarRect";
            string bar_label_name = MEMENTO_OBJ_PREFIX + sym + "_BarLabel";
            
            int bar_width = (int)((MathAbs(pl) / max_abs_pl) * max_bar_width);
            color bar_color = (pl >= 0) ? C'4,180,95' : C'240,82,90';

            ObjectSetInteger(0, bar_rect_name, OBJPROP_XDISTANCE, DASHBOARD_X_GAP + 70);
            ObjectSetInteger(0, bar_rect_name, OBJPROP_YDISTANCE, current_y);
            ObjectSetInteger(0, bar_rect_name, OBJPROP_XSIZE, bar_width);
            ObjectSetInteger(0, bar_rect_name, OBJPROP_YSIZE, 15);
            ObjectSetInteger(0, bar_rect_name, OBJPROP_BGCOLOR, bar_color);
            ObjectSetInteger(0, bar_rect_name, OBJPROP_COLOR, C'55,65,81');
            ObjectSetInteger(0, bar_rect_name, OBJPROP_CORNER, CORNER_LEFT_UPPER);
            ObjectSetInteger(0, bar_rect_name, OBJPROP_ZORDER, 92);
            
            string label_text = StringFormat("%s : %.2f", sym, pl);
            ObjectSetString(0, bar_label_name, OBJPROP_TEXT, label_text);
            ObjectSetInteger(0, bar_label_name, OBJPROP_XDISTANCE, DASHBOARD_X_GAP + 65);
            ObjectSetInteger(0, bar_label_name, OBJPROP_YDISTANCE, current_y + 8);
            ObjectSetInteger(0, bar_label_name, OBJPROP_COLOR, clrSilver);
            ObjectSetString(0, bar_label_name, OBJPROP_FONT, "Calibri");
            ObjectSetInteger(0, bar_label_name, OBJPROP_FONTSIZE, 9);
            ObjectSetInteger(0, bar_label_name, OBJPROP_ANCHOR, ANCHOR_RIGHT);
            ObjectSetInteger(0, bar_label_name, OBJPROP_ZORDER, 93);
            
            current_y += 20;
        }
    }
    ChartRedraw(0);
}

// âœ…âœ…âœ… ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ù…Ø³ØªØ·ÛŒÙ„ Ùˆ ÙÙ„Ø´ Ú©Ø±Ø§Ø³ Ø§ÙˆÙ„ÛŒÙ‡ (Ø«Ø§Ø¨Øª) âœ…âœ…âœ…
void CVisualManager::DrawTripleCrossRectangle(bool is_buy, int shift)
{
    string obj_name_rect = MEMENTO_OBJ_PREFIX + m_symbol + "_SignalRect_" + (string)iTime(m_symbol, _Period, shift);
    string obj_name_arrow = MEMENTO_OBJ_PREFIX + m_symbol + "_SignalArrow_" + (string)iTime(m_symbol, _Period, shift);
    
    ObjectDelete(0, obj_name_rect);
    ObjectDelete(0, obj_name_arrow);

    datetime time1 = iTime(m_symbol, _Period, shift + 1);
    datetime time2 = iTime(m_symbol, _Period, shift);
    double high = iHigh(m_symbol, _Period, shift); 
    double low = iLow(m_symbol, _Period, shift);
    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double buffer = 10 * point * m_settings.object_size_multiplier;
    
    // Ø±Ø³Ù… Ù…Ø³ØªØ·ÛŒÙ„ Ú©Ø±Ø§Ø³
    if(ObjectCreate(0, obj_name_rect, OBJ_RECTANGLE, 0, time1, low - buffer, time2, high + buffer))
    {
        ObjectSetInteger(0, obj_name_rect, OBJPROP_COLOR, is_buy ? m_settings.bullish_color : m_settings.bearish_color);
        ObjectSetInteger(0, obj_name_rect, OBJPROP_STYLE, STYLE_SOLID); 
        ObjectSetInteger(0, obj_name_rect, OBJPROP_WIDTH, 1); 
        ObjectSetInteger(0, obj_name_rect, OBJPROP_BACK, true);
        ObjectSetInteger(0, obj_name_rect, OBJPROP_FILL, false);
        CreateManagedObject(obj_name_rect, (long)iBars(m_symbol, _Period));
    }
    
    // Ø±Ø³Ù… ÙÙ„Ø´ Ú©Ø±Ø§Ø³ (26 Ú©Ù†Ø¯Ù„ Ù‚Ø¨Ù„) Ø¨Ø§ Ú©Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ùˆ ÙØ§ØµÙ„Ù‡ Ù…Ù†Ø§Ø³Ø¨
    double arrow_offset = 5 * point * m_settings.object_size_multiplier;
    double price = is_buy ? low - arrow_offset : high + arrow_offset;
    uchar code = is_buy ? 211 : 212;
    
    if(ObjectCreate(0, obj_name_arrow, OBJ_ARROW, 0, iTime(m_symbol, _Period, shift), price))
    {
        ObjectSetInteger(0, obj_name_arrow, OBJPROP_ARROWCODE, code);
        ObjectSetString(0, obj_name_arrow, OBJPROP_FONT, "Wingdings");
        ObjectSetInteger(0, obj_name_arrow, OBJPROP_COLOR, is_buy ? clrGreen : clrRed); // âœ… Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
        ObjectSetInteger(0, obj_name_arrow, OBJPROP_WIDTH, (int)(2 * m_settings.object_size_multiplier)); 
        CreateManagedObject(obj_name_arrow, (long)iBars(m_symbol, _Period));
    }
}

// âœ…âœ…âœ… ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… ÙÙ„Ø´ ØªØ§ÛŒÛŒØ¯ÛŒÙ‡ Ù†Ù‡Ø§ÛŒÛŒ (Ø±ÙˆÛŒ Ú©Ù†Ø¯Ù„ 1) âœ…âœ…âœ…
void CVisualManager::DrawConfirmationArrow(bool is_buy, int shift)
{
    string obj_name = MEMENTO_OBJ_PREFIX + m_symbol + "_ConfirmArrow_" + (string)iTime(m_symbol, _Period, shift);
    ObjectDelete(0, obj_name);
    
    double point = SymbolInfoDouble(m_symbol, SYMBOL_POINT);
    double offset = 15 * point * m_settings.object_size_multiplier; // ÙØ§ØµÙ„Ù‡ Ø§ÙˆÙ„ÛŒÙ‡
    double price = is_buy ? iLow(m_symbol, _Period, shift) - offset : iHigh(m_symbol, _Period, shift) + offset;
    
    // âœ… ÙØ§ØµÙ„Ù‡ Ù…Ø¹Ù‚ÙˆÙ„ Ø§Ø² Ú©Ù†Ø¯Ù„ Ø±Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    double candle_range = MathAbs(iHigh(m_symbol, _Period, shift) - iLow(m_symbol, _Period, shift));
    double final_offset = candle_range * 0.5; // Ù…Ø«Ù„Ø§ Ù†ØµÙ Ú©Ù†Ø¯Ù„ ÙØ§ØµÙ„Ù‡ Ø¨Ø¯Ù‡
    price = is_buy ? iLow(m_symbol, _Period, shift) - final_offset : iHigh(m_symbol, _Period, shift) + final_offset;
    
    // âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø¯ Ø¬Ø¯ÛŒØ¯ Û±Û¸Û±
    uchar code = 181;
    color arrow_color = is_buy ? m_settings.bullish_color : m_settings.bearish_color;

    if(ObjectCreate(0, obj_name, OBJ_ARROW, 0, iTime(m_symbol, _Period, shift), price))
    {
        ObjectSetInteger(0, obj_name, OBJPROP_ARROWCODE, code);
        ObjectSetString(0, obj_name, OBJPROP_FONT, "Wingdings");
        ObjectSetInteger(0, obj_name, OBJPROP_COLOR, arrow_color);
        ObjectSetInteger(0, obj_name, OBJPROP_WIDTH, (int)(5 * m_settings.object_size_multiplier));
        CreateManagedObject(obj_name, (long)iBars(m_symbol, _Period));
    }
}

// âœ…âœ…âœ… ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ù†Ø§Ø­ÛŒÙ‡ Ø§Ø³Ú©Ù† Ù…ØªØ­Ø±Ú© âœ…âœ…âœ…
void CVisualManager::DrawScanningArea(bool is_buy, int start_shift, int current_shift)
{
    string rect_name = MEMENTO_OBJ_PREFIX + m_symbol + "_ScanningRect";
    
    ObjectDelete(0, rect_name);
    
    if (current_shift < 1 || current_shift > start_shift) return;

    double max_high = 0;
    double min_low = 999999;
    
    MqlRates rates[];
    int bars_to_copy = start_shift - current_shift + 1;
    if(CopyRates(m_symbol, _Period, current_shift, bars_to_copy, rates) > 0)
    {
        for(int i = 0; i < ArraySize(rates); i++)
        {
            if(rates[i].high > max_high) max_high = rates[i].high;
            if(rates[i].low < min_low) min_low = rates[i].low;
        }
    }

    if(max_high > 0 && min_low < 999999)
    {
        datetime time_start_rect = iTime(m_symbol, _Period, start_shift);
        datetime time_end_rect = iTime(m_symbol, _Period, current_shift);
        
        if(ObjectCreate(0, rect_name, OBJ_RECTANGLE, 0, time_start_rect, min_low, time_end_rect, max_high))
        {
            color scan_color = is_buy ? clrLightSkyBlue : clrPaleGoldenrod;
            ObjectSetInteger(0, rect_name, OBJPROP_COLOR, scan_color);
            ObjectSetInteger(0, rect_name, OBJPROP_STYLE, STYLE_SOLID); 
            ObjectSetInteger(0, rect_name, OBJPROP_WIDTH, 1); 
            ObjectSetInteger(0, rect_name, OBJPROP_BACK, true);
            ObjectSetInteger(0, rect_name, OBJPROP_FILL, true);
            ObjectSetInteger(0, rect_name, OBJPROP_SELECTABLE, false);
            
           
            
            CreateManagedObject(rect_name, (long)iBars(m_symbol, _Period));
        }
    }
}


void CVisualManager::CleanupOldObjects(const int max_age_in_bars)
{
    if (max_age_in_bars <= 0) return;
    long current_bar_count = (long)iBars(m_symbol, _Period);
    for (int i = ArraySize(m_managed_objects) - 1; i >= 0; i--)
    {
        if (current_bar_count - m_managed_objects[i].CreationBar >= max_age_in_bars)
        {
            ObjectDelete(0, m_managed_objects[i].ObjectName);
            ArrayRemove(m_managed_objects, i, 1);
        }
    }
}

int CVisualManager::GetSymbolIndex(string symbol)
{
    for(int i = 0; i < ArraySize(m_symbols_list); i++)
    {
        if(m_symbols_list[i] == symbol) return i;
    }
    return -1;
}

void CVisualManager::UpdateDashboardCache(int symbol_index, double deal_profit, double deal_commission, double deal_swap)
{
    if(symbol_index >= 0 && symbol_index < ArraySize(m_dashboard_data))
    {
        m_dashboard_data[symbol_index].trades_count++;
        m_dashboard_data[symbol_index].cumulative_pl += deal_profit + deal_commission + deal_swap;
    }
}

void CVisualManager::CreateManagedObject(string obj_name, long creation_bar)
{
    int total = ArraySize(m_managed_objects);
    ArrayResize(m_managed_objects, total + 1);
    m_managed_objects[total].ObjectName = obj_name;
    m_managed_objects[total].CreationBar = creation_bar;
}


------------------------------------------------------------------------------------------------------------------------------
|                                                   ÙØ§ÛŒÙ„ Ø¯ÛŒÚ¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡                                                               |
|-------------------------------------------------------------------------------------------------------------------------------

//+------------------------------------------------------------------+
//|                                      Universal Trailing Stop Loss Library |
//|                                      File: TrailingStopManager.mqh |
//|                                      Version: 5.1 (Truly Final) |
//|                                      Â© 2025, Mohammad & Gemini |
//|                                                                  |
//+------------------------------------------------------------------+
#property copyright "Â© 2025, hipoalgoritm"
#property link      "https://www.mql5.com"
#property version   "5.1"
#include <Trade\Trade.mqh>

//================================================================================//
//|                                 --- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø³Ø±ÛŒØ¹ ---                   |
//|                                                                                |
//| Û±. Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± Ú©Ù†Ø§Ø± ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù¾Ø±Øª Ø®ÙˆØ¯ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.                                |
//| Û². Ø¯Ø± ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù¾Ø±Øª Ø§ØµÙ„ÛŒ (.mq5)ØŒ Ø§ÛŒÙ† Ø¯Ùˆ Ø®Ø· Ø±Ø§ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ ÙØ§ÛŒÙ„ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:             |
//|    #include "TrailingStopManager.mqh"                                          |
//|    CTrailingStopManager TrailingStop;                                          |
//| Û³. Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ ØªØ§Ø¨Ø¹ OnInit Ø§Ú©Ø³Ù¾Ø±Øª Ø®ÙˆØ¯ØŒ Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:                      |
//|    TrailingStop.Init(magic_number);                                           |
//| Û´. Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ ØªØ§Ø¨Ø¹ OnTimer (ÛŒØ§ OnTick) Ø§Ú©Ø³Ù¾Ø±Øª Ø®ÙˆØ¯ØŒ Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:          |
//|    TrailingStop.Process();                                                     |
//|                                                                                |
//|                                 **Ø¯ÛŒÚ¯Ø± Ø¨Ù‡ Ù‡ÛŒÚ† ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ù†ÛŒØ§Ø² Ù†ÛŒØ³Øª!** |
//|                                                                                |
//================================================================================//

//================================================================//
// Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ (Inputs) - Ú©Ø§Ù…Ù„Ø§ Ù…Ø³ØªÙ‚Ù„ Ùˆ Plug & Play
//================================================================//
input group "---=== ğŸ›¡ï¸ Universal Trailing & Breakeven ğŸ›¡ï¸ ===---";
input bool Inp_TSL_Enable = true;
input double Inp_TSL_Activation_RR = 1.0;
input bool Inp_BE_Enable = true;
input double Inp_BE_Activation_RR = 1.0;
input double Inp_BE_Plus_Pips = 1.0;
enum E_TSL_Mode { TSL_MODE_TENKAN, TSL_MODE_KIJUN, TSL_MODE_MA, TSL_MODE_ATR, TSL_MODE_PSAR, TSL_MODE_PRICE_CHANNEL, TSL_MODE_CHANDELIER_ATR };
input E_TSL_Mode Inp_TSL_Mode = TSL_MODE_TENKAN;
/*input*/ double Inp_TSL_Buffer_Pips = 3.0;
/*input*/ int Inp_TSL_Ichimoku_Tenkan = 9;
/*input*/ int Inp_TSL_Ichimoku_Kijun = 26;
/*input*/ int Inp_TSL_Ichimoku_Senkou = 52;
/*input*/ int Inp_TSL_MA_Period = 50;
/*input*/ ENUM_MA_METHOD Inp_TSL_MA_Method = MODE_SMA;
/*input*/ ENUM_APPLIED_PRICE Inp_TSL_MA_Price = PRICE_CLOSE;
/*input*/ int Inp_TSL_ATR_Period = 14;
/*input*/ double Inp_TSL_ATR_Multiplier = 2.5;
/*input*/ double Inp_TSL_PSAR_Step = 0.02;
/*input*/ double Inp_TSL_PSAR_Max = 0.2;
/*input*/ int Inp_TSL_PriceChannel_Period = 22;

//+------------------------------------------------------------------+
//| Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ù‡ÛŒÙ†Ù‡ Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª ØªØ±ÛŒØ¯Ù‡Ø§          |
//+------------------------------------------------------------------+
struct SIndicatorHandle
{
  string symbol;
  int    handle;
};

struct STradeState
{
  ulong  ticket;
  double open_price;
  double initial_sl;
  bool   be_applied;
};

//+------------------------------------------------------------------+
//| Ú©Ù„Ø§Ø³ Ø§ØµÙ„ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¯ Ø¶Ø±Ø± Ù…ØªØ­Ø±Ú©                                     |
//+------------------------------------------------------------------+
class CTrailingStopManager
{
private:
  long               m_magic_number;
  bool               m_is_initialized;
  CTrade             m_trade;

  // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
  bool               m_tsl_enabled, m_be_enabled;
  double             m_activation_rr, m_be_activation_rr, m_be_plus_pips;
  E_TSL_Mode         m_tsl_mode;
  double             m_buffer_pips;
  int                m_ichimoku_tenkan, m_ichimoku_kijun, m_ichimoku_senkou;
  int                m_ma_period;
  ENUM_MA_METHOD     m_ma_method;
  ENUM_APPLIED_PRICE m_ma_price;
  int                m_atr_period;
  double             m_atr_multiplier;
  double             m_psar_step, m_psar_max;
  int                m_pricechannel_period;

  // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª ---
  STradeState        m_trade_states[];

  // --- Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ù†Ø¯Ù„â€ŒÙ‡Ø§ ---
  SIndicatorHandle   m_ichimoku_handles[];
  SIndicatorHandle   m_ma_handles[];
  SIndicatorHandle   m_atr_handles[];
  SIndicatorHandle   m_psar_handles[];

  // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø®ØµÙˆØµÛŒ ---
  int    GetIchimokuHandle(string symbol);
  int    GetMaHandle(string symbol);
  int    GetAtrHandle(string symbol);
  int    GetPsarHandle(string symbol);
  void   Log(string message);
  void   ManageSingleTrade(ulong ticket);
  int    FindTradeStateIndex(ulong ticket);
  void   AddTradeState(ulong ticket, double open_price, double initial_sl);
  void   CleanupTradeStates();

  double CalculateIchimokuSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculateMaSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculateAtrSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculatePsarSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculatePriceChannelSL(string symbol, ENUM_POSITION_TYPE type);
  double CalculateChandelierAtrSL(string symbol, ENUM_POSITION_TYPE type);
  void   ManageBreakeven(int state_idx);

public:
  CTrailingStopManager() { m_magic_number = 0; m_is_initialized = false; }
  ~CTrailingStopManager();
  void Init(long magic_number);
  void Process();
};

// --- Ù…Ø®Ø±Ø¨ Ú©Ù„Ø§Ø³ ---
CTrailingStopManager::~CTrailingStopManager()
{
  for(int i = 0; i < ArraySize(m_ichimoku_handles); i++) IndicatorRelease(m_ichimoku_handles[i].handle);
  for(int i = 0; i < ArraySize(m_ma_handles); i++) IndicatorRelease(m_ma_handles[i].handle);
  for(int i = 0; i < ArraySize(m_atr_handles); i++) IndicatorRelease(m_atr_handles[i].handle);
  for(int i = 0; i < ArraySize(m_psar_handles); i++) IndicatorRelease(m_psar_handles[i].handle);
}

// --- ØªØ§Ø¨Ø¹ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
void CTrailingStopManager::Init(long magic_number)
{
  if(m_is_initialized) return;
  m_magic_number = magic_number;
  m_trade.SetExpertMagicNumber(m_magic_number);
  m_trade.SetAsyncMode(true);
  m_tsl_enabled = Inp_TSL_Enable;
  m_activation_rr = Inp_TSL_Activation_RR > 0 ? Inp_TSL_Activation_RR : 1.0;
  m_be_enabled = Inp_BE_Enable;
  m_be_activation_rr = Inp_BE_Activation_RR > 0 ? Inp_BE_Activation_RR : 1.0;
  m_be_plus_pips = Inp_BE_Plus_Pips;
  m_tsl_mode = Inp_TSL_Mode;
  m_buffer_pips = Inp_TSL_Buffer_Pips;
  m_ichimoku_tenkan = Inp_TSL_Ichimoku_Tenkan;
  m_ichimoku_kijun = Inp_TSL_Ichimoku_Kijun;
  m_ichimoku_senkou = Inp_TSL_Ichimoku_Senkou;
  m_ma_period = Inp_TSL_MA_Period;
  m_ma_method = Inp_TSL_MA_Method;
  m_ma_price = Inp_TSL_MA_Price;
  m_atr_period = Inp_TSL_ATR_Period;
  m_atr_multiplier = Inp_TSL_ATR_Multiplier;
  m_psar_step = Inp_TSL_PSAR_Step;
  m_psar_max = Inp_TSL_PSAR_Max;
  m_pricechannel_period = Inp_TSL_PriceChannel_Period;
  if(m_tsl_enabled || m_be_enabled) Log("Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Universal Trailing/BE Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø§ÛŒ Ù…Ø¬ÛŒÚ© Ù†Ø§Ù…Ø¨Ø± " + (string)m_magic_number + " ÙØ¹Ø§Ù„ Ø´Ø¯.");
  m_is_initialized = true;
}

// âœ…âœ…âœ… ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ (Ù…Ù†Ø·Ù‚ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø³ØªÙ‚Ù„) âœ…âœ…âœ…
void CTrailingStopManager::Process()
{
  if(!m_is_initialized || (!m_tsl_enabled && !m_be_enabled)) return;

  // Ú¯Ø§Ù… Û±: Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†.
  int positions_total = PositionsTotal();
  for(int i = 0; i < positions_total; i++)
  {
      ulong ticket = PositionGetTicket(i);
      if(PositionGetInteger(POSITION_MAGIC) != m_magic_number) continue;

      int state_idx = FindTradeStateIndex(ticket);

      if(state_idx == -1)
      {
          if(PositionSelectByTicket(ticket))
          {
              AddTradeState(ticket, PositionGetDouble(POSITION_PRICE_OPEN), PositionGetDouble(POSITION_SL));
          }
      }
  }

  // âœ…âœ…âœ… Ú¯Ø§Ù… Û²: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª Ø§Ø² Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ âœ…âœ…âœ…
  CleanupTradeStates();

  // Ú¯Ø§Ù… Û³: Ù…Ù†Ø·Ù‚ ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ùˆ Ø³Ø±Ø¨Ù‡â€ŒØ³Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù¾ÙˆØ²ÛŒØ´Ù† Ø¯Ø± Ù„ÛŒØ³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†.
  for(int i = 0; i < ArraySize(m_trade_states); i++)
  {
    ManageSingleTrade(m_trade_states[i].ticket);
  }
}

// âœ…âœ…âœ… ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ ØªØ±ÛŒØ¯ âœ…âœ…âœ…
void CTrailingStopManager::CleanupTradeStates()
{
    for(int i = ArraySize(m_trade_states) - 1; i >= 0; i--)
    {
        ulong ticket = m_trade_states[i].ticket;
        // Ø§Ú¯Ø± Ù¾ÙˆØ²ÛŒØ´Ù† Ø¨Ø§ Ø§ÛŒÙ† ØªÛŒÚ©Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Ù…Ø¬ÛŒÚ© Ù†Ø§Ù…Ø¨Ø±Ø´ ÙØ±Ù‚ Ø¯Ø§Ø´ØªØŒ ÛŒØ¹Ù†ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡.
        if(!PositionSelectByTicket(ticket) || PositionGetInteger(POSITION_MAGIC) != m_magic_number)
        {
            ArrayRemove(m_trade_states, i, 1);
            Log("Ø­Ø§Ù„Øª ØªÛŒÚ©Øª " + (string)ticket + " Ø§Ø² Ù„ÛŒØ³Øª ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø­Ø°Ù Ø´Ø¯.");
        }
    }
}


// ... Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ Ú©Ù„Ø§Ø³ CTrailingStopManager (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ...
void CTrailingStopManager::ManageSingleTrade(ulong ticket)
{
    if(!PositionSelectByTicket(ticket)) return;

    int state_idx = FindTradeStateIndex(ticket);
    if (state_idx == -1) return;

    double initial_sl = m_trade_states[state_idx].initial_sl;
    
    if (initial_sl == 0)
    {
        double current_sl_from_position = PositionGetDouble(POSITION_SL);
        if (current_sl_from_position > 0)
        {
            m_trade_states[state_idx].initial_sl = current_sl_from_position;
            initial_sl = current_sl_from_position;
            Log("SL Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯: " + (string)initial_sl);
        }
        else
        {
            return;
        }
    }
    
    if(m_be_enabled) ManageBreakeven(state_idx);

    if(!m_tsl_enabled) return;

    string symbol = PositionGetString(POSITION_SYMBOL);
    ENUM_POSITION_TYPE type = (ENUM_POSITION_TYPE)PositionGetInteger(POSITION_TYPE);
    double open_price = PositionGetDouble(POSITION_PRICE_OPEN);
    double initial_risk = MathAbs(open_price - initial_sl);
    if(initial_risk == 0) return;

    double required_profit_for_tsl = initial_risk * m_activation_rr;
    double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
    double current_profit = (type == POSITION_TYPE_BUY) ? (current_price - open_price) : (open_price - current_price);
    
    if(current_profit < required_profit_for_tsl) return;
    
    double new_sl_level = 0;
    switch(m_tsl_mode)
    {
    case TSL_MODE_TENKAN:
    case TSL_MODE_KIJUN:
        new_sl_level = CalculateIchimokuSL(symbol, type);
        break;
    case TSL_MODE_MA:
        new_sl_level = CalculateMaSL(symbol, type);
        break;
    case TSL_MODE_ATR:
        new_sl_level = CalculateAtrSL(symbol, type);
        break;
    case TSL_MODE_PSAR:
        new_sl_level = CalculatePsarSL(symbol, type);
        break;
    case TSL_MODE_PRICE_CHANNEL:
        new_sl_level = CalculatePriceChannelSL(symbol, type);
        break;
    case TSL_MODE_CHANDELIER_ATR:
        new_sl_level = CalculateChandelierAtrSL(symbol, type);
        break;
    }
    if(new_sl_level == 0) return;
    
    double final_new_sl = new_sl_level;
    if(m_tsl_mode == TSL_MODE_TENKAN || m_tsl_mode == TSL_MODE_KIJUN || m_tsl_mode == TSL_MODE_MA)
    {
        double point = SymbolInfoDouble(symbol, SYMBOL_POINT);
        double pips_to_points_multiplier = (SymbolInfoInteger(symbol, SYMBOL_DIGITS) == 3 || SymbolInfoInteger(symbol, SYMBOL_DIGITS) == 5) ? 10.0 : 1.0;
        double buffer_points = m_buffer_pips * point * pips_to_points_multiplier;
        if(type == POSITION_TYPE_BUY) final_new_sl -= buffer_points;
        else final_new_sl += buffer_points;
    }
    
    int digits = (int)SymbolInfoInteger(symbol, SYMBOL_DIGITS);
    final_new_sl = NormalizeDouble(final_new_sl, digits);
    double current_sl = PositionGetDouble(POSITION_SL);

    bool should_modify = false;
    if(type == POSITION_TYPE_BUY)
    {
        if(final_new_sl > current_sl && final_new_sl < current_price) should_modify = true;
    }
    else
    {
        if(final_new_sl < current_sl && final_new_sl > current_price) should_modify = true;
    }

    if(should_modify)
    {
        if(m_trade.PositionModify(ticket, final_new_sl, PositionGetDouble(POSITION_TP)))
        {
            Log("ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + " Ø¨Ù‡ Ù‚ÛŒÙ…Øª " + DoubleToString(final_new_sl, digits) + " Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯.");
        }
        else
        {
            Log("Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØª ØªØ±ÛŒÙ„ÛŒÙ†Ú¯ Ø§Ø³ØªØ§Ù¾ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + ". Ú©Ø¯: " + (string)m_trade.ResultRetcode() + " | " + m_trade.ResultComment());
        }
    }
}
void CTrailingStopManager::ManageBreakeven(int state_idx)
{
    if(m_trade_states[state_idx].be_applied) return;
    ulong ticket = m_trade_states[state_idx].ticket;
    if(!PositionSelectByTicket(ticket)) return;
    string symbol = PositionGetString(POSITION_SYMBOL);
    ENUM_POSITION_TYPE type = (ENUM_POSITION_TYPE)PositionGetInteger(POSITION_TYPE);

    double initial_sl = m_trade_states[state_idx].initial_sl;
    if(initial_sl == 0) return;
    double open_price = PositionGetDouble(POSITION_PRICE_OPEN);
    double initial_risk = MathAbs(open_price - initial_sl);
    if(initial_risk == 0) return;
    double required_profit_for_be = initial_risk * m_be_activation_rr;
    double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
    double current_profit = (type == POSITION_TYPE_BUY) ? (current_price - open_price) : (open_price - current_price);

    if(current_profit >= required_profit_for_be)
    {
        double point = SymbolInfoDouble(symbol, SYMBOL_POINT);
        double pips_to_points_multiplier = (SymbolInfoInteger(symbol, SYMBOL_DIGITS) == 3 || SymbolInfoInteger(symbol, SYMBOL_DIGITS) == 5) ? 10.0 : 1.0;
        double be_offset = m_be_plus_pips * point * pips_to_points_multiplier;
        double new_sl = (type == POSITION_TYPE_BUY) ? open_price + be_offset : open_price - be_offset;
        int digits = (int)SymbolInfoInteger(symbol, SYMBOL_DIGITS);
        new_sl = NormalizeDouble(new_sl, digits);

        if( (type == POSITION_TYPE_BUY && new_sl > PositionGetDouble(POSITION_SL)) ||
            (type == POSITION_TYPE_SELL && new_sl < PositionGetDouble(POSITION_SL)) )
        {
            if(m_trade.PositionModify(ticket, new_sl, PositionGetDouble(POSITION_TP)))
            {
                Log("Ù…Ø¹Ø§Ù…Ù„Ù‡ ØªÛŒÚ©Øª " + (string)ticket + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø±Ø¨Ù‡â€ŒØ³Ø± (Breakeven) Ø´Ø¯.");
                m_trade_states[state_idx].be_applied = true;
            }
        }
    }
}
int CTrailingStopManager::FindTradeStateIndex(ulong ticket)
{
    for(int i = 0; i < ArraySize(m_trade_states); i++)
    {
        if(m_trade_states[i].ticket == ticket) return i;
    }
    return -1;
}
void CTrailingStopManager::AddTradeState(ulong ticket, double open_price, double initial_sl)
{
    int idx = FindTradeStateIndex(ticket);
    if(idx != -1) return;
    
    int new_idx = ArraySize(m_trade_states);
    ArrayResize(m_trade_states, new_idx + 1);
    m_trade_states[new_idx].ticket = ticket;
    m_trade_states[new_idx].open_price = open_price;
    m_trade_states[new_idx].initial_sl = initial_sl;
    m_trade_states[new_idx].be_applied = false;
    Log("Ø­Ø§Ù„Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª " + (string)ticket + " Ø¨Ø§ SL Ø§ÙˆÙ„ÛŒÙ‡ " + (string)initial_sl + " Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
}
int CTrailingStopManager::GetIchimokuHandle(string symbol)
{
  for(int i=0; i<ArraySize(m_ichimoku_handles); i++) if(m_ichimoku_handles[i].symbol==symbol) return m_ichimoku_handles[i].handle;
  int handle = iIchimoku(symbol, _Period, m_ichimoku_tenkan, m_ichimoku_kijun, m_ichimoku_senkou);
  if(handle!=INVALID_HANDLE){int n=ArraySize(m_ichimoku_handles); ArrayResize(m_ichimoku_handles,n+1); m_ichimoku_handles[n].symbol=symbol; m_ichimoku_handles[n].handle=handle;}
  return handle;
}
int CTrailingStopManager::GetMaHandle(string symbol)
{
  for(int i=0; i<ArraySize(m_ma_handles); i++) if(m_ma_handles[i].symbol==symbol) return m_ma_handles[i].handle;
  int handle = iMA(symbol, _Period, m_ma_period, 0, m_ma_method, m_ma_price);
  if(handle!=INVALID_HANDLE){int n=ArraySize(m_ma_handles); ArrayResize(m_ma_handles,n+1); m_ma_handles[n].symbol=symbol; m_ma_handles[n].handle=handle;}
  return handle;
}
int CTrailingStopManager::GetAtrHandle(string symbol)
{
  for(int i=0; i<ArraySize(m_atr_handles); i++) if(m_atr_handles[i].symbol==symbol) return m_atr_handles[i].handle;
  int handle = iATR(symbol, _Period, m_atr_period);
  if(handle!=INVALID_HANDLE){int n=ArraySize(m_atr_handles); ArrayResize(m_atr_handles,n+1); m_atr_handles[n].symbol=symbol; m_atr_handles[n].handle=handle;}
  return handle;
}
int CTrailingStopManager::GetPsarHandle(string symbol)
{
  for(int i=0; i<ArraySize(m_psar_handles); i++) if(m_psar_handles[i].symbol==symbol) return m_psar_handles[i].handle;
  int handle = iSAR(symbol, _Period, m_psar_step, m_psar_max);
  if(handle!=INVALID_HANDLE){int n=ArraySize(m_psar_handles); ArrayResize(m_psar_handles,n+1); m_psar_handles[n].symbol=symbol; m_psar_handles[n].handle=handle;}
  return handle;
}
void CTrailingStopManager::Log(string message)
{
  if (m_magic_number > 0) Print("TSL Manager [", (string)m_magic_number, "]: ", message);
}
double CTrailingStopManager::CalculateIchimokuSL(string symbol, ENUM_POSITION_TYPE type)
{
  int handle = GetIchimokuHandle(symbol);
  if(handle == INVALID_HANDLE) return 0.0;
  int buffer_idx = (m_tsl_mode == TSL_MODE_TENKAN) ? 0 : 1;
  double values[1];
  if(CopyBuffer(handle, buffer_idx, 1, 1, values) < 1) return 0.0;
  double line_value = values[0];
  double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
  if (type == POSITION_TYPE_BUY && line_value > current_price) return 0.0;
  if (type == POSITION_TYPE_SELL && line_value < current_price) return 0.0;
  return line_value;
}
double CTrailingStopManager::CalculateMaSL(string symbol, ENUM_POSITION_TYPE type)
{
  int handle = GetMaHandle(symbol);
  if(handle == INVALID_HANDLE) return 0.0;
  double values[1];
  if(CopyBuffer(handle, 0, 1, 1, values) < 1) return 0.0;
  double ma_value = values[0];
  double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
  if (type == POSITION_TYPE_BUY && ma_value > current_price) return 0.0;
  if (type == POSITION_TYPE_SELL && ma_value < current_price) return 0.0;
  return ma_value;
}
double CTrailingStopManager::CalculateAtrSL(string symbol, ENUM_POSITION_TYPE type)
{
  int handle = GetAtrHandle(symbol);
  if(handle == INVALID_HANDLE) return 0.0;
  double values[1];
  if(CopyBuffer(handle, 0, 1, 1, values) < 1) return 0.0;
  double atr_offset = values[0] * m_atr_multiplier;
  double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
  if(type == POSITION_TYPE_BUY) return current_price - atr_offset;
  else return current_price + atr_offset;
}
double CTrailingStopManager::CalculatePsarSL(string symbol, ENUM_POSITION_TYPE type)
{
  int handle = GetPsarHandle(symbol);
  if(handle == INVALID_HANDLE) return 0.0;
  double values[1];
  if(CopyBuffer(handle, 0, 1, 1, values) < 1) return 0.0;
  double psar_value = values[0];
  double current_price = (type == POSITION_TYPE_BUY) ? SymbolInfoDouble(symbol, SYMBOL_BID) : SymbolInfoDouble(symbol, SYMBOL_ASK);
  if (type == POSITION_TYPE_BUY && psar_value > current_price) return 0.0;
  if (type == POSITION_TYPE_SELL && psar_value < current_price) return 0.0;
  return psar_value;
}
double CTrailingStopManager::CalculatePriceChannelSL(string symbol, ENUM_POSITION_TYPE type)
{
  double values[];
  if(type == POSITION_TYPE_BUY)
  {
      if(CopyLow(symbol, _Period, 1, m_pricechannel_period, values) < m_pricechannel_period) return 0.0;
      return values[ArrayMinimum(values, 0, m_pricechannel_period)];
  }
  else
  {
      if(CopyHigh(symbol, _Period, 1, m_pricechannel_period, values) < m_pricechannel_period) return 0.0;
      return values[ArrayMaximum(values, 0, m_pricechannel_period)];
  }
}
double CTrailingStopManager::CalculateChandelierAtrSL(string symbol, ENUM_POSITION_TYPE type)
{
  int atr_handle = GetAtrHandle(symbol);
  if(atr_handle == INVALID_HANDLE) return 0.0;
  double atr_values[1];
  if(CopyBuffer(atr_handle, 0, 1, 1, atr_values) < 1) return 0.0;
  double atr_offset = atr_values[0] * m_atr_multiplier;
  double price_channel_values[];
  if(type == POSITION_TYPE_BUY)
  {
      if(CopyHigh(symbol, _Period, 1, m_pricechannel_period, price_channel_values) < m_pricechannel_period) return 0.0;
      double highest_high = price_channel_values[ArrayMaximum(price_channel_values, 0, m_pricechannel_period)];
      return highest_high - atr_offset;
  }
  else
  {
      if(CopyLow(symbol, _Period, 1, m_pricechannel_period, price_channel_values) < m_pricechannel_period) return 0.0;
      double lowest_low = price_channel_values[ArrayMinimum(price_channel_values, 0, m_pricechannel_period)];
      return lowest_low + atr_offset;
  }
}








------------------------------------------------------------------------------------------------------------------------------
|                                                   Ù¾Ø§ÛŒØ§Ù†                                                              |
|-------------------------------------------------------------------------------------------------------------------------------







