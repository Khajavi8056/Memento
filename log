//+------------------------------------------------------------------+
//|                                     VisualManager.mqh            |
//|                          © 2025, Mohammad & Gemini               |
//|                                                                  |
//+------------------------------------------------------------------+
#property copyright "© 2025, Mohammad & Gemini"
#property link      "https://www.mql5.com"
#property version   "1.03" // نسخه نهایی و کاملا اصلاح شده

#include "set.mqh" // فایل تنظیمات شما
#include <Object.mqh>
#include <ChartObjects\ChartObject.mqh>
#include <Trade\Trade.mqh>
#include <ChartObjects\ChartObjectsShapes.mqh> // برای رسم مستطیل
#include <ChartObjects\ChartObjectsArrows.mqh>   // برای رسم فلش

//--- نام‌های ثابت برای اشیاء
#define RECT_PREFIX        "M_RECT_"
#define SCAN_PREFIX        "M_SCAN_"
#define CONFIRM_PREFIX     "M_CONFIRM_"

//+------------------------------------------------------------------+
//| کلاس مدیریت گرافیک                                               |
//+------------------------------------------------------------------+
class CVisualManager
{
private:
    string              m_symbol;
    SSettings           m_settings;
    long                m_chart_id;

    string GetObjectName(string prefix, int shift);

public:
    CVisualManager(string symbol, SSettings &settings);
    bool Init();
    void ClearGraphics();
    void DrawTripleCrossRectangle(bool is_buy, int shift);
    void DrawScanningArea(bool is_buy, int start_shift, int current_shift);
    void DrawConfirmationArrow(bool is_buy, int shift);

    ~CVisualManager();
};

//+------------------------------------------------------------------+
//| کانستراکتور کلاس                                                 |
//+------------------------------------------------------------------+
CVisualManager::CVisualManager(string symbol, SSettings &settings)
{
    m_symbol = symbol;
    m_settings = settings;
    m_chart_id = ChartID();
}

//+------------------------------------------------------------------+
//| دیستراکتور کلاس                                                  |
//+------------------------------------------------------------------+
CVisualManager::~CVisualManager()
{
    //--- پاک کردن تمام اشیاء گرافیکی مرتبط با این نماد
    ClearGraphics();
    ChartRedraw(m_chart_id); // رفرش کردن چارت بعد از بستن اکسپرت
}

//+------------------------------------------------------------------+
//| مقداردهی اولیه                                                   |
//+------------------------------------------------------------------+
bool CVisualManager::Init()
{
    //--- مدیریت شیفت چارت برای نمایش ناحیه اسکن
    ChartSetInteger(m_chart_id, CHART_AUTOSCROLL, 0); // خاموش کردن اسکرول خودکار
    ChartSetInteger(m_chart_id, CHART_SHIFT, 1);    // فعال کردن شیفت چارت
    return true;
}

//+------------------------------------------------------------------+
//| ساخت نام منحصر به فرد برای اشیاء                                 |
//+------------------------------------------------------------------+
string CVisualManager::GetObjectName(string prefix, int shift)
{
    datetime time = iTime(m_symbol, _Period, shift);
    return prefix + m_symbol + "_" + (string)time;
}

//+------------------------------------------------------------------+
//| پاکسازی گرافیک                                                   |
//+------------------------------------------------------------------+
void CVisualManager::ClearGraphics()
{
    ObjectsDeleteAll(m_chart_id, RECT_PREFIX + m_symbol + "_");
    ObjectsDeleteAll(m_chart_id, SCAN_PREFIX + m_symbol + "_");
    ObjectsDeleteAll(m_chart_id, CONFIRM_PREFIX + m_symbol + "_");
}

//+------------------------------------------------------------------+
//| رسم مربع کراس سه گانه (کوچک و ثابت)                               |
//+------------------------------------------------------------------+
void CVisualManager::DrawTripleCrossRectangle(bool is_buy, int shift)
{
    ClearGraphics();

    datetime cross_time = iTime(m_symbol, _Period, shift);
    string obj_name = GetObjectName(RECT_PREFIX, shift);

    double high = iHigh(m_symbol, _Period, shift);
    double low = iLow(m_symbol, _Period, shift);

    CChartObjectRectangle rect;
    // اصلاح شد: اضافه کردن (datetime) برای رفع وارنینگ تبدیل نوع داده
    if (rect.Create(m_chart_id, obj_name, 0, cross_time, high, (datetime)(cross_time + PeriodSeconds(_Period) * m_settings.object_size_multiplier), low))
    {
        rect.Color(is_buy ? m_settings.bullish_color : m_settings.bearish_color);
        rect.Style(STYLE_SOLID);
        rect.Width(1);
        rect.Fill(false);
    }
}


//+------------------------------------------------------------------+
//| رسم ناحیه اسکن (مربع بزرگ شیشه‌ای) - نسخه نهایی و کاملاً صحیح       |
//+------------------------------------------------------------------+
void CVisualManager::DrawScanningArea(bool is_buy, int start_shift, int current_shift)
{
    string obj_name = GetObjectName(SCAN_PREFIX, start_shift);
    ObjectDelete(m_chart_id, obj_name);

    datetime start_time = iTime(m_symbol, _Period, start_shift);
    datetime end_time = iTime(m_symbol, _Period, start_shift - m_settings.grace_period_candles);

    // --- شروع منطق صحیح برای پیدا کردن سقف و کف در دوره مهلت ---
    double max_high = iHigh(m_symbol, _Period, start_shift);
    double min_low = iLow(m_symbol, _Period, start_shift);

    // یک حلقه ساده برای پیدا کردن بالاترین High و پایین‌ترین Low در کندل‌های دوره مهلت
    for (int i = 1; i <= m_settings.grace_period_candles; i++)
    {
        int check_shift = start_shift - i;
        if(check_shift < 0) break; // جلوگیری از چک کردن کندل‌های ناموجود

        double current_high = iHigh(m_symbol, _Period, check_shift);
        double current_low = iLow(m_symbol, _Period, check_shift);

        if (current_high > max_high)
            max_high = current_high;
        if (current_low < min_low)
            min_low = current_low;
    }
    // --- پایان منطق صحیح ---

    CChartObjectRectangle rect;
    if (rect.Create(m_chart_id, obj_name, 0, start_time, max_high, end_time, min_low))
    {
        rect.Color(is_buy ? m_settings.bullish_color : m_settings.bearish_color);
        rect.Style(STYLE_DOT);
        rect.Width(1);
        rect.Fill(true);
        // اسم تابع صحیح BgColor است
        rect.BgColor(is_buy ? ColorToARGB(m_settings.bullish_color, 200) : ColorToARGB(m_settings.bearish_color, 200));
    }

    string v_line_name = obj_name + "_VLine";
    ObjectDelete(m_chart_id, v_line_name);

    datetime scan_time = iTime(m_symbol, _Period, start_shift - current_shift);
    ObjectCreate(m_chart_id, v_line_name, OBJ_VLINE, 0, scan_time, 0);
    ObjectSetInteger(m_chart_id, v_line_name, OBJPROP_COLOR, clrWhite);
    ObjectSetInteger(m_chart_id, v_line_name, OBJPROP_STYLE, STYLE_DASH);
    ObjectSetInteger(m_chart_id, v_line_name, OBJPROP_WIDTH, 1);
}


//+------------------------------------------------------------------+
//| رسم فلش تأیید نهایی (نسخه کاملاً اصلاح شده)                     |
//+------------------------------------------------------------------+
void CVisualManager::DrawConfirmationArrow(bool is_buy, int shift)
{
    string obj_name = GetObjectName(CONFIRM_PREFIX, shift);

    double price = is_buy ? iLow(m_symbol, _Period, shift) - (10 * SymbolInfoDouble(m_symbol, SYMBOL_POINT)) : iHigh(m_symbol, _Period, shift) + (10 * SymbolInfoDouble(m_symbol, SYMBOL_POINT));

    // اصلاح شد: کد صحیح برای شکل فلش ها از فونت Wingdings
    uchar code = is_buy ? 233 : 234; // 233 کد فلش رو به بالا و 234 کد فلش رو به پایینه

    CChartObjectArrow arrow;
    // اصلاح شد: تابع Create با 6 پارامتر صحیح فراخوانی شد
    if (arrow.Create(m_chart_id, obj_name, 0, iTime(m_symbol, _Period, shift), price, code))
    {
        arrow.Color(is_buy ? m_settings.bullish_color : m_settings.bearish_color);
        // اصلاح شد: تابع صحیح برای اندازه فلش Width است نه Size
        arrow.Width(2);
    }
}
